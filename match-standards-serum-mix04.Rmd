---
title: "Identifying mix04 standards in serum"
author: "Andrea Vicini, Vinicius Verri Hernandes, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_float: true
    toc_depth: 3
    fig_width: 5
---

```{r, include = FALSE, cached = FALSE}
knitr::read_chunk("R/match-standards-chunks.R")
MIX <- 4
MATRIX <- "Serum"
POLARITY <- "POS"
## settings to find MS2 spectra for features. Be rather inclusive here.
FEATURE_MS2_PPM <- 20
FEATURE_MS2_TOLERANCE <- 0.05
```

```{r, libraries, echo = FALSE, message = FALSE}
```
```{r, general-settings, echo = FALSE, message = FALSE}
```

**Current version: 0.10.1, 2024-10-29.**

# Introduction

Mixes of standards have been solved in water or added to human serum sample
pools in two different concentration and these samples were measured with the
LC-MS setup from Eurac (used also to generate the CHRIS untargeted metabolomics
data). Assignment of retention time and observed ion can be performed for each
standard based on MS1 information such as expected m/z but also based on the
expected difference in signal between samples with low and high concentration of
the standards. Finally, experimental fragment spectra provide the third level of
evidence. Thus, the present data set allows to annotate features to standards
based on 3 levels of evidence: expected m/z, difference in measured intensity
and MS2-based annotation.

A detailed description of the approach is given in
[match-standards-introduction.Rmd](match-standards-introduction.Rmd).


The list of standards that constitute the present sample mix are listed below
along with the expected retention time and the most abundant adduct for positive
and negative polarity as defined manually in a previous analysis by Mar
Garcia-Aloy.

```{r, standards-table, echo = FALSE, results = "asis"}
```

# Data import

We next load the data and split it according to matrix and polarity.

```{r, data-import}
```

We next also load the reference databases we will use to compare the
experimental MS2 spectra against. Below we thus load HMDB and MassBank data. We
create in addition *neutral loss* versions of the databases. Since HMDB does not
provide precursor m/z values we assume the fragment spectra to represent `[M+H]+`
ions (respectively `[M-H]-` ions for negative polarity) and add the m/z for
these adducts as *precursor m/z*.

```{r, load-reference-databases, message = FALSE}
```

```{r, setup-ion-db, message = FALSE, echo = FALSE}
```

# Initial evaluation of available MS2 data

Before performing the actual analysis that involves chromatographic peak
detection and evaluation of feature abundances, we compare all experimental MS2
spectra against the reference libraries. This provides already a first hint for
which standards a valid MS2 spectrum was recorded (and hence would allow
annotation based on evidence 3) and what related retention time might be.

We first extract all MS2 spectra from the respective data files and process them
by first removing all peaks with an intensity below 5% of the highest peak
signal, then scaling all intensities to a value range between 0 and 100 and
finally remove all MS2 spectra with less than 2 peaks.

```{r prepare-all-ms2}
fls <- fileNames(data_all)[data_all$polarity == "POS"]
```
```{r, all-ms2}
```

We next match these spectra against all reference spectra from HMDB for the
standards in `r MIX_NAME`. 

The settings for the matching are defined below. These will be used for all MS2
spectra similarity calculations. All matching spectra with a similarity larger
0.7 are identified.

```{r, compare-spectra-param}
```
 
Standards for which no MS2 spectrum in HMDB is present are listed in
the table below.

```{r, echo = FALSE, results = "asis"}
tmp <- std_dilution[!(std_dilution$HMDB %in% hmdb_std$compound_id), ]
pandoc.table(tmp[, c("name", "HMDB", "formula")], style = "rmarkdown",
             caption = "Standards for which no reference spectrum is available")
```

The table below lists all standards and the number of matching reference spectra
(along with their retention times).

```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We repeat the same analysis for the negative polarity data (code not shown
again).

```{r, echo = FALSE}
fls <- fileNames(data_all)[data_all$polarity == "NEG"]
```
```{r, all-ms2, echo = FALSE}
```
```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We next perform the full analysis of the data set involving MS1 and MS2 data.


# Serum, positive polarity

We first perform the analysis on the samples with the standards solved in serum 
and acquired in positive polarity mode.

```{r}
POLARITY <- "POS"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_pos
hmdb_nl <- hmdb_pos_nl
```

## Data pre-processing

We perform the pre-processing of our data set which consists of the
chromatographic peak detection followed by a peak refinement step to reduce peak
detection artifacts, the correspondence analysis to group peaks across samples
and finally the gap-filling to fill in missing peak data from samples in which
no chromatographic peak was detected.

Some notes on the settings for the pre-processing:

- The `bw` parameter for the correspondence is larger than usual because adding
  the standards in higher concentrations caused considerable retention time
  shifts for some. A higher `bw` will allow to group also mis-aligned
  chromatographic peaks - but will not allow to discriminate between closely
  eluting ions.
- The `binSize` was also slightly increased to avoid splitting of features with
  similar m/z values.

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```

## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-pos}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards evaluation

While for some standards a matching feature was found we still need to evaluate
whether this matching is correct. For each standard we thus first evaluate the
EICs for all matching features, then we match their MS2 spectra (if available)
against reference libraries. To ensure correct assignment of a feature, its
retention time and eventually related MS2 spectra, we consider the following
criteria to determine the annotation confidence:

- feature(s) was/were found with m/z matching those of adduct(s) of the 
  standard.
- signal is higher for samples with higher concentration.
- MS2 spectra matches reference spectra for the standard (if available).
- MS2 spectra don't match MS2 spectra of other compounds.


### Acetylalanine

```{r, echo = FALSE}
std <- "Acetylalanine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EICs for the assigned features and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```


#### Summary

We don't add any ion here since the retention time of the candidate peak is at
-5 seconds from the one found for negative polarity.


### Allantoin

```{r, echo = FALSE}
std <- "Allantoin"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-pos-allantoin-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-pos-allantoin-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix04-serum-pos-allantoin-mirror-hmdb_nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.2,
                           ppm = csp@ppm, tolerance = csp@tolerance, sim)
```

Indeed not the best matches.

```{r mix04-serum-pos-allantoin-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
std_ms2_sel <- Spectra()
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT01673", "FT03175", "FT02416"),
                  confidence_level = c("C", "C-", "C-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT01673_F07.S0500", "FT01673_F08.S0529",
                       "FT03175_F07.S0486", "FT03175_F08.S0512"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Gamma-Aminobutyric acid

```{r, echo = FALSE}
std <- "Gamma-Aminobutyric acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-pos-gamma-aminobutyric-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-pos-gamma-aminobutyric-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix04-serum-pos-gamma-aminobutyric-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

```{r mix04-serum-pos-gamma-aminobutyric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- There are two nice chrom peaks 10 seconds apart. Both with MS2 spectra that
  both match the reference. Thus we add both as ions/features to the database.

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT02085", "FT00311", "FT00542", "FT00301",
                                 "FT00110", "FT00302", "FT00312", "FT00543",
                                 "FT00945", "FT01422", "FT00111"),
                  confidence_level = c("A-", "A-", "A", "A-",
                                       "A-", "A-", "A-", "A",
                                       "A-", "A-", "A-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT00311_F08.S0578", "FT00542_F07.S0545",
                       "FT00542_F08.S0579", "FT00301_F08.S0557",
                       "FT00302_F08.S0635", "FT00543_F07.S0634",
                       "FT00543_F08.S0653", "FT01422_F08.S0639"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low", rep("high", 2), rep("low", 2),
                    rep("high", 2), "low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### AMP

```{r, echo = FALSE}
std <- "AMP"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot its EIC and visually inspect it.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The only MS2 spectrum available for the features matched to `r std` is shown
below (peaks with an intensity below 5% of the maximum peak where removed).

```{r mix04-serum-pos-amp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectrum against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-pos-amp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix04-serum-pos-amp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance, sim)
```

```{r mix04-serum-pos-amp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix04-serum-pos-amp-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance, sim)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT07165", "FT06197", "FT12226"),
                  confidence_level = c("A-", "A", "A-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT07165_F08.S0860", "FT07165_F07.S0860",
                       "FT06197_F07.S0848", "FT06197_F07.S0872",
                       "FT06197_F08.S0850"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low", "low", "high", "high", "high")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Glutamine

```{r, echo = FALSE}
std <- "Glutamine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-pos-glutamine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-pos-glutamine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The best matches (with similarity score greater than 0.7) are shown below.

```{r mix04-serum-pos-glutamine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots", fig.width = 10, fig.height = 10}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

```{r mix04-serum-pos-glutamine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

We observe similar results also from the MassBank comparison.

```{r mix04-serum-pos-glutamine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT04470", "FT00482", "FT01006", "FT01390"),
                  confidence_level = c("B-", "B", "B", "B"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT00482_F07.S0722", "FT00482_F08.S0734",
                       "FT01006_F07.S0716", "FT01006_F07.S0752",
                       "FT01006_F08.S0724", "FT01006_F08.S0763",
                       "FT01390_F07.S0723", "FT01390_F08.S0735"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("high")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### GMP

```{r, echo = FALSE}
std <- "GMP"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-pos-gmp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-pos-gmp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix04-serum-pos-gmp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

We observe similar results for MassBank as we show below.

```{r mix04-serum-pos-gmp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT07167", "FT12668", "FT06615", "FT07553"),
                  confidence_level = c("A-", "A", "A", "A-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT07167_F07.S0886", "FT07167_F08.S0899",
                       "FT07167_F08.S0938", "FT12668_F08.S0905",
                       "FT12668_F07.S0894", "FT06615_F07.S0874",
                       "FT06615_F07.S0917", "FT06615_F07.S0962",
                       "FT06615_F08.S0893", "FT06615_F08.S0934",
                       "FT07553_F07.S0888"),
                     spectraNames(std_ms2))]
ms2$confidence <- c(rep("low", 3), rep("high", 7), "low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Leucine

```{r, echo = FALSE}
std <- "Leucine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-pos-leucine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-pos-leucine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```
 
```{r mix04-serum-pos-leucine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance, sim)
```

```{r mix04-serum-pos-leucine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- Two strong, clean chromatographic peaks are present (merged into the same
  feature). Also, we can not distinguish between leucine and isoleucine. This is
  somewhat similar to what we see for the isoleucine results in Mix 03.
  
```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT02635", "FT00304", "FT01078", "FT01566"),
                  confidence_level = c("B-", "B-", "B", "B-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT02635_F08.S0581", "FT00304_F07.S0543",
                       "FT00304_F08.S0557", "FT00304_F08.S0635",
                       "FT01078_F07.S0546", "FT01078_F08.S0580",
                       "FT01079_F08.S0684"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Phenylethylamine

```{r, echo = FALSE}
std <- "Phenylethylamine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-pos-phenylethylamine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-pos-phenylethylamine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

All the extract spectra seem to match reference spectra from `r std` to some
degree.
 
```{r mix04-serum-pos-phenylethylamine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

```{r mix04-serum-pos-phenylethylamine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- The chromatographic peak is very large, split into two separate ones. We will
  report only the first one, as that matches with the low concentration signal.
  
```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT00874", "FT00560"),
                  confidence_level = c("A", "A-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT00874_F08.S0171", "FT00874_F07.S0164",
                       "FT00560_F07.S0116", "FT00560_F08.S0148"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("high", "high", "low", "low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Propylene glycol

```{r, echo = FALSE}
std <- "Propylene glycol"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

#### Summary

- No signal.


### Putrescine

```{r, echo = FALSE}
std <- "Putrescine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-pos-putrescine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-pos-putrescine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The extracted MS2 spectra match reference spectra from `r std` with low
similarity score.

```{r mix04-serum-pos-putrescine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.2, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

```{r mix04-serum-pos-putrescine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT00158", "FT00342"),
                  confidence_level = c("C", "C-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT00158_F07.S0656", "FT00158_F08.S0672"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Pyridoxine

```{r, echo = FALSE}
std <- "Pyridoxine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-pos-pyridoxine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-pos-pyridoxine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix04-serum-pos-pyridoxine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

We obtain similar results with the MassBank comparison as we show below.

```{r mix04-serum-pos-pyridoxine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT02637", "FT01112", "FT01511",
                                 "FT01887", "FT00909"),
                  confidence_level = c("A-", "A", "A", "A", "A-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT02637_F07.S0427", "FT02637_F08.S0458",
                       "FT02637_F08.S0491", "FT01112_F07.S0462",
                       "FT01112_F08.S0471", "FT01511_F07.S0336",
                       "FT01511_F07.S0382", "FT01511_F07.S0435",
                       "FT01511_F08.S0490", "FT01887_F07.S0363",
                       "FT01887_F07.S0463", "FT01887_F08.S0482",
                       "FT00909_F07.S0448", "FT00909_F08.S0463"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low", "low",
                    "low", "low",
                    "low", "high",
                    "low", "low",
                    "low", "high",
                    "high", "high",
                    "low", "low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Riboflavin

```{r, echo = FALSE}
std <- "Riboflavin"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-pos-riboflavin-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-pos-riboflavin-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix04-serum-pos-riboflavin-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

We obtain similar results for MassBank as we show below.

```{r mix04-serum-pos-riboflavin-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT08644", "FT02465", "FT07872", "FT06959"),
                  confidence_level = c("B-", "B-", "B-", "B"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT08644_F07.S0520", "FT08644_F08.S0550",
                       "FT07872_F07.S0530", "FT06959_F07.S0528",
                       "FT06959_F08.S0562", "FT06959_F08.S0563"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low", "low", "low", "high", "high", "high")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Ribose

```{r, echo = FALSE}
std <- "Ribose"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned features and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-pos-ribose-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-pos-ribose-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix04-serum-pos-ribose-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT01962"),
                  confidence_level = c("D"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT01962_F08.S0423"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### SAMe

```{r, echo = FALSE}
std <- "SAMe"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT02474", "FT07507"),
                  confidence_level = c("D"))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```


### Sedoheptulose-7-phosphate

```{r, echo = FALSE}
std <- "Sedoheptulose-7-phosphate"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-pos-sedoheptulose-7-phosphate-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-pos-sedoheptulose-7-phosphate-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix04-serum-pos-sedoheptulose-7-phosphate-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT03933", "FT04418", "FT03551", "FT10728",
                                 "FT05236", "FT05671"),
                  confidence_level = c("D"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT03933_F08.S0924", "FT05236_F07.S0903",
                       "FT05236_F08.S0915", "FT05671_F07.S0904",
                       "FT05671_F08.S0937"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


# Serum, negative polarity

We now perform the analysis on the samples with the standards still solved in
serum but acquired in negative polarity mode.

```{r}
POLARITY <- "NEG"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_neg
hmdb_nl <- hmdb_neg_nl
csp@tolerance <- 0.01
```

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```


## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-neg}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.


## Standards evaluation

### Acetylalanine

```{r, echo = FALSE}
std <- "Acetylalanine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EICs for the assigned features and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-neg-acetylalanine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-neg-acetylalanine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix04-serum-neg-acetylalanine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

```{r mix04-serum-neg-acetylalanine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

No match was found for reference spectra from MassBank.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- Note: seems the *real* RT would be 37, but the signal is bimodal with two
  different features. MS2 spectra are however only detected for the second
  feature. We add both chrom peaks (with the two distinct RT).

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT1063", "FT0798", "FT1871", "FT0251",
                                 "FT0253", "FT1870", "FT0797", "FT1064"),
                  confidence_level = c("B-", "B-", "B-", "B-",
                                       "B", "B-", "B-", "B-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT1063_F16.S0139", "FT1063_F15.S0165",
                       "FT0253_F15.S0187", "FT0253_F15.S0224",
                       "FT1064_F15.S0165"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Allantoin

```{r, echo = FALSE}
std <- "Allantoin"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-neg-allantoin-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

```{r mix04-serum-neg-allantoin-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix04-serum-neg-allantoin-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

Spectra seem to be matching.

```{r mix04-serum-neg-allantoin-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

No match was found for reference spectra from MassBank.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT2809", "FT1139", "FT0537"),
                  confidence_level = c("A-", "A-", "A"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT0537_F16.S0392"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("high")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Gamma-Aminobutyric acid

```{r, echo = FALSE}
std <- "Gamma-Aminobutyric acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

#### Summary

- Data looks similar to positive polarity: two separate chrom peaks. Will add
  all with confidence D.

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT0077", "FT0706", "FT0076"),
                  confidence_level = c("D"))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```


### AMP

```{r, echo = FALSE}
std <- "AMP"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-neg-amp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-neg-amp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

All the spectra from FT3362 and FT3361 seem to match.

```{r mix04-serum-neg-amp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

```{r mix04-serum-neg-amp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix04-serum-neg-amp-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT7557", "FT4223", "FT3358", "FT4597"),
                  confidence_level = c("B-", "B-", "B", "B"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT7557_F15.S0751", "FT3361_F15.S0747",
                       "FT3361_F15.S0780", "FT3361_F16.S0723",
                       "FT3361_F16.S0758", "FT4597_F15.S0756",
                       "FT4597_F16.S0733"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low", rep("high", 4), "low", "high")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Glutamine

```{r, echo = FALSE}
std <- "Glutamine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-neg-glutamine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-neg-glutamine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We have matches for the spectra from FT0412.

```{r mix04-serum-neg-glutamine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

```{r mix04-serum-neg-glutamine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

We obtain similar results with the Massbank commparison but with lower
similarity scores.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT0845", "FT0981", "FT0414"),
                  confidence_level = c("B-", "B-", "B"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT0981_F15.S0612", "FT0414_F15.S0617",
                       "FT0414_F16.S0594"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### GMP

```{r, echo = FALSE}
std <- "GMP"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-neg-gmp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-neg-gmp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

All the extracted spectra match reference spectra from HMDB.

```{r mix04-serum-neg-gmp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

We repeat the same with MassBank and we obtain similar results as shown below.

```{r mix04-serum-neg-gmp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT7807", "FT3642", "FT4830"),
                  confidence_level = c("A-", "A", "A-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT7807_F15.S0801", "FT7807_F16.S0782",
                       "FT7807_F16.S0798", "FT3642_F16.S0756",
                       "FT3642_F16.S0773", "FT3645_F15.S0792"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low", "low", "low", "high", "high", "high")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Leucine

```{r, echo = FALSE}
std <- "Leucine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EICs for the assigned features and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-neg-leucine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank. The MS2 spectrum does however not match the
reference spectra.

```{r mix04-serum-neg-leucine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix04-serum-neg-leucine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

Only a single peak (the precursor) is matching.

```{r mix04-serum-neg-leucine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- Again, similar to isoleucine, we have 2 chrom peaks. We will add both.

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT0800", "FT0256", "FT1068", "FT0799"),
                  confidence_level = c("B-", "B", "B-", "B-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT0256_F15.S0519", "FT0256_F16.S0427",
                       "FT0256_F16.S0517"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Phenylethylamine

```{r, echo = FALSE}
std <- "Phenylethylamine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

#### Summary

- No signal.

### Propylene glycol

```{r, echo = FALSE}
std <- "Propylene glycol"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```


#### Summary

- No signal.


### Putrescine

```{r, echo = FALSE}
std <- "Putrescine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

#### Summary

- No signal.


### Pyridoxine

```{r, echo = FALSE}
std <- "Pyridoxine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-neg-pyridoxine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-neg-pyridoxine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

All the MS2 spectra from feature FT0685 and FT1288 seem to match reference
spectra from `r std`.

```{r mix04-serum-neg-pyridoxine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

We obtain similar results with the MassBank comparison as we show below.

```{r mix04-serum-neg-pyridoxine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- Similar to positive polarity, we have two separate chrom peaks. The MS2
  spectra for both retention times match the standard, thus we add both.

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT1288", "FT0680", "FT1287", "FT0687"),
                  confidence_level = c("A-", "A", "A-", "A"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT1288_F15.S0325", "FT0687_F15.S0350",
                       "FT0687_F15.S0380", "FT0687_F16.S0268",
                       "FT0687_F16.S0301"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low", rep("high", 4))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Riboflavin

```{r, echo = FALSE}
std <- "Riboflavin"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-neg-riboflavin-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT7998", "FT3901", "FT4540",
                                 "FT4708", "FT5047"),
                  confidence_level = c("D"))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```


### Ribose

```{r, echo = FALSE}
std <- "Ribose"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EICs for the assigned features and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r , echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r , echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.1, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

```{r , echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT1329", "FT1019", "FT0464"),
                  confidence_level = c("C", "C-", "C-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT1329_F15.S0315", "FT1329_F16.S0302"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### SAMe

```{r, echo = FALSE}
std <- "SAMe"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

#### Summary

- No signal.


### Sedoheptulose-7-phosphate

```{r, echo = FALSE}
std <- "Sedoheptulose-7-phosphate"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix04-serum-neg-sedoheptulose-7-phosphate-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix04-serum-neg-sedoheptulose-7-phosphate-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix04-serum-neg-sedoheptulose-7-phosphate-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT6694", "FT2316", "FT3561"),
                  confidence_level = c("D"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT2971_F16.S0755", "FT2972_F16.S0755",
                       "FT2316_F15.S0821", "FT2316_F15.S0865",
                       "FT2316_F16.S0806", "FT6695_F16.S0807",
                       "FT6695_F15.S0831"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```



# Summary on the ion database

Summarizing the content that was added to the `IonDb`.

```{r, iondb-summary, echo = FALSE, results = "asis"}
```

```{r no-ion-table, echo = FALSE, results = "asis"}
```

# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
