---
title: "Identifying standards from mix01"
author: "Andrea Vicini, Vinicius Verri Hernandes, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_depth: 3
    fig_width: 5
---

```{r libraries, message = FALSE, warning = FALSE, echo = FALSE}
library(xcms)
library(pander)
library(MetaboCoreUtils)
library(MetaboAnnotation)
library(BiocParallel)
library(Spectra)
library(RColorBrewer)
library(MetaboAnnotation)
library(pheatmap)
setMSnbaseFastLoad(FALSE)
```

```{r general-settings, echo = FALSE}
mix <- 1
mix_name <- paste0("Mix", ifelse(mix < 10, paste0(0, mix), mix)) 
IMAGE_PATH <- paste0("images/match-standards-", tolower(mix_name),"/")
if (dir.exists(IMAGE_PATH)) unlink(IMAGE_PATH, recursive = TRUE)
RDATA_PATH <- paste0("data/RData/match-standards-/", tolower(mix_name), "/")
dir.create(IMAGE_PATH, showWarnings = FALSE, recursive = TRUE)
dir.create(RDATA_PATH, showWarnings = FALSE, recursive = TRUE)

# Define the mzML files *base* path (/data/massspec/mzML/ on the cluster)
MZML_PATH <- "~/mix01/"
MZML_PATH <- "/data/massspec/mzML/"

register(SerialParam())

library(knitr)
opts_chunk$set(message = FALSE, warning = FALSE, fig.width = 10, fig.height = 8,
               dev = c("png", "pdf"), fig.path = IMAGE_PATH)

```

# Introduction

Mixes of standards have been solved in water or added to human serum sample
pools in two different concentration and these samples were measured with the
LC-MS setup from Eurac (used also to generate the CHRIS untargeted metabolomics
data). The goal of this analysis is to create an in-house reference library for
our untargeted LC-MS setup. For that we:

- determine the retention time of each standard in water and serum.
- define which ions/adducts are measured for each standard (with relative
  abundances, i.e. which is most highly abundant ion etc).
- extract all MS/MS spectra for each standard, match them against reference
  spectra and store them in a database.

The approach consists of the following steps:

- First features are matched to (pre-defined) adducts of all standards within
  the mix based on their m/z value.
- Features are further restricted to those that have a higher signal in samples
  in which a higher concentration was used.
- MS/MS spectra are extracted for all these features and similarities calculated
  against MS/MS spectra for the respective compound from HMDB.
- 

Based on the available information retention times/features are annotated to
standards using different confidence levels:

- **A** (highest confidence): MS/MS spectra are matched with high similarity to
  publicly available reference spectra for that compound. In addition, the
  MS/MS spectra don't match any MS/MS spectrum for any other compound in the
  public resource.
- **B**: MS/MS spectra match with a low similarity to the reference spectra for
  that compound or match also other MS/MS spectra in the reference database with
  a high similarity.
- **C**: matching bases exclusively on m/z matching.


# Identifying standards in sample mix 01

We get all the standards, calculate their exact mass (based on their
formula) and subset to those from mix01.

```{r, echo = FALSE, results = "asis"}
std_dilution <- read.table("data/standards_dilution.txt",
                           sep = "\t", header = TRUE)
std_dilution$exactmass <- calculateMass(std_dilution$formula)
colnames(std_dilution)[colnames(std_dilution) == "HMDB.code"] <- "HMDB"
std_dilution01 <- std_dilution[std_dilution$mix == mix, ]
```

The list of standards that constitute the present sample mix are listed below
along with the expected retention time and the most abundant adduct for positive
and negative polarity as defined manually in a previous analysis by Mar
Garcia-Aloy.

```{r, echo = FALSE, results = "asis"}
pandoc.table(std_dilution01[, c("name", "formula", "HMDB", "RT", "POS", "NEG")], 
             style = "rmarkdown", split.tables = Inf,
             caption = paste0("Standards of ", mix_name))
```

## Data import

We load the data and split it according to matrix and polarity.

```{r}
std_files <- read.table("data/std_serum_files.txt", header = TRUE)
std_files$concentration <- "blank"
std_files$concentration[grep("High", std_files$class)] <- "high"
std_files$concentration[grep("Low", std_files$class)] <- "low"
std_files$group <- std_files$concentration
std_files$group[grep("CE", std_files$mode)] <- "MSMS"

#' Define colors
col_group <- brewer.pal(9, "Set1")[c(1, 5, 4, 9)]
names(col_group) <- c("high", "low", "MSMS", "blank")

#' Subset and load data.
std_files <- std_files[which(std_files$type == mix_name), ]
fls <- paste0(MZML_PATH, std_files$folder, "/", std_files$mzML)
data <- readMSData(fls, pdata = new("NAnnotatedDataFrame", std_files),
                   mode = "onDisk")
data <- filterRt(data, rt = c(0, 350))
data <- filterEmptySpectra(data)

col_group <- col_group[unique(data$group)]
```

```{r}
# matrix_pol: matrix in which the standards are solved and polarity.
tmp <- rep("Water", length(fileNames(data)))
tmp[grep("^QC", data$class)] <- "Serum"
matrix_pol <- paste0(tmp, "_", data$polarity)
data$matrix_pol <- matrix_pol

data_WP <- filterFile(data, file = which(data$matrix_pol == "Water_POS"))
data_WN <- filterFile(data, file = which(data$matrix_pol == "Water_NEG"))
data_SP <- filterFile(data, file = which(data$matrix_pol == "Serum_POS"))
data_SN <- filterFile(data, file = which(data$matrix_pol == "Serum_NEG"))
```

## Water, positive polarity

We first perform the analysis on the samples with the standards solved in pure
water acquired in positive polarity mode.

### Data pre-processing

We perform the pre-processing of our data set which consists of the
chromatographic peak detection followed by a peak refinement step to reduce peak
detection artifacts, the correspondence analysis to group peaks across samples
and finally the gap-filling to fill in missing peak data from samples in which
no chromatographic peak was detected.

Some notes on the settings for the pre-processing:

- The `bw` parameter for the correspondence is larger than usual because adding
  the standards in higher concentrations caused considerable retention time
  shifts for some. A higher `bw` will allow to group also mis-aligned
  chromatographic peaks - but will not allow to discriminate between closely
  eluting ions.
- The `binSize` was also slightly increased to avoid splitting of features with
  similar m/z values.

```{r peakdetection, eval = !file.exists(paste0(RDATA_PATH, "processed_data.RData"))}
## Peak detection
cwp <- CentWaveParam(ppm = 50,
                     peakwidth = c(2, 18),
                     snthresh = 5,
                     mzdiff = 0.001,
                     prefilter = c(4, 300),
                     noise = 100,
                     integrate = 2)

data_WP <- findChromPeaks(data_WP, param = cwp) 

## Peak refinement
mnp <- MergeNeighboringPeaksParam(expandRt = 3.5, expandMz = 0.001,
                                  minProp = 3/4)
data_WP <- refineChromPeaks(data_WP, param = mnp)

## Alignment
pdp1 <- PeakDensityParam(sampleGroups = data_WP$matrix_pol, bw = 3,
                        minFraction = 0.7, binSize = 0.015)
data_WP <- groupChromPeaks(data_WP, param = pdp1)
pgp <- PeakGroupsParam(minFraction = 0.8, extraPeaks = 100, span = 0.8)
data_WP <- adjustRtime(data_WP, param = pgp)

## Correspondence analysis
pdp2 <- PeakDensityParam(sampleGroups = data_WP$mode, bw = 3,
                        minFraction = 0.3, binSize = 0.015)
data_WP <- groupChromPeaks(data_WP, param = pdp2)

## Gap-filling
data_WP <- fillChromPeaks(data_WP, param = ChromPeakAreaParam())
save(data_WP, file = paste0(RDATA_PATH, "processed_data.RData"))
```

```{r correspondence-cached, echo = FALSE, eval = file.exists(paste0(RDATA_PATH, "processed_data.RData"))}
load(paste0(RDATA_PATH, "processed_data.RData"))
```

The base peak chromatogram and peak density image with the expected retention
times for the standards is shown below.

```{r mix01-water-pos-bpc, echo = FALSE, caption = "Base peak chromatogram and chromatographic peak density image. Dashed vertical lines represent the expected retention times for the standards as defined in a previous manual analysis."}
bpc <- chromatogram(data_WP, aggregationFun = "max", msLevel = 1L,
                    mz = c(60, 900), include = "none")
par(mfrow = c(2, 1), mar = c(0, 20, 1.5, 0.5))
plot(bpc, col = paste0(col_group[bpc$group], 80))
legend("topright", col = col_group, lty = 1, legend = names(col_group))
abline(v = std_dilution01$RT, lty = 2)
par(mar = c(4.5, 20, 0, 0.5))
plotChromPeakImage(data_WP, binSize = 3)
abline(v = std_dilution01$RT, lty = 2)
```

There is a clear difference in the signal of samples with high and low
concentration of the standards.


### Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r}
fVlog2 <- log2(featureValues(data_WP, value = "into",
                             method = "sum", filled = TRUE))
high <- grep("High", colnames(fVlog2))
high <- high[-grep("CE", colnames(fVlog2)[high])]
low <- grep("Low", colnames(fVlog2))

ttest <- t(apply(fVlog2, 1, function(x) {
    a <- x[high]
    b <- x[low]
    if (sum(!is.na(a)) > 1 && sum(!is.na(b)) > 1) {
        res <- t.test(a, b, mu = 0)
        c(high_low_diff = unname(res$estimate[1] - res$estimate[2]),
          pvalue = res$p.value, mean_high = mean(a, na.rm = TRUE),
          mean_low = mean(b, na.rm = TRUE))
    } else c(high_low_diff = mean(a, na.rm = TRUE) - mean(b, na.rm = TRUE),
             pvalue = NA_real_, mean_high = mean(a, na.rm = TRUE),
             mean_low = mean(b, na.rm = TRUE))
}))
```


### Identification of features matching standards

We now identify all features matching likely adducts of the standards.

```{r}
adducts <- c("[M+H]+", "[M+2H]2+", "[M+Na]+", "[M+K]+", "[M+NH4]+",
             "[M+H-H2O]+", "[M+H+Na]2+", "[M+2Na]2+", "[M+H-NH3]+")
prm <- Mass2MzParam(adducts = adducts, ppm = 30)
fmat <- c(featureDefinitions(data_WP), ttest)
mtchs <- matchMz(fmat, std_dilution01, param =  prm, mzColname = "mzmed")
mtchs_sub <- mtchs[whichQuery(mtchs)]
```

We further reduce to features that show an at least twice as high signal
in samples with the high concentration compared to the one with the low
concentration. Note that we also keep features for which no difference was
calculated (e.g. because in low concentration no signal was measured).

```{r, echo = FALSE}
mD <- matchedData(mtchs_sub, columns = c("mzmed", "ppm_error", "rtmed",
                                         "target_RT", "target_name",
                                         "target_HMDB",
                                         "adduct", "target_POS",
                                         "high_low_diff", "pvalue",
                                         "mean_high", "mean_low"))
mD <- mD[-which(mD$high_low_diff < 1), ]
mD <- mD[order(mD$target_name), ]
```

for most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution01)`) in mix `r mix` at least one feature was found
matching the standards adducts' m/z. 

Below we plot the BPC indicating the position of the assigned features.

```{r mix01-water-pos-bpc-matched, echo = FALSE, caption = "Base peak chromatogram with position of features assigned to standards."}
plot(bpc, col = paste0(col_group[bpc$group], 80))
legend("topright", col = col_group, lty = 1, legend = names(col_group))
abline(v = mD$rtmed, lty = 2, col = "#00000080")
```

Position of some of the matching features overlap with regions in the BPC that
exhibit a large difference in signal between high and low concentration.
The standards with no match are reported below.

```{r, results = "asis", echo = FALSE}
pandoc.table(std_dilution01[!std_dilution01$name %in% mD$target_name,
                            c("name", "HMDB", "formula", "RT", "POS", "NEG")],
             style = "rmarkdown", split.tables = Inf,
             caption = "Not matched standards")
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

### Standards with matching features

While for some standards a matching feature was found we still need to evaluate
whether this matching is correct. For each standard we thus first evaluate the
EICs for all matching features, then we match their MS2 spectra (if available)
against reference libraries. To ensure correct assignment of a feature, its
retention time and eventually related MS2 spectra, we require the following
to be true:

- feature(s) was/were found with m/z matching those of adduct(s) of the 
  standard.
- signal is higher for samples with higher concentration.
- MS2 spectra matches reference spectra for the standard (if available).
- MS2 spectra don't match MS2 spectra of other compounds.

We next load the reference libraries we will use for the MS2 matching. These are
HMDB and MassBank.

```{r}
register(SerialParam())
library(CompoundDb)

cdb <- CompDb("data/CompDb.Hsapiens.HMDB.5.0.sqlite")

library(MsBackendMassbank)
library(RSQLite)
con <- dbConnect(SQLite(), "data/MassBank.sqlite")
mbank <- Spectra(con, source = MsBackendMassbankSql())
```

#### 3-Phosphoglyceric Acid

```{r, echo = FALSE}
std <- "3-Phosphoglyceric Acid"
```

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

A considerable number of features has been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from two different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics <- function(x, std, tab, MP) {
    eics <- featureChromatograms(x, features = rownames(tab))
    dr <- file.path(IMAGE_PATH, std)
    dir.create(dr, showWarnings = FALSE)
    col_sample <- col_group[eics$group]

    for (i in seq_len(nrow(eics))) {
        ft <- rownames(tab)[i]
        fl <- file.path(dr, paste0(MP,"_", ft, ".png"))
        png(fl, width = 12, height = 8, units = "cm", res = 300, pointsize = 6)
        eic <- eics[i, ]
        plot(eic, col = paste0(col_sample, 80),
             peakBg = paste0(col_sample[chromPeaks(eic)[, "sample"]], 40))
        abline(v = tab$target_RT[1], lty = 2, col = "#00000060")
        grid()
        legend("topleft", c(std, tab$adduct[i], ft))
        legend("topright", col = col_group, legend = names(col_group), lty = 1)
        dev.off()
    }
}
plot_eics(data_WP, std, tmp, "WP")
```

Next we extract the MS2 spectra for all features and clean them (i.e. remove
peaks with an intensity below 10% of the maximum peak and removing spectra with
less than 2 peaks.

```{r}
#' Functions to process the spectra
low_int <- function(x, ...) {
    x > max(x, na.rm = TRUE) * 0.10
}
scale_int <- function(x, ...) {
    maxint <- max(x[, "intensity"], na.rm = TRUE)
    x[, "intensity"] <- 100 * x[, "intensity"] / maxint
    x
}

extract_ms2 <- function(x, features) {
    res <- featureSpectra(x, expandRt = 3, return.type = "Spectra",
                          features = features)
    res <- filterIntensity(res, intensity = low_int)
    res <- res[lengths(res) > 1]
    if (!length(res))
        return(res)
    res <- addProcessing(res, scale_int)
    spectraNames(res) <- paste0(res$feature_id, "_", spectraNames(res))
    res
}

std_ms2 <- extract_ms2(data_WP, rownames(tmp))
```

The MS2 spectra are shown below.

```{r mix01-water-3-phosphoglyceric-acid-ms2, fig.cap = "MS2 spectra for features matched to 3-Phosphoglyceric Acid.", echo = FALSE}
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

The MS2 spectra look rather busy with a large number of peaks. The first two
belong to the first set of features with a retention time of about 250, the 3rd
one to the second set of features with a retention time of ~ 200.

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB.

```{r mix01-water-3-phosphoglyceric-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for 3-Phoshoglyceric Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT1539 match those of 3-Phosphoglyceric Acid, albeit with a
low similarity score while the MS2 spectrum for FT1793 does not match the
reference spectra.

The first two spectra match MS2 spectra for `r std` from HMDB with a similarity
of about 0.4. These are shown in the mirror plots below.

```{r mix01-water-3-phosphoglyceric-acid-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
idx <- which(sim > 0.3, arr.ind = TRUE)

par(mfrow = c(floor(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
for (i in seq_len(nrow(idx))) {
    a <- idx[i, 1L]
    b <- idx[i, 2L]
    plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                      main = paste(std_ms2$feature_id[a], hmdb$name[b]),
                      ppm = 40)
}
```

Although not perfect, it seems that feature FT1539 contains signal from an ion
of `r std`.

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB identifying reference spectra with a similarity larger than
0.7. This is to ensure that no reference spectra from any other compound would
match the extracted spectra for this feature with a higher similarity.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

No spectrum in HMDB matches any of the input spectra with a similarity higher
than 0.7. We next we compare the experimental MS2 spectra against MassBank.

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
mbank_match
```

Also for MassBank no match was found.

##### Summary


#### Acetylhistidine

```{r, echo = FALSE}
std <- "Acetylhistidine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 4 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WP, std, tmp, "WP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-acetylhistidine-ms2, fig.cap = "MS2 spectra for features matched to acetylhistidine.", echo = FALSE}
std_ms2 <- extract_ms2(data_WP, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

We have thus MS2 spectra for each set of features. Next we compare them against
the reference spectra for `r std` from HMDB. The results are shown in the
heatmap below.

```{r mix01-water-acetylhistidine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for Acetylhistidine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT1643 have the highest similarity against MS2 spectra from
`r std`. Mirror plots for the best matching spectra are shown below.

```{r mix01-water-acetylhistidine-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
idx <- which(sim > 0.6, arr.ind = TRUE)

par(mfrow = c(floor(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
for (i in seq_len(nrow(idx))) {
    a <- idx[i, 1L]
    b <- idx[i, 2L]
    plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                      main = paste(std_ms2$feature_id[a], hmdb$name[b]),
                      ppm = 40)
}
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

The features with a retention time of about 37 seconds are clearly not `r std`
while those with a retention time of about 180 seconds seem to represent signal
for that compound, even if their MS2 spectra match also reference spectra from
other compounds.

##### Summary


#### Betaine

```{r, echo = FALSE}
std <- "Betaine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches.")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WP, std, tmp, "WP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-betaine-ms2, fig.cap = "MS2 spectra for features matched to betaine.", echo = FALSE}
std_ms2 <- extract_ms2(data_WP, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

We have thus only MS2 spectra for features with a retention time around 160 or
180 seconds. Next we compare them against the reference spectra for `r std` from
HMDB. The results are shown in the heatmap below.

```{r mix01-water-betaine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for Betaine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

Only the MS2 spectra for FT0544 (with a retention time of 162 match the
reference spectra from betaine.

```{r mix01-water-betaine-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
idx <- which(sim > 0.6, arr.ind = TRUE)

par(mfrow = c(floor(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
for (i in seq_len(nrow(idx))) {
    a <- idx[i, 1L]
    b <- idx[i, 2L]
    plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                      main = paste(std_ms2$feature_id[a], hmdb$name[b]),
                      ppm = 40)
}
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

Thus, the MS2 spectra for feature FT0544 clearly match Betaine.

##### Summary

```{r}
summary_table <- rbind(summary_table, tmp["FT0544", ])
```

#### C3 Carnitine

```{r, echo = FALSE}
std <- "C3 Carnitine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches.")
```

Based on their retention time, it seems that these features represent signal
from two different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WP, std, tmp, "WP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-c3-carnitine-ms2, fig.cap = "MS2 spectra for features matched to C3 Carnitine.", echo = FALSE}
std_ms2 <- extract_ms2(data_WP, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

Unfortunately we don't have any MS2 spectra available. Maybe there are some for
negative polarity which would then help us defining the *correct* retention
time.

##### Summary

#### CDP

```{r, echo = FALSE}
std <- "CDP"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several (7/8?) different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WP, std, tmp, "WP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-CDP-ms2, fig.cap = "MS2 spectra for features matched to CDP", echo = FALSE}
std_ms2 <- extract_ms2(data_WP, rownames(tmp))

if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

We haven't found any MS2 spectra for the features features matched to `r std`.

##### Summary

#### Creatine

```{r, echo = FALSE}
std <- "Creatine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 6 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WP, std, tmp, "WP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-creatine-ms2, fig.cap = "MS2 spectra for features matched to creatine", echo = FALSE}
std_ms2 <- extract_ms2(data_WP, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

We have thus MS2 spectra for features with a retention time around 67 and 177.
Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-water-creatine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for creatine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT0752 have the highest similarity against MS2 spectra from
`r std`. Mirror plots for the best matching spectra are shown below.

```{r mix01-water-creatine-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
idx <- which(sim > 0.6, arr.ind = TRUE)

par(mfrow = c(floor(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
for (i in seq_len(nrow(idx))) {
    a <- idx[i, 1L]
    b <- idx[i, 2L]
    plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                      main = paste(std_ms2$feature_id[a], hmdb$name[b]),
                      ppm = 40)
}
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

The feature with a retention time around 177 seconds (FT0752) seem to represent
signal from `r std` (being only matched to `r std` and with a high score).

##### Summary

#### Dimethylglycine

```{r, echo = FALSE}
std <- "Dimethylglycine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WP, std, tmp, "WP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-dimethylglycine-ms2, fig.cap = "MS2 spectra for features matched to dimethylglycine", echo = FALSE}
std_ms2 <- extract_ms2(data_WP, rownames(tmp))
if (length(std_ms2)) {
    plotSpectra(std_ms2)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

Unfortunately no MS2 spectra is available.

##### Summary

#### Glycerol

```{r, echo = FALSE}
std <- "Glycerol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 6 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WP, std, tmp, "WP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-glycerol-ms2, fig.cap = "MS2 spectra for features matched to glycerol", echo = FALSE}
std_ms2 <- extract_ms2(data_WP, rownames(tmp))
if (length(std_ms2)) {
    plotSpectra(std_ms2)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

Unfortunately no MS2 spectra is available.

##### Summary

#### L-Glutamic Acid

```{r, echo = FALSE}
std <- "L-Glutamic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WP, std, tmp, "WP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-L-Glutamic-Acid-ms2, fig.cap = "MS2 spectra for features matched to L-Glutamic Acid.", echo = FALSE}
std_ms2 <- extract_ms2(data_WP, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

We have thus MS2 spectra for features shown above plus FT1307 (second and
third plot).
Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-water-L-Glutamic-Acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for L-Glutamic Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT1018, FT1020, FT0693, FT0694 have quite high similarity
against MS2 spectra from `r std`. Mirror plots for the best matching spectra
(similarity higher than 0.9) are shown below.

```{r mix01-water-L-Glutamic-Acid-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
idx <- which(sim > 0.9, arr.ind = TRUE)

par(mfrow = c(floor(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
for (i in seq_len(nrow(idx))) {
  a <- idx[i, 1L]
  b <- idx[i, 2L]
  plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                    main = paste(std_ms2$feature_id[a], hmdb$name[b]),
                    ppm = 40)
}
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

MS2 spectra associated to feature FT0694, FT0693, FT1018, FT1020 have been
matched to reference spectra from L-Glutamine but also from other compounds with
relatively high scores in both cases.

##### Summary

#### Myo-Inositol

```{r, echo = FALSE}
std <- "Myo-Inositol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 6 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WP, std, tmp, "WP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-myo-inositol-ms2, fig.cap = "MS2 spectra for features matched to myo-inositol.", echo = FALSE}
std_ms2 <- extract_ms2(data_WP, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

We have thus MS2 spectra for each set of features. Next we compare them against
the reference spectra for `r std` from HMDB. The results are shown in the
heatmap below.

```{r mix01-water-myo-inositol-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for myo-inositol from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT1450 have a high similarity against some MS2 spectra from
`r std`. Mirror plots for the best matching spectra are shown below.

```{r mix01-water-myo-inositol-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
idx <- which(sim > 0.7, arr.ind = TRUE)

par(mfrow = c(floor(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
for (i in seq_len(nrow(idx))) {
  a <- idx[i, 1L]
  b <- idx[i, 2L]
  plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                    main = paste(std_ms2$feature_id[a], hmdb$name[b]),
                    ppm = 40)
}
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

MS2 spectra from FT1450 are matched to `r std` and to other compounds as well
(1,2-Dimethoxybenzene, L-Quebrachitol) but generally with lower scores.

##### Summary

#### Pyruvic Acid

```{r, echo = FALSE}
std <- "Pyruvic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Only FT0348 was matched to `r std`.

We next plot the EIC for the this feature and show it below.

```{r, echo = FALSE}
plot_eics(data_WP, std, tmp, "WP")
```

We next look if there are MS2 spectra associated to this feature but we don't
find any.

```{r mix01-water-pyruvic-acid-ms2, fig.cap = "MS2 spectra for features matched to pyruvic-acid", echo = FALSE}
std_ms2 <- extract_ms2(data_WP, rownames(tmp))
if (length(std_ms2)) {
    plotSpectra(std_ms2)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```


##### Summary

#### Suberic Acid

```{r, echo = FALSE}
std <- "Suberic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 3(or 4?) different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WP, std, tmp, "WP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-suberic-acid-ms2, fig.cap = "MS2 spectra for features matched to suberic acid.", echo = FALSE}
std_ms2 <- extract_ms2(data_WP, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)

```

We have thus MS2 spectra for features around 37 and 140. Next we compare them
against the reference spectra for `r std` from HMDB. The results are shown in
the heatmap below.

```{r mix01-water-suberic-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for suberic acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

Strangely every match has score equal to 0.

We look if there's any match for the MS2 spectra for the matched features
against all spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```


##### Summary

#### Xanthine

```{r, echo = FALSE}
std <- "Xanthine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from a single compound.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WP, std, tmp, "WP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-xanthine-ms2, fig.cap = "MS2 spectra for features matched to xanthine", echo = FALSE}
std_ms2 <- extract_ms2(data_WP, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)

```

We have thus MS2 spectra for the set of features with retention time around 140.
Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-water-xanthine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for xanthine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT1102 have the highest similarity against MS2 spectra from
`r std`. Mirror plots for the best matching spectra are shown below.

```{r mix01-water-xanthine-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
idx <- which(sim > 0.6, arr.ind = TRUE)

par(mfrow = c(floor(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
for (i in seq_len(nrow(idx))) {
  a <- idx[i, 1L]
  b <- idx[i, 2L]
  plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                    main = paste(std_ms2$feature_id[a], hmdb$name[b]),
                    ppm = 40)
}
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

MS2 spectra from FT1102 are assigned also to oxypurinol besides xanthine with
similar (or slightly better) scores.

##### Summary

### Standards without any matching feature

#### propionic acid
#### Uric acid

## Water, negative polarity

We now perform the analysis on the samples with the standards still solved in
pure water but acquired in negative polarity mode.

### Data pre-processing

We perform the pre-processing of these samples (using the same settings as in
water, positive polarity).

```{r peakdetection-water-neg, eval = !file.exists(paste0(RDATA_PATH, "processed_data_WN.RData"))}
## Peak detection
cwp <- CentWaveParam(ppm = 50,
                     peakwidth = c(2, 18),
                     snthresh = 5,
                     mzdiff = 0.001,
                     prefilter = c(4, 300),
                     noise = 100,
                     integrate = 2)

data_WN <- findChromPeaks(data_WN, param = cwp) 

## Peak refinement
mnp <- MergeNeighboringPeaksParam(expandRt = 3.5, expandMz = 0.001,
                                  minProp = 3/4)
data_WN <- refineChromPeaks(data_WN, param = mnp)

## Alignment
pdp1 <- PeakDensityParam(sampleGroups = data_WN$matrix_pol, bw = 3,
                        minFraction = 0.7, binSize = 0.015)
data_WN <- groupChromPeaks(data_WN, param = pdp1)
pgp <- PeakGroupsParam(minFraction = 0.8, extraPeaks = 100, span = 0.8)
data_WN <- adjustRtime(data_WN, param = pgp)

## Correspondence analysis
pdp2 <- PeakDensityParam(sampleGroups = data_WN$mode, bw = 3,
                        minFraction = 0.3, binSize = 0.015)
data_WN <- groupChromPeaks(data_WN, param = pdp2)

## Gap-filling
data_WN <- fillChromPeaks(data_WN, param = ChromPeakAreaParam())
save(data_WN, file = paste0(RDATA_PATH, "processed_data_WN.RData"))
```

```{r correspondence-cached-water-neg, echo = FALSE, eval = file.exists(paste0(RDATA_PATH, "processed_data_WN.RData"))}
load(paste0(RDATA_PATH, "processed_data_WN.RData"))
```

The base peak chromatogram and peak density image with the expected retention
times for the standards is shown below.

```{r mix01-water-neg-bpc, echo = FALSE, caption = "Base peak chromatogram and chromatographic peak density image. Dashed vertical lines represent the expected retention times for the standards as defined in a previous manual analysis."}
bpc_WN <- chromatogram(data_WN, aggregationFun = "max", msLevel = 1L,
                    mz = c(60, 900), include = "none")
par(mfrow = c(2, 1), mar = c(0, 20, 1.5, 0.5))
plot(bpc_WN, col = paste0(col_group[bpc_WN$group], 80))
legend("topright", col = col_group, lty = 1, legend = names(col_group))
abline(v = std_dilution01$RT, lty = 2)
par(mar = c(4.5, 20, 0, 0.5))
plotChromPeakImage(data_WN, binSize = 3)
abline(v = std_dilution01$RT, lty = 2)
```


### Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, echo = FALSE}
fVlog2_WN <- log2(featureValues(data_WN, value = "into",
                             method = "sum", filled = TRUE))
high_WN <- grep("High", colnames(fVlog2_WN))
high_WN <- high_WN[-grep("CE", colnames(fVlog2_WN)[high_WN])]
low_WN <- grep("Low", colnames(fVlog2_WN))

ttest_WN <- t(apply(fVlog2_WN, 1, function(x) {
    a <- x[high_WN]
    b <- x[low_WN]
    if (sum(!is.na(a)) > 1 && sum(!is.na(b)) > 1) {
        res <- t.test(a, b, mu = 0)
        c(high_low_diff = unname(res$estimate[1] - res$estimate[2]),
          pvalue = res$p.value, mean_high = mean(a, na.rm = TRUE),
          mean_low = mean(b, na.rm = TRUE))
    } else c(high_low_diff = mean(a, na.rm = TRUE) - mean(b, na.rm = TRUE),
             pvalue = NA_real_, mean_high = mean(a, na.rm = TRUE),
             mean_low = mean(b, na.rm = TRUE))
}))
```


### Identification of features matching standards

We now identify all features matching likely adducts of the standards.

```{r}
adducts_N <- adducts("negative")[c("[M-H]-", "[M+Cl]-"),
                                 c("mass_multi", "mass_add")]
adducts_N <- rbind(adducts_N, "[M+HCOO]-" = c(1, calculateMass("HCOO"))) 
prm_WN <- Mass2MzParam(adducts = adducts_N, ppm = 30)
fmat_WN <- c(featureDefinitions(data_WN), ttest_WN)
mtchs_WN <- matchMz(fmat_WN, std_dilution01, param = prm_WN, mzColname = "mzmed")
mtchs_sub_WN <- mtchs_WN[whichQuery(mtchs_WN)]
```

We further reduce to features that show an at least twice as high signal
in samples with the high concentration compared to the one with the low
concentration. Note that we also keep features for which no difference was
calculated (e.g. because in low concentration no signal was measured).

```{r, results = "asis", echo = FALSE}
mD_WN <- matchedData(mtchs_sub_WN, columns = c("mzmed", "ppm_error", "rtmed",
                                               "target_RT", "target_name",
                                               "target_HMDB",
                                               "adduct", "target_NEG",
                                               "high_low_diff", "pvalue",
                                               "mean_low", "mean_high"))
mD_WN <- mD_WN[-which(mD_WN$high_low_diff < 1), ]
mD_WN <- mD_WN[order(mD_WN$target_name), ]
```

For most of the standards (`r length(unique(mD_WN$target_name))` out of 
`r nrow(std_dilution01)`) in mix `r mix` at least one feature was found
matching the standards adducts' m/z. 

Below we plot the BPC indicating the position of the assigned features.

```{r mix01-water-neg-bpc-matched, echo = FALSE, caption = "Base peak chromatogram with position of features assigned to standards."}
plot(bpc_WN, peakType = "none", col = paste0(col_group[bpc_WN$group], 80))
legend("topright", col = col_group, lty = 1, legend = names(col_group))
abline(v = mD_WN$rtmed, lty = 2, col = "#00000080")
```

Position of some of the matching features overlap with regions in the BPC that
exhibit a large difference in signal between high and low concentration.
The standards with no match are reported below.

```{r, results = "asis", echo = FALSE}
pandoc.table(std_dilution01[!std_dilution01$name %in% mD_WN$target_name,
                            c("name", "formula", "RT", "POS", "NEG")],
             style = "rmarkdown", split.tables = Inf,
             caption = "Not matched standards")
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

### Standards with matching features

#### 3-Phosphoglyceric Acid

```{r, echo = FALSE}
std <- "3-Phosphoglyceric Acid"
```

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Only two features has been assigned to this standard based on m/z matching.
Based on their retention times, these seem however to represent
ions from two different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WN, std, tmp, "WN")
```

Next we extract the MS2 spectra for all features, clean and plot them.

```{r mix01-water-neg-3-phosphoglyceric-acid-ms2, fig.cap = "MS2 spectra for features matched to 3-Phosphoglyceric Acid.", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

The MS2 spectra seem to belong to the first set of features with a retention
time of about 240.

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB.

```{r mix01-water-neg-3-phosphoglyceric-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for 3-Phoshoglyceric Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT0577 match some spectra from 3-Phosphoglyceric Acid with
high score.

These are shown in the mirror plots below.

```{r mix01-water-neg-3-phosphoglyceric-acid-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
idx <- which(sim > 0.7, arr.ind = TRUE)

par(mfrow = c(floor(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
for (i in seq_len(nrow(idx))) {
    a <- idx[i, 1L]
    b <- idx[i, 2L]
    plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                      main = paste(std_ms2$feature_id[a], hmdb$name[b]),
                      ppm = 40)
}
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB identifying reference spectra with a similarity larger than
0.7. This is to ensure that no reference spectra from any other compound would
match the extracted spectra for this feature with a higher similarity.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
tab[tab$score > max(sim), ]
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

There are many matches also for other HMDB compounds. These have mostly lower
scores than those for `r std` exept a few higher scores.

```{r}
pandoc.table(as.data.frame(tab[tab$score > max(sim), ]),
             style = "rmarkdown", split.table = Inf)

```

##### Summary

#### Acetylhistidine

```{r, echo = FALSE}
std <- "Acetylhistidine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WN, std, tmp, "WN")
```

```{r mix01-water-neg-acetylhistidine-ms2, fig.cap = "MS2 spectra for features matched to acetylhistidine.", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)

```

We have thus MS2 spectra for features with retention time around 180 and 194.
Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-water-neg-acetylhistidine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for Acetylhistidine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for both features FT0620 and FT0623 have a quite high similarity
against MS2 some spectra from `r std`. Mirror plots for the best matching
spectra are shown below.

```{r mix01-water-neg-acetylhistidine-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
idx <- which(sim > 0.7, arr.ind = TRUE)

par(mfrow = c(floor(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
for (i in seq_len(nrow(idx))) {
    a <- idx[i, 1L]
    b <- idx[i, 2L]
    plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                      main = paste(std_ms2$feature_id[a], hmdb$name[b]),
                      ppm = 40)
}
```


In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

Both features FT0620 and FT0623 are matched also to other compounds than
acetylhistidine but with lower scores.

##### Summary

#### Betaine

```{r, echo = FALSE}
std <- "Betaine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches.")
```

Based on their retention time, it seems that these features represent signal
from the same compound.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WN, std, tab = tmp, "WN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-neg-betaine-ms2, fig.cap = "MS2 spectra for features matched to betaine.", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))

if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

##### Summary

#### CDP

```{r, echo = FALSE}
std <- "CDP"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WN, std, tmp, MP = "WN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-neg-CDP-ms2, fig.cap = "MS2 spectra for features matched to CDP", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))

if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

We haven't found any MS2 spectra for the features features matched to `r std`.

##### Summary

#### Creatine

```{r, echo = FALSE}
std <- "Creatine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 2 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WN, std, tmp, "WN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-neg-creatine-ms2, fig.cap = "MS2 spectra for features matched to creatine", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))

if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

We haven't found any MS2 spectra for the features features matched to `r std`.

##### Summary

#### Dimethylglycine

```{r, echo = FALSE}
std <- "Dimethylglycine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

We next plot the EIC for the only feature matched to `r std` and show it below.

```{r, echo = FALSE}
plot_eics(data_WN, std, tmp, "WN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-neg-dimethylglycine-ms2, fig.cap = "MS2 spectra for features matched to dimethylglycine", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

Unfortunately no MS2 spectra associated to FT0052 is available.

##### Summary

#### Glycerol

```{r, echo = FALSE}
std <- "Glycerol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Also for `r std` we have only one match. We next plot the and show the EIC
of the realted feature.

```{r, echo = FALSE}
plot_eics(data_WN, std, tmp, "WN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-neg-glycerol-ms2, fig.cap = "MS2 spectra for features matched to glycerol", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

Unfortunately no MS2 spectra is available.

##### Summary

#### L-Glutamic Acid

```{r, echo = FALSE}
std <- "L-Glutamic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 3 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WN, std, tmp, "WN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-neg-L-Glutamic-Acid-ms2, fig.cap = "MS2 spectra for features matched to L-Glutamic Acid.", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-water-neg-L-Glutamic-Acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for L-Glutamic Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT0269 and even more so for FT070 have quite high similarity
against some MS2 spectra from `r std`. Mirror plots for the best matching
spectra (similarity higher than 0.9) are shown below.

```{r mix01-water-neg-L-Glutamic-Acid-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
idx <- which(sim > 0.9, arr.ind = TRUE)

par(mfrow = c(floor(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
for (i in seq_len(nrow(idx))) {
  a <- idx[i, 1L]
  b <- idx[i, 2L]
  plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                    main = paste(std_ms2$feature_id[a], hmdb$name[b]),
                    ppm = 40)
}
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

Among the matches involving spectra from FT0270 those against spectra from
`r std` have the highest scores. Instead for FT0269 we have a better match
against DL-Glutamate than those against 

##### Summary

#### Myo-Inositol

```{r, echo = FALSE}
std <- "Myo-Inositol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 6 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WN, std, tmp, "WN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-neg-myo-inositol-ms2, fig.cap = "MS2 spectra for features matched to myo-inositol.", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

We have thus MS2 spectra for each set of features. Next we compare them against
the reference spectra for `r std` from HMDB. The results are shown in the
heatmap below.

```{r mix01-water-neg-myo-inositol-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for myo-inositol from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT0813 have a high similarity against some MS2 spectra from
`r std`. Mirror plots for the best matching spectra are shown below.

```{r mix01-water-neg-myo-inositol-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
idx <- which(sim > 0.8, arr.ind = TRUE)

par(mfrow = c(floor(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
for (i in seq_len(nrow(idx))) {
  a <- idx[i, 1L]
  b <- idx[i, 2L]
  plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                    main = paste(std_ms2$feature_id[a], hmdb$name[b]),
                    ppm = 40)
}
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

The matches involve other compounds than `r std` but some of those for `r std`
have the higher score.

##### Summary

#### Pyruvic Acid

```{r, echo = FALSE}
std <- "Pyruvic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 2 different compounds.

Again, we show a representative EIC for both *feature groups* (ordered by
retention time).

```{r, echo = FALSE}
plot_eics(data_WN, std, tmp, "WN")
```

We next look if there are MS2 spectra associated to the above features.

```{r mix01-water-neg-pyruvic-acid-ms2, fig.cap = "MS2 spectra for features matched to pyruvic-acid", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

We match the above MS2 spectrum against all spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

No match involving `r std` was found.

##### Summary

#### Suberic Acid

```{r, echo = FALSE}
std <- "Suberic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 3(or 4?) different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WN, std, tmp, "WN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-neg-suberic-acid-ms2, fig.cap = "MS2 spectra for features matched to suberic acid.", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

We have thus MS2 spectra for features around 37 and 140. Next we compare them
against the reference spectra for `r std` from HMDB. The results are shown in
the heatmap below.

```{r mix01-water-neg-suberic-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for suberic acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT1102 have the highest similarity against MS2 spectra from
`r std`. Mirror plots for the best matching spectra are shown below.

```{r mix01-water-neg-xanthine-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
idx <- which(sim > 0.6, arr.ind = TRUE)

par(mfrow = c(floor(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
for (i in seq_len(nrow(idx))) {
  a <- idx[i, 1L]
  b <- idx[i, 2L]
  plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                    main = paste(std_ms2$feature_id[a], hmdb$name[b]),
                    ppm = 40)
}
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

```{r}
hmdb_match <- hmdb_match[whichQuery(hmdb_match)]

tab <- spectraData(hmdb_match, c("feature_id", "rtime", "target_name", "score"))
pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

MS2 spectra associated with FT0428 have been assigned only to `r std` and with
high scores.

##### Summary

#### Uric acid

```{r, echo = FALSE}
std <- "Uric acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

We show the EICs for the features above.

```{r, echo = FALSE}
plot_eics(data_WN, std, tmp, "WN")
```

We next look if there are MS2 spectra associated to the above features.

```{r mix01-water-neg-uric-acid-ms2, fig.cap = "MS2 spectra for features matched to pyruvic-acid", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

Next we compare the above MS2 spectrum against all spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))
hmdb_match
```

No match is found.

##### Summary

#### Xanthine

```{r, echo = FALSE}
std <- "Xanthine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_WN[mD_WN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
pandoc.table(tmp, style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 3 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_WN, std, tmp, "WN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-water-neg-xanthine-ms2, fig.cap = "MS2 spectra for features matched to xanthine", echo = FALSE}
std_ms2 <- extract_ms2(data_WN, rownames(tmp))

if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    plot(3, 3, pch = NA, xaxt = "n", yaxt = "n")
    text(3, 3, labels = "No Spectra")
}
```

Unfortunately no MS2 spectra was found.

### Standards without any matching feature

#### C3 Carnitine
#### propionic acid

## Alternative?

Sort of a reverse approach. Instead of starting with MS1 we start with MS2.

- use all MS/MS spectra, clean them, normalize them and match them against
  reference spectra for the compounds in HMDB.

### Positive polarity

```{r, results = "asis"}
hmdb <- Spectra(cdb, filter = ~ compound_id == std_dilution01$HMDB)

fls <- fileNames(data_WP)
fls <- fls[grep("_CE", fls)]

all_ms2 <- filterMsLevel(Spectra(fls, source = MsBackendMzR()), msLevel = 2L)
all_ms2 <- filterIntensity(all_ms2, intensity = low_int)
all_ms2 <- all_ms2[lengths(all_ms2) > 1]
all_ms2 <- addProcessing(all_ms2, scale_int)
all_ms2 <- setBackend(all_ms2, MsBackendDataFrame())
all_ms2 <- applyProcessing(all_ms2)

all_match <- matchSpectra(
    hmdb, all_ms2,
    param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))

all_match <- all_match[whichQuery(all_match)]

tab <- matchedData(all_match, c("name", "compound_id", "score", "target_rtime"))

pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```


### Negative polarity

```{r, results = "asis"}
hmdb <- Spectra(cdb, filter = ~ compound_id == std_dilution01$HMDB)

fls <- fileNames(data_WN)
fls <- fls[grep("_CE", fls)]

all_ms2 <- filterMsLevel(Spectra(fls, source = MsBackendMzR()), msLevel = 2L)
all_ms2 <- filterIntensity(all_ms2, intensity = low_int)
all_ms2 <- all_ms2[lengths(all_ms2) > 1]
all_ms2 <- addProcessing(all_ms2, scale_int)
all_ms2 <- setBackend(all_ms2, MsBackendDataFrame())
all_ms2 <- applyProcessing(all_ms2)

all_match <- matchSpectra(
    hmdb, all_ms2,
    param = CompareSpectraParam(ppm = 50, requirePrecursor = FALSE))

all_match <- all_match[whichQuery(all_match)]

tab <- matchedData(all_match, c("name", "compound_id", "score", "target_rtime"))

pandoc.table(as.data.frame(tab), style = "rmarkdown", split.table = Inf)
```

# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```

