---
title: "Identifying mix15 standards in serum"
author: "Marilyn De Graeve, Andrea Vicini, Vinicius Verri Hernandes, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_float: true
    toc_depth: 3
    fig_width: 5
---

```{r, include = FALSE, cached = FALSE}
knitr::read_chunk("R/match-standards-chunks.R")
MIX <- 15
MATRIX <- "Serum"
POLARITY <- "POS"
## settings to find MS2 spectra for features. Be rather inclusive here.
FEATURE_MS2_PPM <- 20
FEATURE_MS2_TOLERANCE <- 0.05
```

```{r, libraries, echo = FALSE, message = FALSE}
```
```{r, general-settings, echo = FALSE, message = FALSE}
```

**Current version: 0.10.1, 2024-10-29.**

# Introduction

Mixes of standards have been solved in serum or added to human serum sample
pools in two different concentration and these samples were measured with the
LC-MS setup from Eurac (used also to generate the CHRIS untargeted metabolomics
data). Assignment of retention time and observed ion can be performed for each
standard based on MS1 information such as expected m/z but also based on the
expected difference in signal between samples with low and high concentration of
the standards. Finally, experimental fragment spectra provide the third level of
evidence. Thus, the present data set allows to annotate features to standards
based on 3 levels of evidence: expected m/z, difference in measured intensity
and MS2-based annotation.

A detailed description of the approach is given in
[match-standards-introduction.Rmd](match-standards-introduction.Rmd).


The list of standards that constitute the present sample mix are listed below
along with the expected retention time and the most abundant adduct for positive
and negative polarity as defined manually in a previous analysis by Mar
Garcia-Aloy.

```{r, standards-table, echo = FALSE, results = "asis"}
```

# Data import

We next load the data and split it according to matrix and polarity.

```{r, data-import}
```

We next also load the reference databases we will use to compare the
experimental MS2 spectra against. Below we thus load HMDB and MassBank data. We
create in addition *neutral loss* versions of the databases. Since HMDB does not
provide precursor m/z values we assume the fragment spectra to represent `[M+H]+`
ions (respectively `[M-H]-` ions for negative polarity) and add the m/z for
these adducts as *precursor m/z*.

```{r, load-reference-databases, message = FALSE}
```

```{r, setup-ion-db, message = FALSE, echo = FALSE}
```

# Initial evaluation of available MS2 data

Before performing the actual analysis that involves chromatographic peak
detection and evaluation of feature abundances, we compare all experimental MS2
spectra against the reference libraries. This provides already a first hint for
which standards a valid MS2 spectrum was recorded (and hence would allow
annotation based on evidence 3) and what related retention time might be.

We first extract all MS2 spectra from the respective data files and process them
by first removing all peaks with an intensity below 5% of the highest peak
signal, then scaling all intensities to a value range between 0 and 100 and
finally remove all MS2 spectra with less than 2 peaks.

```{r prepare-all-ms2}
fls <- fileNames(data_all)[data_all$polarity == "POS"]
```
```{r, all-ms2}
```

We next match these spectra against all reference spectra from HMDB for the
standards in `r MIX_NAME`. 

The settings for the matching are defined below. These will be used for all MS2
spectra similarity calculations. All matching spectra with a similarity larger
0.7 are identified.

```{r, compare-spectra-param}
```
 
Positive polarity:

Standards for which no MS2 spectrum in HMDB is present are listed in
the table below.

```{r, echo = FALSE, results = "asis"}
tmp <- std_dilution[!(std_dilution$HMDB %in% hmdb_std$compound_id), ]
pandoc.table(tmp[, c("name", "HMDB", "formula")], style = "rmarkdown",
             caption = "Standards for which no reference spectrum is available")
```

The table below lists all standards and the number of matching reference spectra
(along with their retention times).

```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

Negative polarity:

We repeat the same analysis for the negative polarity data (code not shown
again).

```{r, echo = FALSE}
fls <- fileNames(data_all)[data_all$polarity == "NEG"]
```
```{r, all-ms2, echo = FALSE}
```
```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We next perform the full analysis of the data set involving MS1 and MS2 data.


# Serum, positive polarity

We first perform the analysis on the samples with the standards solved in pure
serum acquired in positive polarity mode.

```{r}
POLARITY <- "POS"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_pos
hmdb_nl <- hmdb_pos_nl
```

## Data pre-processing

We perform the pre-processing of our data set which consists of the
chromatographic peak detection followed by a peak refinement step to reduce peak
detection artifacts, the correspondence analysis to group peaks across samples
and finally the gap-filling to fill in missing peak data from samples in which
no chromatographic peak was detected. For details on settings please refer to
the analysis of *mix 01* samples.

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```

## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed. Lastly, from mixture 12 onward the maximum retention time deviation 
from the expected 'Target_RT' is less than 10 seconds.

```{r, define-adducts-pos}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards evaluation (all, incl not found/matched)

While for some standards a matching feature was found we still need to evaluate
whether this matching is correct. For each standard we thus first evaluate the
EICs for all matching features, then we match their MS2 spectra (if available)
against reference libraries. To ensure correct assignment of a feature, its
retention time and eventually related MS2 spectra, we consider the following
criteria to determine the annotation confidence:

- feature(s) was/were found with m/z matching those of adduct(s) of the 
  standard.
- signal is higher for samples with higher concentration.
- MS2 spectra matches reference spectra for the standard (if available).
- MS2 spectra don't match MS2 spectra of other compounds.

### N-alpha-Acetyl-L-arginine

```{r, echo = FALSE}
std <- "N-alpha-Acetyl-L-arginine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-pos-N-alpha-Acetyl-L-arginine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-pos-N-alpha-Acetyl-L-arginine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-pos-N-alpha-Acetyl-L-arginine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-pos-N-alpha-Acetyl-L-arginine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.1, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-pos-N-alpha-Acetyl-L-arginine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.1,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No MS2 reference spectra available in MassBank.
- MIRRR
- D for:

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** | FT03206 	261.1 	0.1682 	169 	170 	FG.003.001 	[M+2Na-H]+ 	0 	18.49 	16.37 |
| **D** | FT02836 	239.1 	0.3938 	169.4 	170 	FG.003.001 	[M+Na]+ 	0 	18.32 	15.57 |
| **D** | FT02465 	217.1 	2.596 	170 	170 	FG.001.001 	[M+H]+ 	2 	21.5 	17.82 |
| **D** | FT06986 	433.3 	1.559 	170 	170 	FG.001.001 	[2M+H]+ 	0 	10.42 	4.572 |
| **D** | FT02157 	200.1 	1.946 	170.2 	170 	FG.001.001 	[M+H-NH3]+ 	0 	12.54 	5.236 |
| **D** | FT00900 	131.1 	20.17 	177.4 	170 	FG.002.001 	[M+2Na]2+ 	0 	15.29 	14.12 |
| **D** | FT02142 	199.1 	0.6722 	179.7 	170 	FG.002.001 	[M+H-H2O]+ 	0 	11.18 	5.88 |

- Results previous (wo rt deviation), other (less likely) possible D matches 
  with good EICs

| label |   feature   | mzmed | ppm_error | rtmed | target_RT | feature_group |   adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:-----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:----------:|:-----:|:---------:|:--------:|
| **D** | **FT03083** | 255.1 |   3.669   | 28.87 |    170    |  FG.009.001   |   [M+K]+   |   0   |   10.32   |  8.802   |
| **D** | **FT03085** | 255.1 |  0.03382  | 145.3 |    170    |  FG.001.001   |   [M+K]+   |   0   |   9.698   |  3.687   |
| **D** | **FT03886** |  293  |  0.05861  | 145.1 |    170    |  FG.001.001   | [M+2K-H]+  |   0   |   11.51   |  5.295   |


### alpha-Aminoadipic acid

```{r, echo = FALSE}
std <- "alpha-Aminoadipic acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-pos-alpha-Aminoadipic acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-pos-alpha-Aminoadipic acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-pos-alpha-Aminoadipic acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-pos-alpha-Aminoadipic acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.1, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-pos-alpha-Aminoadipic acid-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.1,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- MIRRR
- non-unique high confidence spectral match for FT01509, so B
- Reference MS2: FT01509: F07.S0657
- labels:

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **B** | FT01509 	162.1 	0.8814 	171 	170 	FG.002.001 	[M+H]+ 	2 	20.11 	16.66 |
| **D** | FT02277 	206 	0.5371 	169.5 	170 	FG.001.001 	[M+2Na-H]+ 	1 	16.03 	12.82 |
| **D** | FT01886 	184.1 	0.6101 	169.7 	170 	FG.001.001 	[M+Na]+ 	0 	15.29 	11.04 |
| **D** | FT01144 	144.1 	1.269 	170.6 	170 	FG.002.001 	[M+H-H2O]+ 	2 	16.4 	12.49 |

- also other D matches but very high rt dev, so ignore.


### FAD

```{r, echo = FALSE}
std <- "FAD"
```

```{r, table-feature-matches-FAD, results = "asis", echo = FALSE, message = FALSE}
feature_table <- as.data.frame(mD[mD$target_name == std, ])
pandoc.table(feature_table, style = "rmarkdown",
             split.tables = Inf,
             caption = paste0("Feature to standards matches for ", std))
```

#### Summary

- No filtered feature table, no potential peaks found.
- No MS2 spectra available (because no potential peaks for `r std`).


### Glucosamine-6-Phosphate

```{r, echo = FALSE}
std <- "Glucosamine-6-Phosphate"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-pos-Glucosamine-6-Phosphate-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-pos-Glucosamine-6-Phosphate-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-pos-Glucosamine-6-Phosphate-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-pos-Glucosamine-6-Phosphate-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.1, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-pos-Glucosamine-6-Phosphate-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.1,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

#### Summary

- No MS2 reference spectra available in HMDB and MassBank.
- D for:

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** | FT03171 	260.1 	2.071 	210.4 	219 	FG.004.001 	[M+H]+ 	1 	12.77 	3.881 |
| **D** | FT02898 	243 	0.1239 	211 	219 	FG.004.001 	[M+H-NH3]+ 	0 	11.29 	7.888 |
| **D** | FT03169 	260.1 	2.246 	219.7 	219 	FG.002.001 	[M+H]+ 	3 	19.84 	10.07 |
| **D** | FT08360 	519.1 	2.971 	219.7 	219 	FG.002.001 	[2M+H]+ 	0 	15.86 	NA |
| **D** | FT02883 	242 	2.088 	220 	219 	FG.003.001 	[M+H-H2O]+ 	3 	18.08 	8.126 |
| **D** | FT02596 	224 	4.036 	220 	219 	FG.003.001 	[M+H-H4O2]+ 	2 	18.79 	8.026 |
| **D** | FT03634 	282 	2.386 	220.5 	219 	FG.005.001 	[M+Na]+ 	1 	13.93 	3.285 |

- Results previous (wo rt deviation), other possible with high rt dev:

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |   adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:-----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:----------:|:-----:|:---------:|:--------:|
| **D** | **FT03172** | 260.1 |   1.574   | 291.4 |    219    |  FG.005.001   |   [M+H]+   |   0   |   11.31   |    NA    |
| **D** | **FT03173** | 260.1 |   2.571   | 313.6 |    219    |  FG.006.001   |   [M+H]+   |   0   |   12.85   |  4.415   |


### Glucuronic Acid

```{r, echo = FALSE}
std <- "Glucuronic Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-pos-Glucuronic Acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

- No MS2 spectra available.
- No MS2 reference spectra available in HMDB and MassBank.
- D for: 

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** | FT06199 	389.1 	6.464 	169.9 	171 	FG.001.001 	[2M+H]+ 	0 	13.63 	5.452 |
| **D** | FT02830 	239 	0.1581 	170.5 	171 	FG.001.001 	[M+2Na-H]+ 	0 	14.64 	12.32 |


### p-Hydroxyphenylacetic acid

```{r, echo = FALSE}
std <- "p-Hydroxyphenylacetic acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-pos-p-Hydroxyphenylacetic acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

- No MS2 spectra available.
- D for:

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** | FT00497 	107 	2.413 	35.61 	36 	FG.001.001 	[M+H-CH2O2]+ 	0 	13.35 	10.14 |


### Isovalerylglycine

```{r, echo = FALSE}
std <- "Isovalerylglycine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-pos-Isovalerylglycine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

- No MS2 spectra available.
- D for:

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** | FT00765 	124.1 	20.21 	37.43 	37 	FG.001.001 	[M+H-H4O2]+ 	0 	10.9 	8.571 |
| **D** | FT02239 	204.1 	2.126 	45.86 	37 	FG.002.001 	[M+2Na-H]+ 	0 	12.8 	10.13 |

- Results previous (wo rt filtering): 
  - 6 feats with high rt dev, 2 with spectra, 0 matching (nor with other 
    compounds)


### 2-Methylcitric acid

```{r, echo = FALSE}
std <- "2-Methylcitric acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-pos-2-Methylcitric acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-pos-2-Methylcitric acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-pos-2-Methylcitric acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-pos-2-Methylcitric acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.1, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-pos-2-Methylcitric acid-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.1,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No MS2 reference spectra available in MassBank.
- MIRRR
- matches to other compound and with only 1 fragment peak and bad EIC, so 
  ignore
- D for:

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** | FT03032 	251 	1.117 	163.5 	171 	FG.001.001 	[M+2Na-H]+ 	1 	13.85 	7.077 |
| **D** | FT01488 	161 	28.65 	164.7 	171 	FG.001.001 	[M+H-CH2O2]+ 	0 	12.22 	10.43 |
| **D** | FT02600 	224.1 	0.6324 	176.3 	171 	FG.002.001 	[M+NH4]+ 	0 	11.46 	8.166 |


### Phenylalanine

```{r, echo = FALSE}
std <- "Phenylalanine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-pos-Phenylalanine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-pos-Phenylalanine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-pos-Phenylalanine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-pos-Phenylalanine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.1, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-pos-Phenylalanine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.1,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No MS2 reference spectra available in HMDB and MassBank.
- Ala-Phe, N-ACETYLPHENYLALANINE, Phenyl-: recognized the Phe residue, but also
  recognized other, so stay B for FT00708, FT01582 and FT01579. high ppm for 
  FT01579. EICs ok but double peak.
- labels:

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **B** | FT00708 	120.1 	2.265 	153.6 	154 	FG.002.001 	[M+H-CH2O2]+ 	3 	19.45 	16.28 |
| **B** | FT01582 	166.1 	0.2176 	153.9 	154 	FG.001.001 	[M+H]+ 	2 	21.68 	19.27 |
| **B** | FT01579 	166.1 	12.61 	159 	154 	FG.003.001 	[M+H]+ 	3 	19.04 	16.03 |
| **D** | FT01261 	149.1 	1.436 	153.9 	154 	FG.001.001 	[M+H-NH3]+ 	2 	14.26 	10.93 |


### Phosphoserine

```{r, echo = FALSE}
std <- "Phosphoserine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-pos-Phosphoserine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-pos-Phosphoserine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-pos-Phosphoserine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-pos-Phosphoserine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.1, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-pos-Phosphoserine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.1,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- MIRR to see if C?
- FT01941 matches to serine backbone but also to other amino acids and other, 
  so keep D.

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** | FT01941 	186 	1.427 	230.4 	231 	FG.001.001 	[M+H]+ 	3 	21.09 	11.81 |
| **D** | FT05858 	371 	3.189 	230.6 	231 	FG.001.003 	[2M+H]+ 	0 	16.79 	NA |


# Serum, negative polarity

We now perform the analysis on the samples with the standards still solved in
pure serum but acquired in negative polarity mode.

```{r}
POLARITY <- "NEG"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_neg
hmdb_nl <- hmdb_neg_nl
```

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```


## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-neg}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards evaluation (all, incl not found/matched)

While for some standards a matching feature was found we still need to evaluate
whether this matching is correct. For each standard we thus first evaluate the
EICs for all matching features, then we match their MS2 spectra (if available)
against reference libraries. To ensure correct assignment of a feature, its
retention time and eventually related MS2 spectra, we consider the following
criteria to determine the annotation confidence:

- feature(s) was/were found with m/z matching those of adduct(s) of the 
  standard.
- signal is higher for samples with higher concentration.
- MS2 spectra matches reference spectra for the standard (if available).
- MS2 spectra don't match MS2 spectra of other compounds.

### N-alpha-Acetyl-L-arginine

```{r, echo = FALSE}
std <- "N-alpha-Acetyl-L-arginine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-neg-N-alpha-Acetyl-L-arginine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-neg-N-alpha-Acetyl-L-arginine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-neg-N-alpha-Acetyl-L-arginine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-neg-N-alpha-Acetyl-L-arginine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-neg-N-alpha-Acetyl-L-arginine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No MS2 reference spectra available in HMDB and MassBank.
- No MS2 spectra available.
- FYI: N-alpha-Acetyl-L-arginine and Amethopterin are synonyms
- FT08081 (RT = 455.2, 1.585 ppm, `[M+H]+` ion) with confidence **A**
- FT08863 (RT = 499.1, 1.695 ppm, `[M+2Na-H]+` ion) with confidence **D**
- FT08464 (RT = 477.2, 0.931 ppm, `[M+Na]+` ion) with confidence **D**
- FT03045 (RT = 228.1, 0.1243 ppm, `[M+2H]2+` ion) with confidence **D**
- FT09407 (RT = 531.1, 27.14 ppm, `[M+2K-H]+` ion) with confidence **D**
- Reference MS2: FT08081 `[M+H]+`: F08.S0507, F07.S0524 (high confidence)

- labels TODO:

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** 
| FT2017 	283.1 	17.9 	168.9 	170 	FG.001.001 	[M-H+HCOONa]- 	0 	16.69 	13.34 |
| FT1210 	215.1 	16.3 	169.6 	170 	FG.001.001 	[M-H]- 	2 	16.29 	12.49 |
| FT4282 	431.2 	16.37 	169.7 	170 	FG.001.002 	[2M-H]- 	0 	10.11 	NA |
| FT1741 	261.1 	13.52 	169.9 	170 	FG.001.001 	[M+CHO2]- 	0 	10.3 	4.182 |


### alpha-Aminoadipic acid

```{r, echo = FALSE}
std <- "alpha-Aminoadipic acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-neg-alpha-Aminoadipic acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-neg-alpha-Aminoadipic acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-neg-alpha-Aminoadipic acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-neg-alpha-Aminoadipic acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-neg-alpha-Aminoadipic acid-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No MS2 reference spectra available in HMDB and MassBank.
- No MS2 spectra available.
- FYI: alpha-Aminoadipic acid and Amethopterin are synonyms
- FT08081 (RT = 455.2, 1.585 ppm, `[M+H]+` ion) with confidence **A**
- FT08863 (RT = 499.1, 1.695 ppm, `[M+2Na-H]+` ion) with confidence **D**
- FT08464 (RT = 477.2, 0.931 ppm, `[M+Na]+` ion) with confidence **D**
- FT03045 (RT = 228.1, 0.1243 ppm, `[M+2H]2+` ion) with confidence **D**
- FT09407 (RT = 531.1, 27.14 ppm, `[M+2K-H]+` ion) with confidence **D**
- Reference MS2: FT08081 `[M+H]+`: F08.S0507, F07.S0524 (high confidence)

- todo neg, high ppm

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **B** |
| FT1343 	228 	15.77 	169.3 	170 	FG.001.001 	[M-H+HCOONa]- 	0 	13.65 	10.74 |
| FT0522 	160.1 	21.21 	170.1 	170 	FG.001.001 	[M-H]- 	2 	16.3 	12.11 |


### FAD

```{r, echo = FALSE}
std <- "FAD"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-neg-FAD-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-neg-FAD-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-neg-FAD-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-neg-FAD-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-neg-FAD-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No MS2 reference spectra available in HMDB and MassBank.
- No MS2 spectra available.
- FYI: FAD and Amethopterin are synonyms
- FT08081 (RT = 455.2, 1.585 ppm, `[M+H]+` ion) with confidence **A**
- FT08863 (RT = 499.1, 1.695 ppm, `[M+2Na-H]+` ion) with confidence **D**
- FT08464 (RT = 477.2, 0.931 ppm, `[M+Na]+` ion) with confidence **D**
- FT03045 (RT = 228.1, 0.1243 ppm, `[M+2H]2+` ion) with confidence **D**
- FT09407 (RT = 531.1, 27.14 ppm, `[M+2K-H]+` ion) with confidence **D**
- Reference MS2: FT08081 `[M+H]+`: F08.S0507, F07.S0524 (high confidence)

-todo

### Glucosamine-6-Phosphate

```{r, echo = FALSE}
std <- "Glucosamine-6-Phosphate"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-neg-Glucosamine-6-Phosphate-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-neg-Glucosamine-6-Phosphate-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-neg-Glucosamine-6-Phosphate-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-neg-Glucosamine-6-Phosphate-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.1, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-neg-Glucosamine-6-Phosphate-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.1,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No MS2 reference spectra available in HMDB and MassBank.
- todo neg D for:

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** | FT1701 	258 	15.96 	218.9 	219 	FG.001.001 	[M-H]- 	2 	19.57 	11.02 |
| **D** | FT2361 	304 	16.59 	218.9 	219 	FG.001.002 	[M+CHO2]- 	0 	12.87 	NA |
| **D** | FT5448 	517.1 	13.54 	218.9 	219 	FG.001.001 	[2M-H]- 	0 	20.26 	0.5264 |

- Results previous (wo rt deviation), other possible with high rt dev: todo

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |    adduct     | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:-------------:|:-----:|:---------:|:--------:|
| **D** | **FT1699** |  258  |   16.49   | 241.9 |    219    |  FG.002.001   |    [M-H]-     |   0   |   14.45   |  6.465   |
| **D** | **FT1700** |  258  |   16.63   | 264.8 |    219    |  FG.003.001   |    [M-H]-     |   0   |   12.54   |  5.182   |
| **D** | **FT1702** |  258  |   10.08   | 304.7 |    219    |  FG.004.001   |    [M-H]-     |   0   |    NA     |  2.288   |- todo:


### Glucuronic Acid

```{r, echo = FALSE}
std <- "Glucuronic Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-neg-Glucuronic Acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-neg-Glucuronic Acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-neg-Glucuronic Acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-neg-Glucuronic Acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-neg-Glucuronic Acid-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No MS2 reference spectra available in HMDB and MassBank.
- D for, high ppm: todod

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** | FT0926 	193 	17.96 	171.3 	171 	FG.001.001 	[M-H]- 	2 	20.61 	18.33 |
| **D** | FT3605 	387.1 	16.75 	172 	171 	FG.001.001 	[2M-H]- 	0 	17.27 	11.29 |
| **D** | FT1361 	229 	19.19 	175.8 	171 	FG.001.001 	[M+Cl]- 	0 	14.3 	8.016 |


### p-Hydroxyphenylacetic acid

```{r, echo = FALSE}
std <- "p-Hydroxyphenylacetic acid"
```

```{r, table-feature-matches-p-Hydroxyphenylacetic acid, results = "asis", echo = FALSE, message = FALSE}
feature_table <- as.data.frame(mD[mD$target_name == std, ])
pandoc.table(feature_table, style = "rmarkdown",
             split.tables = Inf,
             caption = paste0("Feature to standards matches for ", std))
```

#### Summary

- No filtered feature table, no potential peaks found.
- No MS2 spectra available (because no potential peaks for `r std`).
- Results previous (wo rt filter):
  - No MS2 spectra available.


### Isovalerylglycine

```{r, echo = FALSE}
std <- "Isovalerylglycine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-neg-Isovalerylglycine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-neg-Isovalerylglycine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-neg-Isovalerylglycine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-neg-Isovalerylglycine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-neg-Isovalerylglycine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No MS2 reference spectra available in HMDB and MassBank.
- No MS2 spectra available.
- FYI: Isovalerylglycine and Amethopterin are synonyms
- FT08081 (RT = 455.2, 1.585 ppm, `[M+H]+` ion) with confidence **A**
- FT08863 (RT = 499.1, 1.695 ppm, `[M+2Na-H]+` ion) with confidence **D**
- FT08464 (RT = 477.2, 0.931 ppm, `[M+Na]+` ion) with confidence **D**
- FT03045 (RT = 228.1, 0.1243 ppm, `[M+2H]2+` ion) with confidence **D**
- FT09407 (RT = 531.1, 27.14 ppm, `[M+2K-H]+` ion) with confidence **D**
- Reference MS2: FT08081 `[M+H]+`: F08.S0507, F07.S0524 (high confidence)

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** |

### 2-Methylcitric acid

```{r, echo = FALSE}
std <- "2-Methylcitric acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-neg-2-Methylcitric acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-neg-2-Methylcitric acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-neg-2-Methylcitric acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-neg-2-Methylcitric acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-neg-2-Methylcitric acid-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No MS2 reference spectra available in HMDB and MassBank.
- No MS2 spectra available.
- FYI: 2-Methylcitric acid and Amethopterin are synonyms
- FT08081 (RT = 455.2, 1.585 ppm, `[M+H]+` ion) with confidence **A**
- FT08863 (RT = 499.1, 1.695 ppm, `[M+2Na-H]+` ion) with confidence **D**
- FT08464 (RT = 477.2, 0.931 ppm, `[M+Na]+` ion) with confidence **D**
- FT03045 (RT = 228.1, 0.1243 ppm, `[M+2H]2+` ion) with confidence **D**
- FT09407 (RT = 531.1, 27.14 ppm, `[M+2K-H]+` ion) with confidence **D**
- Reference MS2: FT08081 `[M+H]+`: F08.S0507, F07.S0524 (high confidence)
- neg, 2 peaks present in FT1060. tdo

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** |
FT1060 	205 	18.31 	175.8 	171 	FG.001.001 	[M-H]- 	1 	20.43 	16.7

### Phenylalanine

```{r, echo = FALSE}
std <- "Phenylalanine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-neg-Phenylalanine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-neg-Phenylalanine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-neg-Phenylalanine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-neg-Phenylalanine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-neg-Phenylalanine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No MS2 reference spectra available in HMDB and MassBank.
- todo

- No MS2 spectra available.
- FYI: Phenylalanine and Amethopterin are synonyms
- FT08081 (RT = 455.2, 1.585 ppm, `[M+H]+` ion) with confidence **A**
- FT08863 (RT = 499.1, 1.695 ppm, `[M+2Na-H]+` ion) with confidence **D**
- FT08464 (RT = 477.2, 0.931 ppm, `[M+Na]+` ion) with confidence **D**
- FT03045 (RT = 228.1, 0.1243 ppm, `[M+2H]2+` ion) with confidence **D**
- FT09407 (RT = 531.1, 27.14 ppm, `[M+2K-H]+` ion) with confidence **D**
- Reference MS2: FT08081 `[M+H]+`: F08.S0507, F07.S0524 (high confidence)

- neg todo
high ppm, EICs ok but double peak.

| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **B** |
| FT1413 	232.1 	16.52 	153.1 	154 	FG.001.001 	[M-H+HCOONa]- 	3 	19.08 	16.76
| FT0572 	164.1 	19.77 	153.2 	154 	FG.001.001 	[M-H]- 	2 	18.62 	15.37
| FT1146 	210.1 	18.38 	153.2 	154 	FG.001.001 	[M+CHO2]- 	0 	13.48 	9.94
FT2766 	329.1 	13.4 	154.4 	154 	FG.001.001 	[2M-H]- 	0 	11.07 	2.661

### Phosphoserine

```{r, echo = FALSE}
std <- "Phosphoserine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

EICs (check D?):

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix15-serum-neg-Phosphoserine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

Heat maps:

```{r mix15-serum-neg-Phosphoserine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix15-serum-neg-Phosphoserine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

For spectra from untargeted features that match with good similarity to some of 
the HMDB reference spectra for `r std`, we show the mirror plots of the best 
matches.

Mirror plots (check D -> C or B?):

```{r mix15-serum-neg-Phosphoserine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix15-serum-neg-Phosphoserine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

Highest confidence matches (check B -> A?):

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No MS2 reference spectra available in HMDB and MassBank.
- No MS2 spectra available.
- FYI: Phosphoserine and Amethopterin are synonyms
- FT08081 (RT = 455.2, 1.585 ppm, `[M+H]+` ion) with confidence **A**
- FT08863 (RT = 499.1, 1.695 ppm, `[M+2Na-H]+` ion) with confidence **D**
- FT08464 (RT = 477.2, 0.931 ppm, `[M+Na]+` ion) with confidence **D**
- FT03045 (RT = 228.1, 0.1243 ppm, `[M+2H]2+` ion) with confidence **D**
- FT09407 (RT = 531.1, 27.14 ppm, `[M+2K-H]+` ion) with confidence **D**
- Reference MS2: FT08081 `[M+H]+`: F08.S0507, F07.S0524 (high confidence)

- todo neg, D for, high ppm:
| label |   feature  | mzmed | ppm_error | rtmed | target_RT | feature_group |  adduct   | n_ms2 | mean_high | mean_low |
|:-----:|:----------:|:-----:|:---------:|:-----:|:---------:|:-------------:|:---------:|:-----:|:---------:|:--------:|
| **D** |
| FT0799 	184 	17.22 	232.1 	231 	FG.001.001 	[M-H]- 	3 	20.27 	10.85 |
| FT3326 	369 	16.17 	232.1 	231 	FG.001.001 	[2M-H]- 	4 	20.78 	3.528 |

# Summary on the ion database

# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
