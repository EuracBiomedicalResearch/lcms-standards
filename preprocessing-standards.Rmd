---
title: "Preprocessing of the *standards* data set"
author: "Andrea Vicini, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_depth: 3
    fig_width: 5
---

```{r style, echo = FALSE, results = 'asis', message = FALSE}
library(BiocStyle)
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

**Last modified:** `r file.info("preprocessing-standards.Rmd")$mtime`<br />
**Compiled**: `r date()`

```{r general-settings, echo = FALSE}
IMAGE_PATH <- "images/preprocessing-standards/mix01/"
RDATA_PATH <- "data/RData/preprocessing-standards/mix01/"
dir.create(IMAGE_PATH, showWarnings = FALSE)
dir.create(RDATA_PATH, showWarnings = FALSE)

## Define the *base* path where mzML files can be found. This is
## /data/massspec/mzML/ on the cluster
MZML_PATH <- "/data/massspec/mzML/"

library(BiocParallel)
#' Set up parallel processing using 2 cores
if (.Platform$OS.type == "unix") {
    register(bpstart(MulticoreParam(2)))
} else {
    register(bpstart(SnowParam(2)))
}
```

# Introduction

In this document we perform the preprocessing and analysis of mzML files to
determine retention times and measured ions for the *standards*. These standards
are a collection of ~ 250 pure standards of polar metabolites which were used to
setup the HILIC-based LC-MS protocols to measure the polar metabolome in human
serum samples.


# Data preprocessing

In this section we perform the preprocessing of the LC-MS(/MS) data for all
mzML files of one mix of standards.

Below we load all required libraries and the definition of the dataset.

```{r libraries}
library(xcms)
library(pander)
library(RColorBrewer)
std_serum_files <- read.table("data/std_serum_files.txt", header = TRUE)
```

We next subset the data set to a files with samples from a single standards mix.

```{r}
std_serum_files01 <- std_serum_files[which(std_serum_files$type == "Mix01"), ]
```

The list of standards that constitute the present sample mix are listed below
along with the expected retention time and the most abundant adduct for positive
and negative polarity as defined in a previous analysis.

```{r, echo = FALSE, results = "asis"}
std_dilution <- read.table("data/standards_dilution.txt",
                           sep= "\t", header = TRUE)
std_dilution01 <- std_dilution[std_dilution$mix == 1, ]
table1 <- std_dilution01[, c("name", "formula", "RT", "POS", "NEG")]
pandoc.table(table1, style = "rmarkdown", caption = "Standards of mix 01")
```

We next import the MS data from all mzML files of this mix.

```{r load-data, warning = FALSE}
fls <- paste0(MZML_PATH, std_serum_files01$folder, "/", std_serum_files01$mzML)
data <- readMSData(fls, pdata = new("NAnnotatedDataFrame", std_serum_files01),
                   mode = "onDisk")
```

We next create the base peak chromatogram (BPC) for each file and define colors
for the different sets of samples.

```{r}
bpc <- chromatogram(data, aggregationFun = "max")

#' Define a new variable combining the polarity and the matrix in which the
#' standards are solved.
tmp <- rep("Water", length(fileNames(data)))
tmp[grep("^QC", data$class)] <- "Serum"
matrix_pol <- paste0(tmp, "_", data$polarity)
data$matrix_pol <- matrix_pol

#' Define the colors for each type
col_matrix_pol <- brewer.pal(5, "Set1")[c(1, 2, 4, 5)]
names(col_matrix_pol) <- c("Water_POS", "Water_NEG", "Serum_NEG", "Serum_POS")
```

The BPC are shown below.

```{r bpc-mix01, fig.path = IMAGE_PATH, fig.cap = "Base peak chromatogram. Different colours for polarity and matrix. The vertical grey dotted lines indicate the retention time where an ion of a standard present in the current mix is expected.", fig.width = 10, fig.height = 5}
plot(bpc, col = paste0(col_matrix_pol[data$matrix_pol], 80))
legend("topright", col = col_matrix_pol,
       legend = names(col_matrix_pol), lwd = 1)
abline(v = std_dilution01$RT, lty = 3, col = "grey")
```

As expected, the signal in serum samples (orange and purple) seems to be higher
for the retention time regions in which a high number of compounds is expected
(20-60, 110-200 seconds). Surprisingly, also the samples with the mix solved in
water yield high signals for positive polarity (in the region from 60-120
seconds, but also around 160 seconds). In general, samples measured in positive
polarity seem to have higher intensities than the corresponding samples measured
in negative polarity.

- [ ] perform chromatographic peak detection.
- [ ] table with the number of peaks per file.
- [ ] split the data set for positive and negative polarity
- [ ] run correspondence analysis (separately for the positive and negative
      polarity).
- [ ] let's see how to proceed from here...


# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
