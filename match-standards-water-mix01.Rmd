---
title: "Identifying mix01 standards in water"
author: "Andrea Vicini, Vinicius Verri Hernandes, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_float: true
    toc_depth: 3
    fig_width: 5
---

```{r, include = FALSE, cached = FALSE}
knitr::read_chunk("R/match-standards-chunks.R")
MIX <- 1
MATRIX <- "Water"
POLARITY <- "POS"
```

```{r, libraries, echo = FALSE, message = FALSE}
```
```{r, general-settings, echo = FALSE, message = FALSE}
```

# TEMP

What to store from features

- feature_id
- original_sample: mix 01...
- sample_matrix: water|serum pool
- ion_adduct
- relative_ion_intensity: relative to the other ions [0-100]
- confidence_level: ABCD.
- rtmed -> ion_mz
- mzmed -> ion_rt
- compound_id

```{r}
## Create a data.frame with that info.
fts <- data.frame(feature_id = ,
                  compound_id,
                  ion_adduct,
                  sample_matrix,
                  original_sample,
                  confidence_level)
## Extract remaining variables from the features:
ion_mz, ion_rt, relative_ion_intensity, 
## Set relative ion intensity

idb <- insertIon(idb, fts)
```

What to store from spectra

- feature_id
- confidence: high, low
- adduct
- rtime, precursor m/z, acquisitionNum, polarity
- original_file
- collision_energy
- compound_id
- instrument "Sciex TripleTOF 5600+"
- instrument_type "LC-ESI-QTOF"

```{r}
## Manually define the spctrum names/IDs.
sps_insert <- data.frame(original_spectrum_id,
                         compound_id,
                         confidence,
                         adduct,
                         instrument,
                         instrument_type)
## Get remaining from Spectra
rtime, precursor_mz, acquisitionNum, polarity, original_file, collision_energy
## Add the ion_id info by getting the just inserted ion info from the database
## identify the entries with feature_id, original_sample and sample_matrix
idb <- insertSpectra(sps, columns = c(the columns to insert))

```

```{r}
## create a new IonDb from the CompDb. If file exists, remove all ions and
## spectra for the current mix.
```

**Current version: 0.10.0, 2022-05-05.**

# Introduction

Mixes of standards have been solved in water or added to human serum sample
pools in two different concentration and these samples were measured with the
LC-MS setup from Eurac (used also to generate the CHRIS untargeted metabolomics
data). Assignment of retention time and observed ion can be performed for each
standard based on MS1 information such as expected m/z but also based on the
expected difference in signal between samples with low and high concentration of
the standards. Finally, experimental fragment spectra provide the third level of
evidence. Thus, the present data set allows to annotate features to standards
based on 3 levels of evidence: expected m/z, difference in measured intensity
and MS2-based annotation.

A detailed description of the approach is given in
[match-standards-introduction.Rmd](match-standards-introduction.Rmd).


The list of standards that constitute the present sample mix are listed below
along with the expected retention time and the most abundant adduct for positive
and negative polarity as defined manually in a previous analysis by Mar
Garcia-Aloy.

```{r, standards-table, echo = FALSE, results = "asis"}
```

# Data import

We next load the data and split it according to matrix and polarity.

```{r, data-import}
```

We next also load the reference databases we will use to compare the
experimental MS2 spectra against. Below we thus load HMDB and MassBank data. We
create in addition *neutral loss* versions of the databases. Since HMDB does not
provide precursor m/z values we assume the fragment spectra to represent `[M+H]+`
ions (respectively `[M-H]-` ions for negative polarity) and add the m/z for
these adducts as *precursor m/z*.

```{r, load-reference-databases, message = FALSE}
```

# Initial evaluation of available MS2 data

Before performing the actual analysis that involves chromatographic peak
detection and evaluation of feature abundances, we compare all experimental MS2
spectra against the reference libraries. This provides already a first hint for
which standards a valid MS2 spectrum was recorded (and hence would allow
annotation based on evidence 3) and what related retention time might be.

We first extract all MS2 spectra from the respective data files and process them
by first removing all peaks with an intensity below 5% of the highest peak
signal, then scaling all intensities to a value range between 0 and 100 and
finally remove all MS2 spectra with less than 2 peaks.

```{r prepare-all-ms2}
fls <- fileNames(data_all)[data_all$polarity == "POS"]
```
```{r, all-ms2}
```

We next match these spectra against all reference spectra from HMDB for the
standards in `r MIX_NAME`. 

The settings for the matching are defined below. These will be used for all MS2
spectra similarity calculations. All matching spectra with a similarity larger
0.7 are identified.

```{r, compare-spectra-param}
```
 
Standards for which no MS2 spectrum in HMDB is present are listed in
the table below.

```{r, echo = FALSE, results = "asis"}
tmp <- std_dilution01[!(std_dilution01$HMDB %in% hmdb_std$compound_id), ]
pandoc.table(tmp[, c("name", "HMDB", "formula")], style = "rmarkdown",
             caption = "Standards for which no reference spectrum is available")
```

The table below lists all standards and the number of matching reference spectra
(along with their retention times).

```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We repeat the same analysis for the negative polarity data (code not shown
again).

```{r, echo = FALSE}
fls <- fileNames(data_all)[data_all$polarity == "NEG"]
```
```{r, all-ms2, echo = FALSE}
```
```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We next perform the full analysis of the data set involving MS1 and MS2 data.


# Water, positive polarity

We first perform the analysis on the samples with the standards solved in pure
water acquired in positive polarity mode.

```{r}
POLARITY <- "POS"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_pos
hmdb_nl <- hmdb_pos_nl
```

## Data pre-processing

We perform the pre-processing of our data set which consists of the
chromatographic peak detection followed by a peak refinement step to reduce peak
detection artifacts, the correspondence analysis to group peaks across samples
and finally the gap-filling to fill in missing peak data from samples in which
no chromatographic peak was detected.

Some notes on the settings for the pre-processing:

- The `bw` parameter for the correspondence is larger than usual because adding
  the standards in higher concentrations caused considerable retention time
  shifts for some. A higher `bw` will allow to group also mis-aligned
  chromatographic peaks - but will not allow to discriminate between closely
  eluting ions.
- The `binSize` was also slightly increased to avoid splitting of features with
  similar m/z values.

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```

## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-pos}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution01)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards with matching features

While for some standards a matching feature was found we still need to evaluate
whether this matching is correct. For each standard we thus first evaluate the
EICs for all matching features, then we match their MS2 spectra (if available)
against reference libraries. To ensure correct assignment of a feature, its
retention time and eventually related MS2 spectra, we consider the following
criteria to determine the annotation confidence:

- feature(s) was/were found with m/z matching those of adduct(s) of the 
  standard.
- signal is higher for samples with higher concentration.
- MS2 spectra matches reference spectra for the standard (if available).
- MS2 spectra don't match MS2 spectra of other compounds.


### 3-Phosphoglyceric Acid

```{r, echo = FALSE}
std <- "3-Phosphoglyceric Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Four features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from two different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-pos-3-phosphoglyceric-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

The MS2 spectra look rather busy with a large number of peaks. The first two
belong to FT1793, the last two to FT1539.

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB.

```{r mix01-water-pos-3-phosphoglyceric-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra for FT1539 match those of 3-Phosphoglyceric Acid, albeit with a
low similarity score while the MS2 spectrum for FT1793 does not match the
reference spectra.

The first two spectra match MS2 spectra for `r std` from HMDB with a similarity
of about 0.2. These are shown in the mirror plots below.

```{r mix01-water-pos-3-phosphoglyceric-acid-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.2,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

Although not perfect, it seems that feature FT1539 contains signal from an ion
of `r std`.

In addition we compare all spectra against reference spectra from MassBank for
the selected standard but we don't find any match. 

```{r mix01-water-pos-3-phosphoglyceric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for
the matched features against all spectra from HMDB or MassBank identifying
reference spectra with a similarity larger than 0.7. The results (if any spectra
matched) are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- Annotation of FT1539 (RT=250, `[M+H]+` ion) to `r std` with confidence level
  **B**.
- Annotation of FT1749 (RT=250, `[M+NH4]+` ion] to `r std` with confidence level
  **B-**.
- Reference MS2: `[M+H]+`: F07.S0836, F08.S0767 (with a *low* grading?)


### Acetylhistidine

```{r, echo = FALSE}
std <- "Acetylhistidine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from tentatively 3 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

```{r mix01-water-pos-acetylhistidine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-water-pos-acetylhistidine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra for FT1643 have the highest similarity against MS2 spectra from
`r std`. Mirror plots for the best matching spectra are shown below.

```{r mix01-water-pos-acetylhistidine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.6,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we perform also the match against reference spectra for that
standard from MassBank.

```{r mix01-water-pos-acetylhistidine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Surprisingly no spectrum matches MassBank. Finally, we match (**all**) the MS2
spectra for the matched features against all spectra from HMDB or MassBank
identifying reference spectra with a similarity larger than 0.7. The results
(if any spectra matched) are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

Also for other ions than `[M+H]+` we got MS2 spectra: FT2158 (`[M+2Na-H]+`) and
FT1925 (`[M+Na]+`). These have highly similar EIC and thus there is a high
chance that they represent in fact signal from the same original compound. Below
we compare the neutral loss spectra between the MS2 spectra of these - to
evaluate if they would eventually match.

```{r mix01-water-pos-acetylhisidine_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_ms2_nl, csp_nl)
```

The neutral loss spectra don't match.

#### Summary

- FT1643 (RT=177.8, `[M+H]+` ion) matches MS2 spectra of `r std` with high
  similarity: confidence **A**. Matches against MS2 spectra from other compounds
  differ in their precursor m/z.
- FT1925 (RT=177.9, `[M+Na]+` ion); confidence **A-**.
- FT2158 (RT=177.3, `[M+2Na-H]+` ion); confidence **A-**.
- Note on the EIC: multiple peaks, and retention time seems to be
  concentration-dependent (lower concentration -> earlier RT).
- Reference MS2: `[M+H]+`: F08.S0506, F07.S0518 and F08.S0425; high
  confidence. Reference spectra for `[M+Na]+` ion (FT1925): F07.S0429,
  F08.S0426; low confidence. Reference spectra for `[M+2Na-H]+` ion (FT2158):
  F07.S0430, F08.S0427; low confidence.


### Betaine

```{r, echo = FALSE}
std <- "Betaine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds. We next plot the EIC for the assigned feature
and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-pos-betaine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We have MS2 spectra for features with a retention time around 160, 180 and 220
seconds. Next we compare them against the reference spectra for `r std` from
HMDB. The results are shown in the heatmap below.

```{r mix01-water-pos-betaine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

MS2 spectra for FT0544 (F08.S0371 and F07.S0379) match the reference spectra
from betaine. Also MS2 spectrum F08.S0654 of feature FT0522 (retention time 225)
matches betaine, but with a lower similarity. From the EIC FT0522 seems to be
mostly noise and no *real* compound data.

```{r mix01-water-pos-betaine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we compare against MassBank spectra.

```{r mix01-water-pos-betaine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

The same MS2 spectra match, albeit with a lower similarity. Finally, we match
(**all**) the MS2 spectra for the matched features against all spectra from HMDB
or MassBank identifying reference spectra with a similarity larger than 0.7.
The results (if any spectra matched) are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

Thus, the MS2 spectra for feature FT0544 clearly match Betaine.

Again, we have MS2 spectra for two different ions of the same compound. Below we
compare thus the neutral loss versions of all spectra to see if they match.

```{r mix01-water-pos-betaine_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_ms2_nl, csp_nl)
```

The neutral loss MS2 of the different ions don't match.

#### Summary

- MS2 spectra for FT0544 (RT=162.3, `[M+H]+` ion) matches `r std` with
  confidence **A**.
- FT0877 (RT=163.3, `[M+Na]+` ion) matches with **A-**.
- Reference MS2: `[M+H]+`: F08.S0371, F07.S0379; high confidence. `[M+Na]+`:
  F07.S0389, F08.S0380; low confidence.


### C3 Carnitine

```{r, echo = FALSE}
std <- "C3 Carnitine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from two different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Unfortunately we don't have any MS2 spectra available. Maybe there are some for
negative polarity which would then help us defining the *correct* retention
time.

#### Summary

- FT2112 (RT=162.6, `[M+NH4]+`): confidence level **D**. Justify based on not
  possible adduct and polarity.


### CDP

```{r, echo = FALSE}
std <- "CDP"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-pos-cdp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

```{r mix01-water-pos-cdp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

These MS2 spectra don't match any reference spectra from `r std` from HMDB.
In addition we compare against MassBank spectra but again we don't find any
match.

```{r mix01-water-pos-cdp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Since FT5019 appears to match an ion different from `[M+H]+` (`[M+2Na-H]+`) we
also perform a neutral loss comparison.

```{r mix01-water-pos-cdp-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-water-pos-cdp-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

Still we don't find any match. Finally, we match (**all**) the MS2 spectra
for the matched features against all spectra from HMDB or MassBank identifying
reference spectra with a similarity larger than 0.7. The results (if any spectra
matched) are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank (requiring a high similarity).

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
std_ms2_nl <- neutralLoss(std_ms2, PrecursorMzParam())
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl, similarity = 0.9)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl, similarity = 0.9,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```


#### Summary

- FT4469 (RT=236, `[M+H]+` ion): confidence level **D**.
- FT5021 (RT=233, `[M+2Na-H]+` ion): confidence level **D**.

### Creatine

```{r, echo = FALSE}
std <- "Creatine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from 6 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-pos-creatine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We have thus MS2 spectra for features with a retention time around 67, 177
and 225. Next we compare them against the reference spectra for `r std` from
HMDB.  The results are shown in the heatmap below.

```{r mix01-water-pos-creatine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for creatine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra for FT0752 have the highest similarity against MS2 spectra from
`r std`. Mirror plots for the best matching spectra are shown below.

```{r mix01-water-pos-creatine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.6,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we compare against MassBank spectra and we abtain similar results
but with lower similarity.

```{r mix01-water-pos-creatine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

We check in addition if matches between neutral loss spectra would be found.

```{r mix01-water-pos-creatine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

Neutral loss version of MS2 spectra from feature F07.0752 again match neutral
loss version of creatine reference spectra from HMDB. In addition, that is the
case also for neutral loss spectra from feature FT1387 (and with low similarity
also for neutral loss spectra from features FT0479 and FT1779). The best matches
(with similarity higher than 0.5) are shown below.

```{r mix01-water-pos-creatine-mirror-hmdb-nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2_nl, std_hmdb_nl, 0.5,
                               ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

```{r mix01-water-pos-creatine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

We obtain similar results for MassBank.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank (requiring a high similarity).

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
std_ms2_nl <- neutralLoss(std_ms2, PrecursorMzParam())
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl, similarity = 0.9)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl, similarity = 0.9,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

The feature with a retention time around 177 seconds (FT0752) seem to represent
signal from `r std` (being only matched to `r std` and with a high score).

Again, we have MS2 spectra for two different ions of the same compound. Below we
compare thus the neutral loss versions of all spectra to see if they match.

```{r mix01-water-pos-creatine_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_ms2_nl, csp_nl)
```


#### Summary

- FT0752 (RT=177.8, `[M+H]+` ion): confidence **A**: the MS2 spectrum F07.S0424
  matches only `r std`.
- FT1119 (RT=177, `[M+Na]+` ion): confidence **A-**.
- FT1387 (RT=176.6, `[M+2Na-H]+` ion): confidence **A-**.
- Retention time of the peaks seems to be dependent on the concentration.
- Reference MS2: `[M+H]+`: F07.S0424, F08.S0420; high confidence. `[M+Na]+`
  (FT1119): F07.S0426, F08.S0422; low confidence. `[M+2Na-H]+` (FT1387):
  F07.S0427, F08.S0424; low confidence.
- Interestingly, we seem to have Creatinine also present (FT0479, RT=56).


### Dimethylglycine

```{r, echo = FALSE}
std <- "Dimethylglycine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-pos-dimethylglycine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Similarity against reference spectra of `r std` is calculated.

```{r , echo = FALSE}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The spectrum does thus not match any reference spectra from `r std`. In addition
we compare it aginst the reference spectra from MassBank for the selected
standard but again we obtain no match.

```{r mix01-water-pos-dimethylglycine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```
Since the extracted spectrum is associated to
an ion different from `[M+H]+` (`[M+2Na-H]+`) we also perform a comparison
between the neutral loss spectra from HMDB and MassBank.

```{r mix01-water-pos-dimethylglycine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-water-pos-dimethylglycine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

Still, we don't get any match. Finally, we match (**all**) the MS2 spectra for
the matched features against all spectra from HMDB or MassBank identifying
reference spectra with a similarity larger than 0.7. The results (if any
spectra matched) are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT0651 (RT=176.6 `[M+Na]+` ion): confidence level **D**.
- FT1015 (RT=175.2 `[M+2Na-H]+` ion): confidence level **D**.

### Glycerol

```{r, echo = FALSE}
std <- "Glycerol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from 6 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Unfortunately no MS2 spectra is available.

#### Summary

- Inconclusive.
- again, there are quite some candidates and it's not possible to select
  one.
- Evaluating the EICs it seems `r std` can not be detected in the present
  samples.


### L-Glutamic Acid

```{r, echo = FALSE}
std <- "L-Glutamic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-pos-l-glutamic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-water-pos-l-glutamic-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for L-Glutamic Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra for FT1018, FT1019, FT1020, FT1020, FT0693, FT0694 have quite
high similarity against MS2 spectra from `r std`. Mirror plots for the best
matching spectra (similarity higher than 0.9) are shown below. Note also that
some MS2 spectra are assigned to multiple features.

```{r mix01-water-pos-l-glutamic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.9, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

Thus, the best matching spectra are F07.S0508, F07.S0619, F08.S0464 and
F08.S0622. The associated features are *FT1018*, *FT1020* and *FT0693*. Looking
at the EICs of these it is evident that *FT1020* should be ignored.

![](images/match-standards-water-mix01/L-Glutamic Acid/WP_FT0694.png)

![](images/match-standards-water-mix01/L-Glutamic Acid/WP_FT1020.png)

Those most likely representing `r std` are:

![](images/match-standards-water-mix01/L-Glutamic Acid/WP_FT0693.png)

![](images/match-standards-water-mix01/L-Glutamic Acid/WP_FT1018.png)

![](images/match-standards-water-mix01/L-Glutamic Acid/WP_FT1307.png)

The retention time for all 3 of them is about 183 seconds.

We also perform the comparison against reference spectra from MassBank and find
similar results.

```{r mix01-water-pos-l-glutamic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```


```{r mix01-water-pos-l-glutamic-acid-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2, std_mbank, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

We also perform the comparison using the neutral loss version of the spectra.

```{r mix01-water-pos-l-glutamic-acid-ms2-hmdb_nl, echo = FALSE, fig.width = 7, fig.height = 7}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

For HMDB in addition to the previous matches we find FT1583 and FT1307 but the
associated spectra match with lower similarity the reference ones.

```{r mix01-water-pos-l-glutamic-acid-mirror-hmdb_nl, echo = FALSE, fig.cap = "Mirror plots", eval = FALSE}
tmp_res <- plot_select_ms2(std_ms2_nl, std_hmdb_nl, 0.7, ppm = csp_nl@ppm,
                           tolerance = csp_nl@tolerance)
```

```{r mix01-water-pos-l-glutamic-acid-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```
We obtain similar results for MassBank.

```{r mix01-water-pos-l-glutamic-acid-mirror-mbank_nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2_nl, std_mbank_nl, 0.8,
                           ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

MS2 spectra associated to feature FT0693, FT1018 have been matched to reference
spectra from L-Glutamic Acid but also from other compounds with relatively high
scores in both cases.

Again, we have MS2 spectra for two different ions of the same compound. Below we
compare thus the neutral loss versions of all spectra to see if they match.

```{r mix01-water-pos-l-glutamic-acid_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_ms2_nl, csp_nl)
```


#### Summary

- FT1018 (RT=183.8, `[M+H]+` ion): confidence level **B**. Its MS2 spectrum
  (F07.S0508) matches `r std`, but also other compounds.
- FT0693 (RT=182.6, `[M+H-H2O]+`] ion): confidence level **B**. Its MS2 spectrum
  (F08.S0464) matches `r std`, but also other compounds.
- FT1307 (RT=182.3, `[M+Na]+` ion): confidence level **B-**.
- FT0730 (RT=182.6, `[M+H-NH3]+` ion): confidence level **B-**.
- FT1583 (RT=182.3, `[M+2Na-H]+` ion): has a similar EIC, but it's 2 MS2 spectra
  don't match any reference. Confidence level **B-**?
- Retention time seems to be concentration dependent.
- Reference MS2: `[M+H]+`: F07.S0508, F07.S0619, F08.S0622; high
  confidence. `[M+H-H2O]+` (FT0693): F08.S0464; F07.S0468; high
  confidence. `[M+Na]+` (FT1307): F07.S0470, F08.S0466; low
  confidence. `[M+2Na-H]+` (FT1583): F07.S0472, F08.S0467; low confidence.


### Myo-Inositol

```{r, echo = FALSE}
std <- "Myo-Inositol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from 6 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-pos-myo-inositol-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We have thus MS2 spectra for each set of features. Next we compare them against
the reference spectra for `r std` from HMDB. The results are shown in the
heatmap below.

```{r mix01-water-pos-myo-inositol-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for myo-inositol from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectrum for FT1450 have a high similarity against some MS2 spectra from
`r std`. Mirror plots for the best matching spectra are shown below.

```{r mix01-water-pos-myo-inositol-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.6, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix01-water-pos-myo-inositol-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

None of the extracted spectra matches reference spectra of `r std` from
MassBank. We also check if there are matches between neutral loss spectra.

```{r mix01-water-pos-myo-inositol-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-water-pos-myo-inositol-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```


#### Summary

- FT1450 (RT=193.8, `[M+H]+` ion): confidence level **B**.
- FT1989 (RT=194.1, `[M+2Na-H]+` ion): confidence level **B-**.
- FT1733 (RT=194.2, `[M+Na]+` ion: confidence level **B-**.
- FT1256 (RT=194.4, `[M+H-H20]+` ion: confidence level **B-**.
- FT1646 (RT=193.8, `[M+NH4]+` ion): MS2 spectra match another compound, ppm is
  large and EIC looks different.
- Reference MS2: `[M+H]+`: F08.S0532; high confidence. `[M+Na]+` (FT1733):
  F07.S0541, F08.S0535; low confidence.


### Pyruvic Acid

```{r, echo = FALSE}
std <- "Pyruvic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We have quite some features matching with their m/z to potential adducts of `r
std`, but they have quite different retention times.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

We next look if there are MS2 spectra associated to this feature but we don't
find any.

```{r mix01-water-pos-pyruvic-acid-ms2, fig.cap = "MS2 spectra for features matched to pyruvic-acid", echo = FALSE}
plot_spectra(std_ms2)
```


#### Summary

- Inconclusive.
- Seems we can not detect `r std` in the present samples.


### Suberic Acid

```{r, echo = FALSE}
std <- "Suberic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-pos-suberic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We have thus MS2 spectra for features around 37 and 140. Next we compare them
against the reference spectra for `r std` from HMDB. The results are shown in
the heatmap below.

```{r mix01-water-pos-suberic-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for suberic acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix01-water-pos-suberic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Strangely every match has score equal to 0 in both cases. In addition we
also look for matches between neutral loss spectra.

```{r mix01-water-pos-suberic-acid-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-water-pos-suberic-acid-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```
We find that the spectrum F07.S0095 from FT1633 matches with low similarity
reference spectra of `r std` from MassBank.

```{r mix01-water-pos-suberic-acid-mirror-hmdb_nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2_nl, std_mbank_nl, 0.1, ppm = csp_nl@ppm,
                           tolerance = csp_nl@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```


#### Summary

- FT1375 (RT=37.32, `[M+H]+` ion), FT1633 (RT=37.38, `[M+Na]+` ion), FT1585
  (RT=37.25, `[M+NH4]+` ion) and FT1831 (RT=37.17, `[M+K]+` ion) all with
  confidence **D+**: the other features have either high ppm or low signal (in
  EIC). We can not give a higher confidence level because the MS2 spectrum for
  the `[M+Na]+` ion does not match a reference spectrum. The neutral loss
  spectrum has however some similarity with a reference spectrum. This is why we
  assign the **+** to the **D** confidence.
- Reference MS2: `[M+Na]+`: F07.S0095; low confidence.


### Xanthine

```{r, echo = FALSE}
std <- "Xanthine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from a single compound.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-pos-xanthine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We have thus MS2 spectra for the set of features with retention time around 140.
Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-water-pos-xanthine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for xanthine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra for FT1102 have the highest similarity against MS2 spectra from
`r std`. Mirror plots for the best matching spectra are shown below.

```{r mix01-water-pos-xanthine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```
We repeat the comparison using MassBank reference spectra and we obtain similar
results as shown below.

```{r mix01-water-pos-xanthine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```
```{r mix01-water-pos-xanthine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

We also check if there are matches between neutral loss spectra.

```{r mix01-water-pos-xanthine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-water-pos-xanthine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```


#### Summary

- FT1102 (RT=140.3, `[M+H]+` ion): confidence level **B** (matches also
  oxypurinol, although that's very unlikely to be present in the sample).
- FT1372 (RT=140.9, `[M+Na]+` ion): confidence level **B-**.
- FT1567 (RT=140.1, `[M+K]+` ion): confidence level **B-**.
- FT2055 (RT=139.8, `[M+2K-H]+` ion): confidence level **B-**.
- FT1630 (RT=141.2, `[M+2Na-H]+` ion): confidence level **B-**.
- Reference MS2: `[M+H]+` (FT1102): F07.S0315 and F08.S0290; high
  confidence. `[M+Na]+` (FT1372): F08.S0294; low confidence. `[M+K]+` (FT1567):
  F07.S0320, F08.S0296); low confidence. `[M+2K-H]+` (FT2055): F08.S0300; low
  confidence. `[M+2Na-H]+` (FT1630): F08.S0297.
  


### propionic acid

```{r, echo = FALSE}
std <- "propionic acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

The signal is very low and no big difference between high and low concentration
can be observed.

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

No MS2 spectra were found.


#### Summary

- FT1057 (RT=39.54, `[M+2K-H]+` ion): confidence level **D**. Signal is however
  very low.


### Uric acid

```{r, echo = FALSE}
std <- "Uric acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from a single compound.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WP", std_ms2)
```

Signal is only very low for all of the features. And also no MS2 spectra were
found.


```{r echo = FALSE}
std_ms2 <- extract_ms2(data, rownames(tmp))
```


#### Summary

- Inconclusive. Very low signal.


# Water, negative polarity

We now perform the analysis on the samples with the standards still solved in
pure water but acquired in negative polarity mode.

```{r}
POLARITY <- "NEG"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_neg
hmdb_nl <- hmdb_neg_nl
```

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```


## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-neg}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution01)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards with matching features

### 3-Phosphoglyceric Acid

```{r, echo = FALSE}
std <- "3-Phosphoglyceric Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Only two features has been assigned to this standard based on m/z matching.
Based on their retention times, these seem however to represent
ions from two different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```

Next we extract the MS2 spectra for all features, clean and plot them.

```{r mix01-water-neg-3-phosphoglyceric-acid-ms2, fig.cap = "MS2 spectra for features matched to 3-Phosphoglyceric Acid.", echo = FALSE}
plot_spectra(std_ms2)
```

The MS2 spectra seem to belong to the first set of features with a retention
time of about 240.

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB.

```{r mix01-water-neg-3-phosphoglyceric-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for 3-Phoshoglyceric Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra for FT0577 match some spectra from 3-Phosphoglyceric Acid with
high score.

These are shown in the mirror plots below.

```{r mix01-water-neg-3-phosphoglyceric-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition, we perform also the match against reference spectra of `r std`
from MassBank.

```{r mix01-water-neg-3-phosphoglyceric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Surprisingly no spectrum matches MassBank.

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB or MassBank identifying reference spectra with a similarity
larger than 0.7. This is to ensure that no reference spectra from any other
compound would match the extracted spectra for this feature with a higher
similarity.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT0557 (RT=247.4, `[M-H]-` ion): confidence level **B**.
- Reference MS2: `[M-H]-` ion: F15.S0708; high confidence.


### Acetylhistidine

```{r, echo = FALSE}
std <- "Acetylhistidine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```

```{r mix01-water-neg-acetylhistidine-ms2, fig.cap = "MS2 spectra for features matched to acetylhistidine.", echo = FALSE}
plot_spectra(std_ms2)
```

We have thus MS2 spectra for features with retention time around 180 and 194.
Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-water-neg-acetylhistidine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for Acetylhistidine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra for both features FT0620 and FT0623 have a quite high similarity
against MS2 some spectra from `r std`. Mirror plots for the best matching
spectra are shown below.

```{r mix01-water-neg-acetylhistidine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition, we perform also the match against reference spectra of `r std`
from MassBank.

```{r mix01-water-neg-acetylhistidine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Surprisingly no spectrum matches MassBank. In addition we match (**all**) the
MS2 spectra for the matched features against all spectra from HMDB or MassBank
identifying reference spectra with a similarity larger than 0.7. The results
(if any spectra matched) are shown in the two following tables.
In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

Both features FT0620 and FT0623 are matched also carnosine, but with a
difference in their precursor m/z values.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0620 (RT=180.9, `[M-H]-` ion): confidence level **A**.
- FT0623 (RT=193.9, `[M-H]-` ion): confidence level **B**. We will not consider
  this feature/retention time. Also in positive polarity there is the same
  situation, but it seems (also looking at other ions for this compound) that
  the second (this) feature might represent some signal coming from a column
  overload (?).
- Reference MS2: `[M-H]-`: (FT0620) F15.S0417, F16.S0409; high confidence.


### Betaine

```{r, echo = FALSE}
std <- "Betaine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from the same compound.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

- FT0323 (RT=162.7, `[M+Cl]-` ion): confidence level **D**.
- FT0386 (RT=162.7, `[M+HCOO]-` ion): confidence level **D**.


### CDP

```{r, echo = FALSE}
std <- "CDP"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these. EICs
look rather noisy and large retention time shifts between the samples are
visible.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```

```{r mix01-water-neg-cdp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We have thus several MS2 spectra, mostly for the features with retention time of
about 240 seconds.

```{r mix01-water-neg-cdp-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for CDP from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra F15.S0683, F15.S0730, F16.S0627 and F16.S0674 all match
reference spectra for `r std`. Mirror plots for the best matching
spectra are shown below.

```{r mix01-water-neg-cdp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition, we perform also the match against reference spectra of `r std`
from MassBank and we obtain similar results.

```{r mix01-water-neg-cdp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

All MS2 spectra match thus nicely to `r std`.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT2131 (RT=235.2, `[M-H]-` ion): confidence **A**. This feature is the same as
  FT2135, which was however found only in the MS/MS data.
- Reference MS2: `[M-H]-` (FT2131) F16.S0627, F16.S0674, F15.S0683, F15.S0730;
  high confidence.


### Creatine

```{r, echo = FALSE}
std <- "Creatine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from 2 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```

We haven't found any MS2 spectra for the features features matched to `r std`.

#### Summary

- FT0180 (RT=176.7, `[M-H]-` ion): confidence level **D**.


### Dimethylglycine

```{r, echo = FALSE}
std <- "Dimethylglycine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the only feature matched to `r std` and show it below.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Unfortunately no MS2 spectra associated to FT0052 is available.

#### Summary

- FT0052 (RT=181.6, `[M-H]-` ion): confidence level **D**.


### Glycerol

```{r, echo = FALSE}
std <- "Glycerol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Also for `r std` we have only one match. We next plot the and show the EIC
of the realted feature.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```


#### Summary

- very low signal. Seems nothing properly detected.


### L-Glutamic Acid

```{r, echo = FALSE}
std <- "L-Glutamic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from 3 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```

Note: FT0269 and FT0270 are actually the same signal, FT0270 contains the peaks
in low concentration, FT0269 those in high concentration. We should thus focus
on FT0269.

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-neg-l-glutamic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-water-neg-l-glutamic-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for L-Glutamic Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra for FT0269 and even more so for FT0270 have quite high
similarity against some MS2 spectra from `r std`. Mirror plots for the best
matching spectra (similarity higher than 0.8) are shown below.

```{r mix01-water-neg-l-glutamic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.8,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition, we perform also the match against reference spectra of `r std`
from MassBank obtaining similar results.

```{r mix01-water-neg-l-glutamic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT0269 and FT0270 both represent the same compound, but retention times
  shifted for low and high concentration (RT=180, `[M-H]-` ion): confidence
  level **B**.
- Reference MS2: `[M-H]-` (FT0269): F15.S0493, F15.S0436, F16.S0428; high
  confidence.


### Myo-Inositol

```{r, echo = FALSE}
std <- "Myo-Inositol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from 6 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-neg-myo-inositol-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We have thus MS2 spectra for features with an RT of 194. Next we compare them against
the reference spectra for `r std` from HMDB. The results are shown in the
heatmap below.

```{r mix01-water-neg-myo-inositol-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for myo-inositol from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra for FT0813 have a high similarity against some MS2 spectra from
`r std`. Mirror plots for the best matching spectra are shown below.

```{r mix01-water-neg-myo-inositol-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

```{r mix01-water-neg-myo-inositol-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Strangely, no match is found against MassBank.  Since some features associated
to the available spectra were matched ion (`[M+HCOO]-`) different
from `[M-H]-` for completeness we also look at neutral loss spectra (although
the only spectrum that wasn't matching with high similarity was associated to
`[M-H]-`).

```{r mix01-water-neg-myo-inositol-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

Strangely, using the neutral loss comparison matches for FT0813 are no longer
found (at least not with good similarity).

```{r mix01-water-neg-myo-inositol-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0813 (RT=193.9, `[M+HCOO]-` ion): confidence level **A**.
- FT0499 (RT=193.7, `[M-H]-` ion): confidence level **A**.
- Reference MS2: `[M-H]-` (FT0499): F15.S0496, F16.S0477; high
  confidence. `[M+HCOO]-` (FT0813): F15.S0498, F16.S0480; high confidence.


### Pyruvic Acid


```{r, echo = FALSE}
std <- "Pyruvic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from 2 different compounds.

Again, we show a representative EIC for both *feature groups* (ordered by
retention time).

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```

We next look if there are MS2 spectra associated to the above features.

```{r mix01-water-neg-pyruvic-acid-ms2, fig.cap = "MS2 spectra for features matched to pyruvic-acid", echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown below.

```{r mix01-water-neg-pyruvic-acid-ms2-hmdb-heatmap, echo = TRUE}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- compareSpectra(std_ms2, hmdb, ppm = 40, SIMPLIFY = FALSE)
sim
```

```{r mix01-water-neg-pyruvic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Thus, the MS2 spectrum for FT0023 does not match any reference spectra for 
`r std` from HMDB or MassBank.

In addition we match (**all**) the MS2 spectra for the
matched features against all spectra from HMDB or MassBank identifying
reference spectra with a similarity larger than 0.7. The results (if any
spectra matched) are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

No match involving `r std` was found but similarity with MS2 spectra for
Ascorbic acid are high.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT0023 (RT=41.91, `[M-H]-` ion): confidence level **D**.
- FT0205 (RT=41.15, `[M+HCOO]-` ion): confidence level **D-** or inherit from
  above?
- Reference MS2: `[M-H]-` (FT0023): F16.S0125; low confidence.


### Suberic Acid

```{r, echo = FALSE}
std <- "Suberic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from 3(or 4?) different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-neg-suberic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We have thus MS2 spectra for features around 37 and 140. Next we compare them
against the reference spectra for `r std` from HMDB. The results are shown in
the heatmap below.

```{r mix01-water-neg-suberic-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for suberic acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectrum F15.S0115 (for feature FT0428) has the highest similarity
against MS2 spectra from `r std`. Mirror plots for the best matching spectra are
shown below.

```{r mix01-water-neg-suberic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                           ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```
We obtain similar results by matching against MassBank.

```{r mix01-water-neg-suberic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix01-water-neg-suberic-acid-mirror-massbank-nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                           ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
std_ms2_sel <- Spectra()
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0428 (RT=38.11, `[M-H]-` ion): confidence level **A**
- FT0782 (RT=37.7, `[M+HCOO]-`): confidence level **A-**.
- Reference MS2: `[M-H]-` (FT0428): F15.S0115, F16.S0120; high confidence.


### Uric acid

```{r, echo = FALSE}
std <- "Uric acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We show the EICs for the features above.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```

We next look if there are MS2 spectra associated to the above features.

```{r mix01-water-neg-uric-acid-ms2, fig.cap = "MS2 spectra for features matched to pyruvic-acid", echo = FALSE}
plot_spectra(std_ms2)
```


#### Summary

- FT0397 (RT=176.2, `[M-H]-` ion): confidence level **D** or drop it because of
  low signal?


### Xanthine

```{r, echo = FALSE}
std <- "Xanthine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from 3 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-water-neg-xanthine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We thus have 2 spectra for the feature with a retention time for about 140
seconds.

```{r mix01-water-neg-xanthine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Both spectra nicely match some reference spectra for Xanthine from HMDB. Mirror
plots for the best matching spectra are shown below.

```{r mix01-water-neg-xanthine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

```{r mix01-water-neg-xanthine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Again we find good matches and we show their mirror plots below.

```{r mix01-water-neg-xanthine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

The spectra match to Xanthine and some other (related) compounds.

#### Summary

- FT0315 (RT=140.6, `[M-H]-` ion): confidence level **B**.
- FT-633 (RT=140.4, `[M+HCOO]-` ion): confidence level **B-**.
- Reference MS2: `[M-H]-` (FT0315): F15.S0299, F16.S0305; high confidence.


## Standards without any matching feature

### C3 Carnitine
### propionic acid



# Changelog

- Version 0.10.0:
  - Reconsider matches and include neutral loss spectra searches.
- Version 0.9.0:
  - Use `ppm = 20` to select MS2 spectra for features.
  - Add adducts `[M+2Na-H]+` and `[M+2K-H]+`.

# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```

