---
title: "Standards: Matrix effect in RT"
author: "Mar Garcia-Aloy"
output: 
  BiocStyle::html_document:
    toc: true
    number_sections: false
    toc_float: true
---

In this document I'm going to check the matrix effect in retention times 
(RT) of (internal) standards (IS / STD).  
The data used is from the experiment done by Vinicius Veri 
on November-2019 for ISs and on January-2020 for STDs (MIXs). 
For IS, sample names are stored in the file `data/is_serum_files.txt` and experiment 
description in the file `2019_11_18_IS_Experiment Summary.docx`; 
whereas for STDs, sample names are in the file `data/std_serum_files.txt` 
and experiment description in the file `2019_01_13_Experiment Plan_All Mixes.xlsx`.    

# Experiment description
Three replicates of the following samples were injected in the same 
order as they are named in the list below:  
  
- **`Low_IS`**: IS solution used for the untargeted protocol.     
- **`High_IS`**: IS solution x10 more concentrated.  
- **`QC`**: QC samples (serum) without IS.  
- **`QC_Low_IS`**: QC samples (serum) with IS concentrations of untargeted protocol.  
- **`QC_High_IS`**: QC samples (serum) with IS x10 more concentrated.  

This scheme is for the IS. The same was done for each of the MIXs.  

# Preliminaries
## Parameters
```{r}
polarity <- "POS" # specify "POS" or "NEG"
study <- "MIX"    # specify "IS" or "MIX"
mix.n <- 2        # if study == MIX, specify which MIX number
da <- 0.01
MZML_PATH <- "C:/Users/mgarciaaloy/Documents/mzML/"
dir.create(paste0("images/", tolower(study), "_serum"), 
           recursive = TRUE, showWarnings = FALSE)
startpoint <- Sys.time()
```

## Libraries
```{r, message=FALSE, warning=FALSE}
library(Rdisop)
library(CompoundDb)
library(RColorBrewer)
library(xcms)
cwp <- CentWaveParam(
  peakwidth = c(2, 20), 
  ppm = 30, 
  snthresh = 4,
  integrate = 2)
```

# Data import
## Standards
```{r}
if(study == "IS"){
  std_info <- read.table(
    "https://raw.githubusercontent.com/EuracBiomedicalResearch/lcms-standards/master/data/internal_standards.txt",
    sep = "\t", header = TRUE, as.is = TRUE)
} else if(study == "MIX"){
  std_info <- read.table(
    "https://raw.githubusercontent.com/EuracBiomedicalResearch/lcms-standards/master/data/standards_dilution.txt",
    sep = "\t", header = TRUE, as.is = TRUE)
}

std_info <- std_info[!is.na(std_info[, grep(polarity, 
                                            colnames(std_info))]),]
if(study == "MIX"){
  std_info <- std_info[std_info$mix == mix.n, ]
}
for(i in seq(nrow(std_info))){
  if(grepl("C", std_info$formula[i])){std_info$mzneut[i] = 
    getMolecule(as.character(std_info$formula[i]))$exactmass}else{
      std_info$mzneut[i] = as.numeric(std_info$formula[i])}
}
```

## Experiment
```{r}
if(study == "IS"){
  injections <- read.table(paste0(gsub("std_serum", "", getwd()), 
                                  "data/is_serum_files.txt"), 
                           sep = "\t", header = TRUE, as.is = TRUE)
} else if(study == "MIX"){
  injections <- read.table(paste0(gsub("std_serum", "", getwd()), 
                                  "data/std_serum_files.txt"), 
                           sep = "\t", header = TRUE, as.is = TRUE)
}

injections <- injections[injections$polarity == polarity, ]
if(study == "MIX"){
  injections <- injections[injections$mode == "FS", ]
  inj_blankQC <- injections[injections$type == "Blank_QC", ]
  inj_blankQC <- inj_blankQC[grep("QC_5", injections$mzML), ]
  inj_blankQC$class <- "QC"
  injections <- injections[grep("Mix", injections$mzML), ]
  injections <- injections[as.numeric(gsub("Mix", "", injections$type)) == mix.n, ]
  injections <- rbind(inj_blankQC, injections)
}
myfiles <- paste(injections$folder, injections$mzML, sep = "/") 
```

## Colouring factors
```{r}
if(study == "IS"){
  injections$class <- 
    factor(injections$class, 
           levels = c("LowIS", "HighIS", "QC", "QC_LowIS", "QC_HighIS"))
} else if(study == "MIX"){
  injections$class <- gsub(paste0(injections$type[10], "_"), "", injections$class)
  injections$class <- factor(injections$class, 
           levels = c("Water_Low", "Water_High", "QC", "QC_Low", "QC_High"))
}

col_class <- brewer.pal(6, "Paired")
col_class <- col_class[-4]
names(col_class) <- levels(injections$class)
```

# Output
```{r}
data_raw <- readMSData(paste0(MZML_PATH, myfiles), 
                   pdata = new("NAnnotatedDataFrame", injections),
                   mode = "onDisk")

for(i in 1:(nrow(std_info))){
  mzvalue <- 
    unlist(mass2mz(std_info$mzneut[i], 
                   adduct = as.character(
                     std_info[i, grep(polarity, colnames(std_info))])))
  
  chr = chromatogram(data_raw, 
                     mz = c(mzvalue - da,  mzvalue + da),
                     aggregationFun = "max")
  
  cmpname <- tolower(gsub(" .*", "", std_info$name[i]))
  cmpname <- gsub("l-", "", cmpname)
  if((substr(cmpname, 1, 1) %in% (seq(9))) & 
     (substr(cmpname, 3, 3) %in% letters)){
    cmpname <- paste(gsub("*.-", "", cmpname), 
                     gsub("-.*", "", cmpname), sep = "_")
  } else if((substr(cmpname, 1, 1) %in% (seq(9))) & 
            (substr(cmpname, 3, 3) %in% seq(9))){
    cmpname <- paste(gsub(".*-", "", cmpname), 
                     gsub(",", "_", gsub("-.*", "", cmpname)), 
                     sep = "_")
  }
  cmpname <- gsub("-", "_", cmpname)
  
  filename <- paste0("images/", tolower(study), "_serum/", 
                     cmpname, "_", polarity, ".png")
  
  png(file = filename, width = 1000, height = 500)
  par(mfrow = c(1, 2))
  
  plot(chr, main = cmpname,
      col = col_class[chr$class],
       bg = "white")
  legend("topright", legend = names(col_class), 
         pch = 16, col = gsub("60", "", col_class))
  abline(v = std_info$RT[i], lty = 2)
  
  chr2 <- findChromPeaks(chr, param = cwp)
  delta_rt <- abs(chromPeaks(chr2)[, "rt"] - std_info$RT[i])
  pks <- data.frame(chromPeaks(chr2)[delta_rt < 60, , drop=FALSE])
  if (nrow(pks)) {
    pks2 <- pks[0, ]
    for(j in levels(factor(pks$column))
        #seq(length(levels(factor(pks$column))))
        ){
      pks3 <- pks[pks$column == j, ]
      pks2 <- rbind(pks2, pks3[which.max(pks3$maxo),])
    }
    pks2 <- pks2[pks2$column < 7 | pks2$column > 9, ]
    rtmin <- min(pks2$rtmin)
    rtmax <- max(pks2$rtmax)
    ylim <- c(0, max(pks$maxo, na.rm = TRUE))
    } else {
      rtmin <- std_info$RT[i] - 10
      rtmax <- std_info$RT[i] + 10
      ylim <- c(0, max(sapply(chr, intensity), na.rm = TRUE))
    }
  
  plot(chr, 
       col = col_class[chr$class],
       bg = "white",
       xlim = c(rtmin, rtmax))
  legend("topright", legend = names(col_class), 
         pch = 16, col = gsub("60", "", col_class))
  abline(v = std_info$RT[i], lty = 2)
  
  dev.off()
  rm(chr, chr2)
}
```

# Session information
```{r}
Sys.time()-startpoint

devtools::session_info()
```
