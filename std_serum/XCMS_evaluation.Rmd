---
title: "Internal Standards: Matrix effect - Evaluation XCMS"
author: "Mar Garcia-Aloy"
output: 
  BiocStyle::html_document:
    toc: true
    number_sections: false
    toc_float: true
---

```{r include = FALSE}
knitr::opts_chunk$set(echo=TRUE)

startpoint <- Sys.time()
```

In this document I'm going to check the quality of the data obtained 
after processing raw files with XCMS. For that I'm going to focus first 
of all to the 20 IS and later also to the 200 STDs. Different things to 
look for are to check if there is only 1 detected peak per compound 
(peak detection step), as well as, 1 feature per compound 
(correspondance step). I'll check that separately for ISs and for 
QC-serum samples. The group of samples that are going to be used is 
specified in the parameter "study" (in section "preliminaries" - "parameters").

# Preliminaries
I define the specific parameters for the current study, I load all 
required libraries, and I set up the parallel processing.

## Parameters
```{r, echo=TRUE}
polarity <- "POS" # specify "POS" or "NEG"
study <- "IS"     # specify "IS" or "QC"
mz.d <- 0.01
rt.d <- 10
dir.create(paste0("images/", study, "/", polarity, "/XCMS_eval"), 
                  recursive = TRUE, showWarnings = FALSE)
```

## Libraries
```{r, message=FALSE, warning=FALSE}
library(doParallel)
library(xcms)
library(RColorBrewer)
library(Rdisop)
library(CompoundDb)
```

## Parallel processing
```{r}
ncores <- detectCores()-1
registerDoParallel(ncores)
register(DoparParam(), default = TRUE)
```

## Data import
```{r}
load(paste0("XCMS_proccessing_", study, "_", polarity, ".Rdata"))
```

## Colouring factors
Also, I define colors to be used for the various experimental groups 
throughout the experiment.
```{r}
xdata$class <- factor(xdata$class)
if(length(levels(xdata$class)) < 3){
  col_class <- brewer.pal(3, "Set1")
  col_class <- col_class[1:length(levels(xdata$class))]}else{
  col_class <- brewer.pal(length(levels(xdata$class)), "Set1")
  }
names(col_class) <- levels(xdata$class)
plot(NULL ,xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("topleft", legend = names(col_class),
       col = col_class, pch = 16, pt.cex=3, cex=1.5, bty='n')
mtext("Class", at=0.2, cex=2)
```

## Standards library
### Import
```{r}
std_info <- read.table(
    "https://raw.githubusercontent.com/EuracBiomedicalResearch/lcms-standards/master/data/internal_standards.txt",
    sep = "\t", header = TRUE, as.is = TRUE)
```

### Quality
```{r, eval=FALSE}
std_info$quality <- c(NA,      # succinic
                      "2P",    # creatinine   
                      "2P",    # glucose      
                      "OK",    # carnitine
                      "2P",    # alanine
                      "2P",    # arginine
                      "OK",    # aspartic
                      "OK",    # cysteine
                      "2P",    # glutamic
                      "2P",    # glycine      
                      "OK",    # histidine
                      NA,      # isoleucine
                      "2P",    # leucine
                      "OK",    # lysine
                      "OK",    # methionine    
                      "OK",    # phenylalanine
                      "OK",    # proline
                      "OK",    # serine        
                      "OK",    # threonine
                      "2P",    # tyrosine
                      "OK"     # valine
                      )
```

### Additional formating
```{r}
std_info <- std_info[!is.na(std_info[, grep(polarity, 
                                            colnames(std_info))]),]
std_info <- std_info[!grepl("Isoleucine", std_info$name),]
rownames(std_info) <- seq(nrow(std_info))

std_info$mzneut = NA
std_info$mz <- NA
for(i in seq(nrow(std_info))){
  if(grepl("C", std_info$formula[i])){std_info$mzneut[i] = 
    getMolecule(as.character(std_info$formula[i]))$exactmass}else{
      std_info$mzneut[i] = as.numeric(std_info$formula[i])}
  std_info$mz[i] <- unlist(
        mass2mz(std_info$mzneut[i],
                adduct = as.character(
                    std_info[i, grep(polarity, colnames(std_info))])))
}
```

# Workflow
```{r}
dim(featureValues(xdata))

for(i in seq(nrow(std_info))){ # for each IS do the following:
  
  mz.i <- std_info$mz[i]
  rt.i <- std_info$RT[i]
  cmpname <- tolower(gsub(" .*", "", std_info$name[i]))
  cmpname <- gsub("l-", "", cmpname)
  
  # PEAK DETECTION
  chr <- chromatogram(xdata, mz = c((mz.i - mz.d), (mz.i + mz.d)),
                      aggregationFun = "max")
  if(nrow(featureDefinitions(chr)) == 1){
    ft <- rownames(featureDefinitions(chr))
  } else if (nrow(featureDefinitions(chr)) > 1){
    ft <- rownames(featureDefinitions(chr))[
      which.max(rowMeans(featureValues(chr, value = "into"), 
                         na.rm = TRUE))]
  }
  ft_chr <- featureChromatograms(xdata, features = ft)
  
  filename <- paste0("images/", study, "/", polarity, "/XCMS_eval/", 
                     #std_info$quality[i], "_", 
                     cmpname, "_FT.png")
  png(file = filename, width = 1000, height = 500)
  par(mfrow = c(1,2))
  plot(ft_chr, col = "#00000040", 
     peakCol = col_class[xdata$class[chromPeaks(ft_chr)[, "column"]]],
     peakBg = 
       paste0(col_class[xdata$class[chromPeaks(ft_chr)[, "column"]]],
              "10"))
  plot(ft_chr, col = "#00000040", 
       peakCol = col_class[xdata$class[chromPeaks(ft_chr)[, "column"]]],
       peakBg = paste0(col_class[
         xdata$class[chromPeaks(ft_chr)[, "column"]]], "10"))
  xcms:::.add_chromatogram_peaks(
    ft_chr, chromPeaks(ft_chr),
    col = col_class[xdata$class[chromPeaks(ft_chr)[, "column"]]],
    bg = NA,
    type = "rectangle")
  dev.off()
  
  # CORRESPONDANCE
  filename <- paste0("images/", study, "/", polarity, "/XCMS_eval/", 
                     #std_info$quality[i], "_", 
                     cmpname, "_GR.png")
  png(file = filename, width = 1000, height = 500)
  plotChromPeakDensity(
    chr, pdp2, 
    peakCol = col_class[xdata$class[chromPeaks(chr)[, "column"]]],
    peakBg = paste0(col_class[
      xdata$class[chromPeaks(chr)[, "column"]]], "10"))
  dev.off()
  
  chr2 <- chromatogram(raw_data, mz = c((mz.i - mz.d), (mz.i + mz.d)),
                      aggregationFun = "max")
  chr2 <- findChromPeaks(chr2, param = cwp)
  delta_rt <- abs(chromPeaks(chr2)[, "rt"] - rt.i)
  pks <- data.frame(chromPeaks(chr2)[delta_rt < 60, , drop=FALSE])
  if (nrow(pks)) {
    pks2 <- pks[0, ]
    for(j in seq(length(levels(factor(pks$column))))){
      pks3 <- pks[pks$column == j, ]
      pks2 <- rbind(pks2, pks3[which.max(pks3$maxo),])
    }
    #pks2 <- pks2[pks2$column > 3, ]
    rtmin <- min(pks2$rtmin) - 5
    rtmax <- max(pks2$rtmax) + 5
    ylim <- c(0, max(pks$maxo, na.rm = TRUE))
    } else {
      rtmin <- std_info$RT[i] - 5
      rtmax <- std_info$RT[i] + 5
      ylim <- c(0, max(sapply(chr, intensity), na.rm = TRUE))
    }
  chr2 <- chromatogram(xdata, mz = c((mz.i - mz.d), (mz.i + mz.d)),
                       rt = c((rt.i - rt.d), (rt.i + rt.d)),
                      aggregationFun = "max")
  filename <- paste0("images/", study, "/", polarity, "/XCMS_eval/", 
                     #std_info$quality[i], "_", 
                     cmpname, "_GR_zoom.png")
  png(file = filename, width = 1000, height = 500)
  plotChromPeakDensity(
    chr2, pdp2, 
    peakCol = col_class[xdata$class[chromPeaks(chr2)[, "column"]]],
    peakBg = paste0(col_class[
      xdata$class[chromPeaks(chr2)[, "column"]]], "10"))
  dev.off()
}
```

# Session information
```{r}
Sys.time()-startpoint

devtools::session_info()
```

