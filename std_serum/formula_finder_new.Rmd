---
title: "Formula finder"
author: "Mar Garcia-Aloy"
output: 
  BiocStyle::html_document:
    toc: true
    number_sections: false
    toc_float: true
---

# Preliminaries

```{r preliminaries}
library(MetaboCoreUtils)
library(Rdisop)
library(RColorBrewer)
library(kableExtra)

load("isotopic_patterns_tables.RData")
rm(startpoint)
samples <- ls()
startpoint <- Sys.time()

source("formula_finder_functions.R")

std_info <- read.table(
  "../data/standards_dilution.txt",
  sep = "\t", header = TRUE, as.is = TRUE)
std_info <- std_info[, c("mix", "name", "abbreviation", "formula",
                         "POS", "NEG", "quality_POS", "quality_NEG")]
idx <- which(std_info$name == "3-Hydroxy-DL-kynurenine" & 
               std_info$mix == 17)
std_info <- std_info[-idx, ]
std_info <- std_info[-which(std_info$name == "Eplerone"), ]
idx <- which(std_info$name == "Glycerophospho-inositol")
std_info <- std_info[-idx, ]
std_info$formula[std_info$abbreviation == 
                   "chlorotrifluoromethylpyrindol"] <- "C6H3NOClF3"
std_info$formula[std_info$abbreviation == 
                   "dichlorohydroxypyridine"] <- "C5H3NOCl2"
std_info$formula[std_info$abbreviation == 
                   "trichloropyrinidol"] <- "C5H2NOCl3"

std_info <- std_info[!is.na(std_info$quality_POS), ]
#std_info <- std_info[std_info$quality_POS == "0_perfect" | 
#                       std_info$quality_POS == "1_good", ]
#std_info <- std_info[std_info$quality_NEG == "0_perfect" | 
#                       std_info$quality_NEG == "1_good", ]
#std_infox <- std_info[std_info$POS == "[M+H]+" & 
#                        std_info$NEG == "[M-H]-", ]
#std_info <- std_info[!std_info$abbreviation %in% std_infox$abbreviation,]

std_info$mzneut <- NA
for(i in 1:nrow(std_info)){
  std_info$mzneut[i] <- 
    getMolecule(as.character(std_info$formula[i]))$exactmass
}
tmp <- lapply(as.character(std_info$formula), countElements)
tmp <- do.call(dplyr::bind_rows, tmp)
tmp[is.na(tmp)] <- 0
std_info <- cbind(std_info, tmp)
```


# Problematic samples

```{r}
#### Paracetamol in sample PLS3: we've seen that the real A+1 ion is 
#### 153.1060, which mz deviation is 0.028
PLS3$i2[which(PLS3$abrv == "paracetamol")] <- NA
PLS3$mz2[which(PLS3$abrv == "paracetamol")] <- NA

##### 3-Hydroxykynurenine
PLS1$i2[which(PLS1$abrv == "hydroxykynurenine_3")] <- NA
PLS1$mz2[which(PLS1$abrv == "hydroxykynurenine_3")] <- NA
PLS2$i2[which(PLS2$abrv == "hydroxykynurenine_3")] <- NA
PLS2$mz2[which(PLS2$abrv == "hydroxykynurenine_3")] <- NA
PLS3$i2[which(PLS3$abrv == "hydroxykynurenine_3")] <- NA
PLS3$mz2[which(PLS3$abrv == "hydroxykynurenine_3")] <- NA
```



# Formula finder

```{r main-code}
mysamples <- c(4:6,10:24)
for(y in 1:length(mysamples)){
  
  tmp <- get(samples[mysamples[y]])
  
  formula_finder <- matrix(nrow=nrow(std_info), ncol = 9)
  rownames(formula_finder) <- std_info$abbreviation
  colnames(formula_finder) <- c("start", "adduct", "H_rule", "H2_rule", 
                                "N_rule", "RPU_rule", 
                                "A1_filter", "A2_filter", "rank")
  add <- std_info[, c("POS", "NEG")]
  add <- add[, grep(substring(samples[mysamples[y]], 1, 1), 
                    colnames(add))]
  
  for(z in 1:nrow(std_info)){
    
    if(!is.na(tmp$mz1[z])){
      
      myadd <- add[z]
      mymzion <- tmp$mz1[z]
      mymzneut <- getmzneut(mymzion, myadd)
      
      myformok <- std_info$formula[z]
      myformion <- update_form(myformok, myadd, "add")
      
      myA1 <- (tmp$i2[z] / tmp$i1[z]) * 100
      myA2 <- (tmp$i3[z] / tmp$i1[z]) * 100
      if(tmp$i1[z] < 5e5){
        myerror_A1 <- 0.4
        myerror_A2 <- 2
      } else {
        myerror_A1 <- 1.5
        myerror_A2 <- 5
      }
      
      if(grepl("Cl", myformion)){
        myform <- getform(mzval = mymzion,
                          ppm = 15,
                          elements = "CHNOPSCl")
      } else if(grepl("Na", myformion)){
        myform <- getform(mzval = mymzion,
                          ppm = 15,
                          elements = "CHNOPSNa")
      } else {
        myform <- getform(mzval = mymzion,
                          ppm = 15,
                          elements = "CHNOPS")
      }
      formula_finder[z, "start"] <- length(myform)
      
      myform <- adduct_filter(myform, myadd)
      formula_finder[z, "adduct"] <- length(myform)
      
      myform <- update_form(H_rule(update_form(
        myform, myadd, "remove")), myadd, "add")
      formula_finder[z, "H_rule"] <- length(myform)
      myform <- update_form(H_rule2(mymzneut, update_form(
        myform, myadd, "remove")), myadd, "add")
      formula_finder[z, "H2_rule"] <- length(myform)
      if(mymzneut < 500){
        myform <- update_form(N_rule(mymzneut, update_form(
          myform, myadd, "remove")), myadd, "add")
      }
      formula_finder[z, "N_rule"] <- length(myform)
      myform <- update_form(RPU_rule(update_form(
        myform, myadd, "remove")), myadd, "add")
      formula_finder[z, "RPU_rule"] <- length(myform)
      
      if(!is.na(myA1)){
        if(tmp$i2[z] > 150){
          myform <- isotope_rule(myform, myA1, myerror_A1, 1)
        }}
      formula_finder[z, "A1_filter"] <- length(myform)
      
      if(!is.na(myA2)){
        if(tmp$i3[z] > 150){
          myform <- isotope_rule(myform, myA2, myerror_A2, 2)
        }}
      formula_finder[z, "A2_filter"] <- length(myform)
      
      myform <- rank_form(myform, i1 = myA1, i2 = myA2)
      
      if(any(myform$rank[myform$formula == myformion])){
        formula_finder[z, "rank"] <- myform$rank[myform$formula == 
                                                   myformion]
      } else {
        formula_finder[z, "rank"] <- 9999
      }
    } # end if IS NOT NA mz1
    save.image("tmp.RData")
  } # end std "z"
  assign(paste0(samples[mysamples[y]], "_formfind"), formula_finder)
} # end sample Y
```


# Table

```{r}
formula_finder <- c()
for(i in 1:length(mysamples)){
  formula_finder[[i]] <- get(paste0(samples[mysamples[i]], "_formfind"))
  names(formula_finder)[[i]] <- samples[mysamples[i]]
}

formfind <-  matrix(nrow=nrow(std_info), ncol = 9)
rownames(formfind) <- std_info$abbreviation
colnames(formfind) <- c("start", "adduct", "H_rule", "H2_rule", 
                        "N_rule", "RPU_rule", 
                        "A1_filter", "A2_filter", "rank")

for(i in 1:nrow(formfind)){
  for(j in 1:ncol(formfind)){
    tmp <- c()
    for(k in 1:length(formula_finder)){
      tmp <- c(tmp, formula_finder[[k]][i,j])
    }
    tmp <- tmp[!is.na(tmp)]
    if(is.na(tmp[1])){
      formfind[i, j] <- NA
    } else if(range(tmp)[1] == range(tmp)[2]){
      formfind[i, j] <- range(tmp)[1]
    } else if(max(tmp) == 9999){
      tmp <- tmp[tmp != 9999]
      formfind[i, j] <- paste0(range(tmp)[1], "-", range(tmp)[2], " (*)")
    }else {
      formfind[i, j] <- paste(range(tmp)[1], range(tmp)[2], sep="-")
    }
  } # close parameter "j"
} # end std "i"

formfind %>%
  kable() %>%
  kable_styling()

save.image("formfind_data.RData")
```


# Session information

```{r session}
Sys.time()-startpoint

devtools::session_info()
```
