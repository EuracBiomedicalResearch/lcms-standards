---
title: "Identifying mix02 standards in water"
author: "Andrea Vicini, Vinicius Verri Hernandes, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_float: true
    toc_depth: 3
    fig_width: 5
---

```{r, include = FALSE, cached = FALSE}
knitr::read_chunk("R/match-standards-chunks.R")
MIX <- 2
MATRIX <- "Water"
POLARITY <- "POS"
## settings to find MS2 spectra for features. Be rather inclusive here.
FEATURE_MS2_PPM <- 20
FEATURE_MS2_TOLERANCE <- 0.05
```

```{r, libraries, echo = FALSE, message = FALSE}
```
```{r, general-settings, echo = FALSE, message = FALSE}
```

**Current version: 0.10.0, 2022-05-30.**

# Introduction

Mixes of standards have been solved in water or added to human serum sample
pools in two different concentration and these samples were measured with the
LC-MS setup from Eurac (used also to generate the CHRIS untargeted metabolomics
data). Assignment of retention time and observed ion can be performed for each
standard based on MS1 information such as expected m/z but also based on the
expected difference in signal between samples with low and high concentration of
the standards. Finally, experimental fragment spectra provide the third level of
evidence. Thus, the present data set allows to annotate features to standards
based on 3 levels of evidence: expected m/z, difference in measured intensity
and MS2-based annotation.

A detailed description of the approach is given in
[match-standards-introduction.Rmd](match-standards-introduction.Rmd).


The list of standards that constitute the present sample mix are listed below
along with the expected retention time and the most abundant adduct for positive
and negative polarity as defined manually in a previous analysis by Mar
Garcia-Aloy.

```{r, standards-table, echo = FALSE, results = "asis"}
```

```{r}
iso <- data.frame(
    mix = 2,
    name = "Isobutyryl-L-carnitine",
    abbreviation = NA,
    HMDB = "HMDB0000736",
    formula = "C11H22NO4",
    POS = NA,
    NEG = NA,
    RT = 37,
    data_set = NA,
    sample = NA,
    operator = NA,
    version = NA,
    quality_POS = NA,
    quality_NEG = NA,
    exactmass = calculateMass("C11H22NO4")
)
std_dilution <- rbind(std_dilution, iso)
```

# Data import

We next load the data and split it according to matrix and polarity.

```{r, data-import}
```

We next also load the reference databases we will use to compare the
experimental MS2 spectra against. Below we thus load HMDB and MassBank data. We
create in addition *neutral loss* versions of the databases. Since HMDB does not
provide precursor m/z values we assume the fragment spectra to represent `[M+H]+`
ions (respectively `[M-H]-` ions for negative polarity) and add the m/z for
these adducts as *precursor m/z*.

```{r, load-reference-databases, message = FALSE}
```

```{r, setup-ion-db, message = FALSE, echo = FALSE}
```

# Initial evaluation of available MS2 data

Before performing the actual analysis that involves chromatographic peak
detection and evaluation of feature abundances, we compare all experimental MS2
spectra against the reference libraries. This provides already a first hint for
which standards a valid MS2 spectrum was recorded (and hence would allow
annotation based on evidence 3) and what related retention time might be.

We first extract all MS2 spectra from the respective data files and process them
by first removing all peaks with an intensity below 5% of the highest peak
signal, then scaling all intensities to a value range between 0 and 100 and
finally remove all MS2 spectra with less than 2 peaks.

```{r prepare-all-ms2}
fls <- fileNames(data_all)[data_all$polarity == "POS"]
```
```{r, all-ms2}
```

We next match these spectra against all reference spectra from HMDB for the
standards in `r MIX_NAME`. 

The settings for the matching are defined below. These will be used for all MS2
spectra similarity calculations. All matching spectra with a similarity larger
0.7 are identified.

```{r, compare-spectra-param}
```
 
Standards for which no MS2 spectrum in HMDB is present are listed in
the table below.

```{r, echo = FALSE, results = "asis"}
tmp <- std_dilution[!(std_dilution$HMDB %in% hmdb_std$compound_id), ]
pandoc.table(tmp[, c("name", "HMDB", "formula")], style = "rmarkdown",
             caption = "Standards for which no reference spectrum is available")
```

The table below lists all standards and the number of matching reference spectra
(along with their retention times).

```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We repeat the same analysis for the negative polarity data (code not shown
again).

```{r, echo = FALSE}
fls <- fileNames(data_all)[data_all$polarity == "NEG"]
```
```{r, all-ms2, echo = FALSE}
```
```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We next perform the full analysis of the data set involving MS1 and MS2 data.


# Water, positive polarity

We first perform the analysis on the samples with the standards solved in pure
water acquired in positive polarity mode.

```{r}
POLARITY <- "POS"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_pos
hmdb_nl <- hmdb_pos_nl
```

## Data pre-processing

We perform the pre-processing of our data set which consists of the
chromatographic peak detection followed by a peak refinement step to reduce peak
detection artifacts, the correspondence analysis to group peaks across samples
and finally the gap-filling to fill in missing peak data from samples in which
no chromatographic peak was detected. For details on settings please refer to
the analysis of *mix 01* samples.

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```

## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-pos}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards with matching features

While for some standards a matching feature was found we still need to evaluate
whether this matching is correct. For each standard we thus first evaluate the
EICs for all matching features, then we match their MS2 spectra (if available)
against reference libraries. To ensure correct assignment of a feature, its
retention time and eventually related MS2 spectra, we consider the following
criteria to determine the annotation confidence:

- feature(s) was/were found with m/z matching those of adduct(s) of the 
  standard.
- signal is higher for samples with higher concentration.
- MS2 spectra matches reference spectra for the standard (if available).
- MS2 spectra don't match MS2 spectra of other compounds.

### Ascorbic Acid

```{r, echo = FALSE}
std <- "Ascorbic Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EICs for the assigned features and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-ascorbic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-ascorbic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

One spectrum matches reference spectra quite well. Interestingly, the precursor
m/z don't match suggesting potentially a not well calibrated instrument?

```{r mix02-water-pos-ascorbic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

```{r mix02-water-pos-ascorbic-acid-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
std_ms2_sel <- Spectra()
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

We find some matches for extracted spectra from FT2095 and FT2096 with other
compounds than `r std` and with similarity around 0.7, the difference between
their precursor m/z values is however large.

#### Summary

- Annotation of FT1811 (RT=128, `[M+H]+` ion) to `r std` with confidence level
  **C**.
- Reference MS2: FT1811 `[M+H+]`: FT1811_F07.S0399 (high confidence),
  FT1811_F08.S0391 (low confidence).
  

### C4 Carnitine

```{r, echo = FALSE}
std <- "C4 Carnitine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-c4-carnitine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-c4-carnitine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix02-water-pos-c4-carnitine-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In both cases we don't find any match. In addition, since all the extracted
spectra are associated to ions different from `[M+H]+` we perform a neutral
loss spectra comparison.

```{r mix02-water-pos-c4-carnitine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-pos-c4-carnitine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

For the HMDB comparison we don't find matches while for the MassBank one
the neutral loss spectra cannot be computed. 

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
std_ms2_sel <- Spectra()
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

There are high similarity matches involving compounds different from `r std`. In
particular for Butyrylcarnitine also the precursor m/z difference is close to
zero.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```


#### Summary

- MS2 spectra for features FT2682 (RT=123), FT2685 (RT=167), FT2683 (RT=143),
  FT2684 (RT=37) and FT2686 (RT=44) match Butyrylcarnitine (C11H21NO4) but not
  the actual carnitine (C11H22NO4), i.e. with one H more. Note also that the
  formula used for this compound matches the one of butyrylcarnitine!
- What is however very strange is that EICs are present along the whole
  retention time range.
- Check with Vinicius: what was the actual compound used? Why was the formula
  adapted?

### Isobutyryl-L-carnitine


```{r, echo = FALSE}
std <- "Isobutyryl-L-carnitine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-isobutyryl-l-carnitine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```


#### Summary

- The signal for the `[M+H]+` ion for Isobutyryl-L-carnitine (with the formula
  provided by HMDB!) is much higher than the one for C4 Carnitine. Still, no MS2
  spectra are available for this feature.
  

### Fructose

```{r, echo = FALSE}
std <- "Fructose"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-fructose-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-fructose-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix02-water-pos-fructose-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In both cases we don't find any match. In addition, since all the extracted
spectra are associated to ions different from `[M+H]+` we perform a neutral
loss spectra comparison.

```{r mix02-water-pos-fructose-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-pos-fructose-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2_nl, std_hmdb_nl, 0.05,
                           ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

We have a match for one peak.

```{r mix02-water-pos-fructose-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

For the HMDB comparison we don't find good matches while for the MassBank one
the neutral loss spectra cannot be computed. 

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
std_ms2_sel <- Spectra()
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- Inconclusive.
- From the EICs it looks like the signal is measured around 150-160 seconds. But
  these match to `[M+Na]+` ions and the related MS2 spectra don't match
  `r std`.
- We could assign the features with confidence **D** and the MS2 spectra with
  low confidence.
  

### Glycine

```{r, echo = FALSE}
std <- "Glycine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

One single feature has been assigned to this standard based on m/z matching.
We next plot its EIC and visually inspect it.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The only MS2 spectrum available for the features matched to `r std` is shown
below (peaks with an intensity below 5% of the maximum peak where removed).

```{r mix02-water-pos-glycine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectrum against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-glycine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix02-water-pos-glycine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.1,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

```{r mix02-water-pos-glycine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix02-water-pos-glycine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.1,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

For both HMDB and MassBank we find low similarity matches (involving only one
peak) for the only available extracted spectrum (i.e. F08.S0584 from feature
FT0102).

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
std_ms2_sel <- Spectra()
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0102 (RT = 173.7, `[M+H]+` ion) with confidence **C**: the MS2 spectrum
  F08.S0584 matches only `r std` with a low similarity.
- Reference MS2: `[M+H]+`: FT0102_F08.S0584; low confidence.

### cGMP

```{r, echo = FALSE}
std <- "cGMP"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-cgmp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-cgmp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix02-water-pos-cgmp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-pos-cgmp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix02-water-pos-cgmp-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

The extracted spectra from feature FT4591 (F08.S0747, F07.S0735 and
especially F07.S0777) seem to match reference spectra from `r std`. Also
F08.S0748 from FT4903 matches but with very low similarity. 

```{r mix02-water-pos-cgmp-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-pos-cgmp-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

We obtain similar results except the matches associated to F08.S0748 from FT4903
are better in the neutral loss comparison case (around 0.5). 

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

Reference spectra seem to match only with `r std` (in the MassBank case the
listed compounds have the same inchikey as `r std` so could it be they are
the same?).


#### Summary

- FT4591 (RT = 213, ion `[M+H]+`): confidence **A**.
- FT4903 (RT = 212.6, ion `[M+Na]+`): confidence **A-**.
- Reference MS2: `[M+H]+`: FT4591_F07.S0777; high confidence, FT4591_F07.S0735,
  FT4591_F08.S0747: low confidence. `[M+Na]+`: FT4903_F08.S0748?
  

### Histidine

```{r, echo = FALSE}
std <- "Histidine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from two different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-histidine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-histidine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Many matches are found. The best ones are those for spectrum F07.S0730 from
FT1369. We also have high similarity matches for F08.S0740 associated to both 
FT1368 and FT1369, for F08.S0658 from FT1368 and with lower similarity for
F08.S0095 from FT1376 and F07.S0668 from FT1368.

```{r mix02-water-pos-histidine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.85, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-pos-histidine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition, since the extracted spectra from FT2093 and FT1042 that were not
matched are associated to ions different from `[M+H]+` we perform a neutral
loss spectra comparison.

```{r mix02-water-pos-histidine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
sp <- c("FT2093_F07.S0663", "FT1042_F07.S0381", "FT1042_F08.S0380")
std_ms2_nl <- neutralLoss(std_ms2[sp], nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-pos-histidine-mirror-hmdb_nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2_nl, std_hmdb_nl, 0.15,
                           ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

```{r mix02-water-pos-histidine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2[sp], nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

We don't get new good matches from the neutral loss spectra comparison.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT1368 (RT=189.9, `[M+H]+` ion) confidence level **A**.
- FT1832 (RT=190.4, `[M+Na]+` ion) confidence level **A-**.
- FT2093 (RT=184.3, `[M+K]+` ion) confidence level **A-**.
- Reference MS2: `[M+H]+`: FT1368_F07.S0668, FT1368_F08.S0658, FT1368_F08.S0740,
  FT1369_F07.S0730; high confidence. `[M+K]+`: FT2093_F07.S0663; low confidence.
- Feature FT1376, which MS2 also match reference spectra for `r std` matches
  also phenylpyridine and is thus most likely **not** `r std`.

  
### Hydroxyproline

```{r, echo = FALSE}
std <- "Hydroxyproline"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-hydroxyproline-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-hydroxyproline-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The best matchings spectra are F07.S0659 and F08.S0644 from FT0790.
Also F08.S0257 and F07.S0255 from FT0789 match (with similarity around 0.65).
 
```{r mix02-water-pos-hydroxyproline-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

```{r mix02-water-pos-hydroxyproline-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition, since F08.S0585 from FT0516 is associated to an ion different from
`[M+H]+` we perform a neutral loss spectra comparison.

```{r mix02-water-pos-hydroxyproline-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2["FT0516_F08.S0585"], nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-pos-hydroxyproline-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2["FT0516_F08.S0585"], nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

We don't find good matches neither with HMDB or MassBank comparison.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "target_inchikey", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank,
              sv = c("rtime", "target_name", "target_inchikey", "score"),
              name = "target_name", param = csp)
```

There are matches with similarity higher than 0.7 involving more than one
compound (maybe they are similar?).

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT0790 (RT = 175.3, `[M+H]+`): confidence level **B**.
- FT0516 (RT = 175.3, `[M+H-H2O]+`): confidence level **B-**. The MS2 spectrum
  from this compound will be discarded.
- Reference MS2: `[M+H]+`: FT0790_F08.S0599, FT0790_F07.S0659, FT0790_F08.S0644;
  high confidence. FT0790_F07.S0613; low confidence.
- It is unclear what to do with FT0789 (RT = 74.4, `[M+H]+`): which MS2 spectra
  also matches the compound of interest, but with a lower score?


### Hypoxanthine

```{r, echo = FALSE}
std <- "Hypoxanthine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-hypoxanthine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-hypoxanthine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The best matches involve F07.S0376 and F08.S0374 from FT0955. We have low
similarity matches for F07.S0374 and F08.S0372 from FT0611.
 
```{r mix02-water-pos-hypoxanthine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-pos-hypoxanthine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

No good match is found with MassBank comparison (only very low similarity ones
for spectra from FT0955). In addition, since some of the extracted
spectra are associated to ions different from `[M+H]+` we perform a neutral
loss spectra comparison.

```{r mix02-water-pos-hypoxanthine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-pos-hypoxanthine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

With neutral loss comparison we find new matches for spectrum
F07.S0378 from FT1777 in both the HMDB and MassBank case (with similarity
around 0.63).

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
std_ms2_sel <- Spectra()
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT0955 (RT = 126.1, ion `[M+H]+`): confidence level **A**.
- FT0611 (RT = 126.3, ion `[M+H-H2O]+`): confidence level **C**.
- FT1777 (RT = 123.9, ion `[M+K]+`): confidence level **C**.
- Reference MS2: `[M+H]+`: FT0955_F07.S0376, FT0955_F08.S0374; high
  confidence. `[M+H-H2O]+`: FT0611_F07.S0374, FT0611_F08.S0372; low confidence.
  `[M+K]+`: FT1777_F07.S0378, FT1777_F08.S0381; low confidence.

### L-Kynurenine

```{r, echo = FALSE}
std <- "L-Kynurenine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these. Most
of the features above represent noisy and inconsistent data.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-l-kynurenine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-l-kynurenine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We find matches with high similarity for extracted MS2 spectra from FT2299
(F08.S0479 and F07.S0477) and FT2301 (F07.S0570 and F08.S0577) and with
slightly lower similarity from FT2069 (F07.S0476 and F08.S0478).

```{r mix02-water-pos-l-kynurenine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.8, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

We repeat the same with MassBank obtaining similar results.

```{r mix02-water-pos-l-kynurenine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Since we have MS2 spectra associated to ions different from `[M+H]+` we also
perform a neutral loss comparison against reference spectra from HMDB and
MassBank.

```{r mix02-water-pos-l-kynurenine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-pos-l-kynurenine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

Strangely, spectra from FT2069 (related to `[M+H-NH3]+`) don't match any more.
In addition, we find matches for F07.S0480 (features FT3226 and FT3227) and
F08.S0482 (features FT3226 and FT3227) and F07.S0479 (features FT2657 and
FT2654).

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT2299 (RT = 153.9, `[M+H]+` ion) confidence level **A**.
- FT2069 (RT = 153.9, `[M+H-NH3]+` ion) confidence level **C**.
- FT2654 (RT = 154.4, `[M+Na]+` ion) confidence level **C**.
- FT3226 (RT = 157.7, `[M+2Na-H]+` ion) confidence level **C**.
- Reference MS2: `[M+H]+`: FT2299_F07.S0477, FT2299_F08.S0479; high
  confidence. `[M+H-NH3]+`: FT2069_F07.S0476, FT2069_F08.S0478; high
  confidence. `[M+Na]+`: FT2654_F07.S0479, FT2654_F08.S0481; low
  confidence. `[M+2Na-H]+`: FT3226_F07.S0480, FT3226_F08.S0482; low confidence.
- Feature FT2301 (RT = 164, `[M+H]+` ion) will be ignored as the retention time
  is about 10 seconds delayed and its signal is much lower than for the
  first. So maybe that is just some *left over* from the column (?).


### Lactic acid

```{r, echo = FALSE}
std <- "Lactic acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-lactic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

- Inconclusive. Low signal.


### 1-Methylxanthine

```{r, echo = FALSE}
std <- "1-Methylxanthine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-1-methylxanthine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-1-methylxanthine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra from FT1646 (F07.S0185, F07.S0223, F08.S0190) and FT1642
(F07.S0223, F07.S0271, F08.S0270) seem to match reference spectra from `r std`.

```{r mix02-water-pos-1-methylxanthine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-pos-1-methylxanthine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition, since all the extracted spectra are associated to ions different
from `[M+H]+` we perform a neutral loss spectra comparison.

```{r mix02-water-pos-1-methylxanthine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-pos-1-methylxanthine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT1642 (RT = 81.1, `[M+H]+` ion) with confidence level **A**.
Inheriting confidence level from FT1642 for being in the same feature group: 
- FT2024 (RT = 80.2, `[M+Na]+` ion) with confidence level **A-**.
- FT2249 (RT = 79.9, `[M+K]+` ion) with confidence level **A-**.
- FT3108 (RT = 79.2, `[M+2K-H]+` ion) with confidence level **A-**.
- Reference MS2: `[M+H]+`: FT1642_F07.S0223, FT1642_F07.S0271, FT1642_F08.S0270,
  FT1646_F07.S0185, FT1646_F08.S0190, FT1646_F08.S0227; high
  confidence. `[M+Na]+`: FT2024_F07.S0294, FT2024_F08.S0214, FT2024_F08.S0261,
  FT2024_F08.S0286; low confidence.
- FT1646: this EIC is partially overlapping with FT1642 and will thus be ignores
  (but its MS2 spectra will be added).
  

### 3-Nitrotyrosine

```{r, echo = FALSE}
std <- "3-Nitrotyrosine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-3-nitrotyrosine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-3-nitrotyrosine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix02-water-pos-3-nitrotyrosine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

We have very good matches for F07.S0574 from FT2571.

```{r mix02-water-pos-3-nitrotyrosine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition, since some of the extracted spectra are associated to ions
different from `[M+H]+` we perform a neutral loss spectra comparison.

```{r mix02-water-pos-3-nitrotyrosine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-pos-3-nitrotyrosine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

For the HMDB comparison additionally we only find low similarity matches for
spectra from FT2317 while for the MassBank one the neutral loss spectra cannot
be computed. 

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT2571 (RT=164, `[M+H]+` ion) with confidence level **A**.
- FT3454 (RT=161.5, `[M+2Na-H]+` ion) with confidence level **A-**.
- Reference MS2: `[M+H]+`: FT2571_F07.S0574; high confidence. `[M+2Na-H]+`:
  FT3454_F08.S0505; low confidence.
  

### Phosphocreatine

```{r, echo = FALSE}
std <- "Phosphocreatine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-phosphocreatine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-phosphocreatine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We only find low similarity matches for F07.S0726 from FT2352 and even with
lower similarity for F07.S0663 from FT2093, F08.S0719 from FT2353 and
F08.S0719 from FT2352. We report below the mirror plots of the matches with
similarity higher than 0.2.

```{r mix02-water-pos-phosphocreatine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.2, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-pos-phosphocreatine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

We don't find any match with the MassBank comparison. In addition, since some
of the extracted spectra are associated to ions different from `[M+H]+` we
perform a neutral loss spectra comparison.

```{r mix02-water-pos-phosphocreatine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```
In addition to the previous matches we find a low similarity match for F08.S0671
(from FT3261 and FT3262).

```{r mix02-water-pos-phosphocreatine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT2352/FT2353 (RT = 196.3, `[M+H]+` ion) with confidence level **C**.
- Reference MS2: `[M+H]+`: FT2352_F07.S0726; low confidence.
  

### UDP-glucuronate

```{r, echo = FALSE}
std <- "UDP-glucuronate"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The only available MS2 spectrum (cleaned) for the features matched to `r std` is
shown below (peaks with an intensity below 5% of the maximum peak and spectra
with less than 2 peaks where removed).

```{r mix02-water-pos-udp-glucuronate-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-udp-glucuronate-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix02-water-pos-udp-glucuronate-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In both cases we don't find any match. In addition, since the extracted
spectrum is associated to an ion different from `[M+H]+` we perform a neutral
loss spectra comparison.

```{r mix02-water-pos-udp-glucuronate-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-pos-udp-glucuronate-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

For the HMDB comparison we don't find good matches while for the MassBank one
there is a match with very low similarity (around 0.01).

```{r mix02-water-pos-udp-glucuronate-mirror-mbank-nl, echo = TRUE, fig.cap = "Mirror plots"}
plotSpectraMirror(std_ms2_nl, std_mbank_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- Inconclusive.


### Valine

```{r, echo = FALSE}
std <- "Valine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-pos-valine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-pos-valine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix02-water-pos-valine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

The available spectrum F07.S0533 from FT0594 matches reference spectra for
`r std` (with maximum similarity around 0.6)

```{r mix02-water-pos-valine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

We obtain matches (with similarity scores a bit lower) also for MassBank. The
only one with similarity greater than 0.5 is shown below.

```{r mix02-water-pos-valine-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.5, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

This is puzzling. Comparing against reference spectra from all compounds in
MassBank we get a match with Valine with similarity around 0.77 but comparing
only against spectra from Valine we don't find such a high match. It seems
unique(std_hmdb$inchikey) is different from the inchikey of the Valine above.
Also D-Valine is different from L-Valine?

#### Summary

- FT0594 (RT= 158.6, `[M+H]+` ion) with confidence level **A**.
- FT1553 (RT = 157.5, `[M+2Na-H]+` ion) with confidence level **A-**?
- Reference MS2: `[M+H]+`: FT0594_F07.S0533; high confidence. FT0594_F08.S0494;
  low confidence.


# Water, negative polarity

We now perform the analysis on the samples with the standards still solved in
pure water but acquired in negative polarity mode.

```{r}
POLARITY <- "NEG"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_neg
hmdb_nl <- hmdb_neg_nl
```

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```


## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-neg}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards with matching features

### Ascorbic Acid

```{r, echo = FALSE}
std <- "Ascorbic Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EICs for the assigned features and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-ascorbic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-ascorbic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

MS2 spectra for features FT0475 and FT0476 match the reference spectra well.

```{r mix02-water-neg-ascorbic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

```{r mix02-water-neg-ascorbic-acid-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

No spectrum matches reference spectra from MassBank.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- Annotation of FT0475 (RT = 125.9, `[M-H]-` ion) to `r std` with confidence
  level **A**.
- Reference MS2: `[M-H]-`: FT0475_F15.S0311, FT0475_F16.S0290, FT0475_F16.S0326;
  high confidence.
- Feature FT0476 (RT = 36.75, `[M-H]-` ion) matches also with its MS2 spectra to
  the current compound, but signal is much lower than for the feature with
  higher retention time.
  

### C4 Carnitine

```{r, echo = FALSE}
std <- "C4 Carnitine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

A single feature has been assigned to this standard based on
m/z matching. We next plot its EIC and visually inspect it (has very
low intensity).

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-c4-carnitine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

- Inconclusive.


### Fructose

```{r, echo = FALSE}
std <- "Fructose"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

A single feature has been assigned to this standard based on
m/z matching. We next plot its EIC and visually inspect it (has very
low intensity).

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-fructose-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-fructose-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix02-water-neg-fructose-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.05, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-neg-fructose-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In both cases we don't find any match except a very low similarity one involving
F16.S0390 from FT0153.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
std_ms2_sel <- Spectra()
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

We find high score matches for spectra from FT0515 and spectra of compounds
different from `r std` (e.g. Theophyline).

#### Summary

- FT0153 (RT = 152.1 with, `[M-H]-` ion) with confidence level **D**.
- Not sure what to do with the reference spectrum. Does not look to be matching
  properly to anything and thus we're discarding it.
  

### Glycine

```{r, echo = FALSE}
std <- "Glycine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

One single feature has been assigned to this standard based on m/z matching.
Based on their retention times, these seem however to represent ions from two
different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-glycine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-glycine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We find a match (involving a single peak) and we report the mirror plot below.

```{r mix02-water-neg-glycine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

We find similar results for MassBank as shown below.

```{r mix02-water-neg-glycine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix02-water-neg-glycine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0013 (RT = 170.6, `[M-H]-` ion) with confidence level **A**.
- Reference MS2: `[M-H-]`: FT0013_F16.S0546; high confidence.


### cGMP

```{r, echo = FALSE}
std <- "cGMP"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-cgmp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-cgmp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

All the spectra from FT2364 (F15.S0611, F15.S0654, F16.S0644) match well.

```{r mix02-water-neg-cgmp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-neg-cgmp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix02-water-neg-cgmp-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT2364 (RT = 213, `[M-H]-` ion) confidence level **A**.
- FT2846 (RT = 213.3 `[M+HCOO]-` ion) confidence level **A-**.
- Reference MS2: `[M-H]-`: FT2364_F15.S0611, FT2364_F15.S0654, FT2364_F16.S0644;
  high confidence.
  

### Histidine

```{r, echo = FALSE}
std <- "Histidine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-histidine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-histidine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

All the extracted spectra match to some degree the reference spectra from
HMDB. The best matching ones are F15.S0548 from FT0309 and F15.S0597
from FT0311.

```{r mix02-water-neg-histidine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

We repeat the same with MassBank and we obtain similar results as shown below.

```{r mix02-water-neg-histidine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix02-water-neg-histidine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0309 (RT = 189.3, `[M-H]-` ion) with confidence level **A**.
- While also for the other features MS2 spectra match the reference they will
  not be considered (much lower signal).
- Reference MS2: `[M-H]-`: FT0309_F15.S0548, FT0309_F16.S0574; high confidence.


### Hydroxyproline

```{r, echo = FALSE}
std <- "Hydroxyproline"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-hydroxyproline-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-hydroxyproline-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We find matches for spectra F15.S0516 with very high scores and with lower
scores also for F16.S0551.
 
```{r mix02-water-neg-hydroxyproline-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

We repeat the same with MassBank and we obtain similar results as shown below.

```{r mix02-water-neg-hydroxyproline-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix02-water-neg-hydroxyproline-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank,
              sv = c("rtime", "target_name", "target_inchikey", "score"),
              name = "target_name", param = csp)
```

There are matches with similarity higher than 0.7 involving compounds
different (?) from `r std`.

#### Summary

- FT0153 (RT = 175.2, `[M-H]-` ion) with confidence **A**.
- FT0404 (RT = 174.7, `[M+Cl]-` ion) with confidence **A-**.
- FT0153 (RT = 174.6, `[M+HCOO]-` ion) with confidence **A-**.
- Reference MS2: `[M-H]-`: FT0153_F15.S0516, FT0153_F16.S0551; high confidence.


### Hypoxanthine

```{r, echo = FALSE}
std <- "Hypoxanthine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-hypoxanthine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-hypoxanthine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We find matches with high similarity involving F15.S0290 and F16.S0299 from
FT0204.

```{r mix02-water-neg-hypoxanthine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-neg-hypoxanthine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

With the MassBank comparison we find the same matches but with much lower
similarity. In addition, since some of the extracted spectra are associated to
ions different from `[M-H]-` we perform a neutral loss spectra comparison. In
this case, as we show below, we also find matches involving the spectra from
FT0544 (F15.S0179 and with lower score F16.S0178).

```{r mix02-water-neg-hypoxanthine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-neg-hypoxanthine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT0204 (RT = 122.1, `[M-H]-` ion) with confidence level **B**.
- FT0540 (RT = 122.8, `[M+HCOO]-` ion) with confidence level **B-**.
- Reference MS2: `[M-H]-`: FT0204_F15.S0290, FT0204_F16.S0299; high confidence.


### L-Kynurenine

```{r, echo = FALSE}
std <- "L-Kynurenine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-l-kynurenine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-l-kynurenine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix02-water-neg-l-kynurenine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Since all the extracted MS2 spectra are associated to ions different from
`[M-H]-` we also perform a neutral loss comparison against reference spectra
from HMDB and MassBank.

```{r mix02-water-neg-l-kynurenine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-neg-l-kynurenine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

Again we don't find any matches. In addition we match (**all**) the
MS2 spectra for the matched features against all spectra from HMDB or MassBank
identifying reference spectra with a similarity larger than 0.7. The results
(if any spectra matched) are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- Inconclusive.
- From the signal it seems FT1171 might be the *best* candidate, but the MS2
  spectra don't match.


### Lactic acid

```{r, echo = FALSE}
std <- "Lactic acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-lactic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-lactic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix02-water-neg-lactic-acid-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.4, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-neg-lactic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In the HMDB case we find only very low similarity matches for spectra from
FT0025; in the MassBank one we don't find any. In addition, since all the
extracted spectra are associated to ions different from `[M-H]-` we perform
a neutral loss spectra comparison but we don't find additional matches as shown
below.

```{r mix02-water-neg-lactic-acid-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-neg-lactic-acid-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT0025 (RT = 41.7, `[M-H]-` ion) with confidence **C**.
- Reference MS2: `[M-H]-`: FT0025_F15.S0109, FT0025_F16.S0106; low confidence.
- Feature FT0200 is in the same feature group than FT0025, but its EIC looks
  different and the signal is also very low.


### 1-Methylxanthine


```{r, echo = FALSE}
std <- "1-Methylxanthine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-1-methylxanthine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-1-methylxanthine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra from FT1646 (F07.S0185, F07.S0223, F08.S0190) and FT1642
(F07.S0223, F07.S0271, F08.S0270) seem to match reference spectra from `r std`.

```{r mix02-water-neg-1-methylxanthine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-neg-1-methylxanthine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT0396 (RT = 80.1, `[M-H]-` ion) with confidence level **A**.
- FT0397 (RT = 56.4, `[M-H]-` ion) with confidence level **A**.
- FT0822 (RT = 80.2, `[M+HCOO]-` ion) with confidence level **A-**.
- FT0823 (RT = 57.4, `[M+HCOO]-` ion) with confidence level **A-**.
- We might opt to select one of the two, either 56 or 80 seconds.
- Reference MS2: FT0397_F15.S0152, FT0397_F16.S0137, FT0397_F16.S0163,
  FT0396_F15.S0211, FT0396_F16.S0211; high confidence.


### 3-Nitrotyrosine

```{r, echo = FALSE}
std <- "3-Nitrotyrosine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-3-nitrotyrosine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-3-nitrotyrosine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We find good matches for spectra from FTO950 (especially F15.S0493 but also
F16.S0501).

```{r mix02-water-neg-3-nitrotyrosine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-neg-3-nitrotyrosine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition, since some of the extracted spectra are associated to ions
different from `[M+H]+` we perform a neutral loss spectra comparison. We do not
get additional matches as we show below.

```{r mix02-water-neg-3-nitrotyrosine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-neg-3-nitrotyrosine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT0950 (RT = 173.1, `[M-H]-` ion) with confidence **A**.
- Reference MS2: `[M-H-]`: FT0950_F15.S0493, FT0950_F16.S0501; high confidence.


### Phosphocreatine

```{r, echo = FALSE}
std <- "Phosphocreatine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-phosphocreatine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

- FT0814 (RT = 196.1, `[M-H]-` ion) confidence level **D**.


### UDP-glucuronate

```{r, echo = FALSE}
std <- "UDP-glucuronate"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The only available MS2 spectrum (cleaned) for the features matched to `r std` is
shown below (peaks with an intensity below 5% of the maximum peak and spectra
with less than 2 peaks where removed).

```{r mix02-water-neg-udp-glucuronate-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-udp-glucuronate-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We find matches for F15.S0857 and F16.S0878 from FT4308, F15.S0728 and F15.S0745
from FT4312, F16.S0597 from FT4310, F16.S0641 from FT4309, F16.S0749 from FT4311.

```{r mix02-water-neg-udp-glucuronate-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-neg-udp-glucuronate-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

We obtain similar results from the MassBank comparison. In addition, since
there are extracted spectra is associated to an ion different from `[M-H]-`
(`[M+Cl]-`) we perform a neutral loss spectra comparison.

```{r mix02-water-neg-udp-glucuronate-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix02-water-neg-udp-glucuronate-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

For the HMDB comparison we don't find any new good matches while for the
MassBank one there is a match with very low similarity (around 0.01).

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT4308 (RT = 324.6, `[M-H]-` ion) confidence **A**.
- FT4312 (RT = 268.3, `[M-H]-` ion) confidence **A**.
- Seems that all other features are somewhat also showing signal from this ion,
  along the almost complete retention time range. Highest signal is however
  FT4308.
- Reference MS2: `[M-H]-`: FT4308_F15.S0857, FT4308_F16.S0878, FT4312_F15.S0728,
  FT4312_F15.S0745; high confidence.
  

### Valine

```{r, echo = FALSE}
std <- "Valine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix02-water-neg-valine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix02-water-neg-valine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Both available spectra from FT0099 (F16.S0463 and F15.S0434) match reference
spectra for `r std`, but, with the exception of one, only with their precursor
peak.

```{r mix02-water-neg-valine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix02-water-neg-valine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

We obtain similar results also for MassBank. The
only one with similarity greater than 0.7 is shown below.

```{r mix02-water-neg-valine-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.5, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT0099 (RT= 158.6, `[M-H]-` ion) with confidence level **B**. 
- FT0362 (RT= 158.8, `[M+HCOO]-` ion) confidence level **B-**.
- Reference MS2: `[M-H]-`: FT0099_F16.S0463, FT0099_F15.S0434; high confidence.


## Standards without any matching feature

# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
