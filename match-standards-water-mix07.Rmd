---
title: "Identifying mix07 standards in water"
author: "Andrea Vicini, Vinicius Verri Hernandes, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_float: true
    toc_depth: 3
    fig_width: 5
---

```{r, include = FALSE, cached = FALSE}
knitr::read_chunk("R/match-standards-chunks.R")
MIX <- 7
MATRIX <- "Water"
POLARITY <- "POS"
## settings to find MS2 spectra for features. Be rather inclusive here.
FEATURE_MS2_PPM <- 20
FEATURE_MS2_TOLERANCE <- 0.05
```

```{r, libraries, echo = FALSE, message = FALSE}
```
```{r, general-settings, echo = FALSE, message = FALSE}
```

**Current version: 0.10.0, 2022-05-30.**

# Introduction

Mixes of standards have been solved in water or added to human serum sample
pools in two different concentration and these samples were measured with the
LC-MS setup from Eurac (used also to generate the CHRIS untargeted metabolomics
data). Assignment of retention time and observed ion can be performed for each
standard based on MS1 information such as expected m/z but also based on the
expected difference in signal between samples with low and high concentration of
the standards. Finally, experimental fragment spectra provide the third level of
evidence. Thus, the present data set allows to annotate features to standards
based on 3 levels of evidence: expected m/z, difference in measured intensity
and MS2-based annotation.

A detailed description of the approach is given in
[match-standards-introduction.Rmd](match-standards-introduction.Rmd).


The list of standards that constitute the present sample mix are listed below
along with the expected retention time and the most abundant adduct for positive
and negative polarity as defined manually in a previous analysis by Mar
Garcia-Aloy.

```{r, standards-table, echo = FALSE, results = "asis"}
```

# Data import

We next load the data and split it according to matrix and polarity.

```{r, data-import}
```

We next also load the reference databases we will use to compare the
experimental MS2 spectra against. Below we thus load HMDB and MassBank data. We
create in addition *neutral loss* versions of the databases. Since HMDB does not
provide precursor m/z values we assume the fragment spectra to represent `[M+H]+`
ions (respectively `[M-H]-` ions for negative polarity) and add the m/z for
these adducts as *precursor m/z*.

```{r, load-reference-databases, message = FALSE}
```

```{r, setup-ion-db, message = FALSE, echo = FALSE}
```

# Initial evaluation of available MS2 data

Before performing the actual analysis that involves chromatographic peak
detection and evaluation of feature abundances, we compare all experimental MS2
spectra against the reference libraries. This provides already a first hint for
which standards a valid MS2 spectrum was recorded (and hence would allow
annotation based on evidence 3) and what related retention time might be.

We first extract all MS2 spectra from the respective data files and process them
by first removing all peaks with an intensity below 5% of the highest peak
signal, then scaling all intensities to a value range between 0 and 100 and
finally remove all MS2 spectra with less than 2 peaks.

```{r prepare-all-ms2}
fls <- fileNames(data_all)[data_all$polarity == "POS"]
```
```{r, all-ms2}
```

We next match these spectra against all reference spectra from HMDB for the
standards in `r MIX_NAME`. 

The settings for the matching are defined below. These will be used for all MS2
spectra similarity calculations. All matching spectra with a similarity larger
0.7 are identified.

```{r, compare-spectra-param}
```
 
Standards for which no MS2 spectrum in HMDB is present are listed in
the table below.

```{r, echo = FALSE, results = "asis"}
tmp <- std_dilution[!(std_dilution$HMDB %in% hmdb_std$compound_id), ]
pandoc.table(tmp[, c("name", "HMDB", "formula")], style = "rmarkdown",
             caption = "Standards for which no reference spectrum is available")
```

The table below lists all standards and the number of matching reference spectra
(along with their retention times).

```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We repeat the same analysis for the negative polarity data (code not shown
again).

```{r, echo = FALSE}
fls <- fileNames(data_all)[data_all$polarity == "NEG"]
```
```{r, all-ms2, echo = FALSE}
```
```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We next perform the full analysis of the data set involving MS1 and MS2 data.


# Water, positive polarity

We first perform the analysis on the samples with the standards solved in pure
water acquired in positive polarity mode.

```{r}
POLARITY <- "POS"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_pos
hmdb_nl <- hmdb_pos_nl
```

## Data pre-processing

We perform the pre-processing of our data set which consists of the
chromatographic peak detection followed by a peak refinement step to reduce peak
detection artifacts, the correspondence analysis to group peaks across samples
and finally the gap-filling to fill in missing peak data from samples in which
no chromatographic peak was detected. For details on settings please refer to
the analysis of *mix 01* samples.

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```

## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-pos}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards with matching features

While for some standards a matching feature was found we still need to evaluate
whether this matching is correct. For each standard we thus first evaluate the
EICs for all matching features, then we match their MS2 spectra (if available)
against reference libraries. To ensure correct assignment of a feature, its
retention time and eventually related MS2 spectra, we consider the following
criteria to determine the annotation confidence:

- feature(s) was/were found with m/z matching those of adduct(s) of the 
  standard.
- signal is higher for samples with higher concentration.
- MS2 spectra matches reference spectra for the standard (if available).
- MS2 spectra don't match MS2 spectra of other compounds.

### ADMA

```{r, echo = FALSE}
std <- "ADMA"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EICs for the assigned features and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-pos-adma-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-pos-adma-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from features FT1891, FT1894 match with good similarity some of the HMDB
reference spectra for `r std`. Below we show the mirror plots of the best
matches (similarity score  greater than 0.7).

```{r mix07-water-pos-adma-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

```{r mix07-water-pos-adma-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- The EIC signal is slightly bimodal. We select the first peak/feature as it has
  also a much higher intensity. Note that the MS2 spectra match both ADMA and
  SDMA.
- FT1891 (RT = 177.92, ion `[M+H]+`) with confidence **B**.
- FT2276 (RT = 177.65, ion `[M+Na]+`) with confidence **B-**.
- FT2469 (RT = 177.8, ion `[M+K]+`) with confidence **B-**.
- FT0316 (RT = 177.84, ion `[M+2H]2+`) with confidence **B-**.
- FT1612 (RT = 177.8, ion `[M+H-NH3]+`) with confidence **B-**.
- Reference MS2: `[M+H]+`: FT1891_F07.S0579, FT1891_F07.S0636, FT1891_F08.S0580,
  FT1891_F08.S0653; high confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT1891_F07.S0579", "FT1891_F07.S0636", "FT1891_F08.S0580",
                 "FT1891_F08.S0653")]
ms2$confidence <- c("high")
```

```{r, add-ms2-spectra, echo = FALSE}
```


### dAMP

```{r, echo = FALSE}
std <- "dAMP"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned features and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The extracted MS2 spectra (cleaned) for the features matched to `r std`
are shown below (peaks with an intensity below 5% of the maximum peak and
spectra with less than 2 peaks were removed).

```{r mix07-water-pos-damp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectrum against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-pos-damp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from features FT4336, FT4337 match with good similarity (while those
from FT4999 with low similarity) some of the HMDB reference spectra for `r std`.
Below we show the mirror plots of the best matches (similarity score  greater
than 0.8).

```{r mix07-water-pos-damp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

We find similar results with MassBank comparison as shown below.

```{r mix07-water-pos-damp-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT4336 (RT = 205.58, ion `[M+H]+`) with confidence **A**.
- FT4999 (RT = 206.68, ion `[M+K]+`) with confidence **A-**.
- Reference MS2: `[M+H]+`: FT4336_F07.S0687, FT4336_F07.S0738, FT4336_F07.S0791,
  FT4336_F08.S0724; high confidence. `[M+K]+`: FT4999_F07.S0727,
  FT4999_F08.S0727; low confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT4336_F07.S0687", "FT4336_F07.S0738", "FT4336_F07.S0791",
                 "FT4336_F08.S0724", "FT4999_F07.S0727", "FT4999_F08.S0727")]
ms2$confidence <- c(rep("high", 4), rep("low", 2))
```

```{r, add-ms2-spectra, echo = FALSE}
```

  
### Caffeine

```{r, echo = FALSE}
std <- "Caffeine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-pos-caffeine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectrum against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-pos-caffeine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The extracted seem to match some of the HMDB reference spectra from `r std`.
The best matches are shown in the mirror plots below.

```{r mix07-water-pos-caffeine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

We obtain similar results with the MassBank comparison as we show below.

```{r mix07-water-pos-caffeine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT1707 (RT = 35.5, `[M+H]+` ion) with confidence **A**.
- FT2390 (RT = 35.9, `[M+K]+` ion) with confidence **A-**.
- Reference MS2: `[M+H]+`: FT1707_F07.S0138, FT1707_F08.S0145; high confidence.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT1707", "FT2390"),
                  confidence_level = c("A", "A-"))

## Get MS2 spectra:
ms2 <- std_ms2[c("FT1707_F07.S0138", "FT1707_F08.S0145")]
ms2$confidence <- c("high")
```

```{r, add-ions, echo = FALSE}
```

```{r, add-ms2-spectra, echo = FALSE}
```


### CDP-choline

```{r, echo = FALSE}
std <- "CDP-choline"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```


```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The extracted MS2 spectra for the features matched to `r std` are shown
below (peaks with an intensity below 5% of the maximum peak where removed).

```{r mix07-water-pos-cdp-choline-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectrum against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-pos-cdp-choline-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from feature FT6683 match with similarity lower than 0.7 some of the
HMDB reference spectra for `r std`. Below we show the mirror plots of the best
matches (similarity score  greater than 0.5).

```{r mix07-water-pos-cdp-choline-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

Several fragments are matching, but not with their intensity.

```{r mix07-water-pos-cdp-choline-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT6683 (RT = 215.96, ion `[M+H]+`) with confidence **C**.
- FT6906 (RT = 216.2,  ion `[M+Na]+`) with confidence **C-**.
- FT7111 (RT = 215.87, ion `[M+K]+`) with confidence **C-**.
- FT2515 (RT = 216.4, ion `[M+2H]2+`) with confidence **C-**.
- Reference MS2: `[M+H]+`: FT6683_F07.S0765, FT6683_F08.S0754; low
  confidence. `[M+Na]+`: FT6906_F08.S0774, FT6906_F07.S0781; low
  confidence. `[M+K]+`: FT7111_F08.S0776, FT7111_F07.S0783; low confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT6683_F07.S0765", "FT6683_F08.S0754", "FT6906_F08.S0774",
                 "FT6906_F07.S0781", "FT7111_F08.S0776", "FT7111_F07.S0783")]
ms2$confidence <- c("low")
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Creatinine

```{r, echo = FALSE}
std <- "Creatinine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-pos-creatinine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-pos-creatinine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from features FT0500, FT0498 match with good similarity some of the HMDB
reference spectra for `r std`. Below we show the mirror plots of the best
matches (similarity score  greater than 0.85).

```{r mix07-water-pos-creatinine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.85, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix07-water-pos-creatinine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix07-water-pos-creatinine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.85, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- The EIC signal is very high resulting in a very broad (noisy) peak.
- FT0500 (RT = 89.55, ion `[M+H]+`) with confidence **A**.
- Reference MS2: `[M+H]+`: FT0500_F07.S0224, FT0500_F07.S0255, FT0500_F07.S0288,
  FT0500_F08.S0244, FT0500_F08.S0272; high confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT0500_F07.S0224", "FT0500_F07.S0255", "FT0500_F07.S0288",
                 "FT0500_F08.S0244", "FT0500_F08.S0272")]
ms2$confidence <- c(rep("high"))
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Glutaric acid

```{r, echo = FALSE}
std <- "Glutaric acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Three features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from two
different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-pos-glutaric-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-pos-glutaric-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We obtain similar results with the MassBank comparison as we show below.

```{r mix07-water-pos-glutaric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

No match is found for the extracted spectrum.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- Inconclusive. No match found for the extracted spectrum. EICs of the assigned
  features don't look good.
- (Eventually) FT2084 (RT = 39.06, `[M+2K-H]+` ion) with confidence level **D**.
- Reference MS2: `[M+2K-H]+`: FT2084_F07.S0140; low confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT2084_F07.S0140")]
ms2$confidence <- c(rep("low"))
```

```{r, add-ms2-spectra, echo = FALSE}
```

  
### Glycero-phosphocholine

```{r, echo = FALSE}
std <- "Glycero-phosphocholine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-pos-glycero-phosphocholine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank but we don't find any match.

```{r mix07-water-pos-glycero-phosphocholine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix07-water-pos-glycero-phosphocholine-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "target_inchikey", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank,
              sv = c("rtime", "target_name", "target_inchikey", "score"),
              name = "target_name", param = csp)
```

#### Summary

- Inconclusive; needs validation with negative polarity or serum data. EIC data
  for the listed features below looks good.
- FT2690 (RT = 189, `[M+H]+`): confidence level **D**.
- FT2454 (RT = 189, `[M+H-H2O]+`) confidence level **D**.
- Reference MS2: `[M+H]+`: FT2690_F07.S0631, FT2690_F08.S0636; low confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT2690_F07.S0631", "FT2690_F08.S0636")]
ms2$confidence <- c("low")
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Methionine

```{r, echo = FALSE}
std <- "Methionine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-pos-methionine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-pos-methionine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from features FT1017 match with good similarity (those from FT0775,
FT0774 with low) some of the HMDB reference spectra for `r std`. Below we show
the mirror plots of the best matches (similarity score  greater than 0.7).

```{r mix07-water-pos-methionine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix07-water-pos-methionine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT1017 (RT = 156.8, ion `[M+H]+`) with confidence **B**.
- FT1367 (RT = 156.81, ion `[M+Na]+`) with confidence **B-**.
- FT1691 (RT = 157.31, ion `[M+2Na-H]+`) with confidence **B-**.
- FT0774 (RT = 156.64, ion `[M+H-NH3]+`) with confidence **B-**.
- FT1256 (RT = 149.41, ion `[M+NH4]+`) with confidence **B-**.
- Reference MS2: `[M+H]+`: FT1017_F07.S0468, FT1017_F08.S0472; high
  confidence. `[M+Na]+`: FT1367_F08.S0494; low confidence. `[M+2Na-H]+`:
  FT1691_F08.S0473; low confidence. `[M+H-NH3]+`: FT0774_F08.S0471,
  FT0774_F07.S0466; low confidence.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT1017", "FT1367", "FT1691", "FT0774",
                                 "FT1256"),
                  confidence_level = c("B", "B-", "B-", "B-", "B-"))

## Get MS2 spectra:
ms2 <- std_ms2[c("FT1017_F07.S0468", "FT1017_F08.S0472", "FT1367_F08.S0494",
                 "FT1691_F08.S0473", "FT0774_F08.S0471", "FT0774_F07.S0466")]
ms2$confidence <- c(rep("high", 2), rep("low", 4))
```

```{r, add-ions, echo = FALSE}
```

```{r, add-ms2-spectra, echo = FALSE}
```


### 3-Methylhistidine

```{r, echo = FALSE}
std <- "3-Methylhistidine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned features and visually inspect them.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-pos-3-methylhistidine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-pos-3-methylhistidine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from features FT1304, FT1305 match with good similarity some of the HMDB
reference spectra for `r std`. Below we show the mirror plots of the best
matches (similarity score  greater than 0.7).

```{r mix07-water-pos-3-methylhistidine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix07-water-pos-3-methylhistidine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT1304 (RT = 187.7, ion `[M+H]+`) with confidence **A**.
- FT1671 (RT = 187.34, ion `[M+Na]+`) with confidence **A-**.
- FT1078 (RT = 188.74, ion `[M+H-NH3]+`) with confidence **A-**.
- Reference MS2: `[M+H]+`: FT1304_F07.S0612, FT1304_F07.S0680, FT1304_F07.S0760,
  FT1304_F08.S0624; high confidence. `[M+H-NH3]+`: FT1078_F07.S0629; low
  confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT1304_F07.S0612", "FT1304_F07.S0680", "FT1304_F07.S0760",
                 "FT1304_F08.S0624", "FT1078_F07.S0629")]
ms2$confidence <- c(rep("high", 4), "low")
```

```{r, add-ms2-spectra, echo = FALSE}
```


### 1-Methyluric acid

```{r, echo = FALSE}
std <- "1-Methyluric acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-pos-1-methyluric-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-pos-1-methyluric-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from feature FT1560 match with good similarity some of the HMDB
reference spectra for `r std`. Below we show the mirror plots of the best
matches (similarity score  greater than 0.7).

```{r mix07-water-pos-1-methyluric-acid-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

In addition we check for potential matches of neutral loss spectra.

```{r mix06-water-pos-1-methyluric-acid-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix07-water-pos-1-methyluric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- Inconclusive; needs validation by negative polarity and serum data. The EIC
  shows periodic signal. There are two features for other than the `[M+H]+` ion
  that look actually better and would have a RT of 145 (matching the previous
  analysis).
- Can not distinguish between 1 and 3-Methyluric acid.
- FT1560 (RT = 162.75, ion `[M+H]+`) with confidence level **B**.
- FT1949 (RT = 145.2, ion `[M+Na]+`) with confidence level **D**.
- FT2312 (RT = 146.2, ion `[M+2Na-H]+`) with confidence level **D**.
- Reference MS2: `[M+H]+`: FT1560_F07.S0504, FT1560_F08.S0510; high
  confidence. `[M+Na]+`: FT1949_F07.S0404, FT1949_F08.S0414; low
  confidence. `[M+2Na-H]+`: FT2312_F08.S0401; low confidence.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT1560"),
                  confidence_level = c("B"))

## Get MS2 spectra:
ms2 <- std_ms2[c("FT1560_F07.S0504", "FT1560_F08.S0510", "FT1949_F07.S0404",
                 "FT1949_F08.S0414", "FT2312_F08.S0401")]
ms2$confidence <- c(rep("high", 2), rep("low", 3))
```

```{r, add-ions, echo = FALSE}
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Phenylpyruvic acid

```{r, echo = FALSE}
std <- "Phenylpyruvic acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-pos-phenylpyruvic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank but we don't find any match.

```{r mix07-water-pos-phenylpyruvic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix07-water-pos-phenylpyruvic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition, since all the extracted spectra are associated to ions
different from `[M+H]+` we perform a neutral loss spectra comparison but we
don't find good matches (low similarity ones for spectra FT2089 and FT2087).

```{r mix07-water-pos-phenylpyruvic-acid-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix07-water-pos-phenylpyruvic-acid-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- Inconclusive; needs validation by negative polarity and serum data.


### Serine

```{r, echo = FALSE}
std <- "Serine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-pos-serine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-pos-serine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from features FT0369, FT0168 match with good similarity some of the HMDB
reference spectra for `r std`. Below we show the mirror plots of the best
matches (similarity score  greater than 0.7).

```{r mix07-water-pos-serine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix07-water-pos-serine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0369 (RT = 181.13, ion `[M+H]+`) with confidence **A**.
- FT0168 (RT = 181.46, ion `[M+H-H2O]+`) with confidence **A**.
- Reference MS2: `[M+H]+`: FT0369_F07.S0602, FT0369_F08.S0603; high
  confidence. `[M+H-H2O]+`: FT0168_F07.S0601, FT0168_F08.S0609; high confidence.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT0369", "FT0168"),
                  confidence_level = c("A", "A"))

## Get MS2 spectra:
ms2 <- std_ms2[c("FT0369_F07.S0602", "FT0369_F08.S0603",
                 "FT0168_F07.S0601", "FT0168_F08.S0609")]
ms2$confidence <- c("high")
```

```{r, add-ions, echo = FALSE}
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Sphingosine

```{r, echo = FALSE}
std <- "Sphingosine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-pos-sphingosine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-pos-sphingosine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We find many features matching but with similarity lower than 0.7. Below we show
the mirror plots of the best matches (similarity score  greater than 0.6).

```{r mix07-water-pos-sphingosinede-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.6, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```
We obtain similar results with the MassBank comparison as we show below.

```{r mix07-water-pos-sphingosine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- The signal is very high resulting in very broad EIC, split into several
  features. We're reporting the first feature/peak for each ion.
- FT3735 (RT = 37.4, ion `[M+H]+`) with confidence **C**.
- FT3060 (RT = 37.4, ion `[M+H-H2O]+`) with confidence **C-**.
- Reference MS2: `[M+H]+`: FT3735_F07.S0158, FT3735_F08.S0164, FT3738_F07.S0190,
  FT3738_F07.S0218; high confidence. `[M+H-H2O]+`: FT3060_F07.S0119; high
  confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT3735_F07.S0158", "FT3735_F08.S0164", "FT3738_F07.S0190",
                 "FT3738_F07.S0218", "FT3060_F07.S0119")]
ms2$confidence <- c("high")
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Taurine

```{r, echo = FALSE}
std <- "Taurine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The only available MS2 spectrum (cleaned) for the features matched to `r std` is
shown below (peaks with an intensity below 5% of the maximum peak and spectra
with less than 2 peaks were removed).

```{r mix07-water-pos-taurine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-pos-taurine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from feature FT0689 match with good similarity some of the HMDB
reference spectra for `r std`. Below we show the mirror plots of the best
matches (similarity score  greater than 0.7).

```{r mix07-water-pos-taurine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

We obtain similar results with the MassBank comparison as we show below.

```{r mix07-water-pos-taurine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- Assigning confidence *A* since matches to other compounds have a relatively
  large difference in their precursor m/z.
- FT0689 (RT = 171.11, ion `[M+H]+`) with confidence **A**.
- FT0399 (RT = 171.11, ion `[M+H-H2O]+`) with confidence **A-**.
- FT0978 (RT = 171.11, ion `[M+Na]+`) with confidence **A-**.
- Reference MS2: `[M+H]+`: FT0689_F07.S0549, FT0689_F08.S0555; high
  confidence. `[M+H-H2O]+`: FT0399_F07.S0548, FT0399_F08.S0554; low confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT0689_F07.S0549", "FT0689_F08.S0555",
                 "FT0399_F07.S0548", "FT0399_F08.S0554")]
ms2$confidence <- c(rep("high", 2), rep("low", 2))
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Threonic Acid

```{r, echo = FALSE}
std <- "Threonic Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-pos-threonic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank but we don't find any match.

```{r mix07-water-pos-threonic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix07-water-pos-threonic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

We also perform neutral loss comparison but still no match is found.

```{r mix07-water-neg-threonic-acid-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix07-water-neg-threonic-acid-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- Inconclusive; needs validation with negative polarity and serum data. There
  are some potential features with signal and also MS2 spectra but it's not
  clear which one are correct.


# Water, negative polarity

We now perform the analysis on the samples with the standards still solved in
pure water but acquired in negative polarity mode.

```{r}
POLARITY <- "NEG"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_neg
hmdb_nl <- hmdb_neg_nl
```

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```


## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-neg}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards with matching features

### ADMA

```{r, echo = FALSE}
std <- "ADMA"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EICs for the assigned features and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-adma-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-neg-adma-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix07-water-neg-adma-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- Inconclusive; needs validation from positive polarity or serum data.
- FT0623 (RT = 176.2, `[M-H]-` ion) with confidence level **D**.
- FT0994 (RT = 176.2, `[M+HCOO]-` ion) with confidence level **D**.
- (Eventually) FT0919 (RT = 179.6, `[M+Cl]-` ion) with confidence level **D**.
- Reference MS2: `[M-H]-`: FT0623_F15.S0523, FT0623_F16.S0517; low confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT0623_F15.S0523", "FT0623_F16.S0517")]
ms2$confidence <- c("low")
```

```{r, add-ms2-spectra, echo = FALSE}
```


### dAMP

```{r, echo = FALSE}
std <- "dAMP"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. We next
plot its EIC and visually inspect it (has very low intensity).

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-damp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

```{r mix07-water-neg-damp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from feature FT1947 match with good similarity some of the HMDB
reference spectra for `r std`. Below we show the mirror plots of the best
matches (similarity score  greater than 0.7).

```{r mix07-water-neg-damp-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix07-water-neg-damp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix07-water-neg-damp-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7, ppm = csp@ppm,
                           tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT1947 (RT = 206.38, ion `[M-H]-`) with confidence **A**.
- FT2591 (RT = 206.27, ion `[M+HCOO]-`) with confidence **A-**.
- Reference MS2: `[M-H]-`: FT1947_F15.S0648, FT1947_F15.S0702, FT1947_F16.S0621,
  FT1947_F16.S0660, FT1947_F16.S0780; high confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT1947_F15.S0648", "FT1947_F15.S0702", "FT1947_F16.S0621",
                 "FT1947_F16.S0660", "FT1947_F16.S0780")]
ms2$confidence <- c("high")
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Caffeine

```{r, echo = FALSE}
std <- "Caffeine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

A single feature has been assigned to this standard based on
m/z matching. We next plot its EIC and visually inspect it (has very
low intensity).

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-caffeine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

- Inconclusive; needs serum data for validation.
- No MS2 spectra available.
- EIC of the only assigned feature shows low intensity signal.


### CDP-choline

```{r, echo = FALSE}
std <- "CDP-choline"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-cdp-choline-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-neg-cdp-choline-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from features FT3825, FT4216 match (with similarity lower than 0.7) some 
of the HMDB reference spectra for `r std`. Below we show the mirror plots of
the best matches (similarity score  greater than 0.4).

```{r mix07-water-neg-cdp-choline-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.4,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

We find similar results for MassBank as shown below.

```{r mix07-water-neg-cdp-choline-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- EIC data looks very clear and nice.
- FT3825 (RT = 216.13, ion `[M-H]-`) with confidence **C**.
- FT4216 (RT = 216.13, ion `[M+HCOO]-`) with confidence **C**.
- FT4110 (RT = 216.63, ion `[M+Cl]-`) with confidence **C-**.
- Reference MS2: `[M-H]-`: FT3825_F15.S0718, FT3825_F16.S0730; high
  confidence. `[M+HCOO]-`: FT4216_F15.S0709, FT4216_F16.S0731; high
  confidence. `[M+Cl]-`: FT4110_F15.S0728, FT4110_F16.S0742; low confidence.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT3825", "FT4216", "FT4110"),
                  confidence_level = c("C", "C", "C-"))

## Get MS2 spectra:
ms2 <- std_ms2[c("FT3825_F15.S0718", "FT3825_F16.S0730", "FT4216_F15.S0709",
                 "FT4216_F16.S0731", "FT4110_F15.S0728", "FT4110_F16.S0742")]
ms2$confidence <- c(rep("high", 4), rep("low", 2))
```

```{r, add-ions, echo = FALSE}
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Creatinine

```{r, echo = FALSE}
std <- "Creatinine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Three features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-creatinine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank but we don't find any match as shown below.

```{r mix07-water-neg-creatinine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from features FT0053, FT0051 match reference spectra for `r std`. Below
we show the mirror plots of the best matches (similarity score  greater than 0.6).

```{r mix07-water-neg-creatinine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.6,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

No match is found with the MassBank comparison as shown below.

```{r mix07-water-neg-creatinine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0053 (RT = 87.91, ion `[M-H]-`) with confidence **A**.
- Reference MS2: `[M-H]-`: FT0053_F15.S0214, FT0053_F16.S0195, FT0053_F16.S0213,
  FT0053_F16.S0214, FT0053_F16.S0234; high confidence.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT0053"),
                  confidence_level = c("A"))

## Get MS2 spectra:
ms2 <- std_ms2[c("FT0053_F15.S0214", "FT0053_F16.S0195", "FT0053_F16.S0213",
                 "FT0053_F16.S0214", "FT0053_F16.S0234")]
ms2$confidence <- c("high")
```

```{r, add-ions, echo = FALSE}
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Glutaric acid

```{r, echo = FALSE}
std <- "Glutaric acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching.
Based on their retention times, these seem however to represent ions from
different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-glutaric-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-neg-glutaric-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from features FT0126, FT0125 match some of the HMDB reference spectra
for `r std`. Below we show the mirror plots of the best matches (similarity
score  greater than 0.7).

```{r mix07-water-neg-glutaric-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

We repeat the same with MassBank and we obtain similar results as shown below.

```{r mix07-water-neg-glutaric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix07-water-neg-glutaric-acid-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- The two EICs for `[M-H]-` both look very nice and clean - and the MS2 of both
  matches the reference.
- FT0126 (RT = 36.68, ion `[M-H]-`) with confidence **B**.
- FT0436 (RT = 36.72, ion `[M+HCOO]-`) with confidence **B-**.
- FT0125 (RT = 47.57, ion `[M-H]-`) with confidence **B**.
- FT0437 (RT = 45.29, ion `[M+HCOO]-`) with confidence **B-**.
- Reference MS2: `[M-H]-`: FT0126_F15.S0106, FT0126_F16.S0111, FT0125_F15.S0150,
  FT0125_F16.S0168; high confidence.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT0126", "FT0436", "FT0125", "FT0437"),
                  confidence_level = c("B", "B-", "B", "B-"))

## Get MS2 spectra:
ms2 <- std_ms2[c("FT0126_F15.S0106", "FT0126_F16.S0111", "FT0125_F15.S0150",
                 "FT0125_F16.S0168")]
ms2$confidence <- c("high")
```

```{r, add-ions, echo = FALSE}
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Glycero-phosphocholine

```{r, echo = FALSE}
std <- "Glycero-phosphocholine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-glycero-phosphocholine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectrum against the reference spectra for 
`r std` from HMDB and MassBank but we don't find good matches.

```{r mix07-water-neg-glycero-phosphocholine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix07-water-neg-glycero-phosphocholine-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Since the extracted spectrum is associated to an ion different from `[M-H]-` we
perform a neutral loss spectra comparison.

```{r mix07-water-neg-methionine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix07-water-neg-methionine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank,
              sv = c("rtime", "target_name", "target_inchikey", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT1397 (RT = 189.2, `[M+Cl]-` ion) with confidence **D**.
- Reference MS2: `[M+Cl]-`: FT1397_F16.S0586; low confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT1397_F16.S0586")]
ms2$confidence <- c("low")
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Methionine

```{r, echo = FALSE}
std <- "Methionine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Three features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-methionine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank but we don't find any match.

```{r mix07-water-neg-methionine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix07-water-neg-methionine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT0249 (RT = 156.9, `[M-H]-` ion) with confidence level **D**.
- FT0557 (RT = 156.9, `[M+HCOO]-` ion) with confidence level **D**.
- Reference MS2: `[M-H]-`: FT0249_F15.S0421, FT0249_F16.S0421; low confidence.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT0249", "FT0557"),
                  confidence_level = c("D", "D"))

## Get MS2 spectra:
ms2 <- std_ms2[c("FT0249_F15.S0421", "FT0249_F16.S0421")]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE}
```

```{r, add-ms2-spectra, echo = FALSE}
```


### 3-Methylhistidine

```{r, echo = FALSE}
std <- "3-Methylhistidine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-3-methylhistidine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-neg-3-methylhistidine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from features FT0381, FT0383, FT0382 match some of the HMDB reference
spectra for `r std`. Below we show the mirror plots of the best matches
(similarity score  greater than 0.7).

```{r mix07-water-neg-3-methylhistidine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

We obtain similar results for the MassBank comparison as we show below.

```{r mix07-water-neg-3-methylhistidine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0381 (RT = 187.59, ion `[M-H]-`) with confidence **A**.
- FT0654 (RT = 187.65, ion `[M+Cl]-`) with confidence **A-**.
- FT0729 (RT = 187.07, ion `[M+HCOO]-`) with confidence **A-**.
- Reference MS2: `[M-H]-`: FT0381_F15.S0572, FT0381_F15.S0641, FT0381_F16.S0571,
  FT0381_F16.S0648; high confidence.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT0381", "FT0654", "FT0729"),
                  confidence_level = c("A", "A-", "A-"))

## Get MS2 spectra:
ms2 <- std_ms2[c("FT0381_F15.S0572", "FT0381_F15.S0641", "FT0381_F16.S0571",
                 "FT0381_F16.S0648")]
ms2$confidence <- c("high")
```

```{r, add-ions, echo = FALSE}
```

```{r, add-ms2-spectra, echo = FALSE}
```


### 1-Methyluric acid

```{r, echo = FALSE}
std <- "1-Methyluric acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-1-methyluric-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix07-water-neg-1-methyluric-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from feature FT0479 match with good similarity some of the HMDB
reference spectra for `r std`. Below we show the mirror plots of the best
matches (similarity score  greater than 0.7).

```{r mix07-water-neg-1-methyluric-acid-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix07-water-neg-1-methyluric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- EIC signal for `[M-H]-` shows periodic signal. The selected feature might not
  be the first one.
- FT0479 (RT = 159.49, ion `[M-H]-`) with confidence **A**.
- Reference MS2: `[M-H]-`: FT0479_F15.S0464, FT0479_F16.S0459; high confidence.

```{r, echo = FALSE}
## Get MS2 spectra:
ms2 <- std_ms2[c("FT0479_F15.S0464", "FT0479_F16.S0459")]
ms2$confidence <- c("high")
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Phenylpyruvic acid

```{r, echo = FALSE}
std <- "Phenylpyruvic acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-phenylpyruvic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank but we don't obtain good matches.

```{r mix07-water-neg-phenylpyruvic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix07-water-neg-phenylpyruvic-acid-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.05, ppm = csp@ppm,
                           tolerance = csp@tolerance)
```

We obtain similar results with the MassBank comparison as we show below.

```{r mix07-water-neg-phenylpyruvic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- EIC signal for the selected feature looks good, but the signal for the ion
  *spills* across a long RT range.
- FT0328 (RT = 36.89, `[M-H]-` ion) with confidence level **D**.
- FT0697 (RT = 35.95, `[M+HCOO]-` ion) with confidence level **D**.
- Reference MS2: `[M-H]-`: FT0328_F15.S0087, FT0328_F16.S0112; low confidence.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT0328", "FT0697"),
                  confidence_level = c("D", "D"))

## Get MS2 spectra:
ms2 <- std_ms2[c("FT0328_F15.S0087", "FT0328_F16.S0112")]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE}
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Serine

```{r, echo = FALSE}
std <- "Serine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Three features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-serine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank but we don't find any match.

```{r mix07-water-neg-serine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix07-water-neg-serine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Since the extracted spectra are associated to an ion different from `[M-H]-`
(`[M+HCOO]-`) we perform a neutral loss spectra comparison but still no match
is found.

```{r mix07-water-neg-sphingosine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix07-water-neg-sphingosine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0040 (RT = 180.9, `[M-H]-` ion) with confidence **D**.


### Sphingosine

```{r, echo = FALSE}
std <- "Sphingosine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-sphingosine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

- FT2166 (RT = 37.22, `[M+HCOO]-` ion) confidence level **D**.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT2166"),
                  confidence_level = c("D"))

```

```{r, add-ions, echo = FALSE}
```


### Taurine

```{r, echo = FALSE}
std <- "Taurine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-taurine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

```{r mix07-water-neg-taurine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix07-water-neg-taurine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                           tolerance = csp@tolerance)
```

```{r mix07-water-neg-taurine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0093 (RT = 171, `[M-H]-` ion) with confidence **A**.
- Reference MS2: `[M-H]-`: FT0093_F15.S0497, FT0093_F16.S0496; high confidence.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT0093"),
                  confidence_level = c("A"))

## Get MS2 spectra:
ms2 <- std_ms2[c("FT0093_F15.S0497", "FT0093_F16.S0496")]
ms2$confidence <- c("high")
```

```{r, add-ions, echo = FALSE}
```

```{r, add-ms2-spectra, echo = FALSE}
```


### Threonic Acid

```{r, echo = FALSE}
std <- "Threonic Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix07-water-neg-threonic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank but we don't find any match.

```{r mix07-water-neg-threonic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix07-water-neg-threonic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- Inconclusive. Several features/peaks are present across a large RT range. The
  one selected below is the one with the highest intensity.
- FT0173 (RT = 126.6, `[M-H]-` ion) with confidence **D**.
- Reference MS2: `[M-H]-`: FT0173_F15.S0293, FT0173_F16.S0298; low confidence.

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT0173"),
                  confidence_level = c("D"))

## Get MS2 spectra:
ms2 <- std_ms2[c("FT0173_F15.S0293", "FT0173_F16.S0298")]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE}
```

```{r, add-ms2-spectra, echo = FALSE}
```


## Standards without any matching feature

# Summary on the ion database

Summarizing the content that was added to the `IonDb`.

```{r, iondb-summary, echo = FALSE, results = "asis"}
```

# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
