---
title: "Identifying mix01 standards in serum"
author: "Andrea Vicini, Vinicius Verri Hernandes, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_float: true
    toc_depth: 3
    fig_width: 5
---


```{r, include = FALSE, cached = FALSE}
knitr::read_chunk("R/match-standards-chunks.R")
MIX <- 1
MATRIX <- "Serum"
POLARITY <- "POS"
```

```{r, libraries, echo = FALSE, message = FALSE}
```
```{r, general-settings, echo = FALSE, message = FALSE}
```

**Current version: 0.9.0, 2022-03-09.**

# Introduction

Mixes of standards have been solved in water or added to human serum sample
pools in two different concentration and these samples were measured with the
LC-MS setup from Eurac (used also to generate the CHRIS untargeted metabolomics
data). Assignment of retention time and observed ion can be performed for each
standard based on MS1 information such as expected m/z but also based on the
expected difference in signal between samples with low and high concentration of
the standards. Finally, experimental fragment spectra provide the third level of
evidence. Thus, the present data set allows to annotate features to standards
based on 3 levels of evidence: expected m/z, difference in measured intensity
and MS2-based annotation.

A detailed description of the approach is given in
[match-standards-introduction.Rmd](match-standards-introduction.Rmd).


The list of standards that constitute the present sample mix are listed below
along with the expected retention time and the most abundant adduct for positive
and negative polarity as defined manually in a previous analysis by Mar
Garcia-Aloy.

```{r, standards-table, echo = FALSE, results = "asis"}
```

# Data import

We next load the data and split it according to matrix and polarity.

```{r, data-import}
```

We next also load the reference databases we will use to compare the
experimental MS2 spectra against. Below we thus load HMDB and MassBank data. We
create in addition *neutral loss* versions of the databases. Since HMDB does not
provide precusor m/z values we assume the fragment spectra to represent `[M+H]+`
ions (respectively `[M-H]-` ions for negative polarity) and add the m/z for
these adducts as *precursor m/z*.

```{r, load-reference-databases, message = FALSE}
```


# Initial evaluation of available MS2 data

Before performing the actual analysis that involves chromatographic peak
detection and evaluation of feature abundances, we compare all experimental MS2
spectra against the reference libraries. This provides already a first hint for
which standards a valid MS2 spectrum was recorded (and hence would allow
annotation based on evidence 3) and what related retention time might be.

We first extract all MS2 spectra from the respective data files and process them
by first removing all peaks with an intensity below 5% of the highest peak
signal, then scaling all intensities to a value range between 0 and 100 and
finally remove all MS2 spectra with less than 2 peaks.

```{r prepare-all-ms2}
fls <- fileNames(data_all)[data_all$polarity == "POS"]
```
```{r, all-ms2}
```

We next match these spectra against all reference spectra from HMDB for the
standards in `r MIX_NAME`. 

The settings for the matching are defined below. These will be used for all MS2
spectra similarity calculations. All matching spectra with a similarity larger
0.7 are identified.

```{r, compare-spectra-param}
```
 
Standards for which no MS2 spectrum in HMDB is present are listed in
the table below.

```{r, echo = FALSE, results = "asis"}
tmp <- std_dilution01[!(std_dilution01$HMDB %in% hmdb_std$compound_id), ]
pandoc.table(tmp[, c("name", "HMDB", "formula")], style = "rmarkdown",
             caption = "Standards for which no reference spectrum is available")
```

The table below lists all standards and the number of matching reference spectra
(along with their retention times).

```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We repeat the same analysis for the negative polarity data (code not shown
again).

```{r, echo = FALSE}
fls <- fileNames(data_all)[data_all$polarity == "NEG"]
```
```{r, all-ms2, echo = FALSE}
```
```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We next perform the full analysis of the data set involving MS1 and MS2 data.


# Serum, positive polarity

We now perform the analysis on the samples with the standards solved in
serum acquired in positive polarity mode.

```{r}
POLARITY <- "POS"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_pos
hmdb_nl <- hmdb_pos_nl
```

## Data pre-processing

We perform the pre-processing of our data set which consists of the
chromatographic peak detection followed by a peak refinement step to reduce peak
detection artifacts, the correspondence analysis to group peaks across samples
and finally the gap-filling to fill in missing peak data from samples in which
no chromatographic peak was detected.

Some notes on the settings for the pre-processing:

- The `bw` parameter for the correspondence is larger than usual because adding
  the standards in higher concentrations caused considerable retention time
  shifts for some. A higher `bw` will allow to group also mis-aligned
  chromatographic peaks - but will not allow to discriminate between closely
  eluting ions.
- The `binSize` was also slightly increased to avoid splitting of features with
  similar m/z values.

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```

## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-pos}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution01)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.


## Standards with matching features

While for some standards a matching feature was found we still need to evaluate
whether this matching is correct. For each standard we thus first evaluate the
EICs for all matching features, then we match their MS2 spectra (if available)
against reference libraries. To ensure correct assignment of a feature, its
retention time and eventually related MS2 spectra, we consider the following
criteria to determine the annotation confidence:

- feature(s) was/were found with m/z matching those of adduct(s) of the 
  standard.
- signal is higher for samples with higher concentration.
- MS2 spectra matches reference spectra for the standard (if available).
- MS2 spectra don't match MS2 spectra of other compounds.


### 3-Phosphoglyceric Acid

```{r, echo = FALSE}
std <- "3-Phosphoglyceric Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

A considerable number of features has been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB.

```{r mix01-serum-pos-3-phosphoglyceric-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

It seems that no extracted MS2 spectra matches well the reference ones from
3-Phosphoglyceric Acid. The maximum score is around 0.08 and is attained by a
spectrum from FT02219. The only two matches with score greater than 0.07 are
shown below.

```{r mix01-serum-pos-3-phosphoglyceric-acid-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.07,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

The spectra don't seem to match well.

In addition we compare all spectra against reference spectra from MassBank for
the selected standard. 

```{r mix01-serum-pos-3-phosphoglyceric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Since all the extracted MS2 spectra are associated to ions different from
[M+H]+ we also perform a comparison between the neutral loss spectra from HMDB
and MassBank.

```{r mix01-serum-pos-3-phosphoglyceric-acid-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-serum-pos-3-phosphoglyceric-acid-mirror-hmdb_nl, echo = FALSE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2_nl, std_hmdb_nl, 0.03,
                               ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

The matches are not that good.

```{r mix01-serum-pos-3-phosphoglyceric-acid-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

```{r mix01-serum-pos-3-phosphoglyceric-acid-mirror-mbank_nl, echo = FALSE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2_nl, std_mbank_nl, 0.03,
                               ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

No good matches were found. In addition we match (**all**) the MS2 spectra for
the matched features against all spectra from HMDB or MassBank identifying
reference spectra with a similarity larger than 0.7. The results (if any spectra
matched) are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- Inconclusive - would evaluate data in water first and eventually lift results
  over (as additional evidence).
- Only features for ions other than `[M+H]+` are identified, but their MS2
  spectra don't match any spectra from any database - even not with their
  neutral loss version.
- Annotation of FT02219 (RT=115, `[M+Na]+` ion) to `r std` with confidence level
  **C**? Or **D** because the score of the match between MS2 spectra was close
  to 0? 
- FT02581 was grouped together FT02219 so it should get the same confidence
  level? 
- Reference MS2: F08.S0419 (with a very *low* grading?)
- What about the other features. Should we give them confidence **D** or can
  we exclude them with other considerations?


### Acetylhistidine

```{r, echo = FALSE}
std <- "Acetylhistidine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-pos-acetylhistidine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Some of the MS2 spectra for FT02020 and FT02023 have a high similarity against
MS2 spectra from `r std`. Mirror plots for the best matching spectra are shown
below.

```{r mix01-serum-pos-acetylhistidine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

These matches are very nice. In addition we perform also the match against
reference spectra for that standard from MassBank.

```{r mix01-serum-pos-acetylhistidine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Surprisingly no spectrum matches MassBank.

FT02730 and FT02372 correspond to `[M+2Na-H]+` and `[M+Na]+` ions of `r std`.
We check if matches beetween neutral loss spectra would be found.

```{r mix01-serum-pos-acetylhistidine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

The same spectra match also with their neutral loss versions.

```{r mix01-serum-pos-acetylhistidine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

For Massbank we don't get any additional matches.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```


#### Summary

- FT02020 (RT=182.5, `[M+H]+` ion) matches MS2 spectra of `r std`. High
  similarity matches against other compounds are from related compounds, but
  differ in their precursor m/z. Confidence **A**.
- Reference MS2: F08.S0632, F07.S0638. F08.S0806 and F07.S0810 have a much
  higher retention time and will thus not be considered.
- Unclear: FT02730 (`[M+2Na-H]+` ion) and FT02372 (`[M+Na]+` ion). Their MS2
  spectra don't match as expected. Maybe best to not consider? Unless we find
  an explanation why their neutral loss spectra don't match the one from
  `[M+H]+`.
  

### Betaine

```{r, echo = FALSE}
std <- "Betaine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-pos-betaine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

MS2 spectra for FT00644 (F07.S0573, F07.S0602, F08.S0601) match the reference
spectra from Betaine with high scores.

```{r mix01-serum-pos-betaine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we compare against MassBank spectra.

```{r mix01-serum-pos-betaine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

The same MS2 spectra match, albeit with a lower similarity.

We check in addition if matches between neutral loss spectra would be found.

```{r mix01-serum-pos-betaine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

Neutral loss spectra don't match because there seems to be an offset (by 1.008)
in the precursor m/z values.

```{r mix01-serum-pos-betaine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

Note however that neutral loss spectra for the `[M+H]+` feature FT00644 and the
`[M+Na]+` feature FT01012 do match to some degree:

```{r}
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
plotSpectraMirror(std_ms2_nl["FT01012_F07.S0563"],
                  std_ms2_nl["FT00644_F07.S0573"], tolerance = 0.1)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank (requiring a high similarity).

```{r, echo = FALSE, message = FALSE, results = "asis", eval = TRUE}
std_ms2_nl <- neutralLoss(std_ms2, PrecursorMzParam())
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl, similarity = 0.9)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = TRUE}
perform_match(std_ms2_nl, mbank_nl, similarity = 0.9,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```


#### Summary

- MS2 spectra for FT00644 (RT=163.4, `[M+H]+` ion) matches Betaine with
  confidence **B** (or maybe A because Abromine is in fact Betaine?).
- Reference MS2: F08.S0573, F07.S0602, F07.S0601.


### C3 Carnitine

```{r, echo = FALSE}
std <- "C3 Carnitine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-pos-c3-carnitine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix01-serum-pos-c3-carnitine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

No reference spectrum is available in HMDB or MassBank.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = TRUE}
std_ms2_nl <- neutralLoss(std_ms2, PrecursorMzParam())
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl, similarity = 0.7)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = TRUE}
perform_match(std_ms2_nl, mbank_nl, similarity = 0.7,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- Inconclusive: consider/check data in water.
- FT02651 (RT=163.8, `[M+NH4]+`): confidence level **D**?


### CDP

```{r, echo = FALSE}
std <- "CDP"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-pos-cdp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Both spectra (F07.S0864 and F07.S0892) of feature FT06282 match to one
reference spectrum of CDP with high similarity.

```{r mix01-serum-pos-cdp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

Unfortunately, the match based on a single peak (note however that the precursor
peaks are also very close).

In addition we compare against MassBank spectra.

```{r mix01-serum-pos-cdp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

No match against MassBank can be found.

We check in addition if matches between neutral loss spectra would be found.

```{r mix01-serum-pos-cdp-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

Not unexpectedly, the same spectra match also with their neutral losses.

```{r mix01-serum-pos-cdp-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

We don't have a good match against MassBank.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank (requiring a high similarity).

```{r, echo = FALSE, message = FALSE, results = "asis", eval = TRUE}
std_ms2_nl <- neutralLoss(std_ms2, PrecursorMzParam())
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl, similarity = 0.9)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = TRUE}
perform_match(std_ms2_nl, mbank_nl, similarity = 0.9,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT06282 (RT=260.8, `[M+H]+`): confidence level **B** (could be A, but match is
  based on a single peak).
- Reference spectra: F23.S0892, F23.S0864.


### Creatine

```{r, echo = FALSE}
std <- "Creatine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-pos-creatine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

MS2 spectra for FT00872 (F07.S0633 and F08.S0630) match with a low similarity
against reference spectra from HMDB. Mirror plots for these are shown below.

```{r mix01-serum-pos-creatine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.2,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we compare against MassBank spectra.

```{r mix01-serum-pos-creatine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Also here there is a single match with a low similarity.

We check in addition if matches between neutral loss spectra would be found.

```{r mix01-serum-pos-creatine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

Neutral loss version of MS2 spectrum F07.S0621 for feature FT01669 matches the
(neutral loss) reference spectrum for creatine from HMDB - even better than the
MS2 spectra for FT00872.

```{r mix01-serum-pos-creatine-mirror-hmdb-nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2_nl, std_hmdb_nl, 0.5,
                               ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

Thus, FT01669 is truly an `[M+2Na-H]+` ion of `r std`.

```{r mix01-serum-pos-creatine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank (requiring a high similarity).

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
std_ms2_nl <- neutralLoss(std_ms2, PrecursorMzParam())
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl, similarity = 0.9)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl, similarity = 0.9,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- MS2 spectra for FT00577, FT00579 and FT00580 match neutral loss spectra from
  creatine, but their retention times are very different. Also, their MS2
  spectra match those of creatinine.
- FT00872 (RT=176, `[M+H]+` ion): confidence **C**: the MS2 spectrum F07.S0633
  matches only `r std` with a low similarity.
- FT01669 (RT=173.3, `[M+2Ma-H]+` ion): neutral loss spectrum of F07.S0621
  matches reference spectrum with high simlarity. Confidence **B**.
- FT01309 (RT=175.4, `[M+Na]+` ion) inherit confidence from above - or drop
  because the MS2 spectrum does not match any other?
- Reference spectra: F07.S0621, F07.S0630 and F07.S0633.

### Dimethylglycine

```{r, echo = FALSE}
std <- "Dimethylglycine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

The only MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectrum against the reference spectra for 
`r std` from HMDB.

```{r mix01-serum-pos-dimethylglycine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The spectrum does thus not match any reference spectra from `r std`. In addition
we compare it aginst the reference spectra from MassBank for the selected
standard.

```{r mix01-serum-pos-dimethylglycine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Again, we don't obtain any match. Since the extracted spectrum is associated to
an ion different from `[M+H]+` (`[M+2Na-H]+`) we also perform a comparison
between the neutral loss spectra from HMDB and MassBank.

```{r mix01-serum-pos-dimethylglycine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-serum-pos-dimethylglycine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

We don't get any match.

In addition we match (**all**) the MS2 spectra for the
matched features against all spectra from HMDB or MassBank identifying reference
spectra with a similarity larger than 0.7. The results (if any spectra matched)
are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

The neutral loss version of the only available MS2 spectra beside `r std`
strangely matches a lot of other reference compounds.

#### Summary

- Inconclusive: check water data.
- Maybe FT01184 (RT = 174.6, `[M+2Na-H]+` ion)?
- FT00753 (RT = 175, `[M+Na]+` ion) inherit from above.
- FT00428 (RT = 178.6, `[M+H]+` ion) inherit from above.


### Glycerol

```{r, echo = FALSE}
std <- "Glycerol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect it.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Unfortunately no MS2 spectra is available.

#### Summary

- Inconclusive: check water data.
- FT00947 with confidence **D**? But its EIC maybe doesn't look that good
- No MS2 spectra.


### L-Glutamic Acid

```{r, echo = FALSE}
std <- "L-Glutamic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-serum-pos-l-glutamic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra for FT001191 seem to have quite high similarity
against HMDB MS2 spectra from `r std`. Mirror plots for the best matching
spectra (similarity higher than 0.9) are shown below.

```{r mix01-serum-pos-l-glutamic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.9, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

Thus, the best matching spectra are F07.S0695 and F08.S0682.

We also perform the comparison against reference spectra from MassBank and find
the same two MS2 spectra matching.

```{r mix01-serum-pos-l-glutamic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```


```{r mix01-serum-pos-l-glutamic-acid-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2, std_mbank, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

We also perform the comparison using the neutral loss version of the spectra.

```{r mix01-serum-pos-l-glutamic-acid-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

In addition to the previous matches also MS2 spectrum F07.S0636 of FT01568
matches one neutral loss reference spectrum.

```{r mix01-serum-pos-l-glutamic-acid-mirror-hmdb_nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2_nl, std_hmdb_nl, 0.7, ppm = csp_nl@ppm,
                           tolerance = csp_nl@tolerance)
```

This match is however based on a single peak.

```{r mix01-serum-pos-l-glutamic-acid-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

Next to the expected 2 matching spectra, also MS2 spectra for FT01568 (`[M+Na]+`
ion) matches with a lower similarity score. Below we show all matches with a
similarity higher than 0.4.

```{r mix01-serum-pos-l-glutamic-acid-mirror-mbank_nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2_nl, std_mbank_nl, 0.4,
                           ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

Also the neutral loss version of MS2 spectrum F07.S0636 for FT01568 matches the
neutral loss spectra of `r std`, although only with a single peak.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```
  
MS2 spectra associated to feature FT0693, FT1018 have been matched to reference
spectra from L-Glutamic Acid but also from other compounds with relatively high
scores in both cases.

No match is found for HMDB (?) while for MassBank F23.S0695 and F24.S0682
(from FT01189) are matched again. Additionally also F23.S0636 (from FT01566) 
matches but with lower score. Below we plot the matches for this last spectrum
with similarity > 0.4.

#### Summary

- FT01191 (RT=182.5, `[M+H]+` ion): confidence level **A**. Its MS2 spectra
  (F23.S0695 and F24.S0682) match `r std`. Matches with other compounds have
  large differences in precursor m/z.
- FT01933 (RT=179.9, `[M+2Na-H]+` ion): MS2 spectrum does not match
  anything. Confidence **D** based on similar EIC?
- FT00847 (RT=180.1, `[M+H-NH3]+`] ion): confidence level **B-**. Depends if
  that compound can loose an NH3!
- FT01568 (RT=179.9, `[M+Na]+`] ion): confidence level **C**. MS2 spectrum
  F07.S0636 matches neutral loss reference spectra.
- Reference MS2 spectra: F07.S0695 and F08.S0682, F07.S0636 for the `[M+Na]+`
  ion.


### Myo-Inositol

```{r, echo = FALSE}
std <- "Myo-Inositol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB and
MassBank. The results are shown in the heatmaps below.

```{r mix01-serum-pos-myo-inositol-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix01-serum-pos-myo-inositol-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

None of the extracted spectra matches reference spectra from `r std`. We also
check if there are matches between neutral loss spectra.

```{r mix01-serum-pos-myo-inositol-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-serum-pos-myo-inositol-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

We don't find any match also in this case. In addition we match (**all**) the
MS2 spectra for the matched features against all spectra from HMDB or MassBank
identifying reference spectra with a similarity larger than 0.7. The results
(if any spectra matched) are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- Inconclusive: check water data.
- FT02027 is **not** `r std`. Inconclusive for all others.


### Pyruvic Acid

```{r, echo = FALSE}
std <- "Pyruvic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r std` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

We next look if there are MS2 spectra associated to this feature but we don't
find any.

```{r , echo = FALSE}
plot_spectra(std_ms2)
```


#### Summary

- Inconclusive; no MS2 spectra available.


### Suberic Acid

```{r, echo = FALSE}
std <- "Suberic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from a few different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

We have thus MS2 spectra for feature around 140. Next we compare them
against the reference spectra for `r std` from HMDB and MassBank. The results
are shown in the heatmaps below.

```{r mix01-serum-pos-suberic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix01-serum-pos-suberic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Strangely every match has score equal to 0 in both cases. In addition we
also look for matches between neutral loss spectra.

```{r mix01-serum-pos-suberic-acid-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-serum-pos-suberic-acid-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

The extracted spectra match with high similarity reference spectra 
of other compounds than `r std`.

#### Summary

- Inconclusive: check water data.


### Xanthine

```{r, echo = FALSE}
std <- "Xanthine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from two compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

We have thus MS2 spectra for the set of features with retention time around 140.
Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-serum-pos-xanthine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra for FT01285 (F23.S0505 and F24.S0515) have the highest
similarity against MS2 spectra from `r std`. Mirror plots for the best matching
spectra are shown below.

```{r mix01-serum-pos-xanthine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

We repeat the comparison using MassBank reference spectra and we obtain similar
results as shown below.

```{r mix01-serum-pos-xanthine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix01-serum-pos-xanthine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

We also check if there are matches between neutral loss spectra.

```{r mix01-serum-pos-xanthine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-serum-pos-xanthine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

Additional spectra matching with their neutral loss version seem to match
however only with a single peak that matches also ~ the precursor m/z.

```{r mix01-serum-pos-xanthine-mirror-massbank-nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2_nl, std_mbank_nl, 0.5,
                           ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

Based on both HMDB and MassBank the extracted spectra match reference spectra of
compounds different from `r std` with higher similarity.

#### Summary

- FT01287 (RT=141.4, `[M+H]+` ion): confidence level **B**.
- FT00926 (RT=141.2, `[M+H-NH3]+` ion): confidence level **B-**.
- FT01910 (RT=141.2, `[M+K]+` ion): confidence level **B-**.
- FT01647 (RT=141.7, `[M+Na]+` ion): confidence level **B-**.
- FT02004 (RT=142.7, `[M+2Na-H]+` ion): confidence level **B-**.
- Very puzzling that the neutral loss spectra of the different adducts don't
  match.
- Reference MS2: F07.S0505 and F08.S0515 (from FT01287). Question is what to do
  with all the other spectra? Keep them as reference for other ions?

### Uric acid

```{r, echo = FALSE}
std <- "Uric acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from two compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SP", std_ms2)
```

Signal is very low for all of the features. And also no MS2 spectra were
found.

```{r , echo = FALSE}
plot_spectra(std_ms2)
```


#### Summary

- Inconclusive.

# Serum, negative polarity

We now perform the analysis on the samples with the standards still solved in
pure serum but acquired in negative polarity mode.

```{r}
POLARITY <- "NEG"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_neg
hmdb_nl <- hmdb_neg_nl
```

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```

## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-neg}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution01)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards with matching features

### 3-Phosphoglyceric Acid

```{r, echo = FALSE}
std <- "3-Phosphoglyceric Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-neg-3-phosphoglyceric-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectrum matches reference spectra from HMDB with high similarity.
Mirror plots for the best matching spectra are shown below.

```{r mix01-serum-neg-3-phosphoglyceric-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition, we perform also the match against reference spectra of `r std`
from MassBank. MS2 spectrum F15.S0765 for FT0911 matches the reference spectra
from HMDB. 

```{r mix01-serum-neg-3-phosphoglyceric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Surprisingly no spectrum matches MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT0911 (RT=251, `[M-H]-` ion); MS2 spectrum F15.S0765 matches the reference
  spectra for 3-Phosphoglyceric acid and also 2-Phosphoglyceric acid. Annotation
  confidence **B**.
- FT0908 (RT=266.1 `[M-H]-` ion) is the same as the feature above, thus this
  retention time should be assigned/used.


### Acetylhistidine

```{r, echo = FALSE}
std <- "Acetylhistidine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-neg-acetylhistidine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra F16.S0549, F15.S0586 (and maybe F16.S0599) from feature FT1073
have a quite high similarity against MS2 some spectra from `r std`.
Mirror plots for the best matching spectra are shown below.

```{r mix01-serum-neg-acetylhistidine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition, we perform also the match against reference spectra of `r std`
from MassBank.

```{r mix01-serum-neg-acetylhistidine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Surprisingly no spectrum matches MassBank. We also check if there are matches 
between neutral loss spectra for both HMDB and MassBank.

```{r mix01-serum-neg-acetylhistidine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-serum-neg-acetylhistidine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

The same spectra match also with their neutral loss versions.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT1073 (RT=177.1, `[M-H]-` ion): confidence level **A**.
- Reference MS2: F15.S0586, F16.S0549, F16.S0599.


### Betaine

```{r, echo = FALSE}
std <- "Betaine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time these features might represent signal
from the same compound.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r , echo = FALSE}
plot_spectra(std_ms2)
```


#### Summary

- Inconclusive: check water data.
- FT0616 (RT=156.2, `[M+HCOO]-` ion): confidence level **D**.
- FT0496 (RT=159.6, `[M+Cl]-` ion): confidence level as above.
- No MS2 spectra associated to the features.


### CDP

```{r, echo = FALSE}
std <- "CDP"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds. Note that FT4523 and FT4519 are essentially
representing the same signal, only that (for unclear reasons) a different
feature was defined for a single MSMS data file.

We next plot the EIC for the assigned feature and visually inspect these. EICs
look rather noisy and large retention time shifts between the samples are
visible.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-neg-cdp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

All MS2 spectra for FT4523 match very well those of `r std` from HMDB.
Mirror plots for the best matching spectra are shown below.

```{r mix01-serum-neg-cdp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition, we perform also the match against reference spectra of `r std`
from MassBank.

```{r mix01-serum-neg-cdp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT4519 (RT=264.4, `[M-H]-` ion): confidence level **A**. Its MS2 spectra (or
  better said those of FT4523) match the reference spectra of `r std`.  Matches
  with other compounds have large differences in precursor m/z.
- Reference MS2: F16.S0794, F16.S0840, F15.S0801, F15.S0838.


### Dimethylglycine

```{r, echo = FALSE}
std <- "Dimethylglycine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the only feature matched to `r std` and show it below.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Unfortunately no MS2 spectra associated to FT0087 is available.

#### Summary

- Inconclusive: check water data.
- FT0087 (RT=177, `[M-H]-` ion): confidence level **D**.


### Glycerol

```{r, echo = FALSE}
std <- "Glycerol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Also for `r std` we have only one match. We next plot the and show the EIC
of the realted feature.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Unfortunately no MS2 spectra is available.

#### Summary

- Inconclusive: check water data.
- very low signal. Seems nothing properly detected.

### L-Glutamic Acid

```{r, echo = FALSE}
std <- "L-Glutamic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from 2 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-serum-neg-l-glutamic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra F15.S0592, F16.S0560, F16.S0611 (from FT0433) have quite
high similarity against some MS2 spectra from `r std`. Mirror plots for the
best matching spectra (similarity higher than 0.7) are shown below.

```{r mix01-serum-neg-l-glutamic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

We perform also the match against reference spectra for that standard from
MassBank obtaining similar results as shown in the heatmap below.

```{r mix01-serum-neg-l-glutamic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

Extracted spectra match also reference spectra of compounds different from
`r std`. 

#### Summary

- FT0433(RT=176.4, `[M-H]-` ion): confidence level **B**. We can't discriminate
  between L-Glutamic Acid and DL-Glutamate.
- Reference MS2: F15.S0592, F16.S0560, F16.S0611.


### Myo-Inositol

```{r, echo = FALSE}
std <- "Myo-Inositol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

The only available MS2 spectrum available for the above features is shown below.

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare it against the reference spectra for `r std` from HMDB
and MassBank.

```{r mix01-serum-neg-myo-inositol-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix01-serum-neg-myo-inositol-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In both cases the extracted spectrum does not match any reference spectra from
`r std`. Since feature FT1334, the feature associated to the available spectrum,
was matched to an ion (`[M+Cl]-`) different from `[M-Cl]-` we also look at
neutral loss spectra.

```{r mix01-serum-neg-myo-inositol-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-serum-neg-myo-inositol-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

As for the MassBank comparison we don't find any match while for the HMDB one
we find a few matches with low score. Below we report the only match with score
above 0.05.

```{r mix01-serum-neg-myo-inositol-mirror-hmdb-nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2_nl, std_hmdb_nl, 0.05,
                           ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

The matches don't look that good.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = TRUE}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = TRUE}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

In any case, no match with similarity higher than 0.7 is found.

#### Summary

- Inconclusive: check water data.
- FT1334 (RT = 193.7, `[M+Cl]-` ion) with confidence **C** (because of the
  neutral loss spectra match)?
- FT1460 (RT = 192.2, `[M+HCOO]-` ion) and FT0834 (RT = 192.2, `[M-H]-` ion)
  inheriting confidence level from FT1334.
- other features with confidence **D**?


### propionic acid

```{r, echo = FALSE}
std <- "propionic acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

```{r mix01-serum-neg-propionic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix01-serum-neg-propionic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

The extracted MS2 spectrum doesn't match any reference spectra of `r std` from
HMDB or MassBank. In addition we match (**all**) the MS2 spectra for the
matched features against all spectra from HMDB or MassBank identifying
reference spectra with a similarity larger than 0.7. The results (if any
spectra matched) are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- Inconclusive: check water data.
- Only a single MS2 spectra that doesn't match with any reference spectrum and
  looking at the EICs the intensity is relatively low for all features .


### Pyruvic Acid

```{r, echo = FALSE}
std <- "Pyruvic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

We next look if there are MS2 spectra associated to the above features.

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB and
MassBank.

```{r mix01-serum-neg-pyruvic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix01-serum-neg-pyruvic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

No match is found in both cases. Although FT0044 and FT0043 are both from ion
`[M-H]-`, we also perform a neutral loss comparison. While for HMDB no match is 
found, surprisingly we get matches in the MassBank case. Below we plot those
with a similarity score greater than 0.4.

```{r mix01-serum-neg-pyruvic-acid-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-serum-neg-pyruvic-acid-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

```{r mix01-serum-neg-pyruvic-acid-mirror-massbank-nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2_nl, std_mbank_nl, 0.4,
                           ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

These matches look however not that promising.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
std_ms2_sel <- Spectra()
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

No match involving `r std` was found but similarity with MS2 spectra for
Ascorbic acid are high.

#### Summary

- Inconclusive: check water data.
- Only MS2 spectra from FT0043 are available but they don't match reference
  spectra of `r std` (but those of ascorbic acid).


### Suberic Acid

```{r, echo = FALSE}
std <- "Suberic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from 3(or 4?) different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB. The results are shown in
the heatmap below.

```{r mix01-serum-neg-suberic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

MS2 spectra of FT0757 seem to match well. Mirror plots for the best matching
spectra are shown below.

```{r mix01-serum-neg-suberic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we perform also the match against reference spectra for that
standard from MassBank.

```{r mix01-serum-neg-suberic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0757 (RT=37.3, `[M-H]-` ion): confidence level **A**.
- FT1399 (RT=37.3, `[M+HCOO]-` ion) inherits confidence level **A** from FT0757.
- Reference MS2: F15.S0148, F15.S0260.


### Uric acid

```{r, echo = FALSE}
std <- "Uric acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We show the EICs for the features above.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

We next look if there are MS2 spectra associated to the above features.

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

- Inconclusive: check water data.
- No MS2 spectra is available, the EIC of the only matched feature has low
  signal and maybe don't look good.


### Xanthine

```{r, echo = FALSE}
std <- "Xanthine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

Based on their retention time, it seems that these features represent signal
from 3 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, tmp, "SN", std_ms2)
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

- Inconclusive: check water data.

## Standards without any matching feature

### C3 Carnitine
### Creatine

# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
