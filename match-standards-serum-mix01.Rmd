---
title: "Identifying mix01 standards in serum"
author: "Andrea Vicini, Vinicius Verri Hernandes, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_float: true
    toc_depth: 3
    fig_width: 5
---


```{r, include = FALSE, cached = FALSE}
knitr::read_chunk("R/match-standards-chunks.R")
MIX <- 1
MATRIX <- "Serum"
POLARITY <- "POS"
## settings to find MS2 spectra for features. Be rather inclusive here.
FEATURE_MS2_PPM <- 20
FEATURE_MS2_TOLERANCE <- 0.05
```

```{r, libraries, echo = FALSE, message = FALSE}
```
```{r, general-settings, echo = FALSE, message = FALSE}
```

**Current version: 0.10.1, 2024-10-29.**

# Introduction

Mixes of standards have been solved in water or added to human serum sample
pools in two different concentration and these samples were measured with the
LC-MS setup from Eurac (used also to generate the CHRIS untargeted metabolomics
data). Assignment of retention time and observed ion can be performed for each
standard based on MS1 information such as expected m/z but also based on the
expected difference in signal between samples with low and high concentration of
the standards. Finally, experimental fragment spectra provide the third level of
evidence. Thus, the present data set allows to annotate features to standards
based on 3 levels of evidence: expected m/z, difference in measured intensity
and MS2-based annotation.

A detailed description of the approach is given in
[match-standards-introduction.Rmd](match-standards-introduction.Rmd).


The list of standards that constitute the present sample mix are listed below
along with the expected retention time and the most abundant adduct for positive
and negative polarity as defined manually in a previous analysis by Mar
Garcia-Aloy.

```{r, standards-table, echo = FALSE, results = "asis"}
```

```{r}
#' Add missing retention times...
std_dilution$RT[std_dilution$HMDB == "HMDB0000824"] <- 163
std_dilution$RT[std_dilution$HMDB == "HMDB0001546"] <- 260

```


# Data import

We next load the data and split it according to matrix and polarity.

```{r, data-import}
```

We next also load the reference databases we will use to compare the
experimental MS2 spectra against. Below we thus load HMDB and MassBank data. We
create in addition *neutral loss* versions of the databases. Since HMDB does not
provide precusor m/z values we assume the fragment spectra to represent `[M+H]+`
ions (respectively `[M-H]-` ions for negative polarity) and add the m/z for
these adducts as *precursor m/z*.

```{r, load-reference-databases, message = FALSE}
```

```{r, setup-ion-db, message = FALSE, echo = FALSE}
```

# Initial evaluation of available MS2 data

Before performing the actual analysis that involves chromatographic peak
detection and evaluation of feature abundances, we compare all experimental MS2
spectra against the reference libraries. This provides already a first hint for
which standards a valid MS2 spectrum was recorded (and hence would allow
annotation based on evidence 3) and what related retention time might be.

We first extract all MS2 spectra from the respective data files and process them
by first removing all peaks with an intensity below 5% of the highest peak
signal, then scaling all intensities to a value range between 0 and 100 and
finally remove all MS2 spectra with less than 2 peaks.

```{r prepare-all-ms2}
fls <- fileNames(data_all)[data_all$polarity == "POS"]
```
```{r, all-ms2}
```

We next match these spectra against all reference spectra from HMDB for the
standards in `r MIX_NAME`. 

The settings for the matching are defined below. These will be used for all MS2
spectra similarity calculations. All matching spectra with a similarity larger
0.7 are identified.

```{r, compare-spectra-param}
```
 
Standards for which no MS2 spectrum in HMDB is present are listed in
the table below.

```{r, echo = FALSE, results = "asis"}
tmp <- std_dilution[!(std_dilution$HMDB %in% hmdb_std$compound_id), ]
pandoc.table(tmp[, c("name", "HMDB", "formula")], style = "rmarkdown",
             caption = "Standards for which no reference spectrum is available")
```

The table below lists all standards and the number of matching reference spectra
(along with their retention times).

```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We repeat the same analysis for the negative polarity data (code not shown
again).

```{r, echo = FALSE}
fls <- fileNames(data_all)[data_all$polarity == "NEG"]
```
```{r, all-ms2, echo = FALSE}
```
```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We next perform the full analysis of the data set involving MS1 and MS2 data.


# Serum, positive polarity

We now perform the analysis on the samples with the standards solved in
serum acquired in positive polarity mode.

```{r}
POLARITY <- "POS"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_pos
hmdb_nl <- hmdb_pos_nl
```

## Data pre-processing

We perform the pre-processing of our data set which consists of the
chromatographic peak detection followed by a peak refinement step to reduce peak
detection artifacts, the correspondence analysis to group peaks across samples
and finally the gap-filling to fill in missing peak data from samples in which
no chromatographic peak was detected.

Some notes on the settings for the pre-processing:

- The `bw` parameter for the correspondence is larger than usual because adding
  the standards in higher concentrations caused considerable retention time
  shifts for some. A higher `bw` will allow to group also mis-aligned
  chromatographic peaks - but will not allow to discriminate between closely
  eluting ions.
- The `binSize` was also slightly increased to avoid splitting of features with
  similar m/z values.

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```

## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-pos}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.


## Standard evaluation

While for some standards a matching feature was found we still need to evaluate
whether this matching is correct. For each standard we thus first evaluate the
EICs for all matching features, then we match their MS2 spectra (if available)
against reference libraries. To ensure correct assignment of a feature, its
retention time and eventually related MS2 spectra, we consider the following
criteria to determine the annotation confidence:

- feature(s) was/were found with m/z matching those of adduct(s) of the 
  standard.
- signal is higher for samples with higher concentration.
- MS2 spectra matches reference spectra for the standard (if available).
- MS2 spectra don't match MS2 spectra of other compounds.

### 3-Phosphoglyceric Acid

```{r, echo = FALSE}
std <- "3-Phosphoglyceric Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix01-serum-pos-3-phosphoglyceric-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB.

```{r mix01-serum-pos-3-phosphoglyceric-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

There are no good matches, but fragment spectra were recorded for an ion
different than [M+H]+, thus, that is not surprising.

```{r mix01-serum-pos-3-phosphoglyceric-acid-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.1, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

In addition we compare all spectra against reference spectra from MassBank for
the selected standard. 

```{r mix01-serum-pos-3-phosphoglyceric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Since all the extracted MS2 spectra are associated to ions different from
[M+H]+ we also perform a comparison between the neutral loss spectra from HMDB
and MassBank.

```{r mix01-serum-pos-3-phosphoglyceric-acid-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-serum-pos-3-phosphoglyceric-acid-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for
the matched features against all spectra from HMDB or MassBank identifying
reference spectra with a similarity larger than 0.7. The results (if any spectra
matched) are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT01022", "FT01843"),
                  confidence_level = c("C", "C-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT01022_F07.S0888"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Acetylhistidine

```{r, echo = FALSE}
std <- "Acetylhistidine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix01-serum-pos-acetylhistidine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-pos-acetylhistidine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Mirror plots for the best matching spectra are shown below.

```{r mix01-serum-pos-acetylhistidine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

These matches are very nice. In addition we perform also the match against
reference spectra for that standard from MassBank.

```{r mix01-serum-pos-acetylhistidine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT02722", "FT02364", "FT02012"),
                  confidence_level = c("A-", "A-", "A"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT02722_F07.S0623", "FT02722_F08.S0623",
                       "FT02364_F07.S0688", "FT02364_F08.S0622",
                       "FT02364_F08.S0687", "FT02012_F07.S0638",
                       "FT02012_F08.S0632"),
                     spectraNames(std_ms2))]
ms2$confidence <- c(rep("low", 5), rep("high", 2))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Betaine

```{r, echo = FALSE}
std <- "Betaine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix01-serum-pos-betaine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-pos-betaine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We have several high matches.

```{r mix01-serum-pos-betaine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

In addition we compare against MassBank spectra.

```{r mix01-serum-pos-betaine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

The same MS2 spectra match, albeit with a lower similarity.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT01005", "FT01336", "FT00636", "FT02643"),
                  confidence_level = c("B-", "B-", "B", "B-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT01005_F07.S0563", "FT01005_F07.S0596",
                       "FT01005_F08.S0576", "FT00636_F07.S0573",
                       "FT00636_F07.S0602", "FT00636_F08.S0601",
                       "FT02643_F07.S0597"),
                     spectraNames(std_ms2))]
ms2$confidence <- c(rep("low", 3), rep("high", 3), "low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### C3 Carnitine

```{r, echo = FALSE}
std <- "C3 Carnitine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-pos-c3-carnitine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix01-serum-pos-c3-carnitine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

No reference spectrum is available in HMDB or MassBank.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

We will not add information for this compound since the selected feature was
selected already for Betaine.

### CDP

```{r, echo = FALSE}
std <- "CDP"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix01-serum-pos-cdp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-pos-cdp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Both spectra (F07.S0864 and F07.S0892) of feature FT06282 match to one
reference spectrum of CDP with high similarity.

```{r mix01-serum-pos-cdp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

Unfortunately, the match based on a single peak (note however that the precursor
peaks are also very close).

In addition we compare against MassBank spectra.

```{r mix01-serum-pos-cdp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

No match against MassBank can be found.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT06269"),
                  confidence_level = c("B"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT06269_F07.S0864", "FT06269_F07.S0892"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Creatine

```{r, echo = FALSE}
std <- "Creatine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix01-serum-pos-creatine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-pos-creatine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Similarity to *reference* spectra is low. Mirror plots for these are shown below.

```{r mix01-serum-pos-creatine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.2, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

In addition we compare against MassBank spectra.

```{r mix01-serum-pos-creatine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Also here there is a single match with a low similarity.

We check in addition if matches between neutral loss spectra would be found.

```{r mix01-serum-pos-creatine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix01-serum-pos-creatine-mirror-hmdb-nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2_nl, std_hmdb_nl, 0.5, ppm = csp_nl@ppm,
                           tolerance = csp_nl@tolerance, sim)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT01661", "FT01302", "FT00865"),
                  confidence_level = c("C"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT01661_F07.S0621", "FT01661_F08.S0620",
                       "FT01302_F07.S0619", "FT01302_F08.S0618",
                       "FT00865_F07.S0633", "FT00865_F08.S0630"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Dimethylglycine

```{r, echo = FALSE}
std <- "Dimethylglycine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The only MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix01-serum-pos-dimethylglycine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectrum against the reference spectra for 
`r std` from HMDB.

```{r mix01-serum-pos-dimethylglycine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

One of the spectra matches the reference with a low similarity. Below we plot
this.

```{r mix01-water-pos-dimethylglycine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.3, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

In addition we compare it against the reference spectra from MassBank for the
selected standard.

```{r mix01-serum-pos-dimethylglycine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the
matched features against all spectra from HMDB or MassBank identifying reference
spectra with a similarity larger than 0.7. The results (if any spectra matched)
are shown in the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT01177", "FT00745", "FT00421"),
                  confidence_level = c("C-", "C-", "C"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT01177_F08.S0617", "FT00421_F07.S0699",
                       "FT00421_F08.S0693"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Glycerol

```{r, echo = FALSE}
std <- "Glycerol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

#### Summary

- Inconclusive: check water data.


### L-Glutamic Acid

```{r, echo = FALSE}
std <- "L-Glutamic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix01-serum-pos-l-glutamic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-serum-pos-l-glutamic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Mirror plots for the best matching spectra (similarity higher than 0.9) are
shown below.

```{r mix01-serum-pos-l-glutamic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

We also perform the comparison against reference spectra from MassBank and find
the same two MS2 spectra matching.

```{r mix01-serum-pos-l-glutamic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```


```{r mix01-serum-pos-l-glutamic-acid-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2, std_mbank, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT01560", "FT01925", "FT00840",
                                 "FT00811", "FT01184"),
                  confidence_level = c("B-", "B-", "B-", "B-", "B"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT01560_F07.S0636", "FT01560_F07.S0686",
                       "FT01560_F08.S0643", "FT01925_F08.S0644",
                       "FT00811_F07.S0632", "FT00811_F07.S0700",
                       "FT00811_F08.S0641", "FT00811_F08.S0712",
                       "FT01184_F07.S0695", "FT01184_F08.S0617",
                       "FT01184_F08.S0682"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Myo-Inositol

```{r, echo = FALSE}
std <- "Myo-Inositol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix01-serum-pos-myo-inositol-ms2, echo = FALSE}
plot_spectra(std_ms2)
```


#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT02102", "FT01466", "FT01739", "FT05431"),
                  confidence_level = c("D"))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```


### Pyruvic Acid

```{r, echo = FALSE}
std <- "Pyruvic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r std` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

We next look if there are MS2 spectra associated to this feature but we don't
find any.

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT00876"),
                  confidence_level = c("D"))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```


### Suberic Acid

```{r, echo = FALSE}
std <- "Suberic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix01-serum-pos-suberic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```


#### Summary

```{r, echo = FALSE}
## Define the feature (ion) and MS2 spectra to insert
fts <- data.frame(feature_id = c("FT01356", "FT01998", "FT02350"),
                  confidence_level = c("D"))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```


### Xanthine

```{r, echo = FALSE}
std <- "Xanthine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix01-serum-pos-xanthine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We have thus MS2 spectra for the set of features with retention time around 140.
Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-serum-pos-xanthine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra for FT01285 (F23.S0505 and F24.S0515) have the highest
similarity against MS2 spectra from `r std`. Mirror plots for the best matching
spectra are shown below.

```{r mix01-serum-pos-xanthine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance, sim)
```

We repeat the comparison using MassBank reference spectra and we obtain similar
results as shown below.

```{r mix01-serum-pos-xanthine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix01-serum-pos-xanthine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_res <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance, sim)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT02538", "FT00919", "FT01902", "FT01280",
                                 "FT01639", "FT01996"),
                  confidence_level = c("B-", "B-", "B-", "B", "B-", "B-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT02538_F08.S0516", "FT00919_F07.S0524",
                       "FT00919_F08.S0525", "FT01902_F07.S0515",
                       "FT01280_F07.S0505", "FT01280_F08.S0515",
                       "FT01639_F08.S0526", "FT01996_F07.S0525",
                       "FT01996_F08.S0532"),
                     spectraNames(std_ms2))]
ms2$confidence <- c(rep("low", 4), rep("high", 2), rep("low", 3))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Uric acid

```{r, echo = FALSE}
std <- "Uric acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

#### Summary

- Inconclusive.

### propionic acid

```{r, echo = FALSE}
std <- "propionic acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

#### Summary

- Inconclusive.


# Serum, negative polarity

We now perform the analysis on the samples with the standards still solved in
pure serum but acquired in negative polarity mode.

```{r}
POLARITY <- "NEG"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_neg
hmdb_nl <- hmdb_neg_nl
csp@tolerance <- 0.01
```

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```

## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-neg}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards evaluation

### 3-Phosphoglyceric Acid

```{r, echo = FALSE}
std <- "3-Phosphoglyceric Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

```{r mix01-serum-neg-3-phosphoglyceric-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-neg-3-phosphoglyceric-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectrum matches reference spectra from HMDB with high similarity.
Mirror plots for the best matching spectra are shown below.

```{r mix01-serum-neg-3-phosphoglyceric-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

In addition, we perform also the match against reference spectra of `r std`
from MassBank.

```{r mix01-serum-neg-3-phosphoglyceric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT0910", "FT3947"),
                  confidence_level = c("B", "B-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT3948_F16.S0766", "FT0913_F15.S0765"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Acetylhistidine

```{r, echo = FALSE}
std <- "Acetylhistidine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

```{r mix01-serum-neg-acetylhistidine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-neg-acetylhistidine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Mirror plots for the best matching spectra are shown below.

```{r mix01-serum-neg-acetylhistidine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

In addition, we perform also the match against reference spectra of `r std`
from MassBank.

```{r mix01-serum-neg-acetylhistidine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT1994", "FT1075", "FT1585", "FT1703"),
                  confidence_level = c("A-", "A", "A-", "A-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT1075_F15.S0586", "FT1075_F16.S0549",
                       "FT1075_F16.S0599", "FT1704_F15.S0641",
                       "FT1704_F16.S0601"),
                     spectraNames(std_ms2))]
ms2$confidence <- c(rep("high", 3), rep("low", 2))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Betaine

```{r, echo = FALSE}
std <- "Betaine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT0618", "FT0498"),
                  confidence_level = c("D"))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```


### CDP

```{r, echo = FALSE}
std <- "CDP"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these. EICs
look rather noisy and large retention time shifts between the samples are
visible.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

```{r mix01-serum-neg-cdp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-neg-cdp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Mirror plots for the best matching spectra are shown below.

```{r mix01-serum-neg-cdp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

In addition, we perform also the match against reference spectra of `r std`
from MassBank.

```{r mix01-serum-neg-cdp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```
	
#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT4520"),
                  confidence_level = c("A"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT4524_F15.S0801", "FT4524_F15.S0838",
                       "FT4524_F16.S0794", "FT4524_F16.S0840"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Dimethylglycine

```{r, echo = FALSE}
std <- "Dimethylglycine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the only feature matched to `r std` and show it below.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT0088"),
                  confidence_level = c("D"))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```


### Glycerol

```{r, echo = FALSE}
std <- "Glycerol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

#### Summary

- Inconclusive: check water data.
- very low signal. Seems nothing properly detected.

### L-Glutamic Acid

```{r, echo = FALSE}
std <- "L-Glutamic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-neg-l-glutamic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-serum-neg-l-glutamic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Mirror plots for the best matching spectra (similarity higher than 0.7) are
shown below.

```{r mix01-serum-neg-l-glutamic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

We perform also the match against reference spectra for that standard from
MassBank obtaining similar results as shown in the heatmap below.

```{r mix01-serum-neg-l-glutamic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT1312", "FT0435", "FT2479"),
                  confidence_level = c("B-", "B", "B-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT0435_F15.S0592", "FT0435_F16.S0560",
                       "FT0435_F16.S0611"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Myo-Inositol

```{r, echo = FALSE}
std <- "Myo-Inositol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

The only available MS2 spectrum available for the above features is shown below.

```{r mix01-serum-neg-myo-inositol-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare it against the reference spectra for `r std` from HMDB
and MassBank.

```{r mix01-serum-neg-myo-inositol-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix01-serum-neg-myo-inositol-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT0836", "FT1462", "FT3740", "FT1336"),
                  confidence_level = c("D"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT1336_F16.S0635"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### propionic acid

```{r, echo = FALSE}
std <- "propionic acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

```{r mix01-serum-neg-propionic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

```{r mix01-serum-neg-propionic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r ,echo = FALSE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.3, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

```{r mix01-serum-neg-propionic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT0019", "FT0464", "FT0018"),
                  confidence_level = c("D"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT0018_F15.S0257"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Pyruvic Acid

```{r, echo = FALSE}
std <- "Pyruvic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

We next look if there are MS2 spectra associated to the above features.

```{r mix01-serum-neg-pyruvic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB and
MassBank.

```{r mix01-serum-neg-pyruvic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix01-serum-neg-pyruvic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
std_ms2_sel <- Spectra()
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT0330", "FT0044"),
                  confidence_level = c("D"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT0044_F16.S0174"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Suberic Acid

```{r, echo = FALSE}
std <- "Suberic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix01-serum-neg-suberic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-serum-neg-suberic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Mirror plots for the best matching spectra are shown below.

```{r mix01-serum-neg-suberic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance, sim)
```

In addition we perform also the match against reference spectra for that
standard from MassBank.

```{r mix01-serum-neg-suberic-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT3533", "FT1401", "FT0759", "FT1690"),
                  confidence_level = c("A-", "A-", "A", "A-"))
## Get MS2 spectra:
ms2 <- std_ms2[match(c("FT0759_F15.S0148", "FT0759_F16.S0136"),
                     spectraNames(std_ms2))]
ms2$confidence <- c("low")
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

```{r, add-ms2-spectra, echo = FALSE, results = "asis"}
```


### Uric acid

```{r, echo = FALSE}
std <- "Uric acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

#### Summary

- Inconclusive: check water data.
- No MS2 spectra is available, the EIC of the only matched feature has low
  signal and maybe don't look good.


### Xanthine

```{r, echo = FALSE}
std <- "Xanthine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r , echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT2666", "FT1092", "FT0493", "FT1395"),
                  confidence_level = c("D"))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```


### C3 Carnitine

```{r, echo = FALSE}
std <- "C3 Carnitine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

#### Summary

No signal.


### Creatine

```{r, echo = FALSE}
std <- "Creatine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, table-feature-matches, results = "asis", echo = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "SN", std_ms2)
```


#### Summary

```{r, echo = FALSE}
fts <- data.frame(feature_id = c("FT0286"),
                  confidence_level = c("D"))
```

```{r, add-ions, echo = FALSE, results = "asis"}
```

# Summary on the ion database

Summarizing the content that was added to the `IonDb`.

```{r, iondb-summary, echo = FALSE, results = "asis"}
```

```{r no-ion-table, echo = FALSE, results = "asis"}
```


# Changelog

- Version 0.10.0:
  - Reconsider matches and include neutral loss spectra searches.
- Version 0.9.0:
  - Use `ppm = 20` to select MS2 spectra for features.
  - Add adducts `[M+2Na-H]+` and `[M+2K-H]+`.

# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
