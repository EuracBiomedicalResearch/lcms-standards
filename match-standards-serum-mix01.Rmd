---
title: "Identifying mix01 standards in serum"
author: "Andrea Vicini, Vinicius Verri Hernandes, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_depth: 3
    fig_width: 5
---

```{r libraries, message = FALSE, warning = FALSE, echo = FALSE}
library(xcms)
library(pander)
library(MetaboCoreUtils)
library(MsCoreUtils)
library(MetaboAnnotation)
library(BiocParallel)
library(Spectra)
library(RColorBrewer)
library(MetaboAnnotation)
library(pheatmap)
library(MsFeatures)
setMSnbaseFastLoad(FALSE)
```

```{r general-settings, echo = FALSE, message = FALSE}
mix <- 1
mix_name <- paste0("Mix", ifelse(mix < 10, paste0(0, mix), mix)) 
IMAGE_PATH <- paste0("images/match-standards-serum-", tolower(mix_name),"/")
if (dir.exists(IMAGE_PATH)) unlink(IMAGE_PATH, recursive = TRUE)
RDATA_PATH <- paste0("data/RData/match-standards-serum-", tolower(mix_name), "/")
dir.create(IMAGE_PATH, showWarnings = FALSE, recursive = TRUE)
dir.create(RDATA_PATH, showWarnings = FALSE, recursive = TRUE)

# Define the mzML files *base* path (/data/massspec/mzML/ on the cluster)
MZML_PATH <- "~/mix01/"
# MZML_PATH <- "/data/massspec/mzML/"

register(SerialParam())

library(knitr)
opts_chunk$set(message = FALSE, warning = FALSE, fig.width = 10, fig.height = 8,
               dev = c("png", "pdf"), fig.path = IMAGE_PATH)

```

**Current version: 0.9.0, 2022-03-09.**

# Introduction

Mixes of standards have been solved in water or added to human serum sample
pools in two different concentration and these samples were measured with the
LC-MS setup from Eurac (used also to generate the CHRIS untargeted metabolomics
data). Assignment of retention time and observed ion can be performed for each
standard based on MS1 information such as expected m/z but also based on the
expected difference in signal between samples with low and high concentration of
the standards. Finally, experimental fragment spectra provide the third level of
evidence. Thus, the present data set allows to annotate features to standards
based on 3 levels of evidence: expected m/z, difference in measured intensity
and MS2-based annotation.

The goal of this analysis is to create an in-house reference library for
our untargeted LC-MS setup. For that we:

- determine the retention time of each standard in water and serum.
- define which ions/adducts are measured for each standard (with relative
  abundances, i.e. which is most highly abundant ion etc).
- extract all MS2 spectra for each standard, match them against reference
  spectra and store them in a database.

The approach consists of the following steps:

- First features are matched to (pre-defined) adducts of all standards within
  the mix based on their m/z value (evidence 1).
- Features are further restricted to those that have a higher signal in samples
  in which a higher concentration was used (evidence 2). These are further
  grouped based on their retention time (within 5 seconds) and similar abundance
  across samples (correlation > 0.6).
- MS2 spectra are extracted for all these features and similarities calculated
  against MS2 spectra for the respective compound from HMDB (evidence 3).
- The experimental MS2 spectra are in addition compared against all reference
  spectra from HMDB to evaluate their *specificity* against the standard.

Based on the available information retention times/features are annotated to
standards using different confidence levels:

- **D** (lowest confidence): based on evidence 1 and 2: signal needs to be
  higher in samples with higher concentration of the standard. Measured m/z has
  to match the m/z of an ion of the compound.
- **C**: based on evidence 1, 2 and 3. In addition to **D**, also the MS2
  spectrum for that feature needs to match with at least a low similarity to the
  reference spectra for that compound from HMDB.
- **B**: similarity to a reference spectrum for the standard is higher than 0.7.
- **A** (highest confidence): same as **B**, but the experimental MS2 spectrum
  does not match a MS2 spectrum from any other compound in HMDB or MassBank with
  a similarity > 0.7.

These confidence levels are for the annotation of the feature(s) to the
standard. Features with similar retention times and abundances across samples
(as well as eventually similar peak shapes) *inherit* the highest confidence
level from other features. 

We get all the standards, calculate their exact mass (based on their
formula) and subset to those from mix01.

```{r, echo = FALSE, results = "asis"}
std_dilution <- read.table("data/standards_dilution.txt",
                           sep = "\t", header = TRUE)
std_dilution$exactmass <- calculateMass(std_dilution$formula)
colnames(std_dilution)[colnames(std_dilution) == "HMDB.code"] <- "HMDB"
std_dilution01 <- std_dilution[std_dilution$mix == mix, ]

## std_dilution01 <- rbind(
##     std_dilution01,
##     data.frame(mix = 1, name = "CDP2", abbreviation = NA,
##                HMDB = "HMDB0001546", formula = "C14H26N4O11P2",
##                POS = NA, NEG = NA, RT = 172, data_set = NA,
##                sample = NA, operator = NA, version = NA,
##                quality_POS = NA, quality_NEG = NA,
##                exactmass = 488.107330912))

```

The list of standards that constitute the present sample mix are listed below
along with the expected retention time and the most abundant adduct for positive
and negative polarity as defined manually in a previous analysis by Mar
Garcia-Aloy.

```{r, echo = FALSE, results = "asis"}
pandoc.table(std_dilution01[, c("name", "formula", "HMDB", "RT", "POS", "NEG")], 
             style = "rmarkdown", split.tables = Inf,
             caption = paste0("Standards of ", mix_name, ". Columns RT, POS ",
                              "and NEG contain expected retention times and ",
                              "adducts from a previous manual analysis."))
```

# Data import

We next load the data and split it according to matrix and polarity.

```{r}
std_files <- read.table("data/std_serum_files.txt", header = TRUE)
std_files$concentration <- "blank"
std_files$concentration[grep("High", std_files$class)] <- "high"
std_files$concentration[grep("Low", std_files$class)] <- "low"
std_files$group <- std_files$concentration
std_files$group[grep("CE", std_files$mode)] <- "MSMS"

#' Define colors
col_group <- brewer.pal(9, "Set1")[c(1, 5, 4, 9)]
names(col_group) <- c("high", "low", "MSMS", "blank")

#' Subset and load data.
std_files <- std_files[which(std_files$type == mix_name), ]
fls <- paste0(MZML_PATH, std_files$folder, "/", std_files$mzML)
data <- readMSData(fls, pdata = new("NAnnotatedDataFrame", std_files),
                   mode = "onDisk")
data <- filterRt(data, rt = c(0, 350))
data <- filterEmptySpectra(data)

col_group <- col_group[unique(data$group)]
```

```{r, echo = FALSE}
# matrix_pol: matrix in which the standards are solved and polarity.
tmp <- rep("Water", length(fileNames(data)))
tmp[grep("^QC", data$class)] <- "Serum"
matrix_pol <- paste0(tmp, "_", data$polarity)
data$matrix_pol <- matrix_pol

data_SP <- filterFile(data, file = which(data$matrix_pol == "Water_POS"))
data_SN <- filterFile(data, file = which(data$matrix_pol == "Water_NEG"))
data_SP <- filterFile(data, file = which(data$matrix_pol == "Serum_POS"))
data_SN <- filterFile(data, file = which(data$matrix_pol == "Serum_NEG"))
```

We next also load the reference databases we will use to compare the
experimental MS2 spectra against. Below we thus load HMDB and MassBank data.

```{r}
register(SerialParam())
library(CompoundDb)

cdb <- CompDb("data/CompDb.Hsapiens.HMDB.5.0.sqlite")

library(MsBackendMassbank)
library(RSQLite)
con <- dbConnect(SQLite(), "data/MassBank.sqlite")
mbank <- Spectra(con, source = MsBackendMassbankSql())
```

```{r all-functions, echo = FALSE}
#' Functions to process the spectra
low_int <- function(x, ...) {
    x > max(x, na.rm = TRUE) * 0.05
}
scale_int <- function(x, ...) {
    maxint <- max(x[, "intensity"], na.rm = TRUE)
    x[, "intensity"] <- 100 * x[, "intensity"] / maxint
    x
}

#' helper function to group features and return their feature group IDs.
group_features <- function(x, features, groupEic = FALSE) {
    featureGroups(x) <- rep(NA, nrow(featureDefinitions(x)))
    featureGroups(x)[rownames(featureDefinitions(x)) %in% features] <- "FG"
    x <- groupFeatures(x, param = SimilarRtimeParam(5))
    x <- groupFeatures(x, param = AbundanceSimilarityParam(threshold = 0.6,
                                                           transform = log2))
    if (groupEic)
        x <- groupFeatures(x, param = EicSimilarityParam(threshold = 0.5,
                                                         n = 3))
    featureGroups(x)[match(features, rownames(featureDefinitions(x)))]
}

plot_eics <- function(x, std, tab, MP) {
    eics <- featureChromatograms(x, features = rownames(tab))
    dr <- file.path(IMAGE_PATH, std)
    dir.create(dr, showWarnings = FALSE)
    col_sample <- col_group[eics$group]

    for (i in seq_len(nrow(eics))) {
        ft <- rownames(tab)[i]
        fl <- file.path(dr, paste0(MP,"_", ft, ".png"))
        png(fl, width = 12, height = 8, units = "cm", res = 300, pointsize = 6)
        eic <- eics[i, ]
        plot(eic, col = paste0(col_sample, 80),
             peakBg = paste0(col_sample[chromPeaks(eic)[, "sample"]], 40))
        abline(v = tab$target_RT[1], lty = 2, col = "#00000060")
        grid()
        legend("topleft", c(std, tab$adduct[i], ft))
        legend("topright", col = col_group, legend = names(col_group), lty = 1)
        dev.off()
    }
}

extract_ms2 <- function(x, features, ppm = 20) {
    res <- featureSpectra(x, expandRt = 3, return.type = "Spectra",
                          features = features, ppm = ppm)
    res <- filterIntensity(res, intensity = low_int)
    res <- res[lengths(res) > 1]
    if (!length(res))
        return(res)
    res <- addProcessing(res, scale_int)
    spectraNames(res) <- paste0(res$feature_id, "_", spectraNames(res))
    res
}

#' helper function that selects experimental MS2 spectra (std_ms2) with a
#' similarity higher than the specified cutoff, creates mirror plots and
#' returns the selected `Spectra`.
#'
#' This function uses *global* variables `sim`, `std_ms2` and `hmdb`
plot_select_ms2 <- function(cutoff) {
    idx <- which(sim > cutoff, arr.ind = TRUE)

    par(mfrow = c(round(sqrt(nrow(idx))), ceiling(sqrt(nrow(idx)))))
    for (i in seq_len(nrow(idx))) {
        a <- idx[i, 1L]
        b <- idx[i, 2L]
        plotSpectraMirror(std_ms2[a], addProcessing(hmdb[b], scale_int),
                          main = paste(spectraNames(std_ms2)[a], hmdb$name[b]),
                          ppm = 40)
    }
    std_ms2[unique(idx[, "row"])]
}

match_table <- function(x, sv = c("rtime", "target_name",
                                  "score")) {
    x <- x[whichQuery(x)]
    tab <- spectraData(x, c("feature_id", sv))
    tab$precursorMz_diff <- x$precursorMz - x$target_precursorMz
    rn <- strsplit(rownames(tab), "_")
    rn <- vapply(rn, function(z) z[2L], character(1))
    tab$spectrum_id <- rn
    fids <- split(tab$feature_id, tab$spectrum_id)
    fids <- vapply(fids, function(z) paste0(unique(z), collapse = ";"),
                   character(1))
    tab <- as.data.frame(tab)
    rownames(tab) <- NULL
    tab <- unique(tab[, c(sv, "precursorMz_diff", "spectrum_id")])
    tab$feature_id <- fids[tab$spectrum_id]
    tab
}

summarize_match_table <- function(x, name = "target_name") {
  f <- paste(x[, name], x$spectrum_id)
  x <- lapply(split(x, f), function(z)
    z[order(z$score, decreasing = TRUE), ][1, ])
  x <- do.call(rbind, x)
  x <- x[order(x$score, decreasing = TRUE), ]
  x$selected <- rep("", nrow(x))
  if(length(std_ms2_sel)) {
    sel_ids <- vapply(strsplit(spectraNames(std_ms2_sel), "_"),
                      function(z) z[2], character(1))
    x$selected[x$spectrum_id %in% sel_ids] <- "X"
  }
  rownames(x) <- NULL
  x
}
```


# Initial evaluation of available MS2 data

Before performing the actual analysis that involves chromatographic peak
detection and evaluation of feature abundances, we compare all experimental MS2
spectra against the reference libraries. This provides already a first hint for
which standards a valid MS2 spectrum was recorded (and hence would allow
annotation based on evidence 3) and what related retention time might be.

We first extract all MS2 spectra from the respective data files and process them
by first removing all peaks with an intensity below 5% of the highest peak
signal, then scaling all intensities to a value range between 0 and 100 and
finally remove all MS2 spectra with less than 2 peaks.

```{r}
fls <- fileNames(data_SP)
fls <- fls[grep("_CE", fls)]

all_ms2 <- Spectra(fls, source = MsBackendMzR()) |>
filterMsLevel(msLevel. = 2L) |>
filterIntensity(intensity = low_int)

all_ms2 <- all_ms2[lengths(all_ms2) > 1]
all_ms2 <- addProcessing(all_ms2, scale_int)
all_ms2 <- setBackend(all_ms2, MsBackendDataFrame())
all_ms2 <- applyProcessing(all_ms2)
```

We next match these spectra against all reference spectra from HMDB for the
standards in mix 01. All matching spectra with a similarity larger 0.7 are
identified.

```{r}
hmdb_std <- Spectra(cdb, filter = ~ compound_id == std_dilution01$HMDB)
```

Standards for which no MS2 spectrum in HMDB is present are listed in the table
below.

```{r, echo = FALSE, results = "asis"}
tmp <- std_dilution01[!(std_dilution01$HMDB %in% hmdb_std$compound_id), ]
pandoc.table(tmp[, c("name", "HMDB", "formula")], style = "rmarkdown",
             caption = "Standards for which no reference spectrum is available")
```

The table below lists all standards and the number of matching reference spectra
(along with their retention times).

```{r, echo = FALSE, results = "asis"}
all_match <- matchSpectra(
    hmdb_std, all_ms2,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
all_match <- all_match[whichQuery(all_match)]

tab <- matchedData(all_match, c("name", "compound_id", "score", "target_rtime"))

tmp <- split(as.data.frame(tab), tab$compound_id)
tmp <- do.call(rbind, lapply(tmp, function(z) {
    data.frame(name = z$name[1L],
               HMDB = z$compound_id[1L],
               ms2 = nrow(z),
               mean_rt = mean(z$target_rtime),
               min_rt = min(z$target_rtime),
               max_rt = max(z$target_rtime),
               mean_sim = mean(z$score))
}))
tmp <- rbindFill(
    tmp, std_dilution01[!std_dilution01$HMDB %in% tmp$HMDB, c("name", "HMDB")])
rownames(tmp) <- NULL
pandoc.table(tmp[order(tmp$name), ], style = "rmarkdown", split.table = Inf,
             caption = "Standards with matching reference MS2 spectra.")
```

We repeat the same analysis for the negative polarity data (code not shown
again).

```{r, echo = FALSE, results = "asis"}
fls <- fileNames(data_SN)
fls <- fls[grep("_CE", fls)]

all_ms2 <- Spectra(fls, source = MsBackendMzR()) |>
filterMsLevel(msLevel. = 2L) |>
filterIntensity(intensity = low_int)

all_ms2 <- all_ms2[lengths(all_ms2) > 1]
all_ms2 <- addProcessing(all_ms2, scale_int)
all_ms2 <- setBackend(all_ms2, MsBackendDataFrame())
all_ms2 <- applyProcessing(all_ms2)

all_match <- matchSpectra(
    hmdb_std, all_ms2,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
all_match <- all_match[whichQuery(all_match)]

tab <- matchedData(all_match, c("name", "compound_id", "score", "target_rtime"))

tmp <- split(as.data.frame(tab), tab$compound_id)
tmp <- do.call(rbind, lapply(tmp, function(z) {
    data.frame(name = z$name[1L],
               HMDB = z$compound_id[1L],
               ms2 = nrow(z),
               mean_rt = mean(z$target_rtime),
               min_rt = min(z$target_rtime),
               max_rt = max(z$target_rtime),
               mean_sim = mean(z$score))
}))
tmp <- rbindFill(
    tmp, std_dilution01[!std_dilution01$HMDB %in% tmp$HMDB, c("name", "HMDB")])
rownames(tmp) <- NULL
pandoc.table(tmp[order(tmp$name), ], style = "rmarkdown", split.table = Inf,
             caption = "Standards with matching reference MS2 spectra.")
```

We next perform the full analysis of the data set involving MS1 and MS2 data.


# Serum, positive polarity

We now perform the analysis on the samples with the standards solved in
serum acquired in positive polarity mode.

## Data pre-processing

We perform the pre-processing of our data set which consists of the
chromatographic peak detection followed by a peak refinement step to reduce peak
detection artifacts, the correspondence analysis to group peaks across samples
and finally the gap-filling to fill in missing peak data from samples in which
no chromatographic peak was detected.

Some notes on the settings for the pre-processing:

- The `bw` parameter for the correspondence is larger than usual because adding
  the standards in higher concentrations caused considerable retention time
  shifts for some. A higher `bw` will allow to group also mis-aligned
  chromatographic peaks - but will not allow to discriminate between closely
  eluting ions.
- The `binSize` was also slightly increased to avoid splitting of features with
  similar m/z values.

```{r peakdetection, eval = !file.exists(paste0(RDATA_PATH, "processed_data.RData"))}
## Peak detection
cwp <- CentWaveParam(ppm = 50,
                     peakwidth = c(2, 18),
                     snthresh = 5,
                     mzdiff = 0.001,
                     prefilter = c(4, 300),
                     noise = 100,
                     integrate = 2)

data_SP <- findChromPeaks(data_SP, param = cwp) 

## Peak refinement
mnp <- MergeNeighboringPeaksParam(expandRt = 3.5, expandMz = 0.001,
                                  minProp = 3/4)
data_SP <- refineChromPeaks(data_SP, param = mnp)

## Alignment
pdp1 <- PeakDensityParam(sampleGroups = data_SP$matrix_pol, bw = 3,
                        minFraction = 0.7, binSize = 0.015)
data_SP <- groupChromPeaks(data_SP, param = pdp1)
pgp <- PeakGroupsParam(minFraction = 0.8, extraPeaks = 100, span = 0.8)
data_SP <- adjustRtime(data_SP, param = pgp)

## Correspondence analysis
pdp2 <- PeakDensityParam(sampleGroups = data_SP$mode, bw = 3,
                        minFraction = 0.3, binSize = 0.015)
data_SP <- groupChromPeaks(data_SP, param = pdp2)

## Gap-filling
data_SP <- fillChromPeaks(data_SP, param = ChromPeakAreaParam())
save(data_SP, file = paste0(RDATA_PATH, "processed_data.RData"))
```

```{r correspondence-cached, echo = FALSE, eval = file.exists(paste0(RDATA_PATH, "processed_data.RData"))}
load(paste0(RDATA_PATH, "processed_data.RData"))
```

The base peak chromatogram and peak density image with the expected retention
times for the standards is shown below.

```{r mix01-serum-pos-bpc, echo = FALSE, caption = "Base peak chromatogram and chromatographic peak density image. Dashed vertical lines represent the expected retention times for the standards as defined in a previous manual analysis.", fig.width = 7, fig.height = 5}
bpc <- chromatogram(data_SP, aggregationFun = "max", msLevel = 1L,
                    mz = c(60, 900), include = "none")
par(mfrow = c(2, 1), mar = c(0, 20, 1.5, 0.5))
plot(bpc, col = paste0(col_group[bpc$group], 80))
legend("topright", col = col_group, lty = 1, legend = names(col_group))
abline(v = std_dilution01$RT, lty = 2)
par(mar = c(4.5, 20, 0, 0.5))
plotChromPeakImage(data_SP, binSize = 3)
abline(v = std_dilution01$RT, lty = 2)
```

## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r}
fVlog2 <- log2(featureValues(data_SP, value = "into",
                             method = "sum", filled = TRUE))
high <- grep("High", colnames(fVlog2))
high <- high[-grep("CE", colnames(fVlog2)[high])]
low <- grep("Low", colnames(fVlog2))

ttest <- t(apply(fVlog2, 1, function(x) {
    a <- x[high]
    b <- x[low]
    if (sum(!is.na(a)) > 1 && sum(!is.na(b)) > 1) {
        res <- t.test(a, b, mu = 0)
        c(high_low_diff = unname(res$estimate[1] - res$estimate[2]),
          pvalue = res$p.value, mean_high = mean(a, na.rm = TRUE),
          mean_low = mean(b, na.rm = TRUE))
    } else c(high_low_diff = mean(a, na.rm = TRUE) - mean(b, na.rm = TRUE),
             pvalue = NA_real_, mean_high = mean(a, na.rm = TRUE),
             mean_low = mean(b, na.rm = TRUE))
}))
```


## Identification of features matching standards

We now identify all features matching likely adducts of the standards.

```{r}
adducts <- c("[M+H]+", "[M+2H]2+", "[M+Na]+", "[M+K]+", "[M+NH4]+",
             "[M+H-H2O]+", "[M+H+Na]2+", "[M+2Na]2+", "[M+H-NH3]+",
             "[M+2Na-H]+", "[M+2K-H]+")
prm <- Mass2MzParam(adducts = adducts, ppm = 30)
fmat <- c(featureDefinitions(data_SP), ttest)
mtchs <- matchMz(fmat, std_dilution01, param =  prm, mzColname = "mzmed")
mtchs_sub <- mtchs[whichQuery(mtchs)]
```

We further reduce to features that show an at least twice as high signal
in samples with the high concentration compared to the one with the low
concentration. Note that we also keep features for which no difference was
calculated (e.g. because in low concentration no signal was measured).

```{r, echo = FALSE}
mD <- matchedData(mtchs_sub, columns = c("mzmed", "ppm_error", "rtmed",
                                         "target_RT", "target_name",
                                         "target_HMDB",
                                         "adduct", "target_POS",
                                         "high_low_diff", "pvalue",
                                         "mean_high", "mean_low"))
mD <- mD[-which(mD$high_low_diff < 1), ]
mD <- mD[order(mD$target_name), ]
```

for most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution01)`) in mix `r mix` at least one feature was found
matching the standards adducts' m/z. 

Below we plot the BPC indicating the position of the assigned features.

```{r mix01-serum-pos-bpc-matched, echo = FALSE, caption = "Base peak chromatogram with position of features assigned to standards.", fig.width = 7, fig.height = 5}
plot(bpc, col = paste0(col_group[bpc$group], 80))
legend("topright", col = col_group, lty = 1, legend = names(col_group))
abline(v = mD$rtmed, lty = 2, col = "#00000080")
```

Position of some of the matching features overlap with regions in the BPC that
exhibit a large difference in signal between high and low concentration.
The standards with no match are reported below.

```{r, results = "asis", echo = FALSE}
pandoc.table(std_dilution01[!std_dilution01$name %in% mD$target_name,
                            c("name", "HMDB", "formula", "RT", "POS", "NEG")],
             style = "rmarkdown", split.tables = Inf,
             caption = "Not matched standards")
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards with matching features

While for some standards a matching feature was found we still need to evaluate
whether this matching is correct. For each standard we thus first evaluate the
EICs for all matching features, then we match their MS2 spectra (if available)
against reference libraries. To ensure correct assignment of a feature, its
retention time and eventually related MS2 spectra, we consider the following
criteria to determine the annotation confidence:

- feature(s) was/were found with m/z matching those of adduct(s) of the 
  standard.
- signal is higher for samples with higher concentration.
- MS2 spectra matches reference spectra for the standard (if available).
- MS2 spectra don't match MS2 spectra of other compounds.

```{r, echo = FALSE}
# extract all MS2 spectra from HMDB,
all_hmdb_ms2 <- Spectra(cdb)
# artificially compute the precursorMz using [M+H]+. 
all_hmdb_ms2$precursorMz <- mass2mz(all_hmdb_ms2$exactmass)[, 1]
# and compute the neutral loss spectra
all_hmdb_nl_ms2 <- neutralLoss(all_hmdb_ms2, PrecursorMzParam())
```

```{r}
data_SP_FS <- filterFile(data_SP, which(data_SP$mode == "FS"),
                         keepFeatures = TRUE)
```

### 3-Phosphoglyceric Acid

```{r, echo = FALSE}
std <- "3-Phosphoglyceric Acid"
```

```{r, results = "asis", echo = FALSE}
# maybe we could put the code in this block inside a
# get_standard_info <- function(std) {...} to reduce duplication?
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))

std_ms2 <- extract_ms2(data_SP, rownames(tmp))
tmp$n_ms2 <- 0
if(length(std_ms2)) {
   nms2 <- table(std_ms2$feature_id)
   tmp[names(nms2), "n_ms2"] <- unname(nms2) 
}

pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low", "n_ms2")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

A considerable number of features has been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-serum-3-phosphoglyceric-acid-ms2, fig.cap = "MS2 spectra for features matched to 3-Phosphoglyceric Acid.", echo = FALSE}
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB.

```{r mix01-serum-3-phosphoglyceric-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for 3-Phoshoglyceric Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

It seems that no extracted MS2 spectra matches well the reference ones from
3-Phosphoglyceric Acid. The maximum score is around 0.08 and is attained by a
spectrum from FT02217. The only two matches with score greater than 0.07 are
shown below.

```{r mix01-serum-3-phosphoglyceric-acid-mirror-hmdb, echo = FALSE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(0.07)
```

Since all the extracted MS2 spectra are associated to ions different from
[M+H]+ we also perform a comparison between the neutral loss spectra 

```{r mix01-serum-3-phosphoglyceric-acid-nl-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 neutral loss spectra for selected features against reference neutral loss spectra for 3-Phoshoglyceric Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
nl_hmdb <- all_hmdb_nl_ms2[all_hmdb_nl_ms2$compound_id == hmdb_id]
nl_std_ms2 <- neutralLoss(std_ms2, PrecursorMzParam())
sim <- compareSpectra(nl_std_ms2, nl_hmdb, ppm = 40)

ann <- data.frame(feature_id = nl_std_ms2$feature_id, rt = rtime(nl_std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

No match was found. In addition we match (**all**) the MS2 spectra for the
matched features against all spectra from HMDB identifying reference spectra
with a similarity larger than 0.7. This is to ensure that no reference spectra
from any other compound would match the extracted spectra for this feature with
a high similarity.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, all_hmdb_ms2,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r}
hmdb_match <- matchSpectra(
    nl_std_ms2, all_hmdb_nl_ms2,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

No spectrum in HMDB matches any of the input spectra.
We next we compare the experimental MS2 spectra against MassBank.

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r}
# # throws an error. Maybe there's some problem in the packages? 
# mbank_match <- matchSpectra(
#     nl_std_ms2, neutralLoss(mbank, PrecursorMzParam()),
#     param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
# mbank_match
```
Also for MassBank no match was found.

#### Summary

- Annotation of FT02217 (RT=250, `[M+Na]+` ion) to `r std` with confidence level
  **C**? Or **D** because the score of the match between MS2 spectra was close
  to 0? 
- FT02579 was grouped together FT02217 so it should get the same confidence
  level? 
- Reference MS2: F24.S0419 (with a very *low* grading?)
- What about the other features. Should we give them confidence **D** or can
  we exclude them with other considerations?

### Acetylhistidine

```{r, echo = FALSE}
std <- "Acetylhistidine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))

std_ms2 <- extract_ms2(data_SP, rownames(tmp))
tmp$n_ms2 <- 0
if(length(std_ms2)) {
   nms2 <- table(std_ms2$feature_id)
   tmp[names(nms2), "n_ms2"] <- unname(nms2) 
}

pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low", "n_ms2")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks where removed).

```{r mix01-serum-acetylhistidine-ms2, fig.cap = "MS2 spectra for features matched to acetylhistidine.", echo = FALSE}
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-acetylhistidine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for Acetylhistidine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

Some of the MS2 spectra for FT02018 and FT02021 have a high similarity against
MS2 spectra from `r std`.Mirror plots for the best matching spectra are shown
below.

```{r mix01-serum-acetylhistidine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(0.5)
```

FT02728 and FT02370 were considered as from [M+2Na-H]+ and  [M+Na]+
respectively. We check if matches betwween neutral loss spectra would be found.

```{r mix01-serum-3-acetylhistidine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 neutral loss spectra for selected features against reference neutral loss spectra for 3-Phoshoglyceric Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
nl_hmdb <- all_hmdb_nl_ms2[all_hmdb_nl_ms2$compound_id == hmdb_id]
nl_sp <- neutralLoss(std_ms2[std_ms2$feature_id %in% c("FT02728", "FT02370")],
                          PrecursorMzParam())
sim <- compareSpectra(nl_sp, nl_hmdb, ppm = 40)

ann <- data.frame(feature_id = nl_sp$feature_id, rt = rtime(nl_sp))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_ms2 <- Spectra(cdb)
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(
    mbank_match, c("rtime", "target_compound_name",
                   "target_exactmass", "score")) |>
summarize_match_table("target_compound_name")
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```



#### Summary

- FT02018 (RT=182.5, `[M+H]+` ion) matches MS2 spectra of `r std` but also
  those of others: confidence **B**.
- FT02021 (RT=198.1, `[M+H]+` ion); confidence **B**.
- Reference MS2: F24.S0632, F24.S0806 and F08.S0506. FT2158 has MS2 spectra
  F07.S0430 and F08.S0427 that don't match Acetylhistidine.

### Betaine

```{r, echo = FALSE}
std <- "Betaine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-betaine-ms2, fig.cap = "MS2 spectra for features matched to betaine.", echo = FALSE}
std_ms2 <- extract_ms2(data_SP, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

We have MS2 spectra for features with a retention time around 160 seconds.
Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-betaine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for Betaine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

MS2 spectra for FT00638 (F23.S0573, F23.S0602, F24.S0601) and
FT00642 (F23.S0573, F23.S0602, F24.S0601) match the reference spectra
from Betaine with high scores. From the EIC FT0522 seems to be
mostly noise and no *real* compound data.

```{r mix01-serum-betaine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(0.9 )
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(mbank_match, c("rtime", "target_compound_name",
                                 "target_exactmass", "score")) |>
summarize_match_table("target_compound_name")
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```
Abromine and Betaine are the same, right?

#### Summary

- MS2 spectra for FT00638 (RT=163, `[M+H]+` ion) matches `r std` with
  confidence **B**
- The same for FT00642.
- Reference MS2: F23.S0573, F23.S0602, F24.S0601.


### C3 Carnitine

```{r, echo = FALSE}
std <- "C3 Carnitine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-c3-carnitine-ms2, fig.cap = "MS2 spectra for features matched to C3 Carnitine.", echo = FALSE}
std_ms2 <- extract_ms2(data_SP, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

We have a single MS2 spectra available. Next we compare it against the reference
spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-c3-carnitine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for C3 Carnitine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
```
No spectra found with  this id?

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
pandoc.table(data.frame(matchedData(hmdb_match, c("target_name", "score"))),
             style = "rmarkdown", split.table = Inf,
             caption = paste0("Experimental MS2 spectrum with best match to MS2",
                              " spectra of different compounds."))
```

The available spectra matches with other compounds than `r std`.

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r, echo = FALSE, results = "asis"}
pandoc.table(data.frame(matchedData(mbank_match,
                                    c("target_compound_name", "score"))),
             style = "rmarkdown", split.table = Inf,
             caption = paste0("Experimental MS2 spectrum with best match to MS2",
                              " spectra of different compounds."))
```

#### Summary

- FT02650 (RT=162.6, `[M+NH4]+`): confidence level **D**? Maybe EICs for 
  FT02063, FT02649, FT03045 are not that good.

### CDP

```{r, echo = FALSE}
std <- "CDP"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-CDP-ms2, fig.cap = "MS2 spectra for features matched to CDP", echo = FALSE}
std_ms2 <- extract_ms2(data_SP, rownames(tmp))

if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

```{r mix01-serum-cdp-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for CDP from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

F23.S0864 and F23.S0892 MS2 spectra from FT06278 match HMDB reference spectra
from `r std`.

```{r mix01-serum-CDP-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(0.7)
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```
```{r, echo = FALSE, results = "asis"}
st <- match_table(mbank_match, c("rtime", "target_compound_name",
                                 "target_exactmass", "score")) |>
summarize_match_table("target_compound_name")
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

#### Summary

- FT06278 (RT=260.8, `[M+H]+`): confidence level **B**.
- Reference spectra: F23.S0892, F23.S0864?


### Creatine

```{r, echo = FALSE}
std <- "Creatine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-creatine-ms2, fig.cap = "MS2 spectra for features matched to creatine", echo = FALSE}
std_ms2 <- extract_ms2(data_SP, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

Next we compare them against the reference spectra for `r std` from
HMDB.  The results are shown in the heatmap below.

```{r mix01-serum-creatine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for creatine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT00870 have the highest similarity against MS2 spectra from
`r std` but the scores are not very high. Mirror plots for the best matching
spectra (score above 0.4) are shown below.

```{r mix01-serum-creatine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(0.4)
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r, echo = FALSE, results = "asis", eval = length(whichQuery(mbank_match)) > 0}
st <- match_table(mbank_match, c("rtime", "target_compound_name",
                                 "target_exactmass", "score")) |>
summarize_match_table("target_compound_name")
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

The feature with a retention time around 177 seconds (FT0752) seem to represent
signal from `r std` (being only matched to `r std` and with a high score).

#### Summary

- FT00870 (RT=176, `[M+H]+` ion): confidence **C**: the MS2 spectrum F07.S0424
  matches only `r std`.
- FT01667 and FT01307 inherit confidence **C** from FT00870.
- Reference MS2: F23.S0633?
- Also in this case we have spectra that match reference ones from Creatinine
  with relatively high scores.


### Dimethylglycine

```{r, echo = FALSE}
std <- "Dimethylglycine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-dimethylglycine-ms2, fig.cap = "MS2 spectra for features matched to dimethylglycine", echo = FALSE}
std_ms2 <- extract_ms2(data_SP, rownames(tmp))
if (length(std_ms2)) {
    plotSpectra(std_ms2)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

Similarity against reference spectra of `r std` is calculated.

```{r , echo = FALSE}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)
sim
```

The spectrum does thus not match any reference spectra from `r std`. Checking if
it would match any spectrum in HMDB or MassBank.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```


```{r, echo = FALSE, results = "asis"}

st <- data.frame(matchedData(hmdb_match, c("target_name", "score")))
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

The only available MS2 spectra does not match to any reference spectrum from
`r std` (it does with a )..

#### Summary

- we can not assign one of the features properly. Likely it's the ones with
  an RT around 177.

### Glycerol

```{r, echo = FALSE}
std <- "Glycerol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 6 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

We next extract the MS2 spectra for the above features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-glycerol-ms2, fig.cap = "MS2 spectra for features matched to glycerol", echo = FALSE}
std_ms2 <- extract_ms2(data_SP, rownames(tmp))
if (length(std_ms2)) {
    plotSpectra(std_ms2)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

Unfortunately no MS2 spectra is available.

#### Summary

- FT00947 with confidence **D**? But its EIC maybe doesn't look that good
- No MS2 spectra

### L-Glutamic Acid

```{r, echo = FALSE}
std <- "L-Glutamic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-L-Glutamic-Acid-ms2, fig.cap = "MS2 spectra for features matched to L-Glutamic Acid.", echo = FALSE}
std_ms2 <- extract_ms2(data_SP, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

We have thus MS2 spectra from FT01566 (first two plots), FT01931 (third plot),
FT01189 (last two plots).

Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-serum-L-Glutamic-Acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for L-Glutamic Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT00819 seem to have quite high similarity
against MS2 spectra from `r std`. Mirror plots for the best matching spectra
(similarity higher than 0.9) are shown below.

```{r mix01-serum-L-Glutamic-Acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(0.9)
```

Thus, the best matching spectra are F23.S0695 and F24.S0682.

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r, echo = FALSE, results = "asis", eval = length(whichQuery(mbank_match)) > 0}
st <- match_table(mbank_match, c("rtime", "target_compound_name",
                                 "target_exactmass", "score")) |>
summarize_match_table("target_compound_name")
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

MS2 spectra associated to feature FT0693, FT1018 have been matched to reference
spectra from L-Glutamic Acid but also from other compounds with relatively high
scores in both cases.

#### Summary

- FT01189 (RT=182.5, `[M+H]+` ion): confidence level **B**. Its MS2 spectra
  (F23.S0695 and F24.S0682) match `r std`, but also other compounds.
- FT00845 (RT=180.1, `[M+H-NH3]+`] ion): confidence level **B-**.
- FT01566 (RT=179.9, `[M+Na]+`] ion): confidence level **B-**.
- Reference MS2 spectra: F23.S0695 and F24.S0682.
- FT01931 has a very similar retention time to FT01566 and from the EICs the
  peaks have a high intensity but its MS2 spectrum don't match reference spectra
  for `std`.

### Myo-Inositol

```{r, echo = FALSE}
std <- "Myo-Inositol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-myo-inositol-ms2, fig.cap = "MS2 spectra for features matched to myo-inositol.", echo = FALSE}
std_ms2 <- extract_ms2(data_SP, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-myo-inositol-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for myo-inositol from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

None of the extracted spectra matches reference spectra from `r std`.

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
std_ms2_sel <- Spectra()
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r, echo = FALSE, results = "asis", eval = length(whichQuery(mbank_match)) > 0}
st <- match_table(mbank_match, c("rtime", "target_compound_name",
                                 "target_exactmass", "score")) |>
summarize_match_table("target_compound_name")
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

MS2 spectra from FT02025 are matched to reference spectra of other compounds
than `r std` with high scores.

#### Summary

- FT02106, FT02108 with confidence **D**?


### Pyruvic Acid

```{r, echo = FALSE}
std <- "Pyruvic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r std` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

We have quite some features matching with their m/z to potential adducts of `r
std`, but they have quite different retention times.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

We next look if there are MS2 spectra associated to this feature but we don't
find any.

```{r mix01-serum-pyruvic-acid-ms2, fig.cap = "MS2 spectra for features matched to pyruvic-acid", echo = FALSE}
std_ms2 <- extract_ms2(data_SP, rownames(tmp))
if (length(std_ms2)) {
    plotSpectra(std_ms2)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```


#### Summary

- Seems we can not detect `r std` in the present samples.


### Suberic Acid

```{r, echo = FALSE}
std <- "Suberic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from a few different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-suberic-acid-ms2, fig.cap = "MS2 spectra for features matched to suberic acid.", echo = FALSE}
std_ms2 <- extract_ms2(data_SP, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

We have thus MS2 spectra for feature around 140. Next we compare them
against the reference spectra for `r std` from HMDB. The results are shown in
the heatmap below.

```{r mix01-serum-suberic-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for suberic acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

Strangely every match has score equal to 0.

We look if there's any match for the MS2 spectra for the matched features
against all spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
std_ms2_sel <- Spectra()
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

The MS2 spectra from FT00499 match with a high similarity reference spectra
for 1-Methylxanthine, but not `r std`.

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```


#### Summary

- All matched features with level **D**? Or looking to the EICs exclude some
  (e.g FT02375). Two spectra from FT00499 are available but they don't match
  with reference spectra from `r std`.

### Xanthine

```{r, echo = FALSE}
std <- "Xanthine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from two compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-xanthine-ms2, fig.cap = "MS2 spectra for features matched to xanthine", echo = FALSE}
std_ms2 <- extract_ms2(data_SP, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

We have thus MS2 spectra for the set of features with retention time around 140.
Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-serum-xanthine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for xanthine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for FT01285 (F23.S0505 and F24.S0515) have the highest
similarity against MS2 spectra from `r std`. Mirror plots for the best matching
spectra are shown below.

```{r mix01-serum-xanthine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(0.6)
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

Based on HMDB MS2 spectrum F23.S0505 from FT01285 is assigned to oxypurinol
besides xanthine with better scores.

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r, echo = FALSE, results = "asis", eval = length(whichQuery(mbank_match)) > 0}
st <- match_table(mbank_match, c("rtime", "target_compound_name",
                                 "target_exactmass", "score")) |>
summarize_match_table("target_compound_name")
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

Based on HMDB MS2 spectrum F23.S0505 from FT01285 is assigned to oxypurinol,
alloxanthine and xanthine with similar scores.
#### Summary

- FT01285 (RT=141.4, `[M+H]+` ion): confidence level **B**.
- FT00924 (RT=141.2, `[M+H-NH3]+` ion): confidence level **B-**.
- FT01908 (RT=141.2, `[M+K]+` ion): confidence level **B-**.
- FT01645 (RT=141.7, `[M+Na]+` ion): confidence level **B-**.
- FT02002 (RT=142.7, `[M+2Na-H]+` ion): confidence level **B-**.
- Reference MS2: F23.S0505 and F24.S0515.
- A comparison of the MS2 spectra for the features is shown below:

### Uric acid

```{r, echo = FALSE}
std <- "Uric acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD[mD$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SP_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from two compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SP, std, tmp, "SP")
```

Signal is very low for all of the features. And also no MS2 spectra were
found.

```{r echo = FALSE}
std_ms2 <- extract_ms2(data_SP, rownames(tmp))
```


#### Summary

# Serum, negative polarity

We now perform the analysis on the samples with the standards still solved in
pure serum but acquired in negative polarity mode.

## Data pre-processing

We perform the pre-processing of these samples (using the same settings as in
serum, positive polarity).

```{r peakdetection-serum-neg, eval = !file.exists(paste0(RDATA_PATH, "processed_data_SN.RData"))}
## Peak detection
cwp <- CentWaveParam(ppm = 50,
                     peakwidth = c(2, 18),
                     snthresh = 5,
                     mzdiff = 0.001,
                     prefilter = c(4, 300),
                     noise = 100,
                     integrate = 2)

data_SN <- findChromPeaks(data_SN, param = cwp) 

## Peak refinement
mnp <- MergeNeighboringPeaksParam(expandRt = 3.5, expandMz = 0.001,
                                  minProp = 3/4)
data_SN <- refineChromPeaks(data_SN, param = mnp)

## Alignment
pdp1 <- PeakDensityParam(sampleGroups = data_SN$matrix_pol, bw = 3,
                        minFraction = 0.7, binSize = 0.015)
data_SN <- groupChromPeaks(data_SN, param = pdp1)
pgp <- PeakGroupsParam(minFraction = 0.8, extraPeaks = 100, span = 0.8)
data_SN <- adjustRtime(data_SN, param = pgp)

## Correspondence analysis
pdp2 <- PeakDensityParam(sampleGroups = data_SN$mode, bw = 3,
                        minFraction = 0.3, binSize = 0.015)
data_SN <- groupChromPeaks(data_SN, param = pdp2)

## Gap-filling
data_SN <- fillChromPeaks(data_SN, param = ChromPeakAreaParam())
save(data_SN, file = paste0(RDATA_PATH, "processed_data_SN.RData"))
```

```{r correspondence-cached-serum-neg, echo = FALSE, eval = file.exists(paste0(RDATA_PATH, "processed_data_SN.RData"))}
load(paste0(RDATA_PATH, "processed_data_SN.RData"))
```

The base peak chromatogram and peak density image with the expected retention
times for the standards is shown below.

```{r mix01-serum-neg-bpc, echo = FALSE, caption = "Base peak chromatogram and chromatographic peak density image. Dashed vertical lines represent the expected retention times for the standards as defined in a previous manual analysis.", fig.width = 7, fig.height = 5}
bpc_SN <- chromatogram(data_SN, aggregationFun = "max", msLevel = 1L,
                    mz = c(60, 900), include = "none")
par(mfrow = c(2, 1), mar = c(0, 20, 1.5, 0.5))
plot(bpc_SN, col = paste0(col_group[bpc_SN$group], 80))
legend("topright", col = col_group, lty = 1, legend = names(col_group))
abline(v = std_dilution01$RT, lty = 2)
par(mar = c(4.5, 20, 0, 0.5))
plotChromPeakImage(data_SN, binSize = 3)
abline(v = std_dilution01$RT, lty = 2)
```


## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, echo = FALSE}
fVlog2_SN <- log2(featureValues(data_SN, value = "into",
                             method = "sum", filled = TRUE))
high_SN <- grep("High", colnames(fVlog2_SN))
high_SN <- high_SN[-grep("CE", colnames(fVlog2_SN)[high_SN])]
low_SN <- grep("Low", colnames(fVlog2_SN))

ttest_SN <- t(apply(fVlog2_SN, 1, function(x) {
    a <- x[high_SN]
    b <- x[low_SN]
    if (sum(!is.na(a)) > 1 && sum(!is.na(b)) > 1) {
        res <- t.test(a, b, mu = 0)
        c(high_low_diff = unname(res$estimate[1] - res$estimate[2]),
          pvalue = res$p.value, mean_high = mean(a, na.rm = TRUE),
          mean_low = mean(b, na.rm = TRUE))
    } else c(high_low_diff = mean(a, na.rm = TRUE) - mean(b, na.rm = TRUE),
             pvalue = NA_real_, mean_high = mean(a, na.rm = TRUE),
             mean_low = mean(b, na.rm = TRUE))
}))
```


## Identification of features matching standards

We now identify all features matching likely adducts of the standards.

```{r}
adducts_N <- adducts("negative")[c("[M-H]-", "[M+Cl]-"),
                                 c("mass_multi", "mass_add")]
adducts_N <- rbind(adducts_N, "[M+HCOO]-" = c(1, calculateMass("HCOO"))) 
prm_SN <- Mass2MzParam(adducts = adducts_N, ppm = 30)
fmat_SN <- c(featureDefinitions(data_SN), ttest_SN)
mtchs_SN <- matchMz(fmat_SN, std_dilution01, param = prm_SN, mzColname = "mzmed")
mtchs_sub_SN <- mtchs_SN[whichQuery(mtchs_SN)]
```

We further reduce to features that show an at least twice as high signal
in samples with the high concentration compared to the one with the low
concentration. Note that we also keep features for which no difference was
calculated (e.g. because in low concentration no signal was measured).

```{r, results = "asis", echo = FALSE}
mD_SN <- matchedData(mtchs_sub_SN, columns = c("mzmed", "ppm_error", "rtmed",
                                               "target_RT", "target_name",
                                               "target_HMDB",
                                               "adduct", "target_NEG",
                                               "high_low_diff", "pvalue",
                                               "mean_low", "mean_high"))
mD_SN <- mD_SN[-which(mD_SN$high_low_diff < 1), ]
mD_SN <- mD_SN[order(mD_SN$target_name), ]
```

For most of the standards (`r length(unique(mD_SN$target_name))` out of 
`r nrow(std_dilution01)`) in mix `r mix` at least one feature was found
matching the standards adducts' m/z. 

Below we plot the BPC indicating the position of the assigned features.

```{r mix01-serum-neg-bpc-matched, echo = FALSE, caption = "Base peak chromatogram with position of features assigned to standards.", fig.width = 7, fig.height = 5}
plot(bpc_SN, peakType = "none", col = paste0(col_group[bpc_SN$group], 80))
legend("topright", col = col_group, lty = 1, legend = names(col_group))
abline(v = mD_SN$rtmed, lty = 2, col = "#00000080")
```

Position of some of the matching features overlap with regions in the BPC that
exhibit a large difference in signal between high and low concentration.
The standards with no match are reported below.

```{r, results = "asis", echo = FALSE}
pandoc.table(std_dilution01[!std_dilution01$name %in% mD_SN$target_name,
                            c("name", "formula", "RT", "POS", "NEG")],
             style = "rmarkdown", split.tables = Inf,
             caption = "Not matched standards")
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards with matching features

```{r, echo = FALSE}
# artificially compute the precursorMz for MS2 spectra from HMDB using [M-H]-. 
all_hmdb_ms2$precursorMz <- mass2mz(all_hmdb_ms2$exactmass, "[M-H]-")[, 1]
# and compute the neutral loss spectra
all_hmdb_nl_ms2 <- neutralLoss(all_hmdb_ms2, PrecursorMzParam())
```

```{r}
data_SN_FS <- filterFile(data_SN, which(data_SN$mode == "FS"),
                         keepFeatures = TRUE)
```

### 3-Phosphoglyceric Acid

```{r, echo = FALSE}
std <- "3-Phosphoglyceric Acid"
```

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SN, std, tmp, "SN")
```

Next we extract the MS2 spectra for all features, clean and plot them.

```{r mix01-serum-neg-3-phosphoglyceric-acid-ms2, fig.cap = "MS2 spectra for features matched to 3-Phosphoglyceric Acid.", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

Only one MS2 spectrum (from FT0911) is available We next match it against the
reference spectra for `r std` from HMDB.

```{r mix01-serum-neg-3-phosphoglyceric-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for 3-Phoshoglyceric Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)
```

The extracted MS2 spectrum matches some reference spectra from
3-Phosphoglyceric Acid. The matches with scores higher than 0.7 are shown in the
mirror plots below.

```{r mix01-serum-neg-3-phosphoglyceric-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
sim <- matrix(sim, nrow = 1)
std_ms2_sel <- plot_select_ms2(0.7)
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB identifying reference spectra with a similarity larger than
0.7. This is to ensure that no reference spectra from any other compound would
match the extracted spectra for this feature with a higher similarity.

```{r}
all_hmdb_ms2$precursorMz <- mass2mz(all_hmdb_ms2$exactmass, "[M-H]-")[, 1]

hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

Specrum F31.S0765 from feature FT0911 matches also 2-Phosphoglyceric acid with
higher score.

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r, echo = FALSE, results = "asis", eval = length(whichQuery(mbank_match)) > 0}
st <- match_table(mbank_match, c("rtime", "target_compound_name",
                                 "target_exactmass", "score")) |>
summarize_match_table("target_compound_name")
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```


#### Summary

- FT0911 (RT=251, `[M-H]-` ion): confidence level **B**.
- Reference MS2: FT0911.


### Acetylhistidine

```{r, echo = FALSE}
std <- "Acetylhistidine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]

tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SN, std, tmp, "SN")
```

```{r mix01-serum-neg-acetylhistidine-ms2, fig.cap = "MS2 spectra for features matched to acetylhistidine.", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)

```

Next we compare them against the reference spectra for `r std` from HMDB.
The results are shown in the heatmap below.

```{r mix01-serum-neg-acetylhistidine-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for Acetylhistidine from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra for both features FT0620 and FT0623 have a quite high similarity
against MS2 some spectra from `r std`. Mirror plots for the best matching
spectra are shown below.

```{r mix01-serum-neg-acetylhistidine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(0.7)
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

Both features FT0620 and FT0623 are matched also carnosine.

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r, echo = FALSE, results = "asis", eval = length(whichQuery(mbank_match)) > 0}
st <- match_table(mbank_match, c("rtime", "target_compound_name",
                                 "target_exactmass", "score")) |>
summarize_match_table("target_compound_name")
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```


#### Summary

Puzzling situation: needs to be discussed! We have two different features, same
ion, that match the standard (with same confidence level).

- FT1073 (RT=177.1, `[M-H]-` ion): confidence level **B**. MS2 spectra match
  also carnosine.
- Reference MS2: F32.S0549 (also matches carnosine), F31.S0586.

### Betaine

```{r, echo = FALSE}
std <- "Betaine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time these features might represent signal
from the same compound.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SN, std, tab = tmp, "SN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-neg-betaine-ms2, fig.cap = "MS2 spectra for features matched to betaine.", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))

if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

#### Summary

- FT0616 (RT=156.2, `[M+HCOO]-` ion): confidence level **D**.
- FT0496 (RT=159.6, `[M+Cl]-` ion): confidence level as above.


### CDP

```{r, echo = FALSE}
std <- "CDP"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these. EICs
look rather noisy and large retention time shifts between the samples are
visible.

```{r, echo = FALSE}
plot_eics(data_SN, std, tmp, MP = "SN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-neg-CDP-ms2, fig.cap = "MS2 spectra for features matched to CDP", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))

if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

```{r mix01-serum-neg-cdp-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for CDP from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra F32.S0794, F32.S0840, F31.S0801 and F31.S0838 all match
reference spectra for `r std`. Mirror plots for the best matching
spectra with score above 0.7 are shown below.

```{r mix01-serum-neg-cdp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(0.7)
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
    std_ms2, Spectra(cdb),
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

All MS2 spectra match thus nicely to `r std`.

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r, echo = FALSE, results = "asis", eval = length(whichQuery(mbank_match)) > 0}
st <- match_table(mbank_match, c("rtime", "target_compound_name",
                                 "target_exactmass", "score")) |>
summarize_match_table("target_compound_name")
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

#### Summary

- FT4522 (RT=260.6, `[M-H]-` ion): confidence level **B**.
- FT4518 (RT=260.6, `[M-H]-` ion): confidence level **B-**?
- Reference MS2: F32.S0794, F32.S0840 (these first two also match
  Cytidine triphosphate reference spectra from HMDB and other compounds
  from mass bank), F31.S0801 and F31.S0838.

### Dimethylglycine

```{r, echo = FALSE}
std <- "Dimethylglycine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

We next plot the EIC for the only feature matched to `r std` and show it below.

```{r, echo = FALSE}
plot_eics(data_SN, std, tmp, "SN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-neg-dimethylglycine-ms2, fig.cap = "MS2 spectra for features matched to dimethylglycine", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

Unfortunately no MS2 spectra associated to FT0087 is available.

#### Summary

- FT0087 (RT=177, `[M-H]-` ion): confidence level **D**.


### Glycerol

```{r, echo = FALSE}
std <- "Glycerol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Also for `r std` we have only one match. We next plot the and show the EIC
of the realted feature.

```{r, echo = FALSE}
plot_eics(data_SN, std, tmp, "SN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-neg-glycerol-ms2, fig.cap = "MS2 spectra for features matched to glycerol", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

Unfortunately no MS2 spectra is available.

#### Summary

- very low signal. Seems nothing properly detected.

### L-Glutamic Acid

```{r, echo = FALSE}
std <- "L-Glutamic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 2 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SN, std, tmp, "SN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-neg-L-Glutamic-Acid-ms2, fig.cap = "MS2 spectra for features matched to L-Glutamic Acid.", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown in the heatmap below.

```{r mix01-serum-neg-L-Glutamic-Acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for L-Glutamic Acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectra F31.S0592, F32.S0560, F32.S0611 (from FT0433) have quite
high similarity against some MS2 spectra from `r std`. Mirror plots for the
best matching spectra (similarity higher than 0.7) are shown below.

```{r mix01-serum-neg-L-Glutamic-Acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(0.7)
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r, echo = FALSE, results = "asis", eval = length(whichQuery(mbank_match)) > 0}
st <- match_table(mbank_match, c("rtime", "target_compound_name",
                                 "target_exactmass", "score")) |>
summarize_match_table("target_compound_name")
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```


#### Summary

- FT0433(RT=176.4, `[M-H]-` ion): confidence level **B**.
- Reference MS2: F31.S0592, F32.S0560, F32.S0611.


### Myo-Inositol

```{r, echo = FALSE}
std <- "Myo-Inositol"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SN, std, tmp, "SN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-neg-myo-inositol-ms2, fig.cap = "MS2 spectra for features matched to myo-inositol.", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

We have thus a single MS2 spectrum (from FT1334). Next we compare it against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-neg-myo-inositol-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for myo-inositol from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)
```

The extracted spectrum does not match any reference spectra from `r std` in
HMDB. In addition we match it against all spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

The matches involve other compounds than `r std` but some of those for `r std`
have the higher score.

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

#### Summary

- all matched features with confidence **D**- Can we exlude some looking at the
  EICs maybe?

### propionic acid

```{r, echo = FALSE}
std <- "propionic acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from several different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SN, std, tmp, "SN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-neg-propionic-acid-ms2, fig.cap = "MS2 spectra for features matched to myo-inositol.", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```
```{r mix01-serum-neg-propionic-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for myo-inositol from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)
```
The extracted MS2 spectrum doesn't match any reference spectra of `r std`
(from HMDB).

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

The matches involve other compounds than `r std` but some of those for `r std`
have the higher score.

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

#### Summary

Only a single MS2 spectra that doesn't match with any reference spectrum and
looking at the EICs the intensity is relatively low for all features .

### Pyruvic Acid


```{r, echo = FALSE}
std <- "Pyruvic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```


```{r, echo = FALSE}
plot_eics(data_SN, std, tmp, "SN")
```

We next look if there are MS2 spectra associated to the above features.

```{r mix01-serum-neg-pyruvic-acid-ms2, fig.cap = "MS2 spectra for features matched to pyruvic-acid", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

Next we compare them against the reference spectra for `r std` from HMDB. The
results are shown below.

```{r mix01-serum-neg-pyruvic-acid-ms2-hmdb-heatmap, echo = TRUE}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40, SIMPLIFY = FALSE)
sim
```

Thus, the MS2 spectrum for FT0023 does not match any reference spectra for 
`r std` from HMDB.

We match the above MS2 spectrum against all spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

No match involving `r std` was found but similarity with MS2 spectra for
Ascorbic acid are high.

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```


#### Summary

Only MS2 spectra from FT0043 are available but they don't match reference
spectra of `r std` (but those of ascorbic acid).

### Suberic Acid

```{r, echo = FALSE}
std <- "Suberic Acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 3(or 4?) different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SN, std, tmp, "SN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-neg-suberic-acid-ms2, fig.cap = "MS2 spectra for features matched to suberic acid.", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))
par(mar = c(4.2, 4.5, 1.5, 0.5))
xl <- range(unlist(mz(std_ms2)))
plotSpectra(std_ms2, xlim = xl)
```

We have thus MS2 spectra for features around 37 and 140. Next we compare them
against the reference spectra for `r std` from HMDB. The results are shown in
the heatmap below.

```{r mix01-serum-neg-suberic-acid-ms2-hmdb-heatmap, fig.cap = "Similarities of MS2 spectra for selected features against reference spectra for suberic acid from HMDB.", echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)

sim <- compareSpectra(std_ms2, hmdb, ppm = 40)

ann <- data.frame(feature_id = std_ms2$feature_id, rt = rtime(std_ms2))
rownames(ann) <- rownames(sim)

pheatmap(sim, annotation_row = ann, breaks = seq(0, 1, length.out = 101),
         color = colorRampPalette((brewer.pal(n = 7, name = "YlOrRd")))(100))
```

The MS2 spectrum F15.S0115 (for feature FT0428) has the highest similarity
against MS2 spectra from `r std`. Mirror plots for the best matching spectra are
shown below.

```{r mix01-serum-neg-suberic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(0.7)
```

In addition we match the MS2 spectra for the matched features against all
spectra from HMDB.

```{r}
hmdb_match <- matchSpectra(
  std_ms2, Spectra(cdb),
  param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
hmdb_match
```

```{r, echo = FALSE, results = "asis"}
st <- match_table(hmdb_match) |>
summarize_match_table()
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```

MS2 spectra associated with FT0757 and FT0758 have been assigned only to `r std`
and with high scores.

```{r}
mbank_match <- matchSpectra(
    std_ms2, mbank,
    param = CompareSpectraParam(ppm = 40, requirePrecursor = FALSE))
mbank_match
```

```{r, echo = FALSE, results = "asis", eval = length(whichQuery(mbank_match)) > 0}
st <- match_table(mbank_match, c("rtime", "target_compound_name",
                                 "target_exactmass", "score")) |>
summarize_match_table("target_compound_name")
pandoc.table(
    st, style = "rmarkdown", split.table = Inf,
    caption = paste0("Experimental MS2 spectra with best match to MS2",
                     " spectra of different compounds. The best match per ",
                     "compound is reported. Rows are ordered by similarity."))
```


#### Summary
- FT0757 F31.S0148, F32.S0136
- FT0758 F31.S0260, F32.S0255
- FT0757 (RT=37.3, `[M-H]-` ion): confidence level **A**.
- FT1399 (RT=37.3, `[M+HCOO]-` ion) inherits confidence level **A** from FT0757?
  But its EIC has very low intensity in comparison.
- FT0758 (RT=64.1, `[M-H]-` ion): confidence level **A-**?
- Reference MS2: F31.S0148, F31.S0260.


### Uric acid

```{r, echo = FALSE}
std <- "Uric acid"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

We show the EICs for the features above.

```{r, echo = FALSE}
plot_eics(data_SN, std, tmp, "SN")
```

We next look if there are MS2 spectra associated to the above features.

```{r mix01-serum-neg-uric-acid-ms2, fig.cap = "MS2 spectra for features matched to pyruvic-acid", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))
if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```


#### Summary

- No MS2 spectra is available, the EICs have low signal and maybe don't look
  good.


### Xanthine

```{r, echo = FALSE}
std <- "Xanthine"
```

The table below lists all features that were matched to one of the adducts of 
`r print(std)` that have in addition also on average a twice as high signal in
samples with higher concentrations than in those with lower concentrations.

```{r, results = "asis", echo = FALSE}
tmp <- as.data.frame(mD_SN[mD_SN$target_name == std, ])
tmp <- tmp[order(tmp$rtmed), ]
tmp$feature_group <- group_features(data_SN_FS, rownames(tmp))
pandoc.table(tmp[, c("mzmed", "ppm_error", "rtmed", "target_RT",
                     "feature_group", "target_name", "adduct",
                     "mean_high", "mean_low")], style = "rmarkdown",
             split.tables = Inf, caption = "Feature to standards matches")
```

Based on their retention time, it seems that these features represent signal
from 3 different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data_SN, std, tmp, "SN")
```

We next extract the MS2 spectra for all these features and match them against
the reference spectra for `r std` from HMDB.

```{r mix01-serum-neg-xanthine-ms2, fig.cap = "MS2 spectra for features matched to xanthine", echo = FALSE}
std_ms2 <- extract_ms2(data_SN, rownames(tmp))

if (length(std_ms2)) {
    par(mar = c(4.2, 4.5, 1.5, 0.5))
    xl <- range(unlist(mz(std_ms2)))
    plotSpectra(std_ms2, xlim = xl)
} else {
    cat("No MS2 spectra found for", std, "\n")
}
```

#### Summary

- No MS2 spectra available.
- FT1090 (RT=140.2, `[M-H]-` ion): confidence level **D**. The EIC looks good.
- FT0491 was grouped together with FT1090 but its EIC has low intensity and
  maybe doesn't look that good.

## Standards without any matching feature

### C3 Carnitine
### Creatine

# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
