---
title: "Estimating isotope peak intensities for compounds defined in HMDB"
author: "Andrea Vicini, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_depth: 3
    fig_width: 5
---

```{r style, echo = FALSE, results = 'asis', message = FALSE}
library(BiocStyle)
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

**Last modified:** `r file.info("isotope-intensity-estimation.Rmd")$mtime`<br />
**Compiled**: `r date()`

$\require{mhchem}$

# Introduction

In this document we evaluate possibilities to estimate m/z and intensities of
compounds' isotopologues without knowing the chemical formula of the
compound. Ultimately, this should allow to identify groups of mass peaks in a
spectrum that represents isotopologues of the same compound.


# Isotope detection or definition approaches


## `CAMERA`

[`CAMERA`](https://bioconductor.org/packages/release/bioc/html/CAMERA.html)
takes a simple approach based on hard coded lower and upper limits for isotope
peaks. How this limits were defined is unclear. For the m/z differences of the
peaks simple lower and upper limits are used, not discriminating between
e.g. C13 and N15 isotopes.

## `envipat`

[`envipat`](https://cran.r-project.org/web/packages/enviPat/) does not seem to
allow identifying isotopes in MS data but does predict an isotope (intensity)
distribution from a chemical formula.


## Breen et al. 2000. Automatic poisson peak harvesting for high throughput protein identification

The authors consider Poisson modelling of isotopic distributions. Given a 
molecule with mass m they find a mapping F between m and the mean M of the 
Poisson distribution model (F: m-> M).
To compute this mapping they derive from a database a hypothetical average 
aminoacid. Next they use this to construct a set of the theoretical peptides 
whose mass span a certain range of interest. They compute the isotopic 
distribution of those and for each one of them they compute M* as the value of M 
that makes Poisson(M) more similar to the isotopic distribution. Finally they 
fit a line for the values of m against the M* and this line represents the 
mapping F. In the end, they model the isotopic distribution of a compound with 
mass m as a Poisson(P(M))

## Park et al. 2008. Isotopic peak intensity ratio based algorithm for determination of isotopic clusters and monoisotopic masses of polypeptides from high-resolution mass spectrometric data

The following statements are reported for the isotopic distribution of a compound 
with elements C, H, N, O, S.
- the intensity of a peak Ik approximates to a polynomial in m (molecular weight) 
  with degree k
- the ratio between consecutive peaks (R) approximates to a linear function in m
- the ratio product between adjacent peaks (RP) approximates to a constant.

For the last two, the more m is big the better the above approximations get.

To find a relation between R and m they consider a large number of polypeptides 
in a certain database spanning a certain range (400-5200 Da) and for them 
they compute R. Then, the interval of interest is divided in two regions 
(at 1800 Da). For high masses a linear approximation is used and 
its coefficients are found by fitting a regression line whereas for low masses
they use a quotient of polynomials (with degree k+1 and k for the k-th R)

The algorithm to cluster isotopic peaks after peak peaking) involves:

- pseudocluster identification. It requires to loop over all the peaks and for
  each of them find groups of peaks starting with the current peak and separated
  by +1 (in the single charged case) for each peak. They first enumerate
  pseudoclusters with two peaks, then pseudoclusters with more peaks and then
  proceed by considering different charged states.
- isotopic cluster identification. Among the pseudoclusters, they identify
  isotopic clusters whose intensity patterns are similar to those of the
  isotopic distributions in terms of R and RP in the pseudocluster.
- duplicate cluster removal. In case two clusters overlap they remove the one
  whose most abundant peak is smaller. If the most abundant peaks are the same,
  the one with the lowest charge state is removed. If their charge states are
  also the same, the cluster with the lower "similarity score" is removed.

## Valkenborg et al. 2008. A Model-Based Method for the Prediction of the Isotopic Distribution of Peptides

Also in this article the authors consider the ratios between peak heights.
They model it as a polynomial model in m (monoisotopic mass) whose order 
is empirically determined by looking at the improvements obtained by adding 
higher order terms.
The parameters of the polynomial model are estimated using the least-squares 
method on different sets of theoretical peptides (and the model is valid in the 
corresponding mass range).
By comparing the ratios between a series of peaks observed in a spectrum with 
the ratios predicted from the model and selecting a treshold for the allowed 
"difference" they decide whether the series of peaks is part of an isotopic 
group or not.

## sgibb

As far as I have understood sgibb uses a mixed approach. He uses the approach of 
Park et al. 2008 but for checking if a candidate cluster is a isotope cluster, 
for which he uses the Poisson approach of Breen et al. 2000.


# Identification of isotopologue peaks in MS1 data

**Given**\

An MS1 spectrum with paired m/z and intensity values.

**Goal**\

Identify all mass peaks (i.e. m/z and intensity pairs) in a spectrum that
could represent signal from
[isotopologues](https://goldbook.iupac.org/terms/view/I03351) of the same
compound.

**Required**\

- Difference in m/z $mzd$ between a monoisotopic peak and the peak of an
  isotopologue.
- Expected intensity $x_{I}$ for the isotopologue peak (e.g. relative to the
  monoisotopic peak intensity $x_{0}$).
  
## Definitions and approach

The overall mass difference $md$ to the monoisotopic mass is determined by the
isotopic substitution defining the isotopologue $I$, i.e. by the number and
variants of present isotopes $I_{i}$ (such as $\ce{{13}^C}$ and/or
$\ce{{15}^N}$) in the isotopologue. It is defined as the sum of mass differences
of the individual isotope

$$md = \sum md_{I_{i}}$$ 

with the mass differences of isotopes $md_{I_{i}}$ being known.

The frequency of observing an isotope of a certain element in nature is
known. For each such isotope $I_{i}$ it is thus possible to calculate the
probability of observing it based on the total number of atoms $n_{X}$ from the
respective element $X$ in a compound using a multinomial distribution. Further,
the probability of observing an isotopologue $P(I)$ (including the probability
of its monoisotopic form $P(I)$) is equal to the product of probabilities of
each of the isotopes $P(I_{i})$ it constitutes

$$P(I) = \prod P(I_{i})$$

Finally, the ratio between the intensities of the monoisotopic peak $x_0$ and a
peak of an isotopologue $x_I$ is supposed to be equivalent to the ratio of their
probabilities

$$R_{I} = \frac{x_{I}}{x_{0}} = \frac{P(I)}{P(0)}$$

This ratio $R_{I}$ depends only on the ratio of probabilities of the isotopes in
which the isotopologues differ, i.e. which are part of the isotopic substitution
(all other probabilities will cancel themselves in the ratio above). 

Thus, given the chemical formula and hence total numbers of atoms of each
elements of a compound would be known, both the intensity $x_{I}$ and the mass
difference $md$ of each of its isotopologues could be determined.

Without prior knowledge of the measured compounds (and hence chemical formulas)
or defined isotopologues, we need make some simplifications and approximations
to allow the identification of isotopologue peaks from m/z and intensity values
alone. For metabolomics in human samples only a reduced set of compounds
consisting mostly of CHNOPS atoms (C, H, N, O, P, S as well as Cl), are expected
to be present. Based on all compounds present in the human metabolome database
we first identified all isotopic substitutions that would result in an
isotopologue peak with an intensity larger than 0.01% of the highest intensity
in the compounds isosope pattern (see [Section](#isotopologues)). We further
restricted this set to the *most frequent* isotopic substitutions and calculate
their mass difference $md$. This would already enable us to look for
isotopologue *candidate peaks* in an MS1 spectrum, but to determine whether the
signal indeed results from an isotopologue we would in addition also need to
evaluate whether its relative intensity the assumed *monoisotopic peak* matches
the ratio $R_{I} = P(I)/P(0)$. The isotope probabilities depend however on the
total number of atoms of each element from the matching isotopic substitution
(which is however unknown for a given mass peak). We thus next determined for
all compounds in HMDB the number of atoms of each CHNOPS(+Cl) element (see
[Section](#elementcounts)). We used this data to evaluate and define a (linear)
relationship between the number of atoms of a certain element of a compounds and
its mass. The resulting slopes (linear models) allow to estimate a lower and
upper atom count for each element based on the mass (or m/z) of a tentative
isotopologue peak (or for a compound with unknown chemical formula). These
counts can then be used to calculate (lower and upper bounds of) isotope
probabilities $P(I_{i})$ and subsequently a lower and upper bound for the
intensity ratio $R_{I}$. This information hence allows to determine whether the
tested peak's intensity matches the intensity expected from the isotopic
substitution (within given boundaries).


## Limitations

- The present definitions base on compounds from HMDB and the presented approach
  would hence fail to identify isotopes of e.g. anorganic compounds. Parameters
  would have to be estimated based on corresponding collection of compounds.
- By using only the most frequent isotopic substitutions we might miss detection
  of less frequent isotopologues.

## Parameter estimation

### Identification of the most frequent isotopic substitutions {#isotopologues}

### Definition of mass-dependent element counts {#elementcounts}

# Evaluation



## Questions and discussion

- [ ] Change the way to describe isotopic substitutions: use [13]C2 instead of
      2[13C] to describe 2 isotopes C13.
- [ ] Use `isopattern(..., rel_to = 4)` which uses intensities relative to the
      monoisotopic peak.
- So far we subset the isotopic substitutions to the most frequently observed
  ones. Should we maybe also consider the intensity of the resulting
  isotopologue? Maybe a plot frequency against average intensity would be
  helpful.
- **Alternative approach**: for the evaluation whether a peak is from an
  isotopologue we need: the mass difference $md$ and an intensity boundary. The
  latter depends on the ratio of the probabilities of the monoisotopic peak to
  the isotopologue $R_{I} = P(I)/P(0)$. With $P(I)/P(0) = x_{I}/x_{0}$ and
  knowing the intensity of the monoisotopic peak $x_{0}$ we can get an estimate
  of the isotopologues intensity $x_{I} = x_{0} * R_{I}$. From the
  `enviPar::isopattern` function we should in fact already get everything we
  need: the returned `matrix` contains the peaks' m/z and the abundances which
  are equivalent to the probabilities. The $md$ for an isotopologue can be
  calculated from the column `"m/z"` between the monoisotopic peak (first row)
  and any of the isotopologues and the $R_{I}$ can be calculated from the column
  `"abundance"` (ratio between any row and the first row). Thus we could:
  - calculate the isopattern for each compound in HMDB. Then for each compound:
  - calculate $md$ and $R_{I}$ for each isotopologue peak
  - define the character string of the isotopic substitution
    (e.g. `"[13]C1[16]O2"`).
  - save this information along with the m/z of the monoisotopic peak to a
    `data.frame` (or any other object?).
  - Select the most frequent isotopic substitutions. For each of them: plot
    $R_{I}$ against m/z. This should allow us to define an $R_{I}(mz)$ for an
    isotopic substitution that is a function of the mass (ideally a lower and
    upper bound/linear relationship). Also, for each isotopic substitution we
    get the minimal m/z for which such an isotopologue is observed. That can be
    helpful to skip calculations of some isotopic substitution if they are
    simply not possible/observed in *real life*.


@andrea, please copy respective code blocks and documentation from below into
the appropriate sections above.




# Element counts in HMDB

In this section we analyze element compositions of compounds from the Human
Metabolome Database.

```{r libraries, warning = FALSE}
library("CompoundDb")
library("MetaboCoreUtils")
library("pander")
library("enviPat")
```

We load the HMDB database and extract the chemical formula and exact mass of all
compounds.

```{r}
cdb <- CompDb("data/CompDb.Hsapiens.HMDB.4.0.sqlite")
cmps <- compounds(cdb, columns = c("compound_id", "name",
                                   "formula", "exactmass"))
```

For each compound in the human metabolom database (HMDB) with available mass 
we compute how many atoms of C, H, N, O, P and S as well as Cl are present in it
(the latter is important because in human serum samples it is very likely that
Cl adducts are generated by electro spray ionization). 
We collect the counts in a data frame with a column for each element and a row 
for each compound in HMDB.

```{r}
cmps <- cmps[-which(is.na(cmps$exactmass)), ]
```

```{r}
tmp <- lapply(cmps$formula, function(frml) res <- countElements(frml))
elements_names <- unique(names(unlist(tmp)))
counts <- lapply(tmp, function(x) {
  row <- numeric(length(elements_names))
  names(row) <- elements_names
  row[names(x)] <- x
  row
  })
counts_df <- data.frame(do.call(rbind, counts))
rownames(counts_df) <- cmps$compound_id
```

```{r}
CHNOPSCl <- c("C", "H", "N", "O", "P", "S", "Cl")
counts_CHNOPSCl <- data.frame(counts_df[ , CHNOPSCl])
```

```{r}
onlyCHNOPSCl <- rowSums(counts_df[, setdiff(elements_names, CHNOPSCl)]) == 0

# With the following lines we can exclude compounds that have some atoms of
# elements different from CHNOPSCl.
cmps <- cmps[onlyCHNOPSCl, ]
counts_df <- counts_df[onlyCHNOPSCl, ]
```

From the `r nrow(counts_df)` compounds in HMDB 
`r sum(onlyCHNOPSCl != 1)` contain elements other than 
`r paste(CHNOPSCl, collapse = ",")`.

We compute the mean and standard deviation for the number of each element in the
molecules of HMDB. For each element we also report the percentage of compounds 
which have at least one atom of the given element.

```{r, echo = FALSE, results = "asis"}
m_sd <- rbind(colMeans(counts_CHNOPSCl), 
              apply(counts_CHNOPSCl, 2, sd),
              100 * colSums(counts_CHNOPSCl > 0) / nrow(counts_CHNOPSCl))
rownames(m_sd) = c("mean", "standard deviation", "% compounds with count > 0")
pandoc.table(m_sd, style = "rmarkdown")
```

We plot, for each of the considered elements, the distribution of the number of 
atoms of the given element in the compounds of HMDB.

```{r distribution-counts, fig.cap = "Distribution of the number of atoms of CHNOPSCl elements in compounds of HMDB.", fig.width = 7, fig.height = 14, echo = FALSE}
par(mfrow = c(7, 1), mar = c(3, 4, 1, 0.5))
for (el in CHNOPSCl) {
  hist(counts_CHNOPSCl[, el], xlab = "", main = el, breaks = 256)
  abline(v = quantile(counts_CHNOPSCl[, el], c(0.025, 0.975)))
}
```

The most frequent elements in HMDB compounds are H, C and O, but while the
number of C and H atoms varies considerably and goes up to over 100, the maximal
number of O atoms if below 25. Also, the numbers of atoms for all other elements
is only very low. 


## Isotopes

We focus here on elements which have isotopes (which excludes P). 

The presence of heavier elemental isotopes in a compound will result in a mass 
difference $md$ with respect to the monoisotopic mass of the compound.
Although for each element, each isotope species is characterized by a difference 
of one or more neutrons, the difference in mass between them isn't exactly 
integer and each elemental isotope will contribute in a different 
way producing different overall mass differences. 

In a compound with $n$ atoms of element $X$ ($n_X$) each of the atoms can be in
a specific isotope form $\ce{ ^{y}X }$ such as $\ce{^{12}C}$ or $\ce{^{13}C}$
(with the prevalence of each isotope form for each element being known). Each
combination of such isotopes $I_X$ (e.g. $\ce{3 ^{12}C}$ $\ce{2 ^{13}C}$ 
$\ce{4 ^{14}C}$ will result in a different shift in mass $md_{I_X}$. 
The probability $P(I_X)$ of observing such a combination of isotopes for an
element $X$ can be computed using the multinomial distribution. The overall mass
difference $md$ with respect to the monoisotopic mass is determined by the
combination (number and variant) of isotopes of each element $X, Y,... Z$ in the
molecule which defines the
(isotopologue)[https://en.wikipedia.org/wiki/Isotopologue] of the compound $I =
(I_X, I_Y... I_Z)$ and is given by the sum $md = md_{I_X}+ md_{I_Y}
... +md_{I_Z}$. Finally the probability of observing the isotopologue $I$ (and
the corresponding mass difference $md$) is $P(I) = P(md) = P(I_X)*
P(I_Y)...*P(I_Z)$ i.e. the product of the probability of observing each isotope
variant related to each element.

There is a very high number $N_{I_X} = \binom{q + n_X -1}{n_X}$ of possible
combinations of isotopes $I_X$ for the atoms of $X$ and a even greater number
$N_{I_X}* N_{I_Y}...*N_{I_Z}$ of possible isotopologues $I=(I_X, I_Y...,
I_Z)$. Here we keep only those that are significant for our purpose, i.e. that,
based on the isotope pattern calculated from the chemical formulas of all
compounds in HMDB, would result in an intensity that is higher than a specified
proportion of the monoisotopic peak M0. These are identified in the following
section.

## Identifying most common isotopologues

Here we try to determine which isotopologues are the most frequently observed in
human metabolomics based on all compounds from HMDB.

To this end we calculate the isotope pattern for each compound in HMDB using
`enviPat` and identify all isotopologues which would result in an intensity
higher than a certain proportion of the monoisotopic form. We get thus for each
compound all theoretical isotopologues that would result in an intensity higher
than the specified threshold (0.01% of the intensity from the monoisotopic
mass). For each of these peaks we define its *isotopologue id* which
consists of the observed isotopes for that compound, e.g. `"4[13C]2[15N]"` for
isotopologues of all compounds that contain this isotope composition.

```{r, echo = FALSE}
dr <- paste0("data/RData/isotope-intensity-estimation/")
dir.create(dr, showWarnings = FALSE, recursive = TRUE)
```

```{r}
data(isotopes)
# isos <- c("13C", "2H", "15N", "17O", "18O", "33S", "34S", "35S", "36S",
#           "36Cl", "37Cl")
isos <- isotopes$isotope[-match(unique(isotopes$element), isotopes$element)]
```


```{r, eval = !file.exists(paste0(dr, "subst_frequencies.RData"))}
## Ensure that element order is correct
chemforms <- sapply(cmps$formula, standardizeFormula)
threshold = 0.01*10^(-2)
iso_ps <- isopattern(isotopes, chemforms , threshold = threshold, rel_to = 2) 

## Process the isotope pattern to define a character string for each
## isotopologue - ensuring the order of isotopes to be the same across
## compounds
subst_per_cmpd <- lapply(iso_ps, function(iso_p) {
    idx <- match(colnames(iso_p), isos)
    tmp <- iso_p[, !is.na(idx), drop = FALSE]
    tmp <- tmp[rowSums(tmp) > 0, order(idx[!is.na(idx)]), drop = FALSE]
    cn <- colnames(tmp)
    elname <- gsub('[0-9]', '', cn)
    isonumb <- gsub('[^0-9]', '', cn)
    apply(tmp, 1, function(row)
        paste0("[", isonumb[row >0],  "]", elname[row >0], row[row >0], 
               collapse = ""))
})
subst_frequency <- table(unlist(subst_per_cmpd, use.names = FALSE))
save(subst_frequency, subst_per_cmpd, 
     iso_ps, chemforms, file = paste0(dr, "subst_frequencies.RData"))
```


```{r, echo = FALSE, eval = file.exists(paste0(dr, "subst_frequencies.RData"))}
load(paste0(dr, "subst_frequencies.RData"))
```

We thus defined `r length(subst_frequency)` substitutions that in at least a 
compound in HMBD would yield a probability higher than 10^(-4).

For each given substitution we compute the mean intensity that a substitution 
has in the compounds of HMBD where it is significant.
```{r}
intens <- unlist(lapply(iso_ps, function(iso_p) 
  iso_p[rowSums(iso_p[, intersect(colnames(iso_p), isos), drop = FALSE]) != 0,
        "abundance"]), use.names = FALSE)
m_intens_subs <- tapply(intens, unlist(subst_per_cmpd, use.names = FALSE), mean)
```

and plot it against the frequency of the substitution in HMBD. Most of the 
substitution present a small mean intensity. Most of the substitution with mean 
intensity higher than 5 are those realted to Cl (these are not very frequent) 
and C.

```{r}
library(ggplot2)
library(plotly)
p <- data.frame(subst_name = names(m_intens_subs),
  subst_frequency = as.numeric(subst_frequency), 
                intens = m_intens_subs) %>%
ggplot(aes(subst_frequency, intens, label = subst_name)) + geom_point()
ggplotly(p)
```

First approach. Here we plot the proportion (frequency divided for the number of compounds in 
HMBD) 
```{r, fig.height = 5, fig.width = 9, "Substitutions with proportion > 0.5 using approach 1"}
subst_proportion <- sort(subst_frequency / nrow(cmps), decreasing = TRUE)
par(mar = c(8, 4.1, 4.1, 2.1))
barplot(subst_proportion[subst_proportion > 0.5], las = 2)
```

In the plot above we can see isotopologues for compounds in HMBD that produce a
*significant* peak for at least a half of the compounds (the height of the bar
specifies the exact proportion). In other words, if we randomly sample a compund
in HMBD the chance to observe a significant peak related to the above
isotopologues will be high. I observe however that this approach penalizes
families related to elements with low counts in HMBD compounds. The number of
times a family related to N, S or Cl is found to be significant is limited by
the fact that the number of compounds in HMBD that contain these elements is
much lower than those that contain C, H, or O.

Second approach. We thus next compare the isotopologue frequency not against the total number of
compounds in HMDB, but against the number of compounds in HMDB that contain each
of the elements from the isotopologue definition in their chemical formula.

```{r}
ncomps <- vapply(names(subst_frequency), function(x) {
    x <- strsplit(gsub("[0-9\\[]+", "", x), split = "\\]")[[1]][-1]
    sum(rowSums(counts_df[, x, drop = FALSE] > 0) == length(x))
}, integer(1))
```

```{r, fig.height = 5, fig.width = 17, fig.cap= "Substitutions with proportion > 0.5 using approach 2"}
subst_proportion_var <- sort(subst_frequency/ncomps, decreasing = TRUE)
par(mar = c(10, 4.1, 4.1, 2.1))
barplot(subst_proportion_var[subst_proportion_var > 0.5], las = 2)
```

```{r, fig.height = 5, fig.width = 10, fig.cap = "Proportions computed according the second approach and mean intensities for the substitutions. The substitutions on the right of the red line correspond to the columns in the previous barplot"}
p <- data.frame( subst_name = names(m_intens_subs),
  proportion_var = as.numeric(subst_frequency/ncomps), 
                intens = m_intens_subs) %>%
ggplot(aes(proportion_var, intens, label = subst_name)) + geom_point()
ggplotly(p + geom_vline(xintercept = 0.5, color = "red", size = .1))
```

Third approach. Here I also try to divide the counts of the times a family is found to be 
significant in the HMBD compounds for the times that this family can be 
observed across the HMBD compounds. In other words these ratios represent the 
likelihood to find a family significant among the subset of HMBD compounds that 
have it as possible substitution (this happens when, for each element 
$X$ in the compound, the number of atoms of $X$ is >= than the sum of the 
numbers ${n_X}_2$, ..., ${n_X}_q$ of heavier isotopes associated to the 
substitution).

```{r}
count_heavy_iso <- function(subst_str){
  tmp <- sapply(strsplit(subst_str, split = "\\[")[[1]][-1], 
                function(s) strsplit(s, split ="\\]")[[1]][2])
  tapply(as.numeric(gsub('[^0-9]+', '', tmp)), gsub('[0-9]+', '', tmp), sum)
}

nvar <- sapply(names(subst_frequency), function(subst) {
  els <- count_heavy_iso(subst)
  var <- rep(TRUE, nrow(counts_df))
  for (el in names(els)) 
    var <- var & (counts_df[, el] >= els[el])
  sum(var)
})
```

```{r, fig.height = 5, fig.width = 17, fig.cap = "Substitutions with proportion > 0.5 using approach 3"}
subst_proportion_var2 <- sort(subst_frequency/nvar, decreasing = TRUE)
par(mar = c(10, 4.1, 4.1, 2.1))
barplot(subst_proportion_var2[subst_proportion_var2 > 0.5], las = 2)
```

In the plot above we can see the substitutions that produce a significant 
peak for at least a half of the compounds in which they are possible. 
(the height of the bar specifies the exact proportion). In this case we observe 
also families where N, S or Cl in them. 
To exemplify the difference, all molecules (the proportion in the above plot is 
1) of HMBD that have at least 1 atom of C and 1 atom of Cl are found to have 
significant peaks corresponding to 1[13C]1[37Cl]. However, since the number of 
such compounds in HMBD is very low the probability of observing the effect of 
such a substitution is very very low if we randomly pick one compound in HMBD.

In the following plot I show also the mean intensity of the substitutions. 
According to the third approach we select substitutions of Cl which have high 
mean intensity bu were excluded with the first two approaches.

```{r, fig.height = 5, fig.width = 10, fig.cap = "Proportions computed according the third approach and mean intensities for the substitutions. The substitutions on the right of the red line correspond to the columns in the previous barplot"}
library(ggplot2)
library(plotly)
par(mfrow= c(1,2))
p <- data.frame( subst_name = names(m_intens_subs),
  proportion_var2 = as.numeric(subst_frequency/nvar), 
                intens = m_intens_subs) %>%
ggplot(aes(proportion_var2, intens, label = subst_name)) + geom_point()
ggplotly(p + geom_vline(xintercept = 0.5, color = "red", size= .1))
```

We choose the substitutions according to approach 3
```{r}
selected_substs <- names(subst_proportion_var2[subst_proportion_var2 > 0.5])
```

and we compute their mass differences with respect to the monoisotopic form
that they they produce. 

```{r}
# Here I loop over the isotope patterns until I encounter all the selected 
# substitutions and for each of them I compute the related md.
md <- rep(0, length(selected_substs)); i=1
while (any(md == 0) & i<= length(iso_ps)){
not_mono <- which(rowSums(iso_ps[[i]][, intersect(colnames(iso_ps[[i]]), isos), drop = FALSE]) != 0)
I <- match(subst_per_cmpd[[i]], selected_substs[md == 0])
md[md == 0][na.omit(I)] = iso_ps[[i]][not_mono[!is.na(I)], "m/z"] - cmps$exactmass[i]
i=i+1
}
```

We compute the probability to observe the monoisotopic form of each compound
and we use it to compute the ratios R (for the selected substitutions) from 
the probabilities of the substitutions obtained through enviPat::isopattern.

```{r}
# I computed this separately because for some compounds containing elements
# different from CHNOSCl the monoisotopic peak doesn't appear in the output
# of enviPat::isopattern being its probabilty lower than the threshold 
monois_p <- apply(counts_df, 1, function(row) {
  I <- row > 0
  ns <- row[I]
  ps <- isotopes[match(unique(names(counts_df)[I]), isotopes$element), 
                 "abundance"]
  prod(ps^ns)
  })
```

```{r}
Rs <- lapply(seq_along(iso_ps), 
             function(i){
               not_mono <- which(rowSums(iso_ps[[i]][, intersect(colnames(iso_ps[[i]]), isos), drop = FALSE]) != 0)
               iso_ps[[i]][not_mono[match(selected_substs, subst_per_cmpd[[i]])], 
                           "abundance"]/monois_p[i]
               })
R_df <- do.call(rbind, Rs)
colnames(R_df) <- selected_substs
```

By writing and manipulating the analytical formula of the ratio R it is possible 
to see that if the relation between the mass of compounds and the counts of a 
given element (for each element appearing in the substitution) is linear then 
also R has a polynomial form in the mass and the degree of the polynomial is 
determined by the number of atoms in the substitution.

Here we plot the counts of C, H, N, O, S, Cl against the mass of HMBD compounds.
For some elements a linear trend is clearly visible, for others it's not that 
evident (and as a result of that I expect that for the substitutions containing 
these element the polynomial trend could be less pronounced).
```{r, fig.width = 15, fig.height = 10}
par(mfrow = c(3, 2), mar = c(3, 4, 1, 0.5))
for (el in c("C", "H", "N" , "O", "S", "Cl")) {
counts_el <- counts_df[counts_df[, el] > 0, el]
exactmass <- cmps$exactmass[counts_df[, el] > 0]
plot(counts_el ~ exactmass, ylab = "counts", xlab = "exactmass", main = el)
}
```

In view of what we observed before we compute the degree of the expected 
polynomial trend by computing the number of atoms which appear in the 
substitutions.

```{r}
sbst_degree <- sapply(selected_substs, function(string) sum(count_heavy_iso(string)))
```

We transform the data taking the sbst_degree-th root of the values of R and we
compute the slope of the lines through (0,0) and each point (mass, transformed R).
We compute an upper and lower quantile for the slopes representing the slopes
of a upper and lower bound line for the values of the transformed R.
```{r}
R_trnsf <- t(t(R_df)^(1/sbst_degree))
colnames(R_trnsf) <- colnames(R_df)
slp <- R_trnsf/cmps$exactmass
q_slp <- apply(slp, 2, function(x) quantile(x, c(0.005, 0.995), na.rm = TRUE)) # values to be chosen
```

Below we plot the results. We can observe a linear trend for each substitution 
in the transformed data (especially for the substitutions containing only 
elements with clear linear trend of the counts in the mass as observed before).

```{r, fig.width = 15, fig.height = 90, fig.cap = "R against mass for HMBD compounds."}
s_to_plot <- selected_substs# c("1[13C]", "2[13C]", "1[13C]1[33S]1[37Cl]")
par(mfrow = c(ceiling(length(s_to_plot)/3), 3), mar = c(5, 4, 1, 0.5))
for (name in s_to_plot) {
  plot(cmps$exactmass, R_trnsf[, name], xlab = "mass", ylab = "R", main = name)
  abline(0, q_slp[2, name], col = "blue")
  abline(0, q_slp[1, name], col = "green")
}
```
Finally, we create the substitution definition data.frame. For each substitution 
(row) we report its name, degree, mass difference and bounds on R. 
```{r}
# subst_degree column is not strictly necessary and could be 
# also computed inside .isotope_peaks function from subst_name
subst_def <- data.frame(
  subst_name = selected_substs,
  subst_degree = sbst_degree,
  md = md,
  min_slope = q_slp[1, ],
  max_slope = q_slp[2, ]
)
```


```{r}
dr_txt <- paste0("data/txt/isotope-intensity-estimation/")
dir.create(dr, showWarnings = FALSE, recursive = TRUE)
write.table(subst_def, file = paste0(dr_txt, "subst_def.txt"),
            sep = "\t", row.names = TRUE)
```
### Discussion

- [ ] m/z dependent isotopologues: check if the m/z matches ~ the mass of the
      isotopologue definition. Considering an isotopologue 9[13C]2[18O] would
      not make sense for an m/z that is lower than the mass of this
      isotopologue.



# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
