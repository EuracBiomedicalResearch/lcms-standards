---
title: "Defining parameters to identify isotopologue peaks using compounds from HMDB"
author: "Andrea Vicini, Vinicius Verri Hernandez, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_depth: 3
    fig_width: 5
---

```{r style, echo = FALSE, results = 'asis', message = FALSE}
library(BiocStyle)
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

**Last modified:** `r file.info("isotope-intensity-estimation.Rmd")$mtime`<br />
**Compiled**: `r date()`

$\require{mhchem}$

# Introduction

In this document we evaluate possibilities to estimate m/z and intensities of
compounds' isotopologues without knowing the chemical formula of the
compound. Ultimately, this should allow to identify groups of mass peaks in a
spectrum that represents isotopologues of the same compound.


# Isotope detection or definition approaches


## `CAMERA`

[`CAMERA`](https://bioconductor.org/packages/release/bioc/html/CAMERA.html)
takes a simple approach based on hard coded lower and upper limits for isotope
peaks. How this limits were defined is unclear. For the m/z differences of the
peaks simple lower and upper limits are used, not discriminating between
e.g. C13 and N15 isotopes.

## `envipat`

[`envipat`](https://cran.r-project.org/web/packages/enviPat/) does not seem to
allow identifying isotopes in MS data but does predict an isotope (intensity)
distribution from a chemical formula.


## Breen et al. 2000. Automatic poisson peak harvesting for high throughput protein identification

The authors consider Poisson modelling of isotopic distributions. Given a 
molecule with mass m they find a mapping F between m and the mean M of the 
Poisson distribution model (F: m-> M).
To compute this mapping they derive from a database a hypothetical average 
aminoacid. Next they use this to construct a set of the theoretical peptides 
whose mass span a certain range of interest. They compute the isotopic 
distribution of those and for each one of them they compute M* as the value of M 
that makes Poisson(M) more similar to the isotopic distribution. Finally they 
fit a line for the values of m against the M* and this line represents the 
mapping F. In the end, they model the isotopic distribution of a compound with 
mass m as a Poisson(P(M))

## Park et al. 2008. Isotopic peak intensity ratio based algorithm for determination of isotopic clusters and monoisotopic masses of polypeptides from high-resolution mass spectrometric data

The following statements are reported for the isotopic distribution of a compound 
with elements C, H, N, O, S.
- the intensity of a peak Ik approximates to a polynomial in m (molecular weight) 
  with degree k
- the ratio between consecutive peaks (R) approximates to a linear function in m
- the ratio product between adjacent peaks (RP) approximates to a constant.

For the last two, the more m is big the better the above approximations get.

To find a relation between R and m they consider a large number of polypeptides 
in a certain database spanning a certain range (400-5200 Da) and for them 
they compute R. Then, the interval of interest is divided in two regions 
(at 1800 Da). For high masses a linear approximation is used and 
its coefficients are found by fitting a regression line whereas for low masses
they use a quotient of polynomials (with degree k+1 and k for the k-th R)

The algorithm to cluster isotopic peaks after peak peaking) involves:

- pseudocluster identification. It requires to loop over all the peaks and for
  each of them find groups of peaks starting with the current peak and separated
  by +1 (in the single charged case) for each peak. They first enumerate
  pseudoclusters with two peaks, then pseudoclusters with more peaks and then
  proceed by considering different charged states.
- isotopic cluster identification. Among the pseudoclusters, they identify
  isotopic clusters whose intensity patterns are similar to those of the
  isotopic distributions in terms of R and RP in the pseudocluster.
- duplicate cluster removal. In case two clusters overlap they remove the one
  whose most abundant peak is smaller. If the most abundant peaks are the same,
  the one with the lowest charge state is removed. If their charge states are
  also the same, the cluster with the lower "similarity score" is removed.

## Valkenborg et al. 2008. A Model-Based Method for the Prediction of the Isotopic Distribution of Peptides

Also in this article the authors consider the ratios between peak heights.
They model it as a polynomial model in m (monoisotopic mass) whose order 
is empirically determined by looking at the improvements obtained by adding 
higher order terms.
The parameters of the polynomial model are estimated using the least-squares 
method on different sets of theoretical peptides (and the model is valid in the 
corresponding mass range).
By comparing the ratios between a series of peaks observed in a spectrum with 
the ratios predicted from the model and selecting a treshold for the allowed 
"difference" they decide whether the series of peaks is part of an isotopic 
group or not.

## sgibb

As far as I have understood sgibb uses a mixed approach. He uses the approach of 
Park et al. 2008 but for checking if a candidate cluster is a isotope cluster, 
for which he uses the Poisson approach of Breen et al. 2000.


# Identification of isotopologue peaks in MS1 data

**Given**\

An MS1 spectrum with paired m/z and intensity values.

**Goal**\

Identify all mass peaks (i.e. m/z and intensity pairs) in a spectrum that
could represent signal from
[isotopologues](https://goldbook.iupac.org/terms/view/I03351) of the same
compound.

**Required**\

- Difference in m/z $mzd$ between a monoisotopic peak and the peak of an
  isotopologue.
- Expected intensity $x_{I}$ for the isotopologue peak (e.g. relative to the
  monoisotopic peak intensity $x_{0}$).

## Definitions and approach

The presence of heavier elemental isotopes in a compound will result in a mass
difference $md$ with respect to the monoisotopic mass of the compound. Although
for each element, each isotope species is characterized by a difference of one
or more neutrons, the difference in mass between them isn't exactly integer and
each elemental isotope will contribute in a different way producing different
overall mass differences.

In a compound with $n$ atoms of element $X$ ($n_X$) each of the atoms can be in
a specific isotope form $\ce{ ^{y}X }$ such as $\ce{^{12}C}$ or $\ce{^{13}C}$
(with the prevalence of each isotope form for each element being known). Each
combination of such isotopes $I_X$ (e.g. $\ce{^{12}C3}$ $\ce{^{13}C2}$ 
$\ce{^{14}C4}$ will result in a different shift in mass $md_{I_X}$. 

The probability $P(I_X)$ of observing such a combination of isotopes for an
element $X$ can be computed using the multinomial distribution. The overall mass
difference $md$ with respect to the monoisotopic mass is determined by the
combination (number and variant) of isotopes of each element $X, Y,... Z$ in the
molecule which defines the
(isotopologue)[https://en.wikipedia.org/wiki/Isotopologue] of the compound $I =
(I_X, I_Y... I_Z)$ and is given by the sum of the individual mass differences:

$$md = \sum md_{I_{i}}$$ 

Finally the probability of observing the isotopologue $I$ (and the corresponding
mass difference $md$) is the product of the probabilities of observing each
isotope variant related to each element.

$$P(I) = \prod P(I_{i})$$

There is a very high number $N_{I_X} = \binom{q + n_X -1}{n_X}$ of possible
combinations of isotopes $I_X$ for the atoms of $X$ and a even greater number
$N_{I_X}* N_{I_Y}...*N_{I_Z}$ of possible isotopologues $I=(I_X, I_Y..., I_Z)$. 
As a first simplification we keep only isotopologues observed in compounds from
the Human Metabolome Database HMDB that in addition result in an intensity that
is higher than a pre-defined proportion of the monoisotopic peak.

Finally, the ratio between the intensities of the monoisotopic peak $x_0$ and a
peak of an isotopologue $x_I$ is supposed to be equivalent to the ratio of their
probabilities

$$R_{I} = \frac{x_{I}}{x_{0}} = \frac{P(I)}{P(0)}$$

This ratio $R_{I}$ depends only on probabilities of the isotopes in which the
isotopologue differ from the monoisotopic form, i.e. which are part of the
isotopic substitution (all other probabilities will cancel themselves in the
ratio above).

Thus, given the chemical formula and hence total numbers of atoms of each
elements of a compound would be known, both the intensity $x_{I}$ and the mass
difference $md$ of each of its isotopologues could be determined.

Without prior knowledge of the measured compounds (and hence chemical formulas)
or defined isotopologues, we need make some simplifications and approximations
to allow the identification of isotopologue peaks from m/z and intensity values
alone. 

In the present approach we first determine for each compound in HMDB all
isotopologues that would result in a peak with an intensity (relative to the
monoisotopic peak) above a certain threshold. We next identify the most
frequently observed isotopologues (across all compounds in HMDB). For each of
these isotopologues we then determine their mass difference and evaluate the
observed intensity (probability) ratios between the monoisotopic peak and the
isotopologue of all compounds in HMDB for which the isotopologue was
reported. The mass difference is constant for the isotopologues but their
intensity ratio depends on the total number of atoms part of the isotopic
substitution that are present in the compound. For each isotopologue we have
however the empirically determined intensity ratios from the whole set of HMDB
compounds which allows us to define lower and upper bounds of *expected*
(naturally observed) intensity ratios.

Further, a dependency between the number of (certain) atoms and the m/z (or
mass) of a compound can be assumed, and this number of atoms has inherently also
an influence on the intensity (probability) ratio of an isotopologue. We thus
determine for each of the selected isotopologues a mass dependent upper and
lower bound for $R$ to better model this relationship.

## Properties

- This approach considers isotopologues, i.e. all isotopic substitutions
  resulting in a peak and not single isotopes of elements separately.
- This approach considers both differences in mass as well as ratios between the
  intensities of an candidate isotopologue and monoisotopic peaks for
  isotopologue peak identification.
- This approach uses observed intensity (probability) ratios between
  isotopologue and monoisotopic peaks for all compounds in HMDB to define
  mass-dependent lower and upper bounds for the expected isotopologue intensity.

## Limitations

- The present definitions base on compounds from HMDB and the presented approach
  would hence fail to identify isotopes of e.g. anorganic compounds. Parameters
  would have to be estimated based on corresponding collection of compounds.
- By using only the most frequent isotopic substitutions we might miss detection
  of less frequent isotopologues.

## Parameter estimation

Before proceeding to the actual estimation of the parameters we evaluate element
counts for all compounds listed in HMDB.

```{r libraries, warning = FALSE}
library("CompoundDb")
library("MetaboCoreUtils")
library("pander")
library("enviPat")
```

We load the HMDB database and extract the chemical formula and exact mass of all
compounds.

```{r}
cdb <- CompDb("data/CompDb.Hsapiens.HMDB.4.0.sqlite")
cmps <- compounds(cdb, columns = c("compound_id", "name",
                                   "formula", "exactmass"))
```

For each compound in the human metabolom database (HMDB) with available mass 
we compute how many atoms of C, H, N, O, P and S as well as Cl are present in it
(the latter is important because in human serum samples it is very likely that
Cl adducts are generated by electro spray ionization). 
We collect the counts in a data frame with a column for each element and a row 
for each compound in HMDB.

```{r}
cmps <- cmps[-which(is.na(cmps$exactmass)), ]
```

```{r}
tmp <- lapply(cmps$formula, function(frml) res <- countElements(frml))
elements_names <- unique(names(unlist(tmp)))
counts <- lapply(tmp, function(x) {
  row <- numeric(length(elements_names))
  names(row) <- elements_names
  row[names(x)] <- x
  row
  })
counts_df <- data.frame(do.call(rbind, counts))
rownames(counts_df) <- cmps$compound_id
```

```{r}
CHNOPSCl <- c("C", "H", "N", "O", "P", "S", "Cl")
counts_CHNOPSCl <- data.frame(counts_df[ , CHNOPSCl])
```

```{r}
onlyCHNOPSCl <- rowSums(counts_df[, setdiff(elements_names, CHNOPSCl)]) == 0

# With the following lines we can exclude compounds that have some atoms of
# elements different from CHNOPSCl.
cmps <- cmps[onlyCHNOPSCl, ]
counts_df <- counts_df[onlyCHNOPSCl, ]
```

From the `r nrow(counts_df)` compounds in HMDB 
`r sum(onlyCHNOPSCl != 1)` contain elements other than 
`r paste(CHNOPSCl, collapse = ",")`.

We compute the mean and standard deviation for the number of each element in the
molecules of HMDB. For each element we also report the percentage of compounds 
which have at least one atom of the given element.

```{r, echo = FALSE, results = "asis"}
m_sd <- rbind(colMeans(counts_CHNOPSCl), 
              apply(counts_CHNOPSCl, 2, sd),
              100 * colSums(counts_CHNOPSCl > 0) / nrow(counts_CHNOPSCl))
rownames(m_sd) = c("mean", "standard deviation", "% compounds with count > 0")
pandoc.table(m_sd, style = "rmarkdown")
```

We plot, for each of the considered elements, the distribution of the number of 
atoms of the given element in the compounds of HMDB.

```{r distribution-counts, fig.cap = "Distribution of the number of atoms of CHNOPSCl elements in compounds of HMDB.", fig.width = 7, fig.height = 14, echo = FALSE}
par(mfrow = c(7, 1), mar = c(3, 4, 1, 0.5))
for (el in CHNOPSCl) {
  hist(counts_CHNOPSCl[, el], xlab = "", main = el, breaks = 256)
  abline(v = quantile(counts_CHNOPSCl[, el], c(0.025, 0.975)))
}
```

The most frequent elements in HMDB compounds are H, C and O, but while the
number of C and H atoms varies considerably and goes up to over 100, the maximal
number of O atoms if below 25. Also, the numbers of atoms for all other elements
is only very low. 



### Identification of the most frequent isotopic substitutions {#isotopologues}

We next aim at identifying the most frequently observed isotopologues for
compounds in the HMDB.

To this end we calculate the isotope pattern for each compound in HMDB using
`enviPat` and identify isotopologues which would result in an intensity
higher than a certain proportion of the monoisotopic form. We use a threshold of
0.01% of the intensity from the monoisotopic
mass. For each of these peaks we define its *isotopologue id* which
consists of the isotopes characterizing this isotopologue,
e.g. `"[13]C4[15]N2"` and determine the frequency of each isotopologue in HMDB.

```{r, echo = FALSE}
dr <- paste0("data/RData/isotope-intensity-estimation/")
dir.create(dr, showWarnings = FALSE, recursive = TRUE)
```

```{r}
data(isotopes)
# isos <- c("13C", "2H", "15N", "17O", "18O", "33S", "34S", "35S", "36S",
#           "36Cl", "37Cl")
isos <- isotopes$isotope[-match(unique(isotopes$element), isotopes$element)]
```


```{r, eval = !file.exists(paste0(dr, "subst_frequencies.RData"))}
## Ensure that element order is correct
chemforms <- sapply(cmps$formula, standardizeFormula)
threshold <- 0.01 * 10^(-2)
iso_ps <- isopattern(isotopes, chemforms , threshold = threshold, rel_to = 2) 

## Define the isotopologue name for each substitution - ensuring the order of
## isotopes to be the same across compounds
iso_ps <- lapply(iso_ps, function(iso_p) {
    idx <- match(colnames(iso_p), isos)
    tmp <- iso_p[, !is.na(idx), drop = FALSE]
    mono_iso <- rowSums(tmp) == 0
    tmp <- tmp[!mono_iso, order(idx[!is.na(idx)]), drop = FALSE]
    cn <- colnames(tmp)
    elname <- gsub('[0-9]', '', cn)
    isonumb <- gsub('[^0-9]', '', cn)
    nms <- rep("", nrow(iso_p))
    nms[!mono_iso] <- apply(tmp, 1, function(row)
        paste0("[", isonumb[row >0],  "]", elname[row > 0], row[row > 0], 
               collapse = ""))
    nms[mono_iso] <- "mono"
    rownames(iso_p) <- nms
    iso_p
})

subst_per_cmpd <- lapply(iso_ps, function(z) rownames(z)[rownames(z) != "mono"])
subst_frequency <- table(unlist(subst_per_cmpd, use.names = FALSE))
save(subst_frequency, subst_per_cmpd, 
     iso_ps, chemforms, file = paste0(dr, "subst_frequencies.RData"))
```


```{r, echo = FALSE, eval = file.exists(paste0(dr, "subst_frequencies.RData"))}
load(paste0(dr, "subst_frequencies.RData"))
```

We thus defined `r length(subst_frequency)` substitutions that in at least a 
compound in HMBD would yield a probability higher than 10^(-4).

For each given substitution we compute the mean intensity it has in the
compounds of HMBD where it was found to result in a peak higher then the set
threshold.

```{r}
intens <- unlist(lapply(iso_ps, function(iso_p) {
    iso_p[rownames(iso_p) != "mono", "abundance"]
}), use.names = FALSE)
m_intens_subs <- tapply(intens, unlist(subst_per_cmpd, use.names = FALSE), mean)
```

and plot it against the frequency of the substitution in HMBD. Most of the 
substitution present a small mean intensity. Most of the substitution with mean 
intensity higher than 5 are those related to Cl (these are not very frequent) 
and C.

```{r}
library(ggplot2)
library(plotly)
p <- data.frame(subst_name = names(m_intens_subs),
  subst_frequency = as.numeric(subst_frequency), 
                intens = m_intens_subs) %>%
ggplot(aes(subst_frequency, intens, label = subst_name)) + geom_point()
ggplotly(p)
```

We next identify the *most frequently* observed isotopologues in compounds of
HMDB using 3 different approaches.

In the first approach we simply select the isotopologues found in 50% of
compounds to yield an intensity larger than the set threshold.

```{r, fig.height = 5, fig.width = 9, fig.cap = "Substitutions with proportion > 0.5 using approach 1"}
subst_proportion <- sort(subst_frequency / nrow(cmps), decreasing = TRUE)
par(mar = c(8, 4.1, 4.1, 2.1), mfrow = c(1, 1))
barplot(subst_proportion[subst_proportion > 0.5], las = 2)
```

In the plot above we can see isotopologues for compounds in HMBD that produce a
*significant* peak for at least a half of the compounds (the height of the bar
specifies the exact proportion). In other words, if we randomly sample a
compound in HMBD the chance to observe a significant peak related to the above
isotopologues will be high. Because of the high frequency of C, H and O elements
in compounds of HMDB, this selection is heavily biased by isotopes of these
elements.

Thus, in the second approach we compare the frequency of an isotopologue against
the number of compounds in HMDB that contain each of the elements from the
isotopologue definition in their chemical formula.

```{r}
ncomps <- vapply(names(subst_frequency), function(x) {
    x <- strsplit(gsub("[0-9\\[]+", "", x), split = "\\]")[[1]][-1]
    sum(rowSums(counts_df[, x, drop = FALSE] > 0) == length(x))
}, integer(1))
```

```{r, fig.height = 5, fig.width = 17, fig.cap= "Substitutions with proportion > 0.5 using approach 2"}
subst_proportion_var <- sort(subst_frequency/ncomps, decreasing = TRUE)
par(mar = c(10, 4.1, 4.1, 2.1))
barplot(subst_proportion_var[subst_proportion_var > 0.5], las = 2)
```

```{r, fig.height = 5, fig.width = 10, fig.cap = "Proportions computed according the second approach and mean intensities for the substitutions. The substitutions on the right of the red line correspond to the columns in the previous barplot"}
p <- data.frame( subst_name = names(m_intens_subs),
  proportion_var = as.numeric(subst_frequency/ncomps), 
                intens = m_intens_subs) %>%
ggplot(aes(proportion_var, intens, label = subst_name)) + geom_point()
ggplotly(p + geom_vline(xintercept = 0.5, color = "red", size = .1))
```

Third approach. Here I also try to divide the counts of the times a family is
found to be significant in the HMBD compounds for the times that this family can
be observed across the HMBD compounds. In other words these ratios represent the
likelihood to find a family significant among the subset of HMBD compounds that
have it as possible substitution (this happens when, for each element $X$ in the
compound, the number of atoms of $X$ is >= than the sum of the numbers
${n_X}_2$, ..., ${n_X}_q$ of heavier isotopes associated to the substitution).

```{r}
count_heavy_iso <- function(subst_str){
  tmp <- sapply(strsplit(subst_str, split = "\\[")[[1]][-1], 
                function(s) strsplit(s, split ="\\]")[[1]][2])
  tapply(as.numeric(gsub('[^0-9]+', '', tmp)), gsub('[0-9]+', '', tmp), sum)
}

nvar <- sapply(names(subst_frequency), function(subst) {
  els <- count_heavy_iso(subst)
  var <- rep(TRUE, nrow(counts_df))
  for (el in names(els)) 
    var <- var & (counts_df[, el] >= els[el])
  sum(var)
})
```

```{r, fig.height = 5, fig.width = 17, fig.cap = "Substitutions with proportion > 0.5 using approach 3"}
subst_proportion_var2 <- sort(subst_frequency/nvar, decreasing = TRUE)
par(mar = c(10, 4.1, 4.1, 2.1))
barplot(subst_proportion_var2[subst_proportion_var2 > 0.5], las = 2)
```

In the plot above we can see the substitutions that produce a significant 
peak for at least a half of the compounds in which they are possible. 
(the height of the bar specifies the exact proportion). In this case we observe 
also families where N, S or Cl in them. 
To exemplify the difference, all molecules (the proportion in the above plot is 
1) of HMBD that have at least 1 atom of C and 1 atom of Cl are found to have 
significant peaks corresponding to [13]C1[37]Cl1. However, since the number of 
such compounds in HMBD is very low the probability of observing the effect of 
such a substitution is very very low if we randomly pick one compound in HMBD.

In the following plot I show also the mean intensity of the substitutions. 
According to the third approach we select substitutions of Cl which have high 
mean intensity but were excluded with the first two approaches.

```{r, fig.height = 5, fig.width = 10, fig.cap = "Proportions computed according the third approach and mean intensities for the substitutions. The substitutions on the right of the red line correspond to the columns in the previous barplot"}
library(ggplot2)
library(plotly)
par(mfrow= c(1,2))
p <- data.frame(subst_name = names(m_intens_subs),
                proportion_var2 = as.numeric(subst_frequency/nvar), 
                intens = m_intens_subs) %>%
ggplot(aes(proportion_var2, intens, label = subst_name)) + geom_point()
ggplotly(p + geom_vline(xintercept = 0.5, color = "red", size= .1))
```

We thus select substitutions defined by approach 3 as the *most frequently
observed isotopologues*. 

```{r}
selected_substs <- names(subst_proportion_var2[subst_proportion_var2 > 0.5])
```

### Defining mass difference and intensity (probability) ratios

We next compute for all of the selected isotopologues their mass difference $md$
and subsequently also the observed intensity (probability) ratios between
monoisotopic peak and isotopologue peak.

```{r}
## Calculate mass differences and intensity (probability) ratios for all
## isotopologues; putting all into a data.frame for easier data processing
iso_data <- lapply(iso_ps, function(z) {
    mono <- which(rownames(z) == "mono")
    if (length(mono) == 1L) {
        res <- data.frame(isotopologue = rownames(z),
                          md = z[, "m/z"] - z[mono, "m/z"],
                          R = z[, "abundance"] / z[mono, "abundance"],
                          z[, c("m/z", "abundance"), drop = FALSE],
                          monomass = z[mono, "m/z"],
                          check.names = FALSE)
        res[-mono, , drop = FALSE]
    } else {
        data.frame(isotopologue = rownames(z),
                   md = NA_real_,
                   R = NA_real_,
                   z[, c("m/z", "abundance"), drop = FALSE],
                   monomass = NA_real_,
                   check.names = FALSE)
    }
})
cnts <- vapply(iso_data, nrow, integer(1))
iso_data <- do.call(rbind, iso_data)
rownames(iso_data) <- NULL
iso_data$formula <- rep(cmps$formula, cnts)
iso_data$hmdb_id <- rep(cmps$compound_id, cnts)

## subset to selected isotopologues
iso_data_sub <- iso_data[iso_data$isotopologue %in% selected_substs, ]
```

We next extract the mass difference $md$ for each isotopologue.

```{r}
## Calculate the md for each substitution
md <- vapply(split(iso_data$md, iso_data$isotopologue)[selected_substs],
             mean, numeric(1))
```

And finally also the ratios $R$ for each isotopologue.

```{r}
R <- split(iso_data$R, iso_data$isotopologue)[selected_substs]
```

For each isotopologue we have thus defined the observed intensity (probability)
ratio for compounds in HMDB. The probability of an isotope for a single element
is depending on the number of atoms of that element in a compound and the
probability of an isotopologue (i.e. several different isotopes occurring in the
same compound) is equal to the product of the probabilities of the individual
isotopes. Also, there needs to be a relationship between a compounds mass and
the number of atoms its build of, with heavier compounds consisting of a larger
number of atoms. To evaluate that we plot below the counts of individual
elements against the mass of HMDB compounds.

```{r hmdb-element-counts, fig.width = 15, fig.height = 10}
par(mfrow = c(3, 2), mar = c(3, 4, 1, 0.5))
for (el in c("C", "H", "N" , "O", "S", "Cl")) {
    counts_el <- counts_df[counts_df[, el] > 0, el]
    exactmass <- cmps$exactmass[counts_df[, el] > 0]
    plot(counts_el ~ exactmass, ylab = "counts", xlab = "exactmass", main = el,
         pch = 16, col = "#00000040")
}
```

For some elements clearly a linear relationship between the element count and
the compound's mass is visible. The ratio of the probabilities between the
isotopologue and its monoisotopic form depends only on the probabilities of the
isotopes forming the substitution. These probabilities are products on the
individual isotopes' probabilities (which depend on the total number of atoms of
the isotope's element). Given the relationship between the element count
and the compounds mass is linear, we can expect the relationship between the
probability ratio $R$ and the compound's mass to be polynomial with degree
depending on the number of atoms in the substitution.

We thus next determine the degree of the expected polynomial trend by computing
the number of atoms which appear in the substitutions.

```{r}
sbst_degree <- sapply(
    selected_substs, function(string) sum(count_heavy_iso(string)))
iso_data_sub$degree <- sbst_degree[match(iso_data_sub$isotopologue,
                                         names(sbst_degree))]
```

We next transform the data by taking the $x$-th root of $R$ for each 
isotopologue (with $x$ being the degree of the polynomial for each
isotopologue).

```{r}
iso_data_sub$`R_` <- iso_data_sub$R^(1 / iso_data_sub$degree)
```

We next calculate next the ratios between all such transformed $\hat{R}$ of all
isotopologues and the mass of the respective compound. These represent the
slopes from (0, 0) to each data point in the mass - by - $\hat{R}$ space. For
each isotopologue we then determine an upper and lower quantile of these slopes
which we will use as an upper and lower bound for the estimation of the
$\hat{R}$ from a unknown compound's mass.

```{r}
iso_data_sub$slope <- iso_data_sub$R_ / iso_data_sub$monomass
iso_slope_q <- lapply(split(iso_data_sub$slope, iso_data_sub$isotopologue),
                      function(x) quantile(x, c(0.005, 0.995), na.rm = TRUE))
```

We next plot the relationship between the transformed $\hat{R}$ and the
compound masses for all selected isotopologue.

```{r, echo = FALSE}
f <- rep(seq(ceiling(length(selected_substs)/9)), each = 9)[seq_along(selected_substs)]
plts <- split(sort(selected_substs), f)

tmp <- lapply(plts, function(z) {
    par(mfrow = c(3, 3), mar = c(4.2, 4.2, 2, 0.5))
    for (iso in z) {
        idx <- which(iso_data_sub$isotopologue == iso)
        plot(iso_data_sub$monomass[idx], iso_data_sub$R_[idx],
             main = iso, xlab = "monoisotopic mass", ylab = expression(hat(R)),
             pch = 16, col = "#00000040", cex = 0.75)
        abline(0, iso_slope_q[[iso]][2L], col = "#377EB880")
        abline(0, iso_slope_q[[iso]][1L], col = "#4DAF4A80")
    }
})
```

We can observe a linear trend for each substitution in the transformed data
(especially for the substitutions containing only elements with clear linear
trend of the counts in the mass as observed before).

Finally, we create the substitution definition `data.frame`. For each
isotopologue (row) we report its name, the degree of the polynomial, the mass
difference $md$, the lowest mass it was observed, and the lower and upper bounds
on $\hat{R}$.

```{r}
f <- factor(iso_data_sub$isotopologue)
hmdb_subst <- data.frame(
    name = levels(f),
    degree = iso_data_sub$degree[match(levels(f), iso_data_sub$isotopologue)],
    minmass = vapply(split(iso_data_sub$monomass, f), min, numeric(1)),
    md = iso_data_sub$md[match(levels(f), iso_data_sub$isotopologue)],
    min_slope = vapply(iso_slope_q[levels(f)], "[", numeric(1), 1L),
    max_slope = vapply(iso_slope_q[levels(f)], "[", numeric(1), 2L)
)
hmdb_subst <- hmdb_subst[order(hmdb_subst$md), ]
```


```{r}
dr_txt <- paste0("data/txt/isotope-intensity-estimation/")
dir.create(dr, showWarnings = FALSE, recursive = TRUE)
write.table(hmdb_subst, file = paste0(dr_txt, "hmdb_subst.txt"),
            sep = "\t", row.names = TRUE)
```


# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
