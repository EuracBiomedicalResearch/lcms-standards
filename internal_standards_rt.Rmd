---
title: "Define the retention times for the internal standards"
author: "Mar Garcia-Aloy"
output: 
  BiocStyle::html_document:
    toc: true
    number_sections: false
    toc_float: true
---

```{r settings, echo = FALSE, results = "hide", message = FALSE}
polarity <- "POS" # specify "POS" or "NEG"
da <- 0.01

#' Define the path where we can find the mzML files:
MZML_PATH <- "C:/Users/mgarciaaloy/Documents/mzML/"
#if (!file.exists(MZML_PATH))
#    stop("Can not find the directory with the mzML files: ", MZML_PATH)
```

# Preliminaries
```{r, message=FALSE}
library(xcms)
library(MsCoreUtils)
library(magrittr)


# Define a function for getting which mz values are 
# within an independent list of mz values
which_within <- function(x, y, mzd = 0.01){
  lapply(x, function(z){
    which(y >= z - mzd & y <= z + mzd)
  }
    )
}
```

# Data import
In the file `internal_standards_files.txt` there is the information regarding 
the injection sequence.
```{r}
injections <- read.table("data/internal_standards_files.txt", # import the file
                         sep = "\t", header = TRUE, as.is = TRUE)
myfiles <- injections$mzML # get file names
myfiles <- myfiles[grep(polarity, myfiles)]# select files names of our polarity
```

In the file `internal_standards.txt` there is the information regarding the 
standards that are in the samples.  
```{r}
is_info <- read.table("data/internal_standards.txt",
                      sep = "\t", header = TRUE, as.is = TRUE)
colnames(is_info) <- c("name", "molecular_weight", "POS", "NEG")
is_info <- is_info[,1:4]
head(is_info)
```


# Check RT
We are going to do this step using only 1 of the injections.   
We've choosed the nº 7.
```{r}
# Load the raw data
raw_data <- readMSData(paste0(MZML_PATH, myfiles[grep("_7", myfiles)]), 
                       mode = "onDisk")

# Get the base peak chromatogram (BPC)
bpis  = chromatogram(raw_data, aggregationFun = "max")

# Plot the BPC
plot(bpis, col="black", main = paste("IS_7", polarity, sep = "_"))

# Bin the BPC
bpis_bin <- MSnbase::bin(bpis[1,1], binSize = 1)
```

## Major peaks
The following steps are going to be done manually.  
The idea is to identify the peaks from the most intensive one to the least one.  
Each time that one peak has been assigned to one compound, the RT window for 
that peak has to be excluded from the data frame `bpis_bin_df`.
```{r}
# Order the chromatographic bins accorder to intensity:
bpis_bin_df = data.frame(rt=rtime(bpis_bin), i=intensity(bpis_bin))
bpis_bin_df = bpis_bin_df[order(-bpis_bin_df$i),]
bpis_bin_df = bpis_bin_df[
  !(bpis_bin_df$rt>25 & bpis_bin_df$rt<29)  # & # A          (27) [04]
  #!(bpis_bin_df$rt>29 & bpis_bin_df$rt<32)   & # B          (31) [03]
  #!(bpis_bin_df$rt>32 & bpis_bin_df$rt<35)   & # c          (33) [03]
  #!(bpis_bin_df$rt>48 & bpis_bin_df$rt<67)   & # carnitine  (59) [19] **
  #!(bpis_bin_df$rt>67 & bpis_bin_df$rt<84)   & # creatinine (82) [17]
  #!(bpis_bin_df$rt>120 & bpis_bin_df$rt<134) & # (iso)leuc (131) [14]
  #!(bpis_bin_df$rt>134 & bpis_bin_df$rt<139) & # phenylala (138) [05]
  #!(bpis_bin_df$rt>139 & bpis_bin_df$rt<143) & # valine    (141) [04]
  #!(bpis_bin_df$rt>143 & bpis_bin_df$rt<147) & # methionine(145) [04]
  #!(bpis_bin_df$rt>150 & bpis_bin_df$rt<155) & # proline   (152) [05] 
                                                # tyrosine  (153)
  #!(bpis_bin_df$rt>167 & bpis_bin_df$rt<172) & # threonine (169) [05] 
                                                # glutamic  (170)
  #!(bpis_bin_df$rt>185 & bpis_bin_df$rt<188) & # arginine  (187) [03] **
  #!(bpis_bin_df$rt>188 & bpis_bin_df$rt<191) & # lysine    (188) [03] 
                                                # histidine (189)
  #!(bpis_bin_df$rt>194 & bpis_bin_df$rt<198) & # D         (196) [04] 
                                                # histidine (189)
  #!(bpis_bin_df$rt>208 & bpis_bin_df$rt<212)   # cysteine  (209) [04]
    ,]
bpis_bin_df[1,]

# Look where is the peak in the whole TIC
plot(bpis, col="black", main = paste("IS_7", polarity, sep = "_"))
points(bpis_bin_df[1,1], bpis_bin_df[1,2], pch=8, col="red")

my.rt = 186.7 # indicate the RT

# Zoom the TIC for the desidered RT:
plot(bpis, col="black", xlim=c(bpis_bin_df[1,1]-10,bpis_bin_df[1,1]+10))
abline(v=my.rt, col="red")

# Get all spectra measured within the time "my.rt":
sps <- raw_data %>%
    filterRt(rt = c(my.rt-0.5, my.rt+0.5)) %>%
    spectra 
sps.df=as.data.frame(sps[[2]])
sps.df = sps.df[order(-sps.df$i),]
View(sps.df)

# Check which of the theorical mz values are within the spectra "sps.df"
mz_match = which_within(is_info[,grep(polarity, colnames(is_info))], sps.df$mz)
names(mz_match) <- is_info$name
# remove the compounds for which there is not any match:
mz_match = mz_match[lengths(mz_match)>0]
mz_match = lapply(mz_match, function(z){ # get the intensities of matches
  sps.df$i[z]
})
mz_match = data.frame(name=rep(names(mz_match), lengths(mz_match)), 
                      intensity=unlist(mz_match))
mz_match = mz_match[order(-mz_match$intensity),]
mz_match[1,]
plot(sps.df$mz, sps.df$i, type="h", xlab="mz", ylab="intensity", 
     main=paste("RT", sps[[2]]@rt))
points(sps.df$mz[which(sps.df$i==mz_match$intensity[1])], 
       sps.df$i[which(sps.df$i==mz_match$intensity[1])], 
       pch=8, col="red")

# Check the RT window for that compound:
plot(bpis, col="black", xlim=c(bpis_bin_df[1,1]-10,bpis_bin_df[1,1]+10))
abline(v=c(185,188), col="red")
abline(v=my.rt, col="blue")
# add that window in the exclusion list of line nº83
```

## Minor peaks
Once, main peaks have been already identified, let's go to search 
the compounds still not found:
```{r}
mz = 110.05752

# EIC for a specific ion
plot(chromatogram(raw_data, aggregationFun = "max", mz=c(mz-da, mz+da)))

plot(chromatogram(raw_data, aggregationFun = "max", mz=c(mz-da, mz+da)),
     xlim = c(160,190)) # zoom
my.rt = 176.6 # indicate the RT
abline(v=my.rt, col="red")

# Look where is the peak in the whole TIC
plot(bpis, col="black", main = paste("IS_7", polarity, sep = "_"))
points(my.rt, 1e5, pch=8, col="red")

# Get all spectra measured within the time "my.rt":
sps <- raw_data %>%
    filterRt(rt = c(my.rt-0.5, my.rt+0.5)) %>%
    spectra 
plot(sps[[2]])
sps.df=as.data.frame(sps[[2]])
sps.df = sps.df[order(-sps.df$i),]
View(sps.df)

# Check the RT window for that compound:
plot(bpis, col="black", xlim=c(my.rt-10, my.rt+10))
abline(v=my.rt, col="red")
abline(v=c(174,178), col="blue")
```

