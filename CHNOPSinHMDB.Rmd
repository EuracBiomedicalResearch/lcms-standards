---
title: "Counting the number of C, H, N, O, P, S for compounds in HMDB"
author: "Andrea Vicini, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_depth: 3
    fig_width: 5
---

```{r style, echo = FALSE, results = 'asis', message = FALSE}
library(BiocStyle)
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

**Last modified:** `r file.info("CHNOPSinHMDB.Rmd")$mtime`<br />
**Compiled**: `r date()`


```{r libraries, warning = FALSE}
library("CompoundDb")
library("MetaboCoreUtils")
library("pander")
```

We load the HMDB database and extract the related compounds.

```{r}
cdb <- CompDb("~/CompDb.Hsapiens.HMDB.4.0.sqlite")
cmps <- compounds(cdb, columns = c("compound_id", "name", "formula", "exactmass"))
```

For each compound in the human metabolom database (HMDB) we compute how many 
atoms of C, H, N, O, P and S are present in it. 
We collect the counts in a data frame with a column for each element and a row 
for each compound in HMDB.

```{r}
CHNOPS <- c("C", "H", "N", "O", "P", "S", "Cl")
counts <- lapply(cmps$formula, function(frml) {
  res <- countElements(frml)
  row <- data.frame(matrix(0, nrow = 1, ncol = length(CHNOPS)))
  names(row) <- CHNOPS
  only <- intersect(CHNOPS, names(res))
  row[1, only] <- res[only]
  row
  })
counts_df <- do.call(rbind, counts)
rownames(counts_df) <- cmps$compound_id
```


We compute the mean and standard deviation for the number of each element in the 
molecules of HMDB.

```{r}
m_sd <- rbind(colMeans(counts_df), apply(counts_df, 2, sd))
rownames(m_sd) = c("mean", "standard deviation")
pandoc.table(m_sd, style = "rmarkdown")
```

We plot, for each of the considered elements,the distribution of the number of 
atoms of the given element in the compounds of HMDB.

```{r distribution-counts, fig.cap = "distribution of the number of atoms of CHNOPS element in the compounds of HMDB.", fig.width = 7, fig.height = 14}
par(mfrow = c(7, 1))
for (el in CHNOPS)
{
  barplot(table(counts_df[, el]), xlab = paste0("Number of counted ", el),
          ylab = "Number of compounds")
}
# It's not clear to me why particularly for H the number of compounds  
# oscillates between odd and even numbers or almost seems like 
# there are two different behaviours
```

We define the absolute abundances of the isotopes for C, N, O, S, Cl.
```{r}
isotopes <- list(C = c(0.9893, 0.0107), 
                 N = c(0.99636, 0.00364), 
                 O = c(0.99757, 0.00038, 0.00205),
                 S = c(0.9499, 0.0075, 0.0425),
                 Cl = c(0.7576, 0.2424))
```

We compute for each molecule in HMDB the probability that the molecule has 
certain numbers of the isotopes of a given element. 
```{r}
pC13 <- sapply(counts_df$C, 
               function(n) ifelse(n > 0, 
                                  dmultinom(c(n - 1, 1), prob = isotopes$C), 
                                  0))
p2C13 <- sapply(counts_df$C,
                function(n) ifelse(n > 1, 
                                   dmultinom(c(n - 2, 2), prob = isotopes$C), 
                                   0))
pN15 <- sapply(counts_df$N, 
               function(n) ifelse(n > 0, 
                                  dmultinom(c(n - 1, 1), prob = isotopes$N), 
                                  0))
pO17 <- sapply(counts_df$O, 
               function(n) ifelse(n > 0, 
                                  dmultinom(c(n - 1, 1, 0), prob = isotopes$O), 
                                  0))
pO18 <- sapply(counts_df$O, 
               function(n) ifelse(n > 0, 
                                  dmultinom(c(n - 1, 0, 1), prob = isotopes$O), 
                                  0))
pS33 <- sapply(counts_df$S, 
               function(n) ifelse(n > 0, 
                                  dmultinom(c(n - 1, 1, 0), prob = isotopes$S), 
                                  0))
pS34 <- sapply(counts_df$S, 
               function(n) ifelse(n > 0, 
                                  dmultinom(c(n - 1, 0, 1), prob = isotopes$S), 
                                  0))
pCl37 <- sapply(counts_df$Cl, 
                function(n) ifelse(n > 0, 
                                   dmultinom(c(n - 1, 1), prob = isotopes$Cl), 
                                   0))
```

```{r}
#pC13_ <- sapply(counts_df$C, function(n) isotopes$C[2]*n)
# p2S34 <- sapply(counts_df$S, 
#                function(n) ifelse(n > 1, 
#                                   dmultinom(c(n - 2, 0, 2), prob = isotopes$S), 
#                                   0))
# boxplot(p2S34[p2S34>0]); quantile(p2S34[p2S34>0], 0.8)
```

```{r, fig.width = 7, fig.height = 20}
names <- c("C13", "2C13", "N15", "O17", "O18", "S33", "S34", "Cl37")
par(mfrow = c(8, 2))
for (name in names)
{
  namev <- paste0("p", name)
  v <- get(namev)[get(namev) > 0]
  hist(v, probability = TRUE, main = name, xlab = namev)
  boxplot(v, main = name)
  #print(paste0(name," : ", quantile(v, 0.8)))
}
```





# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
