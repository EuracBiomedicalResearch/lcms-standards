---
title: "Identifying mix06 standards in water"
author: "Andrea Vicini, Vinicius Verri Hernandes, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_float: true
    toc_depth: 3
    fig_width: 5
---

```{r, include = FALSE, cached = FALSE}
knitr::read_chunk("R/match-standards-chunks.R")
MIX <- 6
MATRIX <- "Water"
POLARITY <- "POS"
## settings to find MS2 spectra for features. Be rather inclusive here.
FEATURE_MS2_PPM <- 20
FEATURE_MS2_TOLERANCE <- 0.05
```

```{r, libraries, echo = FALSE, message = FALSE}
```
```{r, general-settings, echo = FALSE, message = FALSE}
```

**Current version: 0.10.0, 2022-05-30.**

# Introduction

Mixes of standards have been solved in water or added to human serum sample
pools in two different concentration and these samples were measured with the
LC-MS setup from Eurac (used also to generate the CHRIS untargeted metabolomics
data). Assignment of retention time and observed ion can be performed for each
standard based on MS1 information such as expected m/z but also based on the
expected difference in signal between samples with low and high concentration of
the standards. Finally, experimental fragment spectra provide the third level of
evidence. Thus, the present data set allows to annotate features to standards
based on 3 levels of evidence: expected m/z, difference in measured intensity
and MS2-based annotation.

A detailed description of the approach is given in
[match-standards-introduction.Rmd](match-standards-introduction.Rmd).


The list of standards that constitute the present sample mix are listed below
along with the expected retention time and the most abundant adduct for positive
and negative polarity as defined manually in a previous analysis by Mar
Garcia-Aloy.

```{r, standards-table, echo = FALSE, results = "asis"}
```

# Data import

We next load the data and split it according to matrix and polarity.

```{r, data-import}
```

We next also load the reference databases we will use to compare the
experimental MS2 spectra against. Below we thus load HMDB and MassBank data. We
create in addition *neutral loss* versions of the databases. Since HMDB does not
provide precursor m/z values we assume the fragment spectra to represent `[M+H]+`
ions (respectively `[M-H]-` ions for negative polarity) and add the m/z for
these adducts as *precursor m/z*.

```{r, load-reference-databases, message = FALSE}
```

```{r, setup-ion-db, message = FALSE, echo = FALSE}
```

# Initial evaluation of available MS2 data

Before performing the actual analysis that involves chromatographic peak
detection and evaluation of feature abundances, we compare all experimental MS2
spectra against the reference libraries. This provides already a first hint for
which standards a valid MS2 spectrum was recorded (and hence would allow
annotation based on evidence 3) and what related retention time might be.

We first extract all MS2 spectra from the respective data files and process them
by first removing all peaks with an intensity below 5% of the highest peak
signal, then scaling all intensities to a value range between 0 and 100 and
finally remove all MS2 spectra with less than 2 peaks.

```{r prepare-all-ms2}
fls <- fileNames(data_all)[data_all$polarity == "POS"]
```
```{r, all-ms2}
```

We next match these spectra against all reference spectra from HMDB for the
standards in `r MIX_NAME`. 

The settings for the matching are defined below. These will be used for all MS2
spectra similarity calculations. All matching spectra with a similarity larger
0.7 are identified.

```{r, compare-spectra-param}
```
 
Standards for which no MS2 spectrum in HMDB is present are listed in
the table below.

```{r, echo = FALSE, results = "asis"}
tmp <- std_dilution[!(std_dilution$HMDB %in% hmdb_std$compound_id), ]
pandoc.table(tmp[, c("name", "HMDB", "formula")], style = "rmarkdown",
             caption = "Standards for which no reference spectrum is available")
```

The table below lists all standards and the number of matching reference spectra
(along with their retention times).

```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We repeat the same analysis for the negative polarity data (code not shown
again).

```{r, echo = FALSE}
fls <- fileNames(data_all)[data_all$polarity == "NEG"]
```
```{r, all-ms2, echo = FALSE}
```
```{r, table-all-ms2-hmdb, echo = FALSE, results = "asis"}
```

We next perform the full analysis of the data set involving MS1 and MS2 data.


# Water, positive polarity

We first perform the analysis on the samples with the standards solved in pure
water acquired in positive polarity mode.

```{r}
POLARITY <- "POS"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_pos
hmdb_nl <- hmdb_pos_nl
```

## Data pre-processing

We perform the pre-processing of our data set which consists of the
chromatographic peak detection followed by a peak refinement step to reduce peak
detection artifacts, the correspondence analysis to group peaks across samples
and finally the gap-filling to fill in missing peak data from samples in which
no chromatographic peak was detected. For details on settings please refer to
the analysis of *mix 01* samples.

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```

## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-pos}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards with matching features

While for some standards a matching feature was found we still need to evaluate
whether this matching is correct. For each standard we thus first evaluate the
EICs for all matching features, then we match their MS2 spectra (if available)
against reference libraries. To ensure correct assignment of a feature, its
retention time and eventually related MS2 spectra, we consider the following
criteria to determine the annotation confidence:

- feature(s) was/were found with m/z matching those of adduct(s) of the 
  standard.
- signal is higher for samples with higher concentration.
- MS2 spectra matches reference spectra for the standard (if available).
- MS2 spectra don't match MS2 spectra of other compounds.

### Acetylglutamic acid

```{r, echo = FALSE}
std <- "Acetylglutamic acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EICs for the assigned features and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-pos-acetylglutamic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-acetylglutamic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

With the HMDB comparison we find matches for spectra from features FT1475,
FT1809, FT1811. The matches with similarity score greater than 0.7 are shown
below.

```{r mix06-water-pos-acetylglutamic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```
With the MassBank comparison we don't find any matches as we show below.

```{r mix06-water-pos-acetylglutamic-acid-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```
Since some of the extracted spectra are from features associated to ions
different from `[M+H]+` we also perform a neutral loss spectra comparison.

```{r mix06-water-pos-acetylglutamic-acid-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-pos-acetylglutamic-acid-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT1809 (RT=87.54, `[M+H]+` ion) with confidence level **A**.
- FT1475 (RT=87.22, `[M+H-H2O]+` ion) with confidence level **A-**.
- FT1811 (RT=99.29, `[M+H]+` ion) with confidence level **A**? Seems like the
  EIC of this feature is the right tail of FT1809 EIC.
- FT2588 (RT=96.33, `[M+2K-H]+` ion) with confidence level **A-**?
- Reference MS2: `[M+H+]`: FT1809_F07.S0202, FT1809_F07.S0227; high
  confidence. `[M+H-H2O]+`: FT1475_F07.S0196, FT1475_F07.S0220,
  FT1475_F08.S0193, FT1475_F08.S0211; high confidence?
  `[M+2K-H]+`: FT2588_F07.S0229, FT2588_F07.S0285, FT2588_F08.S0227,
  FT2588_F08.S0278?

### Acetylglycine

```{r, echo = FALSE}
std <- "Acetylglycine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The only available MS2 spectrum (cleaned) for the features matched to `r std`
is shown below (peaks with an intensity below 5% of the maximum peak and
spectra with less than 2 peaks were removed).

```{r mix06-water-pos-acetylglycine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectrum against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-acetylglycine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The extracted spectrum matches with similarity score lower than 0.7. The best
matches (shown below) involve only one peak.

```{r mix06-water-pos-acetylglycine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.4,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

No match is found with MassBank comparison as shown below.

```{r mix06-water-pos-acetylglycine-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT0634 (RT = 54.63, `[M+H]+` ion) with confidence level **C**.
- FT0314 (RT = 55.35, `[M+H-H2O]+` ion) with confidence level **C-**.
- Reference MS2: `[M+H]+`: FT0634_F08.S0158; low confidence.
  
### Arginine

```{r, echo = FALSE}
std <- "Arginine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-pos-arginine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-arginine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```
All extracted seem to match some of the HMDB reference spectra from `r std` to
certain extent. The best matches involve spectra from features FT1529, FT1528,
FT1523, FT1231

```{r mix06-water-pos-arginine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.9,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```
We obtain similar results with the MassBank comparison as we show below.

```{r mix06-water-pos-arginine-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Since some of the extracted spectra are associated to ions different from
`[M+H]+` we perform a neutral loss spectra comparison.

```{r mix06-water-pos-arginine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-pos-arginine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT1523 (RT = 188.3, `[M+H]+` ion) with confidence **B**. (or **A**?)
- FT1231 (RT = 188.1, `[M+H-NH3]+` ion) with confidence **B-**.
- FT0170 (RT = 188.5, `[M+2H]2+` ion) with confidence **B-**.
- FT1879 (RT = 188.6, `[M+Na]+` ion) with confidence **B-**.
- FT1218 (RT = 188.6, `[M+H-H2O]+` ion) with confidence **B-**.
- FT1528 (RT = 211.2, `[M+H]+` ion) with confidence **B**.
- FT1529 (RT = 295.3, `[M+H]+` ion) with confidence **B**.
- Reference MS2: `[M+H]+`: FT1523_F07.S0577, FT1523_F07.S0609, FT1523_F08.S0582,
  FT1523_F08.S0619; FT1528_F07.S0671, FT1528_F08.S0684, FT1529_F07.S0860.
  `[M+H-H2O]+`: FT1218_F07.S0592, FT1218_F08.S0590; low confidence.
  `[M+H-NH3]+`: FT1231_F07.S0575, FT1231_F08.S0580.

### Asparagine

```{r, echo = FALSE}
std <- "Asparagine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```


```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The extracted MS2 spectra for the features matched to `r std` are shown
below (peaks with an intensity below 5% of the maximum peak where removed).

```{r mix06-water-pos-asparagine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectrum against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-asparagine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix06-water-pos-asparagine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

```{r mix06-water-pos-asparagine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix06-water-pos-asparagine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```
Since some of the extracted spectra are associated to ions different from
`[M+H]+` we perform a neutral loss spectra comparison.

```{r mix06-water-pos-asparagine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-pos-asparagine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

We don't get new good matches from the neutral loss spectra comparison.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0812 (RT = 185, `[M+H]+` ion) with confidence **B**. (or **A**?)
- FT0584 (RT = 184.8, `[M+H-H2O]+` ion) with confidence **B-**.
- FT1453 (RT = 184.7, `[M+K]+` ion) with confidence **B-**.
- FT1182 (RT = 184.7, `[M+Na]+` ion) with confidence **B-**.
- FT0596 (RT = 184.5, `[M+H-NH3]+` ion) with confidence **B-**.
- Reference MS2: `[M+H]+`: FT0812_F07.S0556, FT0812_F08.S0564; high confidence.
  `[M+Na]+`: FT1182_F08.S0565; low confidence.
  `[M+H-NH3]+`: FT0596_F08.S0561, FT0596_F07.S0574; low confidence.

### Choline

```{r, echo = FALSE}
std <- "Choline"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-pos-choline-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-choline-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix06-water-pos-choline-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.8, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix06-water-pos-choline-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix06-water-pos-choline-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.8, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0364 (RT = 36.68, ion `[M+H]+`): confidence **A**.
- FT0158 (RT = 33.94, ion `[M+H-H2O]+`): confidence **A-**.
- FT0362 (RT = 44.89, ion `[M+H]+`): confidence **A**?
- FT0363 (RT = 64.34, ion `[M+H]+`): confidence **A**?
- FT0365 (RT = 88.98, ion `[M+H]+`): confidence **A**?
- Reference MS2: `[M+H]+`: FT0364_F08.S0122, FT0362_F08.S0122, FT0362_F08.S0155,
  FT0362_F07.S0121, FT0362_F07.S0145, FT0362_F07.S0168, FT0363_F08.S0171,
  FT0363_F07.S0121, FT0363_F07.S0145, FT0363_F07.S0168, FT0365_F07.S0121,
  FT0365_F07.S0145, FT0365_F07.S0168, FT0365_F08.S0122, FT0365_F08.S0155,
  FT0365_F08.S0171; high confidence.

### CMP

```{r, echo = FALSE}
std <- "CMP"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from two
different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-pos-cmp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-cmp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We find matches for the spectra from feature FT3264.

```{r mix06-water-pos-cmp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```
We obtain similar results with the MassBank comparison as we show below.

```{r mix06-water-pos-cmp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition, since some of the extracted spectra are associated to ions
different from `[M+H]+` we perform a neutral loss spectra comparison.

```{r mix06-water-pos-cmp-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-pos-cmp-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```
With neutral loss comparison we find additional matches for spectra from feature
FT3570 and only in the MassBank case a very low similarity match for
FT3727_F08.S0691.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT3264 (RT=209.8, `[M+H]+` ion) confidence level **A**. (or **B**?)
- FT3060 (RT=209.8, `[M+H-H2O]+` ion) confidence level **A-**.
- FT3570 (RT=210, `[M+Na]+` ion) confidence level **A-**.
- FT3727 (RT=211.3, `[M+K]+` ion) confidence level **A-**.
- Reference MS2: `[M+H]+`: FT3264_F07.S0677, FT3264_F07.S0715, FT3264_F08.S0676;
  high confidence.
  `[M+Na]+`: FT3570_F07.S0678, FT3570_F08.S0689; low confidence.
  `[M+K]+`: FT3727_F07.S0679, FT3727_F08.S0691; low confidence.
  
### Cystine

```{r, echo = FALSE}
std <- "Cystine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-pos-cystine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-cystine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

Spectra from features FT2332 and FT2334 match some of the HMDB reference spectra
for `r std`. The best matches (similarity score greater than 0.7) are shown
in the mirror plots below.
 
```{r mix06-water-pos-cystine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```
With the MassBank comparison we obtain similar results but with lower scores as
shown below.

```{r mix06-water-pos-cystine-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition, since spectrum F07.S0855 from feature FT3181 is associated to an
ion different from `[M+H]+` we perform a neutral loss spectra comparison.

```{r mix06-water-pos-cystine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2["FT3181_F07.S0855"], nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-pos-cystine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2["FT3181_F07.S0855"], nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

We don't find good matches neither with HMDB or MassBank comparison.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "target_inchikey", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank,
              sv = c("rtime", "target_name", "target_inchikey", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT2332 (RT = 211, `[M+H]+`): confidence level **A**. (or **B** because of
  Cystine and L-Cystine?)
- FT0671 (RT = 210.9, `[M+H-H2O]+`): confidence level **A-**.
- FT2334 (RT = 231.8, `[M+H]+`): confidence level **A**.
- Reference MS2: `[M+H]+`: FT2332_F07.S0673, FT2332_F07.S0714, FT2332_F08.S0687,
  FT2332_F08.S0718, FT2334_F07.S0734, FT2334_F08.S0731; high confidence.

### Histamine

```{r, echo = FALSE}
std <- "Histamine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-pos-histamine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-histamine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```
 
```{r mix06-water-pos-histamine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.9, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix06-water-pos-histamine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Since some of the extracted spectra are associated to ions different from
`[M+H]+` we perform a neutral loss spectra comparison.

```{r mix06-water-pos-histamine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-pos-histamine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

With neutral loss comparison we get some matches for spectra FT0835_F07.S0516
that we didn't observe before.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT0512 (RT = 173.5, ion `[M+H]+`): confidence level **A**.
- FT0259 (RT = 173.2, ion `[M+H-NH3]+`): confidence level **A-**.
- FT0835 (RT = 171.6, ion `[M+Na]+`): confidence level **A-**? But associated
  spectra match also reference spectra of compounds different from `r std`.
- FT0515 (RT = 187.4, ion `[M+H]+`): confidence level **B**.
- FT0513 (RT = 212.3, ion `[M+H]+`): confidence level **B**.
- FT0517 (RT = 239.9, ion `[M+H]+`): confidence level **B**.
- FT0518 (RT = 273.7, ion `[M+H]+`): confidence level **A**?
- FT0264 (RT = 277.4, ion `[M+H-NH3]+`): confidence level **A-**?
- (EICs for FT0517 and FT0518 don't show a clear peak)
- Reference MS2: `[M+H]+`: FT0512_F07.S0515, FT0512_F07.S0553, FT0512_F08.S0512;
  high confidence. FT0515_F07.S0553, FT0515_F07.S0601, FT0515_F07.S0670,
  FT0515_F08.S0604, FT0515_F08.S0671, FT0513_F07.S0670, FT0513_F08.S0671,
  FT0513_F08.S0773, FT0513_F08.S0803, FT0517_F07.S0780, FT0517_F08.S0773,
  FT0518_F08.S0803.
  `[M+Na]+`: FT0835_F07.S0516, FT0835_F08.S0504; low confidence.
  `[M+K]+`: FT1777_F07.S0378, FT1777_F08.S0381; low confidence.

### 3-Hydroxybutyric Acid

```{r, echo = FALSE}
std <- "3-Hydroxybutyric Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect it.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-pos-3-hydroxybutyric-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-3-hydroxybutyric-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix06-water-pos-3-hydroxybutyric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

#### Summary

- No reference spectra in HMDB or MassBank for `r std`?
- FT0162 (RT = 32.83, `[M+H-H2O]+` ion) confidence level **D**?

### Methioninesulfoxide

```{r, echo = FALSE}
std <- "Methioninesulfoxide"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-pos-methioninesulfoxide-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-methioninesulfoxide-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We obtain low similarity matches for spectra from features FT1327 and FT1329.

```{r mix06-water-pos-methioninesulfoxide-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.1, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix06-water-pos-methioninesulfoxide-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition, since some of the extracted spectra are associated to ions
different from `[M+H]+` we perform a neutral loss spectra comparison.

```{r mix06-water-pos-methioninesulfoxide-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```
 We find matches for the same spectra as before (with higher similarity score)
 and additionally low similarity matches for spectra from FT1083.
 
```{r mix06-water-pos-methioninesulfoxide-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT1327 (RT = 183.1, `[M+H]+` ion) with confidence level **C**.
- FT2028 (RT = 182, `[M+2Na-H]+` ion) with confidence level **C-**.
- FT1782 (RT = 182.9, `[M+Na]+` ion) with confidence level **C-**.
- FT1062 (RT = 183.3, `[M+H-H2O]+` ion) with confidence level **C-**.
- FT1083 (RT = 183.5, `[M+H-NH3]+` ion) with confidence level **C-**.
- FT1329 (RT = 192.2, `[M+H]+` ion) with confidence level **C**.
- Reference MS2: `[M+H]+`: FT1327_F07.S0550, FT1327_F08.S0551, FT1329_F07.S0598,
  FT1329_F08.S0614; low confidence. `[M+Na]+`: FT1782_F08.S0538; low confidence.
  `[M+H-NH3]+`: FT1083_F07.S0557, FT1083_F08.S0549; low confidence.

### Paracetamol

```{r, echo = FALSE}
std <- "Paracetamol"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-pos-paracetamol-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

#### Summary

- No MS2 spectra available.

### Sphingosine-1-phosphate

```{r, echo = FALSE}
std <- "Sphingosine-1-phosphate"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-pos-sphingosine-1-phosphate-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-sphingosine-1-phosphate-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```
Spectra from features FT3954, FT3953, FT3947, FT3732, FT3736, FT3733, FT3951,
FT3948 match well HMDB reference spectra for `r std`.

```{r mix06-water-pos-sphingosine-1-phosphate-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.8, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix06-water-pos-sphingosine-1-phosphate-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition, since some of the extracted spectra are associated to ions
different from `[M+H]+` we perform a neutral loss spectra comparison but we
don't find additional good matches (low similarity ones for spectra
FT4190_F07.S0440).

```{r mix06-water-pos-sphingosine-1-phosphate-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-pos-sphingosine-1-phosphate-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

Strange situation with many features associated to `[M+H]+` at different
retention times

- FT3954 (RT=281.6, `[M+H]+` ion) with confidence level **A**.
- FT3953 (RT=295.3, `[M+H]+` ion) with confidence level **A**.
- FT3947 (RT=147.3, `[M+H]+` ion) with confidence level **A**.
- FT3732 (RT=147.3, `[M+H-H2O]+` ion) with confidence level **A-**.
- FT4355 (RT=147.3, `[M+K]+` ion) with confidence level **A-**.
- FT3948 (RT=177.4, `[M+H]+` ion) with confidence level **A**.
- FT3733 (RT=147.3, `[M+H-H2O]+` ion) with confidence level **A-**.
- FT4193 (RT=147.3, `[M+H-H2O]+` ion) with confidence level **A-**.
- FT3951 (RT=334.2, `[M+K]+` ion) with confidence level **A**.
- FT4190 (RT=147.6, `[M+Na]+` ion) with confidence level **C**.
- FT4409 (RT=147.6, `[M+2Na-H]+` ion) with confidence level **C-**.
- Reference MS2: `[M+H]+`: FT3954_F07.S0794, FT3954_F07.S0864, FT3953_F07.S0794,
  FT3953_F07.S0864, FT3947_F07.S0396, FT3947_F07.S0466, FT3947_F08.S0390,
  FT3947_F08.S0464, FT3948_F08.S0546, FT3951_F07.S0977?
  `[M+H-H2O]+`: FT3732_F07.S0395, FT3732_F08.S0366, FT3732_F08.S0445,
  FT3733_F07.S0547, FT3733_F08.S0545; low confidence.
  `[M+K]+`: FT4355_F08.S0411, FT4355_F07.S0399; low confidence.
  `[M+K]+`: FT4190_F07.S0386, FT4190_F07.S0440, FT4190_F08.S0379,
  FT4190_F08.S0452; low confidence.
  `[M+2Na-H]+`: FT4409_F07.S0387, FT4409_F07.S0441, FT4409_F08.S0380,
  FT4409_F08.S0434; low confidence.

### Sucrose

```{r, echo = FALSE}
std <- "Sucrose"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-pos-sucrose-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-sucrose-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix06-water-pos-sucrose-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Strangely no match is found against HMDB or MassBank reference spectra for
`r std`. Since some of the extracted spectra are associated to ions different
from `[M+H]+` we perform a neutral loss spectra comparison.

```{r mix06-water-pos-sucrose-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-pos-sucrose-hmdb_nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2_nl, std_hmdb_nl, 0.2, ppm = csp_nl@ppm,
                               tolerance = csp_nl@tolerance)
```

```{r mix06-water-pos-sucrose-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT3781 (RT = 159.1, `[M+Na]+` ion) with confidence level **C**?
- FT3780 (RT = 166.7, `[M+Na]+` ion) with confidence level **C**?
- Reference MS2: `[M+Na]+`: FT3781_F08.S0483, FT3780_F07.S0509,
  FT3780_F08.S0483; low confidence.

### Tryptophan

```{r, echo = FALSE}
std <- "Tryptophan"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The only available MS2 spectrum (cleaned) for the features matched to `r std` is
shown below (peaks with an intensity below 5% of the maximum peak and spectra
with less than 2 peaks were removed).

```{r mix06-water-pos-tryptophan-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-tryptophan-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```
Spectra from features FT1965, FT1967, FT1784, FT1786 match with high similarity
scores. The best matches (similarity score greater than 0.9) are shown in
the mirror plots below.

```{r mix06-water-pos-tryptophan-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.9, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

We obtain similar results with the MassBank comparison as we show below.

```{r mix06-water-pos-tryptophan-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

Since some of the extracted spectra are associated to ions different from
`[M+H]+` we perform a neutral loss spectra comparison.

```{r mix06-water-pos-tryptophan-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-pos-tryptophan-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

We get additional low similarity matches for spectra from features FT2427 and
FT2214.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT1965 (RT= 151.5, `[M+H]+` ion) with confidence level **A**.
- FT1784 (RT= 151.7, `[M+H-NH3]+` ion) with confidence level **A-**.
- FT2427 (RT= 151.9, `[M+2Na-H]+` ion) with confidence level **A-**.
- FT1967 (RT = 177, `[M+H]+` ion) with confidence level **A**.
- FT1786 (RT= 176.7, `[M+H-NH3]+` ion) with confidence level **A-**.
- Reference MS2: `[M+H]+`: FT1965_F08.S0425, FT1965_F07.S0412, FT1965_F07.S0479,
  FT1967_F07.S0541, FT1967_F08.S0540; high confidence.
  `[M+H-NH3]+`: FT1784_F07.S0411, FT1784_F07.S0478, FT1784_F08.S0424,
  FT1786_F07.S0530, FT1786_F08.S0538; high confidence? 
  `[M+2Na-H]+`: FT2427_F08.S0426, FT2214_F07.S0438; low confidence.

### UDP-acetylglucosamine

```{r, echo = FALSE}
std <- "UDP-acetylglucosamine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WP", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-pos-udp-acetylglucosamine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-pos-udp-acetylglucosamine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix06-water-pos-udp-acetylglucosamine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```
No match is found with MassBank comparison as shown below.

```{r mix06-water-pos-udp-acetylglucosamine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```
We also perform neutral loss comparison for spectra FT5874_F08.S0878 because
the associated ion is different from `[M+H]+` but no good match is found.

```{r mix06-water-neg-udp-acetylglucosamine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2["FT5874_F08.S0878"], nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-neg-udp-acetylglucosamine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2["FT5874_F08.S0878"], nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT5731 (RT= 296, `[M+H]+` ion) with confidence level **A**.
- FT5874 (RT= 296.8, `[M+K]+` ion) with confidence level **A-**.
- Reference MS2: `[M+H]+`: FT5731_F07.S0870, FT5731_F08.S0877; high confidence.
  `[M+K]+`: FT5874_F08.S0878; low confidence.


# Water, negative polarity

We now perform the analysis on the samples with the standards still solved in
pure water but acquired in negative polarity mode.

```{r}
POLARITY <- "NEG"
data <- filterFile(data_all, which(data_all$polarity == POLARITY))
hmdb <- hmdb_neg
hmdb_nl <- hmdb_neg_nl
```

```{r, preprocessing, eval = !file.exists(paste0(RDATA_PATH, "processed_data_", POLARITY, ".RData")), message = FALSE}
```

```{r, echo = FALSE}
load(paste0(RDATA_PATH, paste0("processed_data_", POLARITY, ".RData")))
data_FS <- filterFile(data, which(data$mode == "FS"),
                      keepFeatures = TRUE)
```


## Signal intensity difference

We compute the difference in (log2) signals between samples with high and low
concentration of the standards and calculate the p-value for this difference
using the Student's t-test.

```{r, abundance-difference}
```

## Identification of features matching standards

We now identify all features matching the any of the pre-defined set of adducts
for the standards of mix `r MIX`. Matching features are further subsetted to
those that show an at least twice as high signal in samples with high
concentration compared to those with low concentrations. Also, features with a
signal in low concentration but no detectable signal in high concentration are
removed.

```{r, define-adducts-neg}
```
```{r, match-features}
```

For most of the standards (`r length(unique(mD$target_name))` out of 
`r nrow(std_dilution)`) in mix `r MIX` at least one feature was found
matching the standards adducts' m/z. 

```{r, table-standard-no-feature, results = "asis", echo = FALSE}
```

In the next sections we investigate for each standard which assignment would be
the correct one or, for those for which no signal was detected, why that was the
case.

## Standards with matching features

### Acetylglutamic acid

```{r, echo = FALSE}
std <- "Acetylglutamic acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EICs for the assigned features and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-acetylglutamic-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-acetylglutamic-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

MS2 spectra for features FT0483 and FT0485 match the reference spectra with
good similarity scores.

```{r mix06-water-neg-acetylglutamic-acid-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

```{r mix06-water-neg-acetylglutamic-acid-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

No spectrum matches reference spectra from MassBank.

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT0483 (RT = 87.4, `[M-H]-` ion) with confidence level **A**.
- FT0485 (RT = 87.4, `[M-H]-` ion) with confidence level **C**? From EIC only
  MSMS signal is visible.
- Reference MS2: `[M-H]-`: FT0483_F15.S0185, FT0483_F15.S0206, FT0483_F16.S0182;
  high confidence.

### Acetylglycine

```{r, echo = FALSE}
std <- "Acetylglycine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

A single feature has been assigned to this standard based on
m/z matching. We next plot its EIC and visually inspect it (has very
low intensity).

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-acetylglycine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

```{r mix06-water-neg-acetylglycine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix06-water-neg-acetylglycine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix06-water-neg-acetylglycine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix06-water-neg-acetylglycine-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0098 (RT = 52.67, `[M-H]-` ion) with confidence level **A**.
- FT0342 (RT = 53.13, `[M+HCOO]-` ion) with confidence level **A-**.
- Reference MS2: `[M-H]-`: FT0098_F15.S0141, FT0098_F15.S0171, FT0098_F16.S0134;
  high confidence.


### Arginine

```{r, echo = FALSE}
std <- "Arginine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

A single feature has been assigned to this standard based on
m/z matching. We next plot its EIC and visually inspect it (has very
low intensity).

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-arginine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-arginine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix06-water-neg-arginine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

```{r mix06-water-neg-arginine-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0397 (RT = 187.8 with, `[M-H]-` ion) with confidence level **B**.
- FT0690 (RT = 187.8 with, `[M+HCOO]-` ion) with confidence level **B-**.
- FT0398 (RT = 187.8 with, `[M-H]-` ion) with confidence level **C**?
- Reference MS2: FT0397_F15.S0527, FT0397_F15.S0575, FT0397_F16.S0538: high
  confidence.

### Asparagine

```{r, echo = FALSE}
std <- "Asparagine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

One single feature has been assigned to this standard based on m/z matching.
Based on their retention times, these seem however to represent ions from two
different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-asparagine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-asparagine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The available spectra match but with similarity score lower than 0.7. Those
with similarity score higher than 0.5 are shown in the mirror plots below.

```{r mix06-water-neg-asparagine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.5,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

We find similar results for MassBank as shown below.

```{r mix06-water-neg-asparagine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix06-water-neg-asparagine-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.5,
                           ppm = csp@ppm, tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0165 (RT = 184.3, `[M-H]-` ion) with confidence level **C**.
- Reference MS2: `[M-H-]`: FT0165_F15.S0516, FT0165_F16.S0460; low confidence.

### Choline

```{r, echo = FALSE}
std <- "Choline"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-choline-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank but we don't find any match as shown below.

```{r mix06-water-neg-choline-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix06-water-neg-choline-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```
Since the assigned features are associated an ion different from `[M+H]+` we
also perform a neutral loss spectra comparison.

```{r mix06-water-neg-choline-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-neg-choline-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

```{r mix06-water-neg-choline-mirror-mbank_nl, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2_nl, std_mbank_nl, 0.1,
                           ppm = csp_nl@ppm, tolerance = csp_nl@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- No very good match found.
- FT0228 (RT=115, `[M+Cl]-` ion) with confidence **C**??
- FT0229 (RT=140.5, `[M+Cl]-` ion) with confidence **C**??

### CMP

```{r, echo = FALSE}
std <- "CMP"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching.
Based on their retention times, these seem however to represent ions from
different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-cmp-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-cmp-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

All the extracted spectra match to some degree the reference spectra from
HMDB.

```{r mix06-water-neg-cmp-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

We repeat the same with MassBank and we obtain similar results as shown below.

```{r mix06-water-neg-cmp-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix06-water-neg-cmp-mirror-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT1430 (RT = 209.9, `[M-H]-` ion) with confidence level **A**.
- FT1810 (RT = 209.9, `[M+HCOO]-` ion) with confidence level **A-**.
- FT1431 (RT = 300.9, `[M-H]-` ion) with confidence level **C**.
- FT1432 (RT = 314.9, `[M-H]-` ion) with confidence level **A**.
- FT1429 (RT = 324, `[M-H]-` ion) with confidence level **A**.
- Reference MS2: `[M-H]-`: FT1430_F15.S0629, FT1430_F15.S0677, FT1430_F15.S0707,
  FT1430_F16.S0586, FT1430_F16.S0665,  FT1429_F16.S0894, FT1429_F15.S0911;
  high confidence. FT1431_F15.S0911, FT1432_F15.S0911, FT1432_F16.S0894;
  low confidence.


### Cystine

```{r, echo = FALSE}
std <- "Cystine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-cystine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-cystine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```
 
```{r mix06-water-neg-cystine-mirror-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.9,
                               ppm = csp@ppm, tolerance = csp@tolerance)
```

We repeat the same with MassBank but we don't obtain any good match.

```{r mix06-water-neg-cystine-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank,
              sv = c("rtime", "target_name", "target_inchikey", "score"),
              name = "target_name", param = csp)
```

#### Summary

- FT0793 (RT = 211, `[M-H]-` ion) with confidence **A**.
- Reference MS2: `[M-H]-`: FT0793_F15.S0647, FT0793_F15.S0680, FT0793_F15.S0722,
  FT0793_F16.S0596, FT0793_F16.S0635, FT0793_F16.S0663; high confidence.

### Histamine

```{r, echo = FALSE}
std <- "Histamine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-histamine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-histamine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We find matches with low similarity involving spectra from FT0060 but the
matches involve only a single peak as shown below.

```{r mix06-water-neg-histamine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.2, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```
We obtain similar results with the MassBnak comparison as we show below.

```{r mix06-water-neg-histamine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```
```{r mix06-water-neg-histamine-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.2, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

In addition, since some of the extracted spectra are associated to
ions different from `[M-H]-` we perform a neutral loss spectra comparison.

```{r mix06-water-neg-histamine-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-neg-histamine-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

EICs show low intensity signal for all the assigned features and no good spactra
match was found.

### 3-Hydroxybutyric Acid

```{r, echo = FALSE}
std <- "3-Hydroxybutyric Acid"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-3-hydroxybutyric-acid-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-3-hydroxybutyric-acid-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix06-water-neg-3-hydroxybutyric-acid-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

#### Summary

No reference spectra for `r std` in both HMDB and MassBank?
FT0052 has retention time close to the one found in previous analysis, two
associated MS2 spectra and EIC looks nice.


### Methioninesulfoxide

```{r, echo = FALSE}
std <- "Methioninesulfoxide"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-methioninesulfoxide-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-methioninesulfoxide-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix06-water-neg-methioninesulfoxide-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```


In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

#### Summary

No spectra match is found.FT0354 has retention time close to the one found
in previous analysis, two associated MS2 spectra (not matching) and EIC looks
nice. FT0640 is in the same feature group and EIC looks nice as well.

### Paracetamol


```{r, echo = FALSE}
std <- "Paracetamol"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-paracetamol-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-paracetamol-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

The MS2 spectra from FT0292 match reference spectra from `r std`.

```{r mix06-water-neg-paracetamol-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.8, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```
We obtain similar results with the MassBank comparison as we show below.

```{r mix06-water-neg-paracetamol-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT0292 (RT = 37.22, `[M-H]-` ion) with confidence level **A**.
- FT0543 (RT = 37.11, `[M+HCOO]-` ion) with confidence level **A-**.
- Reference MS2: FT0292_F16.S0095, FT0292_F16.S0095; high confidence.

### Sphingosine-1-phosphate

```{r, echo = FALSE}
std <- "Sphingosine-1-phosphate"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on
m/z matching. Based on their retention times, these seem however to represent
ions from different compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-sphingosine-1-phosphate-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-sphingosine-1-phosphate-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

```{r mix06-water-neg-sphingosine-1-phosphate-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

No spectra match is found. FT1877 has retention time close to the one found
in previous analysis, 4 associated MS2 spectra (not matching) and EIC looks
nice. FT2243 is in the same feature group and EIC looks nice as well.

### Sucrose

```{r, echo = FALSE}
std <- "Sucrose"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

Many features have been assigned to this standard based on m/z matching. Based
on their retention times, these seem however to represent ions from different
compounds.

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-sucrose-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-sucrose-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We find matches for all the extracted spectra.

```{r mix06-water-neg-sucrose-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```
We obtain similar results from the MassBank comparison as shown below.

```{r mix06-water-neg-sucrose-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition, since there are extracted spectra associated to an ion different
from `[M-H]-` (`[M+HCOO]-`) we perform a neutral loss spectra comparison.

```{r mix06-water-neg-sucrose-ms2-hmdb_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_hmdb_nl <- hmdb_nl[hmdb_nl$compound_id == hmdb_id]
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_hmdb_nl, csp_nl)
```

```{r mix06-water-neg-sucrose-ms2-mbank_nl, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank_nl <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey), nl = TRUE)
std_ms2_nl <- neutralLoss(std_ms2, nl_param)
sim <- plot_ms2_similarity_heatmap(std_ms2_nl, std_mbank_nl, csp_nl)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT1643 (RT = 186.8, `[M-H]-` ion) confidence level **B**.
- FT1971 (RT = 187.6, `[M+HCOO]-` ion) confidence level **B**.
- MS2 spectra:`[M-H]-`: FT1643_F15.S0528, FT1643_F16.S0494.
  `[M+HCOO]-`: FT1971_F15.S0531, FT1971_F16.S0497.

### Tryptophan

```{r, echo = FALSE}
std <- "Tryptophan"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The only available MS2 spectrum (cleaned) for the features matched to `r std` is
shown below (peaks with an intensity below 5% of the maximum peak and spectra
with less than 2 peaks were removed).

```{r mix06-water-neg-tryptophan-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-tryptophan-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We find matches for both extracted spectra.

```{r mix06-water-neg-tryptophan-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```
We obtain similar results from the MassBank comparison as shown below.

```{r mix06-water-neg-tryptophan-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

For completeness, we also perform a neutral loss spectra comparison with HMDB
and MassBank.

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, hmdb_nl, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

```{r, echo = FALSE, message = FALSE, results = "asis", eval = ALL_NL_MATCH}
perform_match(std_ms2_nl, mbank_nl,
              sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp_nl)
```

#### Summary

- FT0600 (RT = 151.1, `[M-H]-` ion) confidence **B** (or **A**?).
- FT0852 (RT = 151.3, `[M+HCOO]-` ion) confidence **B-**.
- Reference MS2: `[M-H]-`: FT0600_F15.S0399, FT0600_F16.S0380; high confidence.

### UDP-acetylglucosamine

```{r, echo = FALSE}
std <- "UDP-acetylglucosamine"
```

```{r, table-feature-matches, results = "asis", echo = FALSE, message = FALSE}
```

We next plot the EIC for the assigned feature and visually inspect these.

```{r, echo = FALSE}
plot_eics(data, std, feature_table, "WN", std_ms2)
```

The cleaned MS2 spectra for the features matched to `r std` are shown below
(peaks with an intensity below 5% of the maximum peak and spectra with less
than 2 peaks were removed).

```{r mix06-water-neg-udp-acetylglucosamine-ms2, echo = FALSE}
plot_spectra(std_ms2)
```

We next match the extracted MS2 spectra against the reference spectra for 
`r std` from HMDB and MassBank.

```{r mix06-water-neg-udp-acetylglucosamine-ms2-hmdb, echo = FALSE, fig.width = 5, fig.height = 5}
hmdb_id <- std_dilution$HMDB[std_dilution$name == std]
std_hmdb <- Spectra(cdb, filter = ~ compound_id == hmdb_id)
sim <- plot_ms2_similarity_heatmap(std_ms2, std_hmdb, csp)
```

We find matches for all the extracted spectra.

```{r mix06-water-neg-udp-acetylglucosamine-hmdb, echo = TRUE, fig.cap = "Mirror plots"}
std_ms2_sel <- plot_select_ms2(std_ms2, std_hmdb, 0.7, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```
We obtain matches also with the MassBank comparison but with lower similarity
scores.

```{r mix06-water-neg-udp-acetylglucosamine-ms2-mbank, echo = FALSE, fig.width = 5, fig.height = 5}
std_mbank <- get_mbank(mbank, inchikey = unique(std_hmdb$inchikey))
sim <- plot_ms2_similarity_heatmap(std_ms2, std_mbank, csp)
```

```{r mix06-water-neg-udp-acetylglucosamine-mbank, echo = TRUE, fig.cap = "Mirror plots"}
tmp_sel <- plot_select_ms2(std_ms2, std_mbank, 0.4, ppm = csp@ppm,
                               tolerance = csp@tolerance)
```

In addition we match (**all**) the MS2 spectra for the matched features against
all spectra from HMDB or MassBank identifying reference spectra with a
similarity larger than 0.7. The results (if any spectra matched) are shown in
the two following tables.

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, hmdb, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```

```{r, echo = FALSE, message = FALSE, results = "asis"}
perform_match(std_ms2, mbank, sv = c("rtime", "target_name", "score"),
              name = "target_name", param = csp)
```


#### Summary

- FT3284 (RT= 211.2, `[M-H]-` ion) with confidence level **A**. 
- FT3282 (RT= 246.8, `[M-H]-` ion) with confidence level **A**.
- FT3283 (RT= 293.6, `[M-H]-` ion) with confidence level **A**.
- Reference MS2: `[M-H]-`: FT3284_F16.S0614, FT3282_F15.S0727, FT3282_F16.S0692,
  FT3283_F16.S0787; high confidence.

## Standards without any matching feature

# Summary on the ion database

# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
